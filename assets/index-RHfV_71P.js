(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const oc=e=>{let n;const t=new Set,s=(l,d)=>{const c=typeof l=="function"?l(n):l;if(!Object.is(c,n)){const f=n;n=d??(typeof c!="object"||c===null)?c:Object.assign({},n,c),t.forEach(b=>b(n,f))}},r=()=>n,o={setState:s,getState:r,getInitialState:()=>u,subscribe:l=>(t.add(l),()=>t.delete(l))},u=n=e(s,r,o);return o},cc=(e=>oc),z=e=>e.realms[e.activeRealm];function Wr(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function Ha(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function Yr(e,n,t){return n&&Ha(e.prototype,n),t&&Ha(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}var lc=(function(){function e(n){Wr(this,e),this.map=new Map,this.first=void 0,this.last=void 0,this.maxSize=n}return Yr(e,[{key:"size",get:function(){return this.map.size}},{key:"get",value:function(t){var s=this.map.get(t);if(s!==void 0)return s!==this.first&&(s===this.last?(this.last=s.prev,this.last.next=void 0):(s.prev.next=s.next,s.next.prev=s.prev),s.next=this.first,this.first.prev=s,this.first=s),s.value}},{key:"set",value:function(t,s){if(!(this.maxSize<1)){if(this.map.has(t))throw new Error("Cannot update existing keys in the cache");var r=new uc(t,s);for(this.first===void 0?(this.first=r,this.last=r):(r.next=this.first,this.first.prev=r,this.first=r),this.map.set(t,r);this.map.size>this.maxSize;){var a=this.last;this.map.delete(a.key),this.last=a.prev,this.last.next=void 0}}}}]),e})(),uc=Yr(function e(n,t){Wr(this,e),this.next=void 0,this.prev=void 0,this.key=n,this.value=t}),Ys=17,Ue=9e15,dc=Math.log10(9e15),_t=1/9e15,fc=308,mc=-324,ja=5,pc=1023,gc=(function(){for(var e=[],n=mc+1;n<=fc;n++)e.push(+("1e"+n));var t=323;return function(s){return e[s+t]}})(),Lt=[2,Math.E,3,4,5,6,7,8,9,10],hc=[[1,1.0891180521811203,1.1789767925673957,1.2701455431742086,1.3632090180450092,1.4587818160364217,1.5575237916251419,1.6601571006859253,1.767485818836978,1.8804192098842727,2],[1,1.1121114330934079,1.231038924931609,1.3583836963111375,1.4960519303993531,1.6463542337511945,1.8121385357018724,1.996971324618307,2.2053895545527546,2.4432574483385254,Math.E],[1,1.1187738849693603,1.2464963939368214,1.38527004705667,1.5376664685821402,1.7068895236551784,1.897001227148399,2.1132403089001035,2.362480153784171,2.6539010333870774,3],[1,1.1367350847096405,1.2889510672956703,1.4606478703324786,1.6570295196661111,1.8850062585672889,2.1539465047453485,2.476829779693097,2.872061932789197,3.3664204535587183,4],[1,1.1494592900767588,1.319708228183931,1.5166291280087583,1.748171114438024,2.0253263297298045,2.3636668498288547,2.7858359149579424,3.3257226212448145,4.035730287722532,5],[1,1.159225940787673,1.343712473580932,1.5611293155111927,1.8221199554561318,2.14183924486326,2.542468319282638,3.0574682501653316,3.7390572020926873,4.6719550537360774,6],[1,1.1670905356972596,1.3632807444991446,1.5979222279405536,1.8842640123816674,2.2416069644878687,2.69893426559423,3.3012632110403577,4.121250340630164,5.281493033448316,7],[1,1.1736630594087796,1.379783782386201,1.6292821855668218,1.9378971836180754,2.3289975651071977,2.8384347394720835,3.5232708454565906,4.478242031114584,5.868592169644505,8],[1,1.1793017514670474,1.394054150657457,1.65664127441059,1.985170999970283,2.4069682290577457,2.9647310119960752,3.7278665320924946,4.814462547283592,6.436522247411611,9],[1,1.1840100246247336,1.4061375836156955,1.6802272208863964,2.026757028388619,2.4770056063449646,3.080525271755482,3.9191964192627284,5.135152840833187,6.989961179534715,10]],vc=[[-1,-.9194161097107025,-.8335625019330468,-.7425599821143978,-.6466611521029437,-.5462617907227869,-.4419033816638769,-.3342645487554494,-.224140440909962,-.11241087890006762,0],[-1,-.90603157029014,-.80786507256596,-.7064666939634,-.60294836853664,-.49849837513117,-.39430303318768,-.29147201034755,-.19097820800866,-.09361896280296,0],[-1,-.9021579584316141,-.8005762598234203,-.6964780623319391,-.5911906810998454,-.486050182576545,-.3823089430815083,-.28106046722897615,-.1831906535795894,-.08935809204418144,0],[-1,-.8917227442365535,-.781258746326964,-.6705130326902455,-.5612813129406509,-.4551067709033134,-.35319256652135966,-.2563741554088552,-.1651412821106526,-.0796919581982668,0],[-1,-.8843387974366064,-.7678744063886243,-.6529563724510552,-.5415870994657841,-.4352842206588936,-.33504449124791424,-.24138853420685147,-.15445285440944467,-.07409659641336663,0],[-1,-.8786709358426346,-.7577735191184886,-.6399546189952064,-.527284921869926,-.4211627631006314,-.3223479611761232,-.23107655627789858,-.1472057700818259,-.07035171210706326,0],[-1,-.8740862815291583,-.7497032990976209,-.6297119746181752,-.5161838335958787,-.41036238255751956,-.31277212146489963,-.2233976621705518,-.1418697367979619,-.06762117662323441,0],[-1,-.8702632331800649,-.7430366914122081,-.6213373075161548,-.5072025698095242,-.40171437727184167,-.30517930701410456,-.21736343968190863,-.137710238299109,-.06550774483471955,0],[-1,-.8670016295947213,-.7373984232432306,-.6143173985094293,-.49973884395492807,-.394584953527678,-.2989649949848695,-.21245647317021688,-.13434688362382652,-.0638072667348083,0],[-1,-.8641642839543857,-.732534623168535,-.6083127477059322,-.4934049257184696,-.3885773075899922,-.29376029055315767,-.2083678561173622,-.13155653399373268,-.062401588652553186,0]],C=function(n){return m.fromValue_noAlloc(n)},Q=function(n,t,s){return m.fromComponents(n,t,s)},te=function(n,t,s){return m.fromComponents_noNormalize(n,t,s)},It=function(n,t){var s=t+1,r=Math.ceil(Math.log10(Math.abs(n))),a=Math.round(n*Math.pow(10,s-r))*Math.pow(10,r-s);return parseFloat(a.toFixed(Math.max(s-r,0)))},Ks=function(n){return Math.sign(n)*Math.log10(Math.abs(n))},bc=function(n){if(!isFinite(n))return n;if(n<-50)return n===Math.trunc(n)?Number.NEGATIVE_INFINITY:0;for(var t=1;n<10;)t=t*n,++n;n-=1;var s=.9189385332046727;s=s+(n+.5)*Math.log(n),s=s-n;var r=n*n,a=n;return s=s+1/(12*a),a=a*r,s=s-1/(360*a),a=a*r,s=s+1/(1260*a),a=a*r,s=s-1/(1680*a),a=a*r,s=s+1/(1188*a),a=a*r,s=s-691/(360360*a),a=a*r,s=s+7/(1092*a),a=a*r,s=s-3617/(122400*a),Math.exp(s)/t},xc=.36787944117144233,Li=.5671432904097838,zs=function(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e-10,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r,a;if(!Number.isFinite(n))return n;if(s){if(n===0)return n;if(n===1)return Li;n<10?r=0:r=Math.log(n)-Math.log(Math.log(n))}else{if(n===0)return-1/0;n<=-.1?r=-2:r=Math.log(-n)-Math.log(-Math.log(-n))}for(var i=0;i<100;++i){if(a=(n*Math.exp(-r)+r*r)/(r+1),Math.abs(a-r)<t*Math.abs(a))return a;r=a}throw Error("Iteration failed to converge: ".concat(n.toString()))};function Ga(e){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e-10,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,s,r,a,i;if(!Number.isFinite(e.mag))return new m(e);if(t){if(e.eq(m.dZero))return te(0,0,0);if(e.eq(m.dOne))return m.fromNumber(Li);s=m.ln(e)}else{if(e.eq(m.dZero))return new m(m.dNegInf);s=m.ln(e.neg())}for(var o=0;o<100;++o){if(r=s.neg().exp(),a=s.sub(e.mul(r)),i=s.sub(a.div(s.add(1).sub(s.add(2).mul(a).div(m.mul(2,s).add(2))))),m.abs(i.sub(s)).lt(m.abs(i).mul(n)))return i;s=i}throw Error("Iteration failed to converge: ".concat(e.toString()))}var m=(function(){function e(n){Wr(this,e),this.sign=0,this.mag=0,this.layer=0,n instanceof e?this.fromDecimal(n):typeof n=="number"?this.fromNumber(n):typeof n=="string"&&this.fromString(n)}return Yr(e,[{key:"m",get:function(){if(this.sign===0)return 0;if(this.layer===0){var t=Math.floor(Math.log10(this.mag)),s;return this.mag===5e-324?s=5:s=this.mag/gc(t),this.sign*s}else if(this.layer===1){var r=this.mag-Math.floor(this.mag);return this.sign*Math.pow(10,r)}else return this.sign},set:function(t){this.layer<=2?this.fromMantissaExponent(t,this.e):(this.sign=Math.sign(t),this.sign===0&&(this.layer=0,this.exponent=0))}},{key:"e",get:function(){return this.sign===0?0:this.layer===0?Math.floor(Math.log10(this.mag)):this.layer===1?Math.floor(this.mag):this.layer===2?Math.floor(Math.sign(this.mag)*Math.pow(10,Math.abs(this.mag))):this.mag*Number.POSITIVE_INFINITY},set:function(t){this.fromMantissaExponent(this.m,t)}},{key:"s",get:function(){return this.sign},set:function(t){t===0?(this.sign=0,this.layer=0,this.mag=0):this.sign=t}},{key:"mantissa",get:function(){return this.m},set:function(t){this.m=t}},{key:"exponent",get:function(){return this.e},set:function(t){this.e=t}},{key:"normalize",value:function(){if(this.sign===0||this.mag===0&&this.layer===0||this.mag===Number.NEGATIVE_INFINITY&&this.layer>0&&Number.isFinite(this.layer))return this.sign=0,this.mag=0,this.layer=0,this;if(this.layer===0&&this.mag<0&&(this.mag=-this.mag,this.sign=-this.sign),this.mag===Number.POSITIVE_INFINITY||this.layer===Number.POSITIVE_INFINITY||this.mag===Number.NEGATIVE_INFINITY||this.layer===Number.NEGATIVE_INFINITY)return this.mag=Number.POSITIVE_INFINITY,this.layer=Number.POSITIVE_INFINITY,this;if(this.layer===0&&this.mag<_t)return this.layer+=1,this.mag=Math.log10(this.mag),this;var t=Math.abs(this.mag),s=Math.sign(this.mag);if(t>=Ue)return this.layer+=1,this.mag=s*Math.log10(t),this;for(;t<dc&&this.layer>0;)this.layer-=1,this.layer===0?this.mag=Math.pow(10,this.mag):(this.mag=s*Math.pow(10,t),t=Math.abs(this.mag),s=Math.sign(this.mag));return this.layer===0&&(this.mag<0?(this.mag=-this.mag,this.sign=-this.sign):this.mag===0&&(this.sign=0)),(Number.isNaN(this.sign)||Number.isNaN(this.layer)||Number.isNaN(this.mag))&&(this.sign=Number.NaN,this.layer=Number.NaN,this.mag=Number.NaN),this}},{key:"fromComponents",value:function(t,s,r){return this.sign=t,this.layer=s,this.mag=r,this.normalize(),this}},{key:"fromComponents_noNormalize",value:function(t,s,r){return this.sign=t,this.layer=s,this.mag=r,this}},{key:"fromMantissaExponent",value:function(t,s){return this.layer=1,this.sign=Math.sign(t),t=Math.abs(t),this.mag=s+Math.log10(t),this.normalize(),this}},{key:"fromMantissaExponent_noNormalize",value:function(t,s){return this.fromMantissaExponent(t,s),this}},{key:"fromDecimal",value:function(t){return this.sign=t.sign,this.layer=t.layer,this.mag=t.mag,this}},{key:"fromNumber",value:function(t){return this.mag=Math.abs(t),this.sign=Math.sign(t),this.layer=0,this.normalize(),this}},{key:"fromString",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=t,a=e.fromStringCache.get(r);if(a!==void 0)return this.fromDecimal(a);if(t=t.replace(",",""),t.toLowerCase()==="nan")return this.fromDecimal(e.dNaN);if(t.toLowerCase()==="infinity")return this.fromDecimal(e.dInf);if(t.toLowerCase()==="-infinity")return this.fromDecimal(e.dNegInf);var i=t.split("^^^");if(i.length===2){var o=parseFloat(i[0]),u=parseFloat(i[1]),l=i[1].split(";"),d=1;if(l.length===2&&(d=parseFloat(l[1]),isFinite(d)||(d=1)),isFinite(o)&&isFinite(u)){var c=e.pentate(o,u,d,s);return this.sign=c.sign,this.layer=c.layer,this.mag=c.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}}var f=t.split("^^");if(f.length===2){var b=parseFloat(f[0]),y=parseFloat(f[1]),g=f[1].split(";"),w=1;if(g.length===2&&(w=parseFloat(g[1]),isFinite(w)||(w=1)),isFinite(b)&&isFinite(y)){var p=e.tetrate(b,y,w,s);return this.sign=p.sign,this.layer=p.layer,this.mag=p.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}}var h=t.split("^");if(h.length===2){var x=parseFloat(h[0]),S=parseFloat(h[1]);if(isFinite(x)&&isFinite(S)){var $=e.pow(x,S);return this.sign=$.sign,this.layer=$.layer,this.mag=$.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}}t=t.trim().toLowerCase();var R,k,v=t.split("pt");if(v.length===2){R=10;var I=!1;v[0][0]=="-"&&(I=!0,v[0]=v[0].slice(1)),k=parseFloat(v[0]),v[1]=v[1].replace("(",""),v[1]=v[1].replace(")","");var T=parseFloat(v[1]);if(isFinite(T)||(T=1),isFinite(R)&&isFinite(k)){var L=e.tetrate(R,k,T,s);return this.sign=L.sign,this.layer=L.layer,this.mag=L.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),I&&(this.sign*=-1),this}}if(v=t.split("p"),v.length===2){R=10;var q=!1;v[0][0]=="-"&&(q=!0,v[0]=v[0].slice(1)),k=parseFloat(v[0]),v[1]=v[1].replace("(",""),v[1]=v[1].replace(")","");var j=parseFloat(v[1]);if(isFinite(j)||(j=1),isFinite(R)&&isFinite(k)){var H=e.tetrate(R,k,j,s);return this.sign=H.sign,this.layer=H.layer,this.mag=H.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),q&&(this.sign*=-1),this}}if(v=t.split("f"),v.length===2){R=10;var _=!1;v[0][0]=="-"&&(_=!0,v[0]=v[0].slice(1)),v[0]=v[0].replace("(",""),v[0]=v[0].replace(")","");var J=parseFloat(v[0]);if(v[1]=v[1].replace("(",""),v[1]=v[1].replace(")",""),k=parseFloat(v[1]),isFinite(J)||(J=1),isFinite(R)&&isFinite(k)){var ee=e.tetrate(R,k,J,s);return this.sign=ee.sign,this.layer=ee.layer,this.mag=ee.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),_&&(this.sign*=-1),this}}var X=t.split("e"),re=X.length-1;if(re===0){var ce=parseFloat(t);if(isFinite(ce))return this.fromNumber(ce),e.fromStringCache.size>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}else if(re===1){var B=parseFloat(t);if(isFinite(B)&&Math.abs(B)>1e-307)return this.fromNumber(B),e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}var se=t.split("e^");if(se.length===2){this.sign=1,se[0].charAt(0)=="-"&&(this.sign=-1);for(var ae="",fe=0;fe<se[1].length;++fe){var me=se[1].charCodeAt(fe);if(me>=43&&me<=57||me===101)ae+=se[1].charAt(fe);else{if(this.layer=parseFloat(ae),this.mag=parseFloat(se[1].substr(fe+1)),this.layer<0||this.layer%1!=0){var G=e.tetrate(10,this.layer,this.mag,s);this.sign=G.sign,this.layer=G.layer,this.mag=G.mag}return this.normalize(),e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}}}if(re<1)return this.sign=0,this.layer=0,this.mag=0,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this;var W=parseFloat(X[0]);if(W===0)return this.sign=0,this.layer=0,this.mag=0,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this;var he=parseFloat(X[X.length-1]);if(re>=2){var pe=parseFloat(X[X.length-2]);isFinite(pe)&&(he*=Math.sign(pe),he+=Ks(pe))}if(!isFinite(W))this.sign=X[0]==="-"?-1:1,this.layer=re,this.mag=he;else if(re===1)this.sign=Math.sign(W),this.layer=1,this.mag=he+Math.log10(Math.abs(W));else if(this.sign=Math.sign(W),this.layer=re,re===2){var ge=e.mul(Q(1,2,he),C(W));return this.sign=ge.sign,this.layer=ge.layer,this.mag=ge.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}else this.mag=he;return this.normalize(),e.fromStringCache.maxSize>=1&&e.fromStringCache.set(r,e.fromDecimal(this)),this}},{key:"fromValue",value:function(t){return t instanceof e?this.fromDecimal(t):typeof t=="number"?this.fromNumber(t):typeof t=="string"?this.fromString(t):(this.sign=0,this.layer=0,this.mag=0,this)}},{key:"toNumber",value:function(){return this.mag===Number.POSITIVE_INFINITY&&this.layer===Number.POSITIVE_INFINITY&&this.sign===1?Number.POSITIVE_INFINITY:this.mag===Number.POSITIVE_INFINITY&&this.layer===Number.POSITIVE_INFINITY&&this.sign===-1?Number.NEGATIVE_INFINITY:Number.isFinite(this.layer)?this.layer===0?this.sign*this.mag:this.layer===1?this.sign*Math.pow(10,this.mag):this.mag>0?this.sign>0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:0:Number.NaN}},{key:"mantissaWithDecimalPlaces",value:function(t){return isNaN(this.m)?Number.NaN:this.m===0?0:It(this.m,t)}},{key:"magnitudeWithDecimalPlaces",value:function(t){return isNaN(this.mag)?Number.NaN:this.mag===0?0:It(this.mag,t)}},{key:"toString",value:function(){return isNaN(this.layer)||isNaN(this.sign)||isNaN(this.mag)?"NaN":this.mag===Number.POSITIVE_INFINITY||this.layer===Number.POSITIVE_INFINITY?this.sign===1?"Infinity":"-Infinity":this.layer===0?this.mag<1e21&&this.mag>1e-7||this.mag===0?(this.sign*this.mag).toString():this.m+"e"+this.e:this.layer===1?this.m+"e"+this.e:this.layer<=ja?(this.sign===-1?"-":"")+"e".repeat(this.layer)+this.mag:(this.sign===-1?"-":"")+"(e^"+this.layer+")"+this.mag}},{key:"toExponential",value:function(t){return this.layer===0?(this.sign*this.mag).toExponential(t):this.toStringWithDecimalPlaces(t)}},{key:"toFixed",value:function(t){return this.layer===0?(this.sign*this.mag).toFixed(t):this.toStringWithDecimalPlaces(t)}},{key:"toPrecision",value:function(t){return this.e<=-7?this.toExponential(t-1):t>this.e?this.toFixed(t-this.exponent-1):this.toExponential(t-1)}},{key:"valueOf",value:function(){return this.toString()}},{key:"toJSON",value:function(){return this.toString()}},{key:"toStringWithDecimalPlaces",value:function(t){return this.layer===0?this.mag<1e21&&this.mag>1e-7||this.mag===0?(this.sign*this.mag).toFixed(t):It(this.m,t)+"e"+It(this.e,t):this.layer===1?It(this.m,t)+"e"+It(this.e,t):this.layer<=ja?(this.sign===-1?"-":"")+"e".repeat(this.layer)+It(this.mag,t):(this.sign===-1?"-":"")+"(e^"+this.layer+")"+It(this.mag,t)}},{key:"abs",value:function(){return te(this.sign===0?0:1,this.layer,this.mag)}},{key:"neg",value:function(){return te(-this.sign,this.layer,this.mag)}},{key:"negate",value:function(){return this.neg()}},{key:"negated",value:function(){return this.neg()}},{key:"sgn",value:function(){return this.sign}},{key:"round",value:function(){return this.mag<0?te(0,0,0):this.layer===0?Q(this.sign,0,Math.round(this.mag)):new e(this)}},{key:"floor",value:function(){return this.mag<0?this.sign===-1?te(-1,0,1):te(0,0,0):this.sign===-1?this.neg().ceil().neg():this.layer===0?Q(this.sign,0,Math.floor(this.mag)):new e(this)}},{key:"ceil",value:function(){return this.mag<0?this.sign===1?te(1,0,1):te(0,0,0):this.sign===-1?this.neg().floor().neg():this.layer===0?Q(this.sign,0,Math.ceil(this.mag)):new e(this)}},{key:"trunc",value:function(){return this.mag<0?te(0,0,0):this.layer===0?Q(this.sign,0,Math.trunc(this.mag)):new e(this)}},{key:"add",value:function(t){var s=C(t);if(this.eq(e.dInf)&&s.eq(e.dNegInf)||this.eq(e.dNegInf)&&s.eq(e.dInf))return new e(e.dNaN);if(!Number.isFinite(this.layer))return new e(this);if(!Number.isFinite(s.layer))return new e(s);if(this.sign===0)return new e(s);if(s.sign===0)return new e(this);if(this.sign===-s.sign&&this.layer===s.layer&&this.mag===s.mag)return te(0,0,0);var r,a;if(this.layer>=2||s.layer>=2)return this.maxabs(s);if(e.cmpabs(this,s)>0?(r=new e(this),a=new e(s)):(r=new e(s),a=new e(this)),r.layer===0&&a.layer===0)return e.fromNumber(r.sign*r.mag+a.sign*a.mag);var i=r.layer*Math.sign(r.mag),o=a.layer*Math.sign(a.mag);if(i-o>=2)return r;if(i===0&&o===-1){if(Math.abs(a.mag-Math.log10(r.mag))>Ys)return r;var u=Math.pow(10,Math.log10(r.mag)-a.mag),l=a.sign+r.sign*u;return Q(Math.sign(l),1,a.mag+Math.log10(Math.abs(l)))}if(i===1&&o===0){if(Math.abs(r.mag-Math.log10(a.mag))>Ys)return r;var d=Math.pow(10,r.mag-Math.log10(a.mag)),c=a.sign+r.sign*d;return Q(Math.sign(c),1,Math.log10(a.mag)+Math.log10(Math.abs(c)))}if(Math.abs(r.mag-a.mag)>Ys)return r;var f=Math.pow(10,r.mag-a.mag),b=a.sign+r.sign*f;return Q(Math.sign(b),1,a.mag+Math.log10(Math.abs(b)))}},{key:"plus",value:function(t){return this.add(t)}},{key:"sub",value:function(t){return this.add(C(t).neg())}},{key:"subtract",value:function(t){return this.sub(t)}},{key:"minus",value:function(t){return this.sub(t)}},{key:"mul",value:function(t){var s=C(t);if(this.eq(e.dInf)&&s.eq(e.dNegInf)||this.eq(e.dNegInf)&&s.eq(e.dInf))return new e(e.dNegInf);if(this.mag==Number.POSITIVE_INFINITY&&s.eq(e.dZero)||this.eq(e.dZero)&&this.mag==Number.POSITIVE_INFINITY)return new e(e.dNaN);if(this.eq(e.dNegInf)&&s.eq(e.dNegInf))return new e(e.dInf);if(!Number.isFinite(this.layer))return new e(this);if(!Number.isFinite(s.layer))return new e(s);if(this.sign===0||s.sign===0)return te(0,0,0);if(this.layer===s.layer&&this.mag===-s.mag)return te(this.sign*s.sign,0,1);var r,a;if(this.layer>s.layer||this.layer==s.layer&&Math.abs(this.mag)>Math.abs(s.mag)?(r=new e(this),a=new e(s)):(r=new e(s),a=new e(this)),r.layer===0&&a.layer===0)return e.fromNumber(r.sign*a.sign*r.mag*a.mag);if(r.layer>=3||r.layer-a.layer>=2)return Q(r.sign*a.sign,r.layer,r.mag);if(r.layer===1&&a.layer===0)return Q(r.sign*a.sign,1,r.mag+Math.log10(a.mag));if(r.layer===1&&a.layer===1)return Q(r.sign*a.sign,1,r.mag+a.mag);if(r.layer===2&&a.layer===1){var i=Q(Math.sign(r.mag),r.layer-1,Math.abs(r.mag)).add(Q(Math.sign(a.mag),a.layer-1,Math.abs(a.mag)));return Q(r.sign*a.sign,i.layer+1,i.sign*i.mag)}if(r.layer===2&&a.layer===2){var o=Q(Math.sign(r.mag),r.layer-1,Math.abs(r.mag)).add(Q(Math.sign(a.mag),a.layer-1,Math.abs(a.mag)));return Q(r.sign*a.sign,o.layer+1,o.sign*o.mag)}throw Error("Bad arguments to mul: "+this+", "+t)}},{key:"multiply",value:function(t){return this.mul(t)}},{key:"times",value:function(t){return this.mul(t)}},{key:"div",value:function(t){var s=C(t);return this.mul(s.recip())}},{key:"divide",value:function(t){return this.div(t)}},{key:"divideBy",value:function(t){return this.div(t)}},{key:"dividedBy",value:function(t){return this.div(t)}},{key:"recip",value:function(){return this.mag===0?new e(e.dNaN):this.mag===Number.POSITIVE_INFINITY?te(0,0,0):this.layer===0?Q(this.sign,0,1/this.mag):Q(this.sign,this.layer,-this.mag)}},{key:"reciprocal",value:function(){return this.recip()}},{key:"reciprocate",value:function(){return this.recip()}},{key:"mod",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=C(t),a=r.abs();if(this.eq(e.dZero)||a.eq(e.dZero))return te(0,0,0);if(s){var i=this.abs().mod(a);return this.sign==-1!=(r.sign==-1)&&(i=r.abs().sub(i)),i.mul(r.sign)}var o=this.toNumber(),u=a.toNumber();return isFinite(o)&&isFinite(u)&&o!=0&&u!=0?new e(o%u):this.sub(a).eq(this)?te(0,0,0):a.sub(this).eq(a)?new e(this):this.sign==-1?this.abs().mod(a).neg():this.sub(this.div(a).floor().mul(a))}},{key:"modulo",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.mod(t,s)}},{key:"modular",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.mod(t,s)}},{key:"cmp",value:function(t){var s=C(t);return this.sign>s.sign?1:this.sign<s.sign?-1:this.sign*this.cmpabs(t)}},{key:"cmpabs",value:function(t){var s=C(t),r=this.mag>0?this.layer:-this.layer,a=s.mag>0?s.layer:-s.layer;return r>a?1:r<a?-1:this.mag>s.mag?1:this.mag<s.mag?-1:0}},{key:"compare",value:function(t){return this.cmp(t)}},{key:"isNan",value:function(){return isNaN(this.sign)||isNaN(this.layer)||isNaN(this.mag)}},{key:"isFinite",value:(function(n){function t(){return n.apply(this,arguments)}return t.toString=function(){return n.toString()},t})(function(){return isFinite(this.sign)&&isFinite(this.layer)&&isFinite(this.mag)})},{key:"eq",value:function(t){var s=C(t);return this.sign===s.sign&&this.layer===s.layer&&this.mag===s.mag}},{key:"equals",value:function(t){return this.eq(t)}},{key:"neq",value:function(t){return!this.eq(t)}},{key:"notEquals",value:function(t){return this.neq(t)}},{key:"lt",value:function(t){return this.cmp(t)===-1}},{key:"lte",value:function(t){return!this.gt(t)}},{key:"gt",value:function(t){return this.cmp(t)===1}},{key:"gte",value:function(t){return!this.lt(t)}},{key:"max",value:function(t){var s=C(t);return this.lt(s)?new e(s):new e(this)}},{key:"min",value:function(t){var s=C(t);return this.gt(s)?new e(s):new e(this)}},{key:"maxabs",value:function(t){var s=C(t);return this.cmpabs(s)<0?new e(s):new e(this)}},{key:"minabs",value:function(t){var s=C(t);return this.cmpabs(s)>0?new e(s):new e(this)}},{key:"clamp",value:function(t,s){return this.max(t).min(s)}},{key:"clampMin",value:function(t){return this.max(t)}},{key:"clampMax",value:function(t){return this.min(t)}},{key:"cmp_tolerance",value:function(t,s){var r=C(t);return this.eq_tolerance(r,s)?0:this.cmp(r)}},{key:"compare_tolerance",value:function(t,s){return this.cmp_tolerance(t,s)}},{key:"eq_tolerance",value:function(t,s){var r=C(t);if(s==null&&(s=1e-7),this.sign!==r.sign||Math.abs(this.layer-r.layer)>1)return!1;var a=this.mag,i=r.mag;return this.layer>r.layer&&(i=Ks(i)),this.layer<r.layer&&(a=Ks(a)),Math.abs(a-i)<=s*Math.max(Math.abs(a),Math.abs(i))}},{key:"equals_tolerance",value:function(t,s){return this.eq_tolerance(t,s)}},{key:"neq_tolerance",value:function(t,s){return!this.eq_tolerance(t,s)}},{key:"notEquals_tolerance",value:function(t,s){return this.neq_tolerance(t,s)}},{key:"lt_tolerance",value:function(t,s){var r=C(t);return!this.eq_tolerance(r,s)&&this.lt(r)}},{key:"lte_tolerance",value:function(t,s){var r=C(t);return this.eq_tolerance(r,s)||this.lt(r)}},{key:"gt_tolerance",value:function(t,s){var r=C(t);return!this.eq_tolerance(r,s)&&this.gt(r)}},{key:"gte_tolerance",value:function(t,s){var r=C(t);return this.eq_tolerance(r,s)||this.gt(r)}},{key:"pLog10",value:function(){return this.lt(e.dZero)?te(0,0,0):this.log10()}},{key:"absLog10",value:function(){return this.sign===0?new e(e.dNaN):this.layer>0?Q(Math.sign(this.mag),this.layer-1,Math.abs(this.mag)):Q(1,0,Math.log10(this.mag))}},{key:"log10",value:function(){return this.sign<=0?new e(e.dNaN):this.layer>0?Q(Math.sign(this.mag),this.layer-1,Math.abs(this.mag)):Q(this.sign,0,Math.log10(this.mag))}},{key:"log",value:function(t){return t=C(t),this.sign<=0?new e(e.dNaN):t.sign<=0?new e(e.dNaN):t.sign===1&&t.layer===0&&t.mag===1?new e(e.dNaN):this.layer===0&&t.layer===0?Q(this.sign,0,Math.log(this.mag)/Math.log(t.mag)):e.div(this.log10(),t.log10())}},{key:"log2",value:function(){return this.sign<=0?new e(e.dNaN):this.layer===0?Q(this.sign,0,Math.log2(this.mag)):this.layer===1?Q(Math.sign(this.mag),0,Math.abs(this.mag)*3.321928094887362):this.layer===2?Q(Math.sign(this.mag),1,Math.abs(this.mag)+.5213902276543247):Q(Math.sign(this.mag),this.layer-1,Math.abs(this.mag))}},{key:"ln",value:function(){return this.sign<=0?new e(e.dNaN):this.layer===0?Q(this.sign,0,Math.log(this.mag)):this.layer===1?Q(Math.sign(this.mag),0,Math.abs(this.mag)*2.302585092994046):this.layer===2?Q(Math.sign(this.mag),1,Math.abs(this.mag)+.36221568869946325):Q(Math.sign(this.mag),this.layer-1,Math.abs(this.mag))}},{key:"logarithm",value:function(t){return this.log(t)}},{key:"pow",value:function(t){var s=C(t),r=new e(this),a=new e(s);if(r.sign===0)return a.eq(0)?te(1,0,1):r;if(r.sign===1&&r.layer===0&&r.mag===1)return r;if(a.sign===0)return te(1,0,1);if(a.sign===1&&a.layer===0&&a.mag===1)return r;var i=r.absLog10().mul(a).pow10();return this.sign===-1?Math.abs(a.toNumber()%2)%2===1?i.neg():Math.abs(a.toNumber()%2)%2===0?i:new e(e.dNaN):i}},{key:"pow10",value:function(){if(this.eq(e.dInf))return new e(e.dInf);if(this.eq(e.dNegInf))return te(0,0,0);if(!Number.isFinite(this.layer)||!Number.isFinite(this.mag))return new e(e.dNaN);var t=new e(this);if(t.layer===0){var s=Math.pow(10,t.sign*t.mag);if(Number.isFinite(s)&&Math.abs(s)>=.1)return Q(1,0,s);if(t.sign===0)return te(1,0,1);t=te(t.sign,t.layer+1,Math.log10(t.mag))}return t.sign>0&&t.mag>=0?Q(t.sign,t.layer+1,t.mag):t.sign<0&&t.mag>=0?Q(-t.sign,t.layer+1,-t.mag):te(1,0,1)}},{key:"pow_base",value:function(t){return C(t).pow(this)}},{key:"root",value:function(t){var s=C(t);return this.lt(0)&&s.mod(2,!0).eq(1)?this.neg().root(s).neg():this.pow(s.recip())}},{key:"factorial",value:function(){return this.mag<0?this.add(1).gamma():this.layer===0?this.add(1).gamma():this.layer===1?e.exp(e.mul(this,e.ln(this).sub(1))):e.exp(this)}},{key:"gamma",value:function(){if(this.mag<0)return this.recip();if(this.layer===0){if(this.lt(te(1,0,24)))return e.fromNumber(bc(this.sign*this.mag));var t=this.mag-1,s=.9189385332046727;s=s+(t+.5)*Math.log(t),s=s-t;var r=t*t,a=t,i=12*a,o=1/i,u=s+o;if(u===s||(s=u,a=a*r,i=360*a,o=1/i,u=s-o,u===s))return e.exp(s);s=u,a=a*r,i=1260*a;var l=1/i;return s=s+l,a=a*r,i=1680*a,l=1/i,s=s-l,e.exp(s)}else return this.layer===1?e.exp(e.mul(this,e.ln(this).sub(1))):e.exp(this)}},{key:"lngamma",value:function(){return this.gamma().ln()}},{key:"exp",value:function(){return this.mag<0?te(1,0,1):this.layer===0&&this.mag<=709.7?e.fromNumber(Math.exp(this.sign*this.mag)):this.layer===0?Q(1,1,this.sign*Math.log10(Math.E)*this.mag):this.layer===1?Q(1,2,this.sign*(Math.log10(.4342944819032518)+this.mag)):Q(1,this.layer+1,this.sign*this.mag)}},{key:"sqr",value:function(){return this.pow(2)}},{key:"sqrt",value:function(){if(this.layer===0)return e.fromNumber(Math.sqrt(this.sign*this.mag));if(this.layer===1)return Q(1,2,Math.log10(this.mag)-.3010299956639812);var t=e.div(te(this.sign,this.layer-1,this.mag),te(1,0,2));return t.layer+=1,t.normalize(),t}},{key:"cube",value:function(){return this.pow(3)}},{key:"cbrt",value:function(){return this.lt(0)?this.neg().pow(1/3).neg():this.pow(1/3)}},{key:"tetrate",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:te(1,0,1),r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(t===1)return e.pow(this,s);if(t===0)return new e(s);if(this.eq(e.dOne))return te(1,0,1);if(this.eq(-1))return e.pow(this,s);if(t===Number.POSITIVE_INFINITY){var a=this.toNumber();if(a<=1.444667861009766&&a>=.06598803584531254){var i=e.ln(this).neg(),o=i.lambertw().div(i);if(a<1)return o;var u=i.lambertw(!1).div(i);return a>1.444667861009099&&(o=u=e.fromNumber(Math.E)),s=C(s),s.eq(u)?u:s.lt(u)?o:new e(e.dInf)}else return a>1.444667861009766?new e(e.dInf):new e(e.dNaN)}if(this.eq(e.dZero)){var l=Math.abs((t+1)%2);return l>1&&(l=2-l),e.fromNumber(l)}if(t<0)return e.iteratedlog(s,this,-t,r);s=new e(s);var d=t;t=Math.trunc(t);var c=d-t;if(this.gt(e.dZero)&&(this.lt(1)||this.lte(1.444667861009766)&&s.lte(e.ln(this).neg().lambertw(!1).div(e.ln(this).neg())))&&(d>1e4||!r)){var f=Math.min(1e4,t);s.eq(e.dOne)?s=this.pow(c):this.lt(1)?s=s.pow(1-c).mul(this.pow(s).pow(c)):s=s.layeradd(c,this);for(var b=0;b<f;++b){var y=s;if(s=this.pow(s),y.eq(s))return s}return d>1e4&&Math.ceil(d)%2==1?this.pow(s):s}c!==0&&(s.eq(e.dOne)?this.gt(10)||r?s=this.pow(c):(s=e.fromNumber(e.tetrate_critical(this.toNumber(),c)),this.lt(2)&&(s=s.sub(1).mul(this.minus(1)).plus(1))):this.eq(10)?s=s.layeradd10(c,r):this.lt(1)?s=s.pow(1-c).mul(this.pow(s).pow(c)):s=s.layeradd(c,this,r));for(var g=0;g<t;++g){if(s=this.pow(s),!isFinite(s.layer)||!isFinite(s.mag))return s.normalize();if(s.layer-this.layer>3)return te(s.sign,s.layer+(t-g-1),s.mag);if(g>1e4)return s}return s}},{key:"iteratedexp",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:te(1,0,1),r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return this.tetrate(t,s,r)}},{key:"iteratedlog",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(s<0)return e.tetrate(t,-s,this,r);t=C(t);var a=e.fromDecimal(this),i=s;s=Math.trunc(s);var o=i-s;if(a.layer-t.layer>3){var u=Math.min(s,a.layer-t.layer-3);s-=u,a.layer-=u}for(var l=0;l<s;++l){if(a=a.log(t),!isFinite(a.layer)||!isFinite(a.mag))return a.normalize();if(l>1e4)return a}return o>0&&o<1&&(t.eq(10)?a=a.layeradd10(-o,r):a=a.layeradd(-o,t,r)),a}},{key:"slog",value:function(){for(var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,a=.001,i=!1,o=!1,u=this.slog_internal(t,r).toNumber(),l=1;l<s;++l){var d=new e(t).tetrate(u,e.dOne,r),c=d.gt(this);if(l>1&&o!=c&&(i=!0),o=c,i?a/=2:a*=2,a=Math.abs(a)*(c?-1:1),u+=a,a===0)break}return e.fromNumber(u)}},{key:"slog_internal",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(t=C(t),t.lte(e.dZero))return new e(e.dNaN);if(t.eq(e.dOne))return new e(e.dNaN);if(t.lt(e.dOne))return this.eq(e.dOne)?te(0,0,0):this.eq(e.dZero)?te(-1,0,1):new e(e.dNaN);if(this.mag<0||this.eq(e.dZero))return te(-1,0,1);if(t.lt(1.444667861009766)){var r=e.ln(t).neg(),a=r.lambertw().div(r);if(this.eq(a))return new e(e.dInf);if(this.gt(a))return new e(e.dNaN)}var i=0,o=e.fromDecimal(this);if(o.layer-t.layer>3){var u=o.layer-t.layer-3;i+=u,o.layer-=u}for(var l=0;l<100;++l)if(o.lt(e.dZero))o=e.pow(t,o),i-=1;else{if(o.lte(e.dOne))return s?e.fromNumber(i+o.toNumber()-1):e.fromNumber(i+e.slog_critical(t.toNumber(),o.toNumber()));i+=1,o=e.log(o,t)}return e.fromNumber(i)}},{key:"layeradd10",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t=e.fromValue_noAlloc(t).toNumber();var r=e.fromDecimal(this);if(t>=1){r.mag<0&&r.layer>0?(r.sign=0,r.mag=0,r.layer=0):r.sign===-1&&r.layer==0&&(r.sign=1,r.mag=-r.mag);var a=Math.trunc(t);t-=a,r.layer+=a}if(t<=-1){var i=Math.trunc(t);if(t-=i,r.layer+=i,r.layer<0)for(var o=0;o<100;++o){if(r.layer++,r.mag=Math.log10(r.mag),!isFinite(r.mag))return r.sign===0&&(r.sign=1),r.layer<0&&(r.layer=0),r.normalize();if(r.layer>=0)break}}for(;r.layer<0;)r.layer++,r.mag=Math.log10(r.mag);return r.sign===0&&(r.sign=1,r.mag===0&&r.layer>=1&&(r.layer-=1,r.mag=1)),r.normalize(),t!==0?r.layeradd(t,10,s):r}},{key:"layeradd",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,a=C(s);if(a.gt(1)&&a.lte(1.444667861009766)){var i=e.excess_slog(this,s,r),o=i[0].toNumber(),u=i[1],l=o+t,d=e.ln(s).neg(),c=d.lambertw().div(d),f=d.lambertw(!1).div(d),b=e.dOne;u==1?b=c.mul(f).sqrt():u==2&&(b=f.mul(2));var y=a.pow(b),g=Math.floor(l),w=l-g,p=b.pow(1-w).mul(y.pow(w));return e.tetrate(a,g,p,r)}var h=this.slog(s,100,r).toNumber(),x=h+t;return x>=0?e.tetrate(s,x,e.dOne,r):Number.isFinite(x)?x>=-1?e.log(e.tetrate(s,x+1,e.dOne,r),s):e.log(e.log(e.tetrate(s,x+2,e.dOne,r),s),s):new e(e.dNaN)}},{key:"lambertw",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this.lt(-.3678794411710499)?new e(e.dNaN):t?this.abs().lt("1e-300")?new e(this):this.mag<0?e.fromNumber(zs(this.toNumber())):this.layer===0?e.fromNumber(zs(this.sign*this.mag)):this.lt("eee15")?Ga(this):this.ln():this.sign===1?new e(e.dNaN):this.layer===0?e.fromNumber(zs(this.sign*this.mag,1e-10,!1)):this.layer==1?Ga(this,1e-10,!1):this.neg().recip().lambertw().neg()}},{key:"ssqrt",value:function(){return this.linear_sroot(2)}},{key:"linear_sroot",value:function(t){if(t==1)return this;if(this.eq(e.dInf))return new e(e.dInf);if(!this.isFinite())return new e(e.dNaN);if(t>0&&t<1)return this.root(t);if(t>-2&&t<-1)return e.fromNumber(t).add(2).pow(this.recip());if(t<=0)return new e(e.dNaN);if(t==Number.POSITIVE_INFINITY){var s=this.toNumber();return s<Math.E&&s>xc?this.pow(this.recip()):new e(e.dNaN)}if(this.eq(1))return te(1,0,1);if(this.lt(0))return new e(e.dNaN);if(this.lte("1ee-16"))return t%2==1?new e(this):new e(e.dNaN);if(this.gt(1)){var r=e.dTen;this.gte(e.tetrate(10,t,1,!0))&&(r=this.iteratedlog(10,t-1,!0)),t<=1&&(r=this.root(t));for(var a=e.dZero,i=r.layer,o=r.iteratedlog(10,i,!0),u=o,l=o.div(2),d=!0;d;)l=a.add(o).div(2),e.iteratedexp(10,i,l,!0).tetrate(t,1,!0).gt(this)?o=l:a=l,l.eq(u)?d=!1:u=l;return e.iteratedexp(10,i,l,!0)}else{for(var c=1,f=Q(1,10,1),b=Q(1,10,1),y=Q(1,10,1),g=Q(1,1,-16),w=e.dZero,p=Q(1,10,1),h=g.pow10().recip(),x=e.dZero,S=h,$=h,R=Math.ceil(t)%2==0,k=0,v=Q(1,10,1),I=!1,T=e.dZero,L=!1;c<4;){if(c==2){if(R)break;y=Q(1,10,1),g=f,c=3,p=Q(1,10,1),v=Q(1,10,1)}for(I=!1;g.neq(y);){if(T=g,g.pow10().recip().tetrate(t,1,!0).eq(1)&&g.pow10().recip().lt(.4))h=g.pow10().recip(),S=g.pow10().recip(),$=g.pow10().recip(),x=e.dZero,k=-1,c==3&&(v=g);else if(g.pow10().recip().tetrate(t,1,!0).eq(g.pow10().recip())&&!R&&g.pow10().recip().lt(.4))h=g.pow10().recip(),S=g.pow10().recip(),$=g.pow10().recip(),x=e.dZero,k=0;else if(g.pow10().recip().tetrate(t,1,!0).eq(g.pow10().recip().mul(2).tetrate(t,1,!0)))h=g.pow10().recip(),S=e.dZero,$=h.mul(2),x=h,R?k=-1:k=0;else{for(w=g.mul(12e-17),h=g.pow10().recip(),S=g.add(w).pow10().recip(),x=h.sub(S),$=h.add(x);S.tetrate(t,1,!0).eq(h.tetrate(t,1,!0))||$.tetrate(t,1,!0).eq(h.tetrate(t,1,!0))||S.gte(h)||$.lte(h);)w=w.mul(2),S=g.add(w).pow10().recip(),x=h.sub(S),$=h.add(x);if((c==1&&$.tetrate(t,1,!0).gt(h.tetrate(t,1,!0))&&S.tetrate(t,1,!0).gt(h.tetrate(t,1,!0))||c==3&&$.tetrate(t,1,!0).lt(h.tetrate(t,1,!0))&&S.tetrate(t,1,!0).lt(h.tetrate(t,1,!0)))&&(v=g),$.tetrate(t,1,!0).lt(h.tetrate(t,1,!0)))k=-1;else if(R)k=1;else if(c==3&&g.gt_tolerance(f,1e-8))k=0;else{for(;S.tetrate(t,1,!0).eq_tolerance(h.tetrate(t,1,!0),1e-8)||$.tetrate(t,1,!0).eq_tolerance(h.tetrate(t,1,!0),1e-8)||S.gte(h)||$.lte(h);)w=w.mul(2),S=g.add(w).pow10().recip(),x=h.sub(S),$=h.add(x);$.tetrate(t,1,!0).sub(h.tetrate(t,1,!0)).lt(h.tetrate(t,1,!0).sub(S.tetrate(t,1,!0)))?k=0:k=1}}if(k==-1&&(L=!0),c==1&&k==1||c==3&&k!=0)if(y.eq(Q(1,10,1)))g=g.mul(2);else{var q=!1;if(I&&(k==1&&c==1||k==-1&&c==3)&&(q=!0),g=g.add(y).div(2),q)break}else if(y.eq(Q(1,10,1)))y=g,g=g.div(2);else{var j=!1;if(I&&(k==1&&c==1||k==-1&&c==3)&&(j=!0),y=y.sub(p),g=g.sub(p),j)break}if(y.sub(g).div(2).abs().gt(p.mul(1.5))&&(I=!0),p=y.sub(g).div(2).abs(),g.gt("1e18")||g.eq(T))break}if(g.gt("1e18")||!L||v==Q(1,10,1))break;c==1?f=v:c==3&&(b=v),c++}y=f,g=Q(1,1,-18);for(var H=g,_=e.dZero,J=!0;J;)if(y.eq(Q(1,10,1))?_=g.mul(2):_=y.add(g).div(2),e.pow(10,_).recip().tetrate(t,1,!0).gt(this)?g=_:y=_,_.eq(H)?J=!1:H=_,g.gt("1e18"))return new e(e.dNaN);if(_.eq_tolerance(f,1e-15)){if(b.eq(Q(1,10,1)))return new e(e.dNaN);for(y=Q(1,10,1),g=b,H=g,_=e.dZero,J=!0;J;)if(y.eq(Q(1,10,1))?_=g.mul(2):_=y.add(g).div(2),e.pow(10,_).recip().tetrate(t,1,!0).gt(this)?g=_:y=_,_.eq(H)?J=!1:H=_,g.gt("1e18"))return new e(e.dNaN);return _.pow10().recip()}else return _.pow10().recip()}}},{key:"pentate",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:te(1,0,1),r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;s=new e(s);var a=t;t=Math.floor(t);var i=a-t,o=e.dZero,u=e.dZero;if(i!==0)if(s.eq(e.dOne))++t,s=e.fromNumber(i);else return this.pentate(s.penta_log(this,void 0,r).plus(a).toNumber(),1,r);if(t>0)for(var l=0;l<t;){if(u=o,o=s,s=this.tetrate(s.toNumber(),e.dOne,r),++l,this.gt(0)&&this.lte(1)&&s.gt(0)&&s.lte(1))return this.tetrate(t-l,s,r);if(s.eq(o)||s.eq(u)&&l%2==t%2||!isFinite(s.layer)||!isFinite(s.mag))return s.normalize();if(l>1e4)return s}else for(var d=0;d<-t;++d){if(o=s,s=s.slog(this,void 0,r),s.eq(o)||!isFinite(s.layer)||!isFinite(s.mag))return s.normalize();if(d>100)return s}return s}},{key:"penta_log",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(t=new e(t),t.lte(1))return new e(e.dNaN);if(this.eq(1))return te(0,0,0);if(this.eq(e.dInf))return new e(e.dInf);var a=new e(1),i=0,o=1;if(this.lt(-1)){if(this.lte(-2))return new e(e.dNaN);var u=t.tetrate(this.toNumber(),1,r);if(this.eq(u))return new e(e.dNegInf);if(this.gt(u))return new e(e.dNaN)}if(this.gt(1)){for(;a.lt(this);)if(i++,a=e.tetrate(t,a.toNumber(),1,r),i>1e3)return new e(e.dNaN)}else for(;a.gt(this);)if(i--,a=e.slog(a,t,r),i>100)return new e(e.dNaN);for(var l=1;l<s;++l){var d=t.pentate(i,e.dOne,r);if(d.eq(this))break;var c=d.gt(this);if(o=Math.abs(o)*(c?-1:1),i+=o,o/=2,o===0)break}return e.fromNumber(i)}},{key:"linear_penta_root",value:function(t){return t==1?this:t<0?new e(e.dNaN):this.eq(e.dInf)?new e(e.dInf):this.isFinite()?t>0&&t<1?this.root(t):this.eq(1)?te(1,0,1):this.lt(0)?new e(e.dNaN):this.lt(1)?this.linear_sroot(t):e.increasingInverse(function(s){return e.pentate(s,t,1,!0)})(this):new e(e.dNaN)}},{key:"sin",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.sin(this.sign*this.mag)):te(0,0,0)}},{key:"cos",value:function(){return this.mag<0?te(1,0,1):this.layer===0?e.fromNumber(Math.cos(this.sign*this.mag)):te(0,0,0)}},{key:"tan",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.tan(this.sign*this.mag)):te(0,0,0)}},{key:"asin",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.asin(this.sign*this.mag)):new e(e.dNaN)}},{key:"acos",value:function(){return this.mag<0?e.fromNumber(Math.acos(this.toNumber())):this.layer===0?e.fromNumber(Math.acos(this.sign*this.mag)):new e(e.dNaN)}},{key:"atan",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.atan(this.sign*this.mag)):e.fromNumber(Math.atan(this.sign*(1/0)))}},{key:"sinh",value:function(){return this.exp().sub(this.negate().exp()).div(2)}},{key:"cosh",value:function(){return this.exp().add(this.negate().exp()).div(2)}},{key:"tanh",value:function(){return this.sinh().div(this.cosh())}},{key:"asinh",value:function(){return e.ln(this.add(this.sqr().add(1).sqrt()))}},{key:"acosh",value:function(){return e.ln(this.add(this.sqr().sub(1).sqrt()))}},{key:"atanh",value:function(){return this.abs().gte(1)?new e(e.dNaN):e.ln(this.add(1).div(e.fromNumber(1).sub(this))).div(2)}},{key:"ascensionPenalty",value:function(t){return t===0?new e(this):this.root(e.pow(10,t))}},{key:"egg",value:function(){return this.add(9)}},{key:"lessThanOrEqualTo",value:function(t){return this.cmp(t)<1}},{key:"lessThan",value:function(t){return this.cmp(t)<0}},{key:"greaterThanOrEqualTo",value:function(t){return this.cmp(t)>-1}},{key:"greaterThan",value:function(t){return this.cmp(t)>0}}],[{key:"fromComponents",value:function(t,s,r){return new e().fromComponents(t,s,r)}},{key:"fromComponents_noNormalize",value:function(t,s,r){return new e().fromComponents_noNormalize(t,s,r)}},{key:"fromMantissaExponent",value:function(t,s){return new e().fromMantissaExponent(t,s)}},{key:"fromMantissaExponent_noNormalize",value:function(t,s){return new e().fromMantissaExponent_noNormalize(t,s)}},{key:"fromDecimal",value:function(t){return new e().fromDecimal(t)}},{key:"fromNumber",value:function(t){return new e().fromNumber(t)}},{key:"fromString",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return new e().fromString(t,s)}},{key:"fromValue",value:function(t){return new e().fromValue(t)}},{key:"fromValue_noAlloc",value:function(t){if(t instanceof e)return t;if(typeof t=="string"){var s=e.fromStringCache.get(t);return s!==void 0?s:e.fromString(t)}else return typeof t=="number"?e.fromNumber(t):te(0,0,0)}},{key:"abs",value:function(t){return C(t).abs()}},{key:"neg",value:function(t){return C(t).neg()}},{key:"negate",value:function(t){return C(t).neg()}},{key:"negated",value:function(t){return C(t).neg()}},{key:"sign",value:function(t){return C(t).sign}},{key:"sgn",value:function(t){return C(t).sign}},{key:"round",value:function(t){return C(t).round()}},{key:"floor",value:function(t){return C(t).floor()}},{key:"ceil",value:function(t){return C(t).ceil()}},{key:"trunc",value:function(t){return C(t).trunc()}},{key:"add",value:function(t,s){return C(t).add(s)}},{key:"plus",value:function(t,s){return C(t).add(s)}},{key:"sub",value:function(t,s){return C(t).sub(s)}},{key:"subtract",value:function(t,s){return C(t).sub(s)}},{key:"minus",value:function(t,s){return C(t).sub(s)}},{key:"mul",value:function(t,s){return C(t).mul(s)}},{key:"multiply",value:function(t,s){return C(t).mul(s)}},{key:"times",value:function(t,s){return C(t).mul(s)}},{key:"div",value:function(t,s){return C(t).div(s)}},{key:"divide",value:function(t,s){return C(t).div(s)}},{key:"recip",value:function(t){return C(t).recip()}},{key:"reciprocal",value:function(t){return C(t).recip()}},{key:"reciprocate",value:function(t){return C(t).reciprocate()}},{key:"mod",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return C(t).mod(s,r)}},{key:"modulo",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return C(t).modulo(s,r)}},{key:"modular",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return C(t).modular(s,r)}},{key:"cmp",value:function(t,s){return C(t).cmp(s)}},{key:"cmpabs",value:function(t,s){return C(t).cmpabs(s)}},{key:"compare",value:function(t,s){return C(t).cmp(s)}},{key:"isNaN",value:(function(n){function t(s){return n.apply(this,arguments)}return t.toString=function(){return n.toString()},t})(function(n){return n=C(n),isNaN(n.sign)||isNaN(n.layer)||isNaN(n.mag)})},{key:"isFinite",value:(function(n){function t(s){return n.apply(this,arguments)}return t.toString=function(){return n.toString()},t})(function(n){return n=C(n),isFinite(n.sign)&&isFinite(n.layer)&&isFinite(n.mag)})},{key:"eq",value:function(t,s){return C(t).eq(s)}},{key:"equals",value:function(t,s){return C(t).eq(s)}},{key:"neq",value:function(t,s){return C(t).neq(s)}},{key:"notEquals",value:function(t,s){return C(t).notEquals(s)}},{key:"lt",value:function(t,s){return C(t).lt(s)}},{key:"lte",value:function(t,s){return C(t).lte(s)}},{key:"gt",value:function(t,s){return C(t).gt(s)}},{key:"gte",value:function(t,s){return C(t).gte(s)}},{key:"max",value:function(t,s){return C(t).max(s)}},{key:"min",value:function(t,s){return C(t).min(s)}},{key:"minabs",value:function(t,s){return C(t).minabs(s)}},{key:"maxabs",value:function(t,s){return C(t).maxabs(s)}},{key:"clamp",value:function(t,s,r){return C(t).clamp(s,r)}},{key:"clampMin",value:function(t,s){return C(t).clampMin(s)}},{key:"clampMax",value:function(t,s){return C(t).clampMax(s)}},{key:"cmp_tolerance",value:function(t,s,r){return C(t).cmp_tolerance(s,r)}},{key:"compare_tolerance",value:function(t,s,r){return C(t).cmp_tolerance(s,r)}},{key:"eq_tolerance",value:function(t,s,r){return C(t).eq_tolerance(s,r)}},{key:"equals_tolerance",value:function(t,s,r){return C(t).eq_tolerance(s,r)}},{key:"neq_tolerance",value:function(t,s,r){return C(t).neq_tolerance(s,r)}},{key:"notEquals_tolerance",value:function(t,s,r){return C(t).notEquals_tolerance(s,r)}},{key:"lt_tolerance",value:function(t,s,r){return C(t).lt_tolerance(s,r)}},{key:"lte_tolerance",value:function(t,s,r){return C(t).lte_tolerance(s,r)}},{key:"gt_tolerance",value:function(t,s,r){return C(t).gt_tolerance(s,r)}},{key:"gte_tolerance",value:function(t,s,r){return C(t).gte_tolerance(s,r)}},{key:"pLog10",value:function(t){return C(t).pLog10()}},{key:"absLog10",value:function(t){return C(t).absLog10()}},{key:"log10",value:function(t){return C(t).log10()}},{key:"log",value:function(t,s){return C(t).log(s)}},{key:"log2",value:function(t){return C(t).log2()}},{key:"ln",value:function(t){return C(t).ln()}},{key:"logarithm",value:function(t,s){return C(t).logarithm(s)}},{key:"pow",value:function(t,s){return C(t).pow(s)}},{key:"pow10",value:function(t){return C(t).pow10()}},{key:"root",value:function(t,s){return C(t).root(s)}},{key:"factorial",value:function(t,s){return C(t).factorial()}},{key:"gamma",value:function(t,s){return C(t).gamma()}},{key:"lngamma",value:function(t,s){return C(t).lngamma()}},{key:"exp",value:function(t){return C(t).exp()}},{key:"sqr",value:function(t){return C(t).sqr()}},{key:"sqrt",value:function(t){return C(t).sqrt()}},{key:"cube",value:function(t){return C(t).cube()}},{key:"cbrt",value:function(t){return C(t).cbrt()}},{key:"tetrate",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:te(1,0,1),a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return C(t).tetrate(s,r,a)}},{key:"iteratedexp",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:te(1,0,1),a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return C(t).iteratedexp(s,r,a)}},{key:"iteratedlog",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return C(t).iteratedlog(s,r,a)}},{key:"layeradd10",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return C(t).layeradd10(s,r)}},{key:"layeradd",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:10,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return C(t).layeradd(s,r,a)}},{key:"slog",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return C(t).slog(s,100,r)}},{key:"lambertw",value:function(t,s){return C(t).lambertw(s)}},{key:"ssqrt",value:function(t){return C(t).ssqrt()}},{key:"linear_sroot",value:function(t,s){return C(t).linear_sroot(s)}},{key:"pentate",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:te(1,0,1),a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return C(t).pentate(s,r,a)}},{key:"penta_log",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return C(t).penta_log(s,100,r)}},{key:"linear_penta_root",value:function(t,s){return C(t).linear_penta_root(s)}},{key:"sin",value:function(t){return C(t).sin()}},{key:"cos",value:function(t){return C(t).cos()}},{key:"tan",value:function(t){return C(t).tan()}},{key:"asin",value:function(t){return C(t).asin()}},{key:"acos",value:function(t){return C(t).acos()}},{key:"atan",value:function(t){return C(t).atan()}},{key:"sinh",value:function(t){return C(t).sinh()}},{key:"cosh",value:function(t){return C(t).cosh()}},{key:"tanh",value:function(t){return C(t).tanh()}},{key:"asinh",value:function(t){return C(t).asinh()}},{key:"acosh",value:function(t){return C(t).acosh()}},{key:"atanh",value:function(t){return C(t).atanh()}},{key:"affordGeometricSeries",value:function(t,s,r,a){return this.affordGeometricSeries_core(C(t),C(s),C(r),a)}},{key:"sumGeometricSeries",value:function(t,s,r,a){return this.sumGeometricSeries_core(t,C(s),C(r),a)}},{key:"affordArithmeticSeries",value:function(t,s,r,a){return this.affordArithmeticSeries_core(C(t),C(s),C(r),C(a))}},{key:"sumArithmeticSeries",value:function(t,s,r,a){return this.sumArithmeticSeries_core(C(t),C(s),C(r),C(a))}},{key:"efficiencyOfPurchase",value:function(t,s,r){return this.efficiencyOfPurchase_core(C(t),C(s),C(r))}},{key:"randomDecimalForTesting",value:function(t){if(Math.random()*20<1)return te(0,0,0);var s=Math.random()>.5?1:-1;if(Math.random()*20<1)return te(s,0,1);var r=Math.floor(Math.random()*(t+1)),a=r===0?Math.random()*616-308:Math.random()*16;Math.random()>.9&&(a=Math.trunc(a));var i=Math.pow(10,a);return Math.random()>.9&&(i=Math.trunc(i)),Q(s,r,i)}},{key:"affordGeometricSeries_core",value:function(t,s,r,a){var i=s.mul(r.pow(a));return e.floor(t.div(i).mul(r.sub(1)).add(1).log10().div(r.log10()))}},{key:"sumGeometricSeries_core",value:function(t,s,r,a){return s.mul(r.pow(a)).mul(e.sub(1,r.pow(t))).div(e.sub(1,r))}},{key:"affordArithmeticSeries_core",value:function(t,s,r,a){var i=s.add(a.mul(r)),o=i.sub(r.div(2)),u=o.pow(2);return o.neg().add(u.add(r.mul(t).mul(2)).sqrt()).div(r).floor()}},{key:"sumArithmeticSeries_core",value:function(t,s,r,a){var i=s.add(a.mul(r));return t.div(2).mul(i.mul(2).plus(t.sub(1).mul(r)))}},{key:"efficiencyOfPurchase_core",value:function(t,s,r){return t.div(s).add(t.div(r))}},{key:"slog_critical",value:function(t,s){return t>10?s-1:e.critical_section(t,s,vc)}},{key:"tetrate_critical",value:function(t,s){return e.critical_section(t,s,hc)}},{key:"critical_section",value:function(t,s,r){s*=10,s<0&&(s=0),s>10&&(s=10),t<2&&(t=2),t>10&&(t=10);for(var a=0,i=0,o=0;o<Lt.length;++o)if(Lt[o]==t){a=r[o][Math.floor(s)],i=r[o][Math.ceil(s)];break}else if(Lt[o]<t&&Lt[o+1]>t){var u=(t-Lt[o])/(Lt[o+1]-Lt[o]);a=r[o][Math.floor(s)]*(1-u)+r[o+1][Math.floor(s)]*u,i=r[o][Math.ceil(s)]*(1-u)+r[o+1][Math.ceil(s)]*u;break}var l=s-Math.floor(s);return a<=0||i<=0?a*(1-l)+i*l:Math.pow(t,Math.log(a)/Math.log(t)*(1-l)+Math.log(i)/Math.log(t)*l)}},{key:"excess_slog",value:function(t,s){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;t=C(t),s=C(s);var a=s;if(s=s.toNumber(),s==1||s<=0)return[new e(e.dNaN),0];if(s>1.444667861009766)return[t.slog(s,100,r),0];var i=e.ln(s).neg(),o=i.lambertw().div(i),u=e.dInf;if(s>1&&(u=i.lambertw(!1).div(i)),s>1.444667861009099&&(o=u=e.fromNumber(Math.E)),t.lt(o))return[t.slog(s,100,r),0];if(t.eq(o))return[new e(e.dInf),0];if(t.eq(u))return[new e(e.dNegInf),2];if(t.gt(u)){var l=u.mul(2),d=a.pow(l),c=0;if(t.gte(l)&&t.lt(d))c=0;else if(t.gte(d)){var f=d;for(c=1;f.lt(t);)if(f=a.pow(f),c=c+1,f.layer>3){var b=Math.floor(t.layer-f.layer+1);f=a.iteratedexp(b,f,r),c=c+b}f.gt(t)&&(f=f.log(s),c=c-1)}else if(t.lt(l)){var y=l;for(c=0;y.gt(t);)y=y.log(s),c=c-1}for(var g=0,w=0,p=.5,h=l,x=e.dZero;p>1e-16;){if(w=g+p,h=l.pow(1-w).mul(d.pow(w)),x=e.iteratedexp(s,c,h),x.eq(t))return[new e(c+w),2];x.lt(t)&&(g+=p),p/=2}return x.neq_tolerance(t,1e-7)?[new e(e.dNaN),0]:[new e(c+g),2]}if(t.lt(u)&&t.gt(o)){var S=o.mul(u).sqrt(),$=a.pow(S),R=0;if(t.lte(S)&&t.gt($))R=0;else if(t.lte($)){var k=$;for(R=1;k.gt(t);)k=a.pow(k),R=R+1;k.lt(t)&&(k=k.log(s),R=R-1)}else if(t.gt(S)){var v=S;for(R=0;v.lt(t);)v=v.log(s),R=R-1}for(var I=0,T=0,L=.5,q=S,j=e.dZero;L>1e-16;){if(T=I+L,q=S.pow(1-T).mul($.pow(T)),j=e.iteratedexp(s,R,q),j.eq(t))return[new e(R+T),1];j.gt(t)&&(I+=L),L/=2}return j.neq_tolerance(t,1e-7)?[new e(e.dNaN),0]:[new e(R+I),1]}throw new Error("Unhandled behavior in excess_slog")}},{key:"increasingInverse",value:function(t){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:120,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:e.dLayerMax.neg(),i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:e.dLayerMax,o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:e.dLayerMax.neg(),u=arguments.length>6&&arguments[6]!==void 0?arguments[6]:e.dLayerMax;return function(l){if(l=new e(l),a=new e(a),i=new e(i),o=new e(o),u=new e(u),l.isNan()||i.lt(a)||l.lt(o)||l.gt(u))return new e(e.dNaN);var d=function(Z){return new e(Z)},c=!0;if(i.lt(0))c=!1;else if(a.gt(0))c=!0;else{var f=t(e.dZero);if(f.eq(l))return te(0,0,0);c=l.gt(f),s&&(c=!c)}var b=c,y;if(c){if(i.lt(_t))c=!0;else if(a.gt(_t))c=!1;else{var g=t(new e(_t));c=l.lt(g),s&&(c=!c)}if(c){y=!0;var w=e.pow(10,Ue).recip();if(i.lt(w))c=!1;else if(a.gt(w))c=!0;else{var p=t(new e(w));c=l.gt(p),s&&(c=!c)}if(c)d=function(Z){return e.pow(10,Z).recip()};else{var h=e.tetrate(10,Ue);if(i.lt(h))c=!1;else if(a.gt(h))c=!0;else{var x=t(new e(h));c=l.gt(x),s&&(c=!c)}c?d=function(Z){return e.tetrate(10,new e(Z).toNumber()).recip()}:d=function(Z){return new e(Z).gt(Math.log10(Number.MAX_VALUE))?e.dZero:e.tetrate(10,e.pow(10,Z).toNumber()).recip()}}}else{if(y=!1,i.lt(Ue))c=!0;else if(a.gt(Ue))c=!1;else{var S=t(new e(Ue));c=l.lt(S),s&&(c=!c)}if(c)d=function(Z){return new e(Z)};else{var $=e.pow(10,Ue);if(i.lt($))c=!0;else if(a.gt($))c=!1;else{var R=t(new e($));c=l.lt(R),s&&(c=!c)}if(c)d=function(Z){return e.pow(10,Z)};else{var k=e.tetrate(10,Ue);if(i.lt(k))c=!0;else if(a.gt(k))c=!1;else{var v=t(new e(k));c=l.lt(v),s&&(c=!c)}c?d=function(Z){return e.tetrate(10,new e(Z).toNumber())}:d=function(Z){return new e(Z).gt(Math.log10(Number.MAX_VALUE))?e.dInf:e.tetrate(10,e.pow(10,Z).toNumber())}}}}}else{if(y=!0,i.lt(-_t))c=!1;else if(a.gt(-_t))c=!0;else{var I=t(new e(-_t));c=l.gt(I),s&&(c=!c)}if(c){var T=e.pow(10,Ue).recip().neg();if(i.lt(T))c=!0;else if(a.gt(T))c=!1;else{var L=t(new e(T));c=l.lt(L),s&&(c=!c)}if(c)d=function(Z){return e.pow(10,Z).recip().neg()};else{var q=e.tetrate(10,Ue).neg();if(i.lt(q))c=!0;else if(a.gt(q))c=!1;else{var j=t(new e(q));c=l.lt(j),s&&(c=!c)}c?d=function(Z){return e.tetrate(10,new e(Z).toNumber()).recip().neg()}:d=function(Z){return new e(Z).gt(Math.log10(Number.MAX_VALUE))?e.dZero:e.tetrate(10,e.pow(10,Z).toNumber()).recip().neg()}}}else{if(y=!1,i.lt(-Ue))c=!1;else if(a.gt(-Ue))c=!0;else{var H=t(new e(-Ue));c=l.gt(H),s&&(c=!c)}if(c)d=function(Z){return e.neg(Z)};else{var _=e.pow(10,Ue).neg();if(i.lt(_))c=!1;else if(a.gt(_))c=!0;else{var J=t(new e(_));c=l.gt(J),s&&(c=!c)}if(c)d=function(Z){return e.pow(10,Z).neg()};else{var ee=e.tetrate(10,Ue).neg();if(i.lt(ee))c=!1;else if(a.gt(ee))c=!0;else{var X=t(new e(ee));c=l.gt(X),s&&(c=!c)}c?d=function(Z){return e.tetrate(10,new e(Z).toNumber()).neg()}:d=function(Z){return new e(Z).gt(Math.log10(Number.MAX_VALUE))?e.dNegInf:e.tetrate(10,e.pow(10,Z).toNumber()).neg()}}}}}for(var re=b!=y!=s,ce=re?function(ve,Z){return e.gt(ve,Z)}:function(ve,Z){return e.lt(ve,Z)},B=.001,se=!1,ae=!1,fe=1,me=e.dOne,G=0,W=!1,he=1;he<r;++he){W=!1,G=fe,me=d(fe),me.gt(i)&&(me=i,W=!0),me.lt(a)&&(me=a,W=!0);var pe=t(me);if(pe.eq(l)&&!W)break;var ge=ce(pe,l);if(he>1&&ae!=ge&&(se=!0),ae=ge,se?B/=2:B*=2,ge!=re&&me.eq(i)||ge==re&&me.eq(a))return new e(e.dNaN);if(B=Math.abs(B)*(ge?-1:1),fe+=B,B===0||G==fe)break}return d(fe)}}}]),e})();m.dZero=te(0,0,0);m.dOne=te(1,0,1);m.dNegOne=te(-1,0,1);m.dTwo=te(1,0,2);m.dTen=te(1,0,10);m.dNaN=te(Number.NaN,Number.NaN,Number.NaN);m.dInf=te(1,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);m.dNegInf=te(-1,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);m.dNumberMax=Q(1,0,Number.MAX_VALUE);m.dNumberMin=Q(1,0,Number.MIN_VALUE);m.dLayerSafeMax=Q(1,Number.MAX_SAFE_INTEGER,Ue-1);m.dLayerSafeMin=Q(1,Number.MAX_SAFE_INTEGER,-8999999999999999);m.dLayerMax=Q(1,Number.MAX_VALUE,Ue-1);m.dLayerMin=Q(1,Number.MAX_VALUE,-8999999999999999);m.fromStringCache=new lc(pc);C=m.fromValue_noAlloc;Q=m.fromComponents;te=m.fromComponents_noNormalize;m.fromMantissaExponent;m.fromMantissaExponent_noNormalize;const O=e=>`/evercraft2/${e.replace(/^\//,"")}`,$e={1:{tier:1,name:"T1 Mana Gem",icon:O("icons/t1 gem.png"),effect:{type:"flat",value:new m(.1)},recipe:[{type:"mana",amount:new m(0)}],craftTime:1,visibleByDefault:!0},2:{tier:2,name:"T2 Mana Gem",icon:O("icons/t2 gem.png"),effect:{type:"multiplier",value:new m(2)},recipe:[{type:"gem",tier:1,amount:new m(10)}],craftTime:2,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:1,amount:100}},3:{tier:3,name:"T3 Mana Gem",icon:O("icons/t3 gem.png"),effect:{type:"multiplier",value:new m(2)},recipe:[{type:"gem",tier:2,amount:new m(50)}],craftTime:4,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:2,amount:500}},4:{tier:4,name:"T4 Mana Gem",icon:O("icons/t4 gem.png"),effect:{type:"multiplier",value:new m(3)},recipe:[{type:"gem",tier:3,amount:new m(200)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:3,amount:2e3}},5:{tier:5,name:"T5 Mana Gem",icon:O("icons/t5 gem.png"),effect:{type:"multiplier",value:new m(4)},recipe:[{type:"gem",tier:4,amount:new m(500)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:4,amount:5e3}},6:{tier:6,name:"T6 Mana Gem",icon:O("icons/t6 gem.png"),effect:{type:"multiplier",value:new m(5)},recipe:[{type:"gem",tier:5,amount:new m(1e3)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:5,amount:1e4}},7:{tier:7,name:"T7 Mana Gem",icon:O("icons/t7 gem.png"),effect:{type:"multiplier",value:new m(10)},recipe:[{type:"gem",tier:6,amount:new m(2500)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:6,amount:25e3}},8:{tier:8,name:"T8 Mana Gem",icon:O("icons/t8 gem.png"),effect:{type:"multiplier",value:new m(20)},recipe:[{type:"gem",tier:7,amount:new m(1e4)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:7,amount:1e5}}},Ze=[1,2,3,4,5,6,7,8],un={1:{tier:1,name:"T1 Flask",icon:O("icons/t1 flask.png"),recipe:[{type:"gem",tier:1,amount:new m(10)}],craftTime:5},2:{tier:2,name:"T2 Flask",icon:O("icons/t2 flask.png"),recipe:[{type:"gem",tier:2,amount:new m(20)}],craftTime:10},3:{tier:3,name:"T3 Flask",icon:O("icons/t3 flask.png"),recipe:[{type:"gem",tier:3,amount:new m(30)}],craftTime:15},4:{tier:4,name:"T4 Flask",icon:O("icons/t4 flask.png"),recipe:[{type:"gem",tier:4,amount:new m(40)}],craftTime:20},5:{tier:5,name:"T5 Flask",icon:O("icons/t5 flask.png"),recipe:[{type:"gem",tier:5,amount:new m(50)}],craftTime:25},6:{tier:6,name:"T6 Flask",icon:O("icons/t6 flask.png"),recipe:[{type:"gem",tier:6,amount:new m(60)}],craftTime:30},7:{tier:7,name:"T7 Flask",icon:O("icons/t7 flask.png"),recipe:[{type:"gem",tier:7,amount:new m(70)}],craftTime:35},8:{tier:8,name:"T8 Flask",icon:O("icons/t8 flask.png"),recipe:[{type:"gem",tier:8,amount:new m(80)}],craftTime:40}},tt=[1,2,3,4,5,6,7,8],yc={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:2e4,sacrificeBatchSize:1,calculateSacrificeBonus:e=>{if(e<=0)return new m(1);const n=Math.min(e,2e4);return new m(1+Math.pow(n,.4)*.1)}},wc={t1_knight:{id:"t1_knight",name:"T1 Knight",icon:O("icons/t1 knight.png"),recipe:[{type:"gem",tier:1,amount:new m(100)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:1,strengthExponent:.8},t4_knight:{id:"t4_knight",name:"T4 Knight",icon:O("icons/t4 knight.png"),recipe:[{type:"gem",tier:4,amount:new m(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:4,amount:1e5},unitRole:"strength",strengthMultiplier:20,strengthExponent:.8},t7_knight:{id:"t7_knight",name:"T7 Knight",icon:O("icons/t7 knight.png"),recipe:[{type:"gem",tier:7,amount:new m(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:7,amount:1e6},unitRole:"strength",strengthMultiplier:400,strengthExponent:.8},t2_boat:{id:"t2_boat",name:"T2 Boat",icon:O("icons/t2 boat.png"),recipe:[{type:"gem",tier:2,amount:new m(500)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:2,amount:5e4},unitRole:"speed",strengthMultiplier:1,strengthExponent:.6},t5_boat:{id:"t5_boat",name:"T5 Boat",icon:O("icons/t5 boat.png"),recipe:[{type:"gem",tier:5,amount:new m(5e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:5,amount:5e5},unitRole:"speed",strengthMultiplier:5,strengthExponent:.6},t3_beacon:{id:"t3_beacon",name:"T3 Beacon",icon:O("icons/t3 beacon.png"),recipe:[{type:"gem",tier:3,amount:new m(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e5},unitRole:"taunt",strengthMultiplier:1,strengthExponent:.6},t6_beacon:{id:"t6_beacon",name:"T6 Beacon",icon:O("icons/t6 beacon.png"),recipe:[{type:"gem",tier:6,amount:new m(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:6,amount:1e6},unitRole:"taunt",strengthMultiplier:10,strengthExponent:.6}},Sc=["t1_knight","t2_boat","t3_beacon","t4_knight","t5_boat","t6_beacon","t7_knight"],us=1,Pi=.1,kc=5,$c=(e,n)=>1,Ic=[{id:"shard_1",name:"Shard 1",difficulty:5,duration:60,rewards:{artifactShards:1},icon:O("icons/forest patrol.png"),group:"Shards"},{id:"shard_2",name:"Shard 2",difficulty:1e3,duration:3600,rewards:{artifactShards:150},icon:O("icons/mountain pass.png"),group:"Shards",unlockRequirement:"shard_1"},{id:"nullstone_1",name:"Ancient Ruins",difficulty:5e4,duration:10800,rewards:{nullstone:1},icon:O("icons/ancient ruins.png"),group:"Nullstones",unlockRequirement:"shard_2"},{id:"shard_3",name:"Shard 3",difficulty:5e5,duration:21600,rewards:{artifactShards:1e5},icon:O("icons/wraith stronghold.png"),group:"Shards",unlockRequirement:"shard_2"},{id:"shard_4",name:"Shard 4",difficulty:1e8,duration:21600,rewards:{artifactShards:1e6},icon:O("icons/wraith stronghold.png"),group:"Shards",unlockRequirement:"shard_3"},{id:"heroic_shard_affinity",name:"Shard Affinity",duration:1800,rewards:{},icon:O("icons/artifact shard.png"),group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"shard_drops",rewardScaling:1.1}},{id:"heroic_prime_mastery",name:"Prime Realm Mastery",duration:1800,rewards:{},icon:O("icons/r0.png"),group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm1_output",rewardScaling:1.1}},{id:"heroic_war_mastery",name:"Realm of War Mastery",duration:1800,rewards:{},icon:O("icons/portal.png"),group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm2_output",rewardScaling:1.1}}],dt=["t1_ring","t2_ring","t3_ring","t4_ring","t5_ring","t6_ring","t7_ring","t8_ring","combat_artifact","crafting_speed"],Ce={t1_ring:{id:"t1_ring",type:"ring",tier:1,name:"T1 Ring",icon:O("icons/t1 ring.png"),description:"Amplifies T1 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(10),gems:new m(0)}},t2_ring:{id:"t2_ring",type:"ring",tier:2,name:"T2 Ring",icon:O("icons/t2 ring.png"),description:"Amplifies T2 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(50),gems:new m(0)}},t3_ring:{id:"t3_ring",type:"ring",tier:3,name:"T3 Ring",icon:O("icons/t3 ring.png"),description:"Amplifies T3 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(500),gems:new m(0)}},t4_ring:{id:"t4_ring",type:"ring",tier:4,name:"T4 Ring",icon:O("icons/t4 ring.png"),description:"Amplifies T4 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(1e4),gems:new m(0)}},t5_ring:{id:"t5_ring",type:"ring",tier:5,name:"T5 Ring",icon:O("icons/t5 ring.png"),description:"Amplifies T5 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(1e5),gems:new m(0)}},t6_ring:{id:"t6_ring",type:"ring",tier:6,name:"T6 Ring",icon:O("icons/t6 ring.png"),description:"Amplifies T6 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(1e6),gems:new m(0)}},t7_ring:{id:"t7_ring",type:"ring",tier:7,name:"T7 Ring",icon:O("icons/t7 ring.png"),description:"Amplifies T7 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(1e7),gems:new m(0)}},t8_ring:{id:"t8_ring",type:"ring",tier:8,name:"T8 Ring",icon:O("icons/t8 ring.png"),description:"Amplifies T8 gem production (x1.3 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new m(1e8),gems:new m(0)}},combat_artifact:{id:"combat_artifact",type:"combat",tier:0,name:"Combat Artifact",icon:O("icons/combat artifact.png"),description:"Increases combat strength (x1.1 per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.1,costScaling:3,maxLevel:100,cost:{artifactShards:new m(50),gems:new m(0)}},crafting_speed:{id:"crafting_speed",type:"crafting_speed",tier:0,name:"Crafting Speed",icon:O("icons/crafting speed.png"),description:"Increases crafting speed (+5% per level)",baseInputMultiplier:new m(1),baseOutputMultiplier:new m(1),upgradeBonus:.05,costScaling:2.5,maxLevel:40,cost:{artifactShards:new m(200),gems:new m(0)}}};new m(1e15),new m(1e30),new m(1e60),new m(1e120),new m(1e240),new m("1e480"),new m("1e1000"),new m("1e2000");const Rc=Object.freeze(Object.defineProperty({__proto__:null,ALL_ARTIFACT_IDS:dt,ALL_MILITARY_UNIT_IDS:Sc,ARTIFACTS:Ce,COMPLETIONS_TO_UNLOCK:kc,EXPEDITIONS:Ic,MAX_SUCCESS_RATE:us,MILITARY_UNITS:wc,MIN_SUCCESS_RATE:Pi,MODIFIERS:yc,calculateQuestBonus:$c},Symbol.toStringTag,{value:"Module"})),Mc={manaModifier:e=>e.sqrt(),craftTimeMultiplier:4,flaskRecipeMultiplier:4,sacrificeCap:2e5,sacrificeBatchSize:10,calculateSacrificeBonus:e=>{if(e<=0)return new m(1);const n=Math.min(e,2e5);return new m(1+Math.pow(n,.5)*.02)}},Tc={t1_sword:{id:"t1_sword",name:"T1 Sword",icon:O("icons/t1 sword.png"),recipe:[{type:"gem",tier:1,amount:new m(1e3)}],craftTime:10,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:10,strengthExponent:.8},t2_sword:{id:"t2_sword",name:"T2 Sword",icon:O("icons/t2 sword.png"),recipe:[{type:"gem",tier:2,amount:new m(1e4)}],craftTime:15,unlockRequirement:{type:"lifetime_gems",tier:2,amount:1e5},unitRole:"strength",strengthMultiplier:100,strengthExponent:.8},t3_sword:{id:"t3_sword",name:"T3 Sword",icon:O("icons/t3 sword.png"),recipe:[{type:"gem",tier:3,amount:new m(1e5)}],craftTime:20,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e6},unitRole:"strength",strengthMultiplier:1e3,strengthExponent:.8},t4_sword:{id:"t4_sword",name:"T4 Sword",icon:O("icons/t4 sword.png"),recipe:[{type:"gem",tier:4,amount:new m(4e5)}],craftTime:30,unlockRequirement:{type:"lifetime_gems",tier:4,amount:4e6},unitRole:"strength",strengthMultiplier:1e4,strengthExponent:.8},t5_sword:{id:"t5_sword",name:"T5 Sword",icon:O("icons/t5 sword.png"),recipe:[{type:"gem",tier:5,amount:new m(16e5)}],craftTime:45,unlockRequirement:{type:"lifetime_gems",tier:5,amount:16e6},unitRole:"strength",strengthMultiplier:1e5,strengthExponent:.8},t6_sword:{id:"t6_sword",name:"T6 Sword",icon:O("icons/t6 sword.png"),recipe:[{type:"gem",tier:6,amount:new m(64e5)}],craftTime:60,unlockRequirement:{type:"lifetime_gems",tier:6,amount:64e6},unitRole:"strength",strengthMultiplier:1e6,strengthExponent:.8}},Cc=["t1_sword","t2_sword","t3_sword","t4_sword","t5_sword","t6_sword"],Ec=1,Ac=.1,Nc=15,Oi=[{id:"t1_quest",name:"T1 Quest",difficulty:50,duration:60,rewards:{questBonusTiers:[1]},icon:O("icons/t1 gem.png"),group:"Output Bonuses"},{id:"t2_quest",name:"T2 Quest",difficulty:500,duration:60,rewards:{questBonusTiers:[1,2]},icon:O("icons/t2 gem.png"),group:"Output Bonuses",unlockRequirement:"t1_quest"},{id:"t3_quest",name:"T3 Quest",difficulty:5e3,duration:60,rewards:{questBonusTiers:[1,2,3]},icon:O("icons/t3 gem.png"),group:"Output Bonuses",unlockRequirement:"t2_quest"},{id:"t4_quest",name:"T4 Quest",difficulty:5e4,duration:60,rewards:{questBonusTiers:[1,2,3,4]},icon:O("icons/t4 gem.png"),group:"Output Bonuses",unlockRequirement:"t3_quest"},{id:"t5_quest",name:"T5-T6 Quest",difficulty:2e6,duration:60,rewards:{questBonusTiers:[5,6]},icon:O("icons/t5 gem.png"),group:"Output Bonuses",unlockRequirement:"t4_quest"}],qc=(e,n)=>{let t=1;for(const s of Oi){const r=s.rewards.questBonusTiers;if(r&&r.includes(e)){const a=n[s.id]||0;a>0&&(t+=Math.sqrt(a*.1))}}return t},_c=Object.freeze(Object.defineProperty({__proto__:null,ALL_MILITARY_UNIT_IDS:Cc,COMPLETIONS_TO_UNLOCK:Nc,EXPEDITIONS:Oi,MAX_SUCCESS_RATE:Ec,MILITARY_UNITS:Tc,MIN_SUCCESS_RATE:Ac,MODIFIERS:Mc,calculateQuestBonus:qc},Symbol.toStringTag,{value:"Module"})),Lc={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:2e4,sacrificeBatchSize:1,calculateSacrificeBonus:e=>{if(e<=0)return new m(1);const n=Math.min(e,2e4);return new m(1+Math.pow(n,.4)*.1)}},Pc={pixie:{id:"pixie",name:"Pixie",icon:O("icons/pixie.png"),recipe:[],craftTime:0,unlockRequirement:{type:"lifetime_gems",tier:1,amount:0},unitRole:"strength",strengthMultiplier:1,strengthExponent:.8}},Oc=["pixie"],Uc=1,Fc=.1,Bc=20,Dc=[{id:"r3_mine_1",name:"Mine",difficulty:100,duration:120,rewards:{arcaneBars:1},icon:O("icons/arcane bar.png"),group:"Mine"},{id:"r3_forest_1",name:"Forest",difficulty:100,duration:120,rewards:{arcaneLogs:1},icon:O("icons/arcane log.png"),group:"Forest"},{id:"r3_mine_2",name:"Mine II",difficulty:1e4,duration:240,rewards:{arcaneBars:25},icon:O("icons/arcane bar.png"),group:"Mine",unlockRequirement:"r3_mine_1"},{id:"r3_forest_2",name:"Forest II",difficulty:1e4,duration:240,rewards:{arcaneLogs:25},icon:O("icons/arcane log.png"),group:"Forest",unlockRequirement:"r3_forest_1"},{id:"r3_mine_3",name:"Mine III",difficulty:1e6,duration:480,rewards:{arcaneBars:625},icon:O("icons/arcane bar.png"),group:"Mine",unlockRequirement:"r3_mine_2"},{id:"r3_forest_3",name:"Forest III",difficulty:1e6,duration:480,rewards:{arcaneLogs:625},icon:O("icons/arcane log.png"),group:"Forest",unlockRequirement:"r3_forest_2"},{id:"r3_mine_4",name:"Mine IV",difficulty:1e8,duration:960,rewards:{arcaneBars:15625},icon:O("icons/arcane bar.png"),group:"Mine",unlockRequirement:"r3_mine_3"},{id:"r3_forest_4",name:"Forest IV",difficulty:1e8,duration:960,rewards:{arcaneLogs:15625},icon:O("icons/arcane log.png"),group:"Forest",unlockRequirement:"r3_forest_3"},{id:"r3_mine_5",name:"Mine V",difficulty:1e10,duration:1920,rewards:{arcaneBars:390625},icon:O("icons/arcane bar.png"),group:"Mine",unlockRequirement:"r3_mine_4"},{id:"r3_forest_5",name:"Forest V",difficulty:1e10,duration:1920,rewards:{arcaneLogs:390625},icon:O("icons/arcane log.png"),group:"Forest",unlockRequirement:"r3_forest_4"}],Hc=(e,n)=>1,Ui={produces:"pixie",amountPerCycle:1,cycleDuration:10},jc={produces:"arcane_warden",amountPerCycle:1,cycleDuration:20},Gc={produces:"eidolon",amountPerCycle:1,cycleDuration:30},Vc={produces:"mana_wisp",amountPerCycle:1,cycleDuration:40},Wc={produces:"anima_core",amountPerCycle:1,cycleDuration:50},dn={arcane_warden:Ui,eidolon:jc,mana_wisp:Gc,anima_core:Vc,luminary:Wc},Sr={arcane_warden:{requiredRecipe:"pixie",lifetimeThreshold:100},eidolon:{requiredRecipe:"arcane_warden",lifetimeThreshold:1e3},mana_wisp:{requiredRecipe:"eidolon",lifetimeThreshold:1e4},anima_core:{requiredRecipe:"mana_wisp",lifetimeThreshold:1e5},luminary:{requiredRecipe:"anima_core",lifetimeThreshold:1e6}},ds={arcane_dwelling:{population:1}},fn={arcane_sanctum:{creatureProductionMultiplier:2,baseTicks:1e4,secondsPerTick:3,tickCost:[{recipeId:"arcane_bar",amount:1},{recipeId:"arcane_log",amount:1}],costEscalation:10}},Yc=e=>{e.arcane_soul={id:"arcane_soul",category:"magical_creature",name:"Arcane Soul",icon:O("icons/arcane soul.png"),recipe:[],craftTime:5,realmId:"realm3",ignoreModifiers:!0,outputMultipliers:[{type:"inventory",source:"forge_enhancer",formula:n=>1+n,label:"Forge Enhancer"},{type:"ascension",source:"asc_arcane_soul_prod",formula:n=>Math.pow(1.3,n),label:"Ascension: Soul Prod"}]},e.pixie={id:"pixie",category:"magical_creature",name:"Pixie",icon:O("icons/pixie.png"),recipe:[{type:"recipe",recipeId:"arcane_soul",amount:new m(1)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.arcane_warden={id:"arcane_warden",category:"magical_creature",name:"Arcane Warden",icon:O("icons/arcane warden.png"),recipe:[{type:"recipe",recipeId:"pixie",amount:new m(100)},{type:"recipe",recipeId:"arcane_soul",amount:new m(10)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.eidolon={id:"eidolon",category:"magical_creature",name:"Eidolon",icon:O("icons/eidolon.png"),recipe:[{type:"recipe",recipeId:"arcane_warden",amount:new m(1e3)},{type:"recipe",recipeId:"arcane_soul",amount:new m(100)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.mana_wisp={id:"mana_wisp",category:"magical_creature",name:"Mana Wisp",icon:O("icons/mana wisp.png"),recipe:[{type:"recipe",recipeId:"eidolon",amount:new m(1e4)},{type:"recipe",recipeId:"arcane_soul",amount:new m(1e3)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.anima_core={id:"anima_core",category:"magical_creature",name:"Anima Core",icon:O("icons/anima core.png"),recipe:[{type:"recipe",recipeId:"mana_wisp",amount:new m(1e5)},{type:"recipe",recipeId:"arcane_soul",amount:new m(1e4)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.luminary={id:"luminary",category:"magical_creature",name:"Luminary",icon:O("icons/luminary.png"),recipe:[{type:"recipe",recipeId:"anima_core",amount:new m(1e6)},{type:"recipe",recipeId:"arcane_soul",amount:new m(1e5)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0}},Va=new m(100),Kc=1.7,zc=e=>{e.arcane_dwelling={id:"arcane_dwelling",category:"building",name:"Arcane Dwelling",icon:O("icons/arcane dwelling.png"),recipe:[{type:"recipe",recipeId:"arcane_log",amount:Va},{type:"recipe",recipeId:"arcane_bar",amount:Va}],craftTime:0,realmId:"realm3",ignoreModifiers:!0,escalatingCost:Kc}},Xc=e=>{e.arcane_sanctum={id:"arcane_sanctum",category:"arcane_wonder",name:"Arcane Sanctum",icon:O("icons/arcane sanctum.png"),recipe:[],craftTime:0,realmId:"realm3",ignoreModifiers:!0}},mn={pickaxe:{expeditionGroup:"Mine",exponent:.6,rewardDivisor:7,difficultyDivisor:30},axe:{expeditionGroup:"Forest",exponent:.6,rewardDivisor:7,difficultyDivisor:30}},Zc=e=>{e.pickaxe={id:"pickaxe",category:"equipment",name:"Pickaxe",icon:O("icons/pickaxe.png"),recipe:[],craftTime:1,realmId:"realm3",ignoreModifiers:!0},e.axe={id:"axe",category:"equipment",name:"Axe",icon:O("icons/axe.png"),recipe:[],craftTime:1,realmId:"realm3",ignoreModifiers:!0}},fs=e=>{var t,s;let n=1;for(const[r,a]of Object.entries(ds)){if(!a.creatureProductionMultiplier||a.creatureProductionMultiplier===1)continue;const i=((t=e[r])==null?void 0:t.toNumber())??0;i>0&&(n*=Math.pow(a.creatureProductionMultiplier,i))}for(const[r,a]of Object.entries(fn)){const i=((s=e[r])==null?void 0:s.toNumber())??0;i>0&&(n*=Math.pow(a.creatureProductionMultiplier,i))}return n},Qc=e=>e.amountPerCycle/e.cycleDuration,Jc=e=>{var t;return 1+(((t=e.forge_enhancer)==null?void 0:t.toNumber())??0)},tn=[{id:"asc_arcane_soul_prod",name:"Arcane Soul Production",description:"Increases arcane soul production",effectDescription:e=>e===0?"x1":`x${Math.pow(1.3,e).toFixed(2)}`,baseCost:5,costScaling:1.8,maxLevel:10},{id:"asc_production_speed",name:"Production Speed",description:"Increases creature production speed",effectDescription:e=>e===0?"x1":`x${(1+e*.1).toFixed(1)}`,baseCost:5,costScaling:2,maxLevel:20},{id:"asc_pixie_strength",name:"Pixie Strength",description:"Increases pixie combat strength",effectDescription:e=>e===0?"+0":`+${(e*.3).toFixed(1)}`,baseCost:10,costScaling:1.7,maxLevel:10},{id:"asc_t8_gem_prod",name:"T8 Gem Production (R1+R2)",description:"Multiplies T8 gem production in Realm 1 and Realm 2",effectDescription:e=>e===0?"x1":`x${Math.pow(2,e)}`,baseCost:50,costScaling:3,maxLevel:10},{id:"asc_bigger_dwelling",name:"Bigger Dwelling",description:"Each arcane dwelling provides additional population",effectDescription:e=>e===0?"+0":`+${e}`,baseCost:30,costScaling:3,maxLevel:4}],Kr=Object.fromEntries(tn.map(e=>[e.id,e])),zr=1e5,Xr=()=>({ascendedSouls:0,upgrades:{},lifetimePixies:0,totalAscensions:0}),ms=e=>Math.floor(Math.sqrt(e/zr)),ps=e=>e>=zr,gs=(e,n)=>{const t=Kr[e];return Math.floor(t.baseCost*Math.pow(t.costScaling,n))},ct=(e,n)=>e.upgrades[n]??0,el=e=>Math.pow(1.3,ct(e,"asc_arcane_soul_prod")),An=e=>1+ct(e,"asc_production_speed")*.1,Nn=e=>ct(e,"asc_pixie_strength")*.3,tl=e=>Math.pow(2,ct(e,"asc_t8_gem_prod")),kn=e=>ct(e,"asc_bigger_dwelling"),Fi=new m(1e9),Bi=10,Di=1e9,qn="gem_8",Hi=new m(1e9),ji=10,Gi=1e9,_n="gem_8",Vi=e=>{e.soulforge={id:"soulforge",category:"special",name:"Soulforge",icon:O("icons/soulforge.png"),recipe:[{type:"recipe",recipeId:qn,amount:Fi}],craftTime:0,unlockCondition:{recipeId:qn,threshold:Di},ignoreModifiers:!0,escalatingCost:Bi,targetRealm:"realm3"},e.forge_enhancer={id:"forge_enhancer",category:"special",name:"Forge Enhancer",icon:O("icons/forge enhancer.png"),recipe:[{type:"recipe",recipeId:_n,amount:Hi}],craftTime:0,unlockCondition:{recipeId:_n,threshold:Gi},ignoreModifiers:!0,escalatingCost:ji,targetRealm:"realm3"},Yc(e),zc(e),Zc(e),Xc(e)},nl=Object.freeze(Object.defineProperty({__proto__:null,ALL_MILITARY_UNIT_IDS:Oc,ASCENSION_UPGRADES:tn,ASCENSION_UPGRADE_MAP:Kr,COMPLETIONS_TO_UNLOCK:Bc,CREATURE_PRODUCTION:dn,EQUIPMENT_CONFIGS:mn,EXPEDITIONS:Dc,FORGE_ENHANCER_BASE_COST:Hi,FORGE_ENHANCER_ESCALATION_FACTOR:ji,FORGE_ENHANCER_INGREDIENT_RECIPE_ID:_n,FORGE_ENHANCER_UNLOCK_THRESHOLD:Gi,MAX_SUCCESS_RATE:Uc,MILITARY_UNITS:Pc,MIN_PIXIES_TO_ASCEND:zr,MIN_SUCCESS_RATE:Fc,MODIFIERS:Lc,SOULFORGE_BASE_COST:Fi,SOULFORGE_ESCALATION_FACTOR:Bi,SOULFORGE_INGREDIENT_RECIPE_ID:qn,SOULFORGE_UNLOCK_THRESHOLD:Di,WARDEN_PRODUCTION:Ui,calculateQuestBonus:Hc,canAscend:ps,createDefaultAscensionState:Xr,getAscensionArcaneSoulMult:el,getAscensionDwellingBonus:kn,getAscensionGain:ms,getAscensionPixieStrengthBonus:Nn,getAscensionProductionSpeedMult:An,getAscensionT8GemMult:tl,getAscensionUpgradeCost:gs,getAscensionUpgradeLevel:ct,getCreatureRatePerSecond:Qc,getForgeEnhancerMultiplier:Jc,registerRealm3Recipes:Vi},Symbol.toStringTag,{value:"Module"})),We=["realm1","realm2","realm3"],sl={realm1:"Prime Realm",realm2:"Realm of War",realm3:"Realm of Magic"},Me=e=>e==="realm1"?Rc:e==="realm2"?_c:nl,ke={};function Wi(e,n,t){return e==="mana"?{type:"mana",amount:t}:{type:"recipe",recipeId:`gem_${n}`,amount:t}}for(const e of Ze){const n=$e[e],t=`gem_${e}`;ke[t]={id:t,category:"gem",name:n.name,icon:n.icon,tier:e,recipe:n.recipe.map(s=>Wi(s.type,s.tier,s.amount)),craftTime:n.craftTime,visibleByDefault:n.visibleByDefault,unlockCondition:n.unlockRequirement?{recipeId:`gem_${n.unlockRequirement.tier}`,threshold:n.unlockRequirement.amount}:void 0,manaEffect:n.effect}}ke.gem_8.outputMultipliers=[{type:"ascension",source:"asc_t8_gem_prod",formula:e=>Math.pow(2,e),label:"Ascension: T8 Gem",realmFilter:["realm1","realm2"]}];for(const e of tt){const n=un[e],t=`flask_${e}`;ke[t]={id:t,category:"flask",name:n.name,icon:n.icon,tier:e,recipe:n.recipe.map(s=>({type:"recipe",recipeId:`gem_${s.tier}`,amount:s.amount})),craftTime:n.craftTime,unlockCondition:{recipeId:`gem_${e}`,threshold:500}}}for(const e of We){const n=Me(e),t=n.MILITARY_UNITS;for(const s of n.ALL_MILITARY_UNIT_IDS){const r=t[s];ke[s]||(ke[s]={id:s,category:"military",name:r.name,icon:r.icon,recipe:r.recipe.map(a=>Wi(a.type,a.tier,a.amount)),craftTime:r.craftTime,unlockCondition:{recipeId:`gem_${r.unlockRequirement.tier}`,threshold:r.unlockRequirement.amount},unitRole:r.unitRole,strengthMultiplier:r.strengthMultiplier,strengthExponent:r.strengthExponent,realmId:e,...e==="realm2"&&r.unlockRequirement.tier>=4?{crossRealmPooling:{minGlobalTier:2,targetRealms:["realm1"]}}:{}})}}ke.artifact_shard={id:"artifact_shard",category:"expedition_reward",name:"Artifact Shard",icon:O("icons/artifact shard.png"),recipe:[],craftTime:0};ke.nullstone={id:"nullstone",category:"expedition_reward",name:"Nullstone",icon:O("icons/nullstone.png"),recipe:[],craftTime:0};ke.arcane_bar={id:"arcane_bar",category:"expedition_reward",name:"Arcane Bar",icon:O("icons/arcane bar.png"),recipe:[],craftTime:0,realmId:"realm3"};ke.arcane_log={id:"arcane_log",category:"expedition_reward",name:"Arcane Log",icon:O("icons/arcane log.png"),recipe:[],craftTime:0,realmId:"realm3"};Vi(ke);const Rt=ke,rt=Object.keys(ke),ne=e=>{const n=ke[e];if(!n)throw new Error(`Unknown recipe: ${e}`);return n},Ln=e=>rt.filter(n=>{const t=ke[n];return t.category==="expedition_reward"||t.category==="special"||t.category==="equipment"||t.craftTime===0?!1:t.category==="magical_creature"?t.realmId===e:e==="realm3"&&(t.category==="gem"||t.category==="flask")?!1:t.category!=="military"?!0:t.realmId===e});Ze.map(e=>`gem_${e}`);tt.map(e=>`flask_${e}`);const rl=e=>rt.filter(n=>ke[n].category==="military"&&ke[n].realmId===e);rt.filter(e=>ke[e].category==="military");const kr=["artifact_shard","nullstone"],Yi=e=>rt.filter(n=>ke[n].category==="magical_creature"&&ke[n].realmId===e),Wa=e=>rt.filter(n=>ke[n].category==="building"&&ke[n].realmId===e),hs=e=>rt.filter(n=>ke[n].category==="equipment"&&ke[n].realmId===e),vs=e=>rt.filter(n=>ke[n].category==="arcane_wonder"&&ke[n].realmId===e),Ya=e=>`gem_${e}`,al=e=>`flask_${e}`,As=()=>{const e={};for(const n of rt)e[n]=new m(0);return e},D=(e,n)=>e[n]??new m(0),He=(e,n,t)=>{e[n]=D(e,n).add(t)},we=(e,n,t)=>{e[n]=m.max(D(e,n).sub(t),0)},Ns=(e,n,t)=>D(e,n).gte(t),il=e=>{const n={};for(const t of Object.keys(e)){const s=e[t];s&&!s.eq(0)&&(n[t]=s.toString())}return n},ol=e=>{const n=As();for(const[t,s]of Object.entries(e))s&&t in n&&(n[t]=new m(s));return n},qs=()=>{const e={};for(const n of rt)e[n]={assignment:0,progress:0,lifetimeProduced:0};return e},cl=e=>{const n={};for(const[t,s]of Object.entries(e))(s.assignment!==0||s.progress!==0||s.lifetimeProduced!==0)&&(n[t]={a:s.assignment,p:s.progress,l:s.lifetimeProduced});return n},ll=e=>{const n=qs();for(const[t,s]of Object.entries(e))t in n&&(n[t]={assignment:s.a??0,progress:s.p??0,lifetimeProduced:s.l??0});return n},Xe=(e,n)=>{var a;const t=ne(e);if(t.visibleByDefault||!t.unlockCondition)return!0;const{recipeId:s,threshold:r}=t.unlockCondition;return(((a=n[s])==null?void 0:a.lifetimeProduced)??0)>=r},Yt=(e,n)=>{for(const t of e)if(!Xe(t,n))return t;return null},Sn=(e,n)=>{var a;const t=ne(e);if(!t.unlockCondition)return null;const{recipeId:s,threshold:r}=t.unlockCondition;return{current:((a=n[s])==null?void 0:a.lifetimeProduced)??0,required:r}},ul=e=>{var t;let n=0;for(const s of rt)n+=((t=e[s])==null?void 0:t.assignment)??0;return n},Ki=(e,n)=>e-ul(n),Nt=e=>{const n={};for(const t of Ze)n[t]=D(e,`gem_${t}`);return n},xn=e=>{const n={};for(const t of tt)n[t]=D(e,`flask_${t}`);return n},Mt=e=>{const n={};for(const t of rt)ne(t).category==="military"&&(n[t]=D(e,t));return n},Zr=(e,n)=>{const t={},s={},r={};for(const a of n){const i=e[a];t[a]=(i==null?void 0:i.assignment)??0,s[a]=(i==null?void 0:i.progress)??0,r[a]=(i==null?void 0:i.lifetimeProduced)??0}return{crafterAssignments:t,craftProgress:s,lifetimeCrafted:r}},Et={crafters:{id:"crafters",name:"Crafter",description:"Unlock a crafter for gem production",baseCost:new m(1),costExponent:10,maxLevel:300}},zi=Object.keys(Et),dl=[[{tier:1,amount:new m(50)}],[{tier:1,amount:new m(200)},{tier:2,amount:new m(100)}],[{tier:2,amount:new m(300)},{tier:3,amount:new m(200)}],[{tier:3,amount:new m(400)},{tier:4,amount:new m(300)}],[{tier:4,amount:new m(500)},{tier:5,amount:new m(400)}],[{tier:5,amount:new m(600)},{tier:6,amount:new m(500)}],[{tier:6,amount:new m(700)},{tier:7,amount:new m(600)}],[{tier:7,amount:new m(800)},{tier:8,amount:new m(700)}]],fl=Array.from({length:16},(e,n)=>{const t=Math.floor(n/2)+1,s=n%2===0?10:50;return[{tier:t,amount:new m(s)}]}),Xs=(e,n=5e4)=>Array.from({length:10},(t,s)=>[{tier:e,amount:new m(n).mul(m.pow(4,s))}]),Zs=e=>Array.from({length:8},(n,t)=>[{tier:e,amount:new m(1e4).mul(m.pow(1.4,t))},{tier:e,amount:new m(1e3).mul(m.pow(1.4,t)),recipeId:`t${e}_sword`}]),ml=[[{tier:1,amount:new m(10)}],[{tier:1,amount:new m(25)}],[{tier:1,amount:new m(50)}],[{tier:2,amount:new m(10)}],[{tier:2,amount:new m(25)}],[{tier:2,amount:new m(50)}],[{tier:3,amount:new m(10)}],[{tier:3,amount:new m(25)}],[{tier:3,amount:new m(50)}],[{tier:4,amount:new m(100)}]],pl=[[{tier:1,amount:new m(100)},{tier:2,amount:new m(100)}],[{tier:1,amount:new m(500)},{tier:2,amount:new m(500)}],[{tier:2,amount:new m(100)},{tier:3,amount:new m(100)}],[{tier:2,amount:new m(500)},{tier:3,amount:new m(500)}],[{tier:3,amount:new m(100)},{tier:4,amount:new m(100)}],[{tier:3,amount:new m(500)},{tier:4,amount:new m(500)}],[{tier:4,amount:new m(100)},{tier:5,amount:new m(100)}],[{tier:4,amount:new m(500)},{tier:5,amount:new m(500)}],[{tier:5,amount:new m(100)},{tier:6,amount:new m(100)}],[{tier:5,amount:new m(500)},{tier:6,amount:new m(500)}]],gl=[[{tier:1,amount:new m(50)}],[{tier:1,amount:new m(100)}],[{tier:1,amount:new m(250)}],[{tier:2,amount:new m(50)}],[{tier:2,amount:new m(100)}],[{tier:2,amount:new m(250)}],[{tier:3,amount:new m(50)}],[{tier:3,amount:new m(100)}],[{tier:3,amount:new m(250)}],[{tier:4,amount:new m(1e3)}]],Xi={craftersGuild:{id:"craftersGuild",name:"Crafter's Guild",description:"The first 30 crafters boost all crafters' output",tooltip:`Each of the first 30 crafters multiplies ALL crafting output (does not increase consumption).
Lv1: x1.03 per crafter, +0.005 per additional level.
Total multiplier = (1 + bonus) ^ min(total crafters, 30).
Applies to gems, flasks, and military.`,costs:dl},gemManufacturing:{id:"gemManufacturing",name:"Gem Manufacturing",description:"Increases all gem output",tooltip:`Multiplies ALL gem crafting output by x1.2 per level.
Does not affect flask or military output.
Does not increase consumption.`,costs:fl},t1KnightStrength:{id:"t1KnightStrength",name:"T1 Knight Strength",description:"Increases T1 Knight combat strength",tooltip:`Multiplies T1 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:Xs(1,1e3)},t4KnightStrength:{id:"t4KnightStrength",name:"T4 Knight Strength",description:"Increases T4 Knight combat strength",tooltip:`Multiplies T4 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:Xs(4)},t7KnightStrength:{id:"t7KnightStrength",name:"T7 Knight Strength",description:"Increases T7 Knight combat strength",tooltip:`Multiplies T7 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:Xs(7)},cheaperGems:{id:"cheaperGems",name:"Cheaper Gems",description:"Reduces gem input requirements",tooltip:`Reduces gem crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, gems cost 50% less to craft.`,costs:ml},cheaperFlasks:{id:"cheaperFlasks",name:"Cheaper Flasks",description:"Reduces flask input requirements",tooltip:`Reduces flask crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, flasks cost 50% less to craft.`,costs:gl},cheaperMilitary:{id:"cheaperMilitary",name:"Cheaper Expedition Units",description:"Reduces military input requirements",tooltip:`Reduces military crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, expedition units cost 50% less to craft.`,costs:pl},t4SwordEfficiency:{id:"t4SwordEfficiency",name:"Cheaper T4 Swords",description:"Reduces T4 Sword input costs",tooltip:`Reduces T4 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T4 Swords cost 96% less to craft.`,costs:Zs(4)},t5SwordEfficiency:{id:"t5SwordEfficiency",name:"Cheaper T5 Swords",description:"Reduces T5 Sword input costs",tooltip:`Reduces T5 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T5 Swords cost 96% less to craft.`,costs:Zs(5)},t6SwordEfficiency:{id:"t6SwordEfficiency",name:"Cheaper T6 Swords",description:"Reduces T6 Sword input costs",tooltip:`Reduces T6 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T6 Swords cost 96% less to craft.`,costs:Zs(6)}},Qr=Object.keys(Xi),_s=[...zi,...Qr],ht={...Xi},Zi=(e,n,t)=>e[n].gte(t),Jr=(e,n,t,s)=>{const r=t==="realm1"?e:n,a=t==="realm1"?n:e,i={...r};for(const o of Object.keys(a)){const u=Rt[o];u!=null&&u.crossRealmPooling&&s>=u.crossRealmPooling.minGlobalTier&&(!u.crossRealmPooling.targetRealms||u.crossRealmPooling.targetRealms.includes(t))&&(i[o]=(i[o]||new m(0)).add(a[o]||new m(0)))}return i},hl=(e,n,t,s,r)=>{const a=Jr(e,n,s,r);for(const i of Object.keys(t)){const o=t[i];if(o>0&&(a[i]||new m(0)).lt(o))return!1}return!0},vl=(e,n,t,s,r)=>{let a={...e},i={...n};for(const o of Object.keys(t)){let u=t[o];if(u<=0)continue;const l=Rt[o];if((l==null?void 0:l.crossRealmPooling)&&r>=l.crossRealmPooling.minGlobalTier&&(!l.crossRealmPooling.targetRealms||l.crossRealmPooling.targetRealms.includes(s))){const c=s==="realm1"?a:i,f=s==="realm1"?i:a,b=(c[o]||new m(0)).toNumber(),y=Math.min(u,b);y>0&&(c[o]=(c[o]||new m(0)).sub(y),u-=y),u>0&&(f[o]=(f[o]||new m(0)).sub(u)),s==="realm1"?(a=c,i=f):(i=c,a=f)}else{const c=s==="realm1"?a:i;c[o]=(c[o]||new m(0)).sub(u)}}return{realm1:a,realm2:i}},ea=()=>{const e={};for(const n of _s)e[n]=0;return e},bl=e=>{const n={};for(const t of _s)e[t]!==0&&(n[t]=e[t]);return n},xl=e=>{const n=ea();for(const t of _s)e[t]!==void 0&&(n[t]=e[t]);return n},gt=(e,n,t=0)=>{if(n in Et){const s=Et[n];return e[n]>=s.maxLevel}if(n in ht){const s=ht[n];return e[n]>=s.costs.length}return!0},yl=(e,n=0)=>e in Et?Et[e].maxLevel:e in ht?ht[e].costs.length:0,wl=(e,n)=>{const t=Et[e];return n>=t.maxLevel?null:t.baseCost.mul(m.pow(t.costExponent,n))},Yn=(e,n)=>{const t=ht[e];return!t||n>=t.costs.length?null:t.costs[n]},ta=(e,n,t=0)=>{if(n in Et){const s=wl(n,e[n]);return s?{type:"mana",amount:s}:null}if(n in ht){const s=Yn(n,e[n]);return!s||s.length===0?null:{type:"flask",tier:s[0].tier,amount:s[0].amount}}return null},Kn=(e,n,t,s,r,a=0,i)=>{if(n in Et){const o=ta(e,n);return o?t.gte(o.amount):!1}if(n in ht){const o=Yn(n,e[n]);return o?o.every(u=>u.recipeId&&i?D(i,u.recipeId).gte(u.amount):Zi(r,u.tier,u.amount)):!1}return!1},bs=e=>1+(e.crafters??0),Sl=.03,kl=.005,$l=30,na=e=>{const n=e.craftersGuild??0;if(n<=0)return new m(1);const t=Math.min(bs(e),$l),s=Sl+kl*(n-1);return new m(1+s).pow(t)},Il=1.2,sa=e=>{const n=e.gemManufacturing??0;return n<=0?new m(1):new m(Il).pow(n)},ra=.05,aa=e=>{const n=e.cheaperGems??0;return n<=0?new m(1):new m(1-ra*n)},ia=e=>{const n=e.cheaperFlasks??0;return n<=0?new m(1):new m(1-ra*n)},oa=e=>{const n=e.cheaperMilitary??0;return n<=0?new m(1):new m(1-ra*n)},Rl=.12,Ml={t4_sword:"t4SwordEfficiency",t5_sword:"t5SwordEfficiency",t6_sword:"t6SwordEfficiency"},rn=["t4SwordEfficiency","t5SwordEfficiency","t6SwordEfficiency"],ca=(e,n)=>{const t=Ml[n];if(!t)return new m(1);const s=e[t]??0;return s<=0?new m(1):new m(1-Rl*s)},Ka=(e,n)=>new m(1),Pn=(e,n)=>new m(1),$r=(e,n)=>new m(1),za=e=>new m(1),Xa=e=>new m(1),Ls=e=>1,Tl=e=>1,Qi=(e,n)=>0,Cl=1.3,El={t1_knight:"t1KnightStrength",t4_knight:"t4KnightStrength",t7_knight:"t7KnightStrength"},an=["t1KnightStrength","t4KnightStrength","t7KnightStrength"],Ji=(e,n)=>{const t=El[n];if(!t)return 1;const s=e[t]??0;return s<=0?1:Math.pow(Cl,s)},zn=e=>Me(e).MILITARY_UNITS,Je=e=>Me(e).ALL_MILITARY_UNIT_IDS,la=(e,n,t)=>{const s=Rt[e];return!(!(s!=null&&s.crossRealmPooling)||t<s.crossRealmPooling.minGlobalTier||s.crossRealmPooling.targetRealms&&!s.crossRealmPooling.targetRealms.includes(n))},Al=(e,n)=>{const t=[];for(const s of We)if(s!==e)for(const r of Me(s).ALL_MILITARY_UNIT_IDS)la(r,e,n)&&t.push(r);return t},yt=(e,n)=>{const t=Me(e).ALL_MILITARY_UNIT_IDS,s=Al(e,n);return s.length>0?[...t,...s]:[...t]},yn=(e,n)=>{const t={};Object.assign(t,Me(e).MILITARY_UNITS);for(const s of We){if(s===e)continue;const r=Me(s).MILITARY_UNITS;for(const a of Object.keys(r))la(a,e,n)&&(t[a]=r[a])}return t},Nl=(e,n)=>{for(const t of We)if(t!==e){for(const s of Me(t).ALL_MILITARY_UNIT_IDS)if(la(s,e,n))return!0}return!1},ql=()=>{const e={};for(const n of We){const t=Me(n).MILITARY_UNITS;Object.assign(e,t)}return e},wt=e=>Me(e).EXPEDITIONS,ua=e=>Me(e).COMPLETIONS_TO_UNLOCK,Ps=e=>Me(e).calculateQuestBonus,eo=10,to=40,no=20,xs=(e,n)=>{if(n){const t=Ce[n];if(t)return t.maxLevel}return 1/0},da=(e,n,t=1/0)=>{if(n>=t)return{artifactShards:new m(1/0),gems:new m(1/0)};const s=m.pow(e.costScaling,n);return{artifactShards:e.cost.artifactShards.mul(s),gems:new m(0)}},_l=(e,n)=>{const t=Ce[e];return m.pow(1+t.upgradeBonus,n)},so=(e,n,t)=>{if(!t)return{inputMultiplier:new m(1),outputMultiplier:new m(1)};const s=Ce[e],r=_l(e,n),a=s.baseOutputMultiplier.mul(r);return{inputMultiplier:new m(1),outputMultiplier:a}},fa=()=>{const e={},n={};for(const t of dt)e[t]=!1,n[t]=0;return{owned:e,upgradeLevels:n,slotted:[],slotCount:0}},Ll=e=>({owned:e.owned,upgradeLevels:e.upgradeLevels,slotted:e.slotted,slotCount:e.slotCount}),Pl=e=>{const n=fa(),t=e==null?void 0:e.owned,s=e==null?void 0:e.upgradeLevels;if(t&&typeof t=="object"&&Object.keys(t).some(u=>u.startsWith("artifact_t")))return n;const r={},a={};for(const i of dt)r[i]=(t==null?void 0:t[i])??!1,a[i]=(s==null?void 0:s[i])??0;return{owned:r,upgradeLevels:a,slotted:Array.isArray(e==null?void 0:e.slotted)?e.slotted.filter(i=>dt.includes(i)):[],slotCount:(e==null?void 0:e.slotCount)??0}},et=(e,n)=>e.owned[n]===!0,ro=(e,n)=>{const t=Ce[e];return t?n>=t.cost.artifactShards.toNumber():!1},ao=(e,n,t,s=1/0)=>{if(n>=s)return!1;const r=Ce[e];if(!r)return!1;const a=da(r,n,s);return t>=a.artifactShards.toNumber()},io=(e,n)=>{let t=new m(1);for(const s of dt){if(Ce[s].tier!==n)continue;const{inputMultiplier:a}=so(s,e.upgradeLevels[s]??0,e.owned[s]??!1);t=t.mul(a)}return t},ma=(e,n)=>{let t=new m(1);for(const s of dt){if(Ce[s].tier!==n)continue;const{outputMultiplier:a}=so(s,e.upgradeLevels[s]??0,e.owned[s]??!1);t=t.mul(a)}return t},oo=e=>{const n="combat_artifact";if(!e.owned[n])return 1;const t=e.upgradeLevels[n]??0;return t<=0?1:Math.pow(1+Ce[n].upgradeBonus,t)},co=e=>{const n="crafting_speed";if(!e.owned[n])return 1;const t=e.upgradeLevels[n]??0;return t<=0?1:1+Ce[n].upgradeBonus*t},Ol=(e,n)=>{const t=Ce[e];return[{type:"shards",icon:O("icons/artifact shard.png"),amount:t.cost.artifactShards,have:new m(n),canAfford:n>=t.cost.artifactShards.toNumber()}]},Ul=(e,n,t,s)=>{const r=Ce[e],a=da(r,n,t);return[{type:"shards",icon:O("icons/artifact shard.png"),amount:a.artifactShards,have:new m(s),canAfford:s>=a.artifactShards.toNumber()}]},Fl=1e3,Bl=100,Dl=.2,Hl=.01,lo=()=>({prestigeCounts:{},autoPrestige:{}}),jl=e=>({prestigeCounts:e.prestigeCounts,autoPrestige:e.autoPrestige}),Gl=e=>{const n=e.prestigeCounts||{},t=e.autoPrestige||{};return{prestigeCounts:n,autoPrestige:t}},Os=e=>new m(Fl).mul(new m(Bl).pow(e)),Us=(e,n,t)=>{const s=Os(t);return n.gte(s)},uo=(e,n)=>{const t=e[n]||0;return new m(1+t*Dl)},fo=e=>{let n=0;for(const t of Object.values(e))n+=t;return new m(1+n*Hl)},vt=(e,n)=>uo(e,n).mul(fo(e)),Vl=()=>{const e={};for(const n of Ze)e[`gem_${n}`]=0;for(const n of tt)e[`flask_${n}`]=0;for(const n of We)for(const t of Je(n))e[`military_${t}`]=0;return e.artifact_shard=0,e.nullstone=0,e},pa=()=>({tier:0,sacrificeCounts:Vl(),activeSacrifice:null,sacrificeProgress:0}),Ir=e=>e>=1,mo=(e,n,t)=>{const s=e[`gem_${n}`]||0;return t(s)},po=(e,n,t)=>{const s=e[`flask_${n}`]||0;return t(s)},ga=(e,n)=>{const t=e.artifact_shard||0;return n(t)},ha=(e,n)=>{const t=e.nullstone||0;return n(t)},go=(e,n,t)=>{const s=e[`military_${n}`]||0;return t(s)},Wl=e=>{const n={};for(const[t,s]of Object.entries(e.sacrificeCounts))s>0&&(n[t]=s);return{tier:e.tier,sacrificeCounts:n,activeSacrifice:e.activeSacrifice,sacrificeProgress:e.sacrificeProgress}},Yl=e=>{const t={...pa().sacrificeCounts};if(e.sacrificeCounts)for(const[s,r]of Object.entries(e.sacrificeCounts))s in t&&typeof r=="number"&&(t[s]=r);return{tier:e.tier??0,sacrificeCounts:t,activeSacrifice:e.activeSacrifice??null,sacrificeProgress:e.sacrificeProgress??0}},va=()=>({activeExpeditions:{},completionsPerExpedition:{},expeditionSetups:{},expeditionLog:[],pendingRepeats:{},portalBuilt:!1,heroicVictories:{}}),Kl=e=>({activeExpeditions:e.activeExpeditions,completionsPerExpedition:e.completionsPerExpedition,expeditionSetups:e.expeditionSetups,expeditionLog:e.expeditionLog,pendingRepeats:e.pendingRepeats,portalBuilt:e.portalBuilt,heroicVictories:e.heroicVictories}),Za={expedition_2:null,expedition_3:"expedition_2",expedition_4:"expedition_3",expedition_5:"expedition_4"},Qa={expedition_1:"shard_1",expedition_2:"shard_2",expedition_3:"nullstone_1",expedition_4:"shard_3"},zl=(e,n)=>n.some(t=>t in e),Xl=e=>{const n=[e.expeditionSetups,e.activeExpeditions,e.completionsPerExpedition,e.pendingRepeats];for(const t of n)if(t&&"expedition_5"in t)return!0;return!1},Zl=e=>{const n=[e.expeditionSetups,e.activeExpeditions,e.completionsPerExpedition,e.pendingRepeats];for(const t of n)if(t&&zl(t,["expedition_1","expedition_2","expedition_3","expedition_4"]))return!0;return!1},Ql=(e,n,t)=>{let s=e;return n&&s in Za&&(s=Za[s]??null,s===null)?null:(t&&s in Qa&&(s=Qa[s]),s)},Jl=e=>{const n=Xl(e),t=Zl(e)||n,s=f=>n||t?Ql(f,n,t):f,r={};if(e.expeditionSetups)for(const[f,b]of Object.entries(e.expeditionSetups)){const y=s(f);if(!y)continue;const g={},w=b.assignedUnits;if(w)for(const p of Object.keys(w))g[p]=w[p];r[y]={assignedUnits:g,assignedEquipment:b.assignedEquipment,repeatIfUnitsAvailable:b.repeatIfUnitsAvailable||!1}}const a={};if(e.activeExpeditions)for(const[f,b]of Object.entries(e.activeExpeditions)){const y=s(f);y&&(a[y]=b.map(g=>{const w={},p=g.assignedUnits;if(p)for(const h of Object.keys(p))w[h]=p[h];return{...g,expeditionId:y,assignedUnits:w}}))}const i=e.completionsPerExpedition||{},o={};for(const[f,b]of Object.entries(i)){const y=s(f);y&&(o[y]=(o[y]||0)+b)}const u=e.pendingRepeats||{},l={};for(const[f,b]of Object.entries(u)){const y=s(f);y&&(l[y]=b)}const d=e.expeditionLog||[],c=[];for(const f of d){const b=s(f.expeditionId);b&&c.push({...f,expeditionId:b})}return{activeExpeditions:a,completionsPerExpedition:o,expeditionSetups:r,expeditionLog:c,pendingRepeats:l,portalBuilt:e.portalBuilt||!1,heroicVictories:e.heroicVictories||{}}},Fs=(e,n="realm1")=>zn(n)[e]||ql()[e]||null,ba=(e,n,t="realm1",s=0)=>{if(n<=0)return 0;const r=Fs(e,t);return r?Math.pow(n,r.strengthExponent)*(r.strengthMultiplier+s):0},eu=(e,n,t="realm1",s=0)=>{const r=Fs(e,t);return!r||r.unitRole!=="strength"?0:ba(e,n,t,s)},st=(e,n="realm1",t,s,r=0,a=0)=>{let i=0;const o=yt(n,r);for(const l of o){const d=(t?Qi():0)+a;let c=eu(l,e[l]||0,n,d);if(t){const f=Ji(t,l);f>1&&(c*=f)}i+=c}const u=s?oo(s):1;return i*u},ys=(e,n="realm1",t=0)=>{let s=0;const r=yt(n,t);for(const a of r){const i=Fs(a,n);!i||i.unitRole!=="speed"||(s+=ba(a,e[a]||0,n))}return s},nt=(e,n="realm1",t=0)=>{let s=0;const r=yt(n,t);for(const a of r){const i=Fs(a,n);!i||i.unitRole!=="taunt"||(s+=ba(a,e[a]||0,n))}return s},bt=e=>1+e/to,ws=e=>1+e/no,tu=e=>1+e/eo,pn=(e,n,t="realm1",s=0)=>{const r=wt(t),a=ua(t),i=r.findIndex(d=>d.id===e);if(i===0)return!0;const o=r[i];if(!o)return!1;if(o.heroic)return ru(s);if(!o.unlockRequirement)return!0;const u=r.find(d=>d.id===o.unlockRequirement);return u?(n[u.id]||0)>=a:!1},nu=(e,n,t,s="realm1")=>{const r=n[e]||[],a=Ye(e,s);return a!=null&&a.heroic?r.length===0:!(r.length>=t)},su=(e="realm1")=>{const n={},t=Je(e);for(const s of t)n[s]=0;return n},xa=()=>({assignedUnits:su(),repeatIfUnitsAvailable:!0}),Ye=(e,n="realm1")=>wt(n).find(s=>s.id===e),Rr=e=>e*Pi/us,On=(e,n)=>{const t=e/n*us;return Math.min(t,us)},gn=(e,n="realm1",t=0)=>{const s=Ye(e,n),r=s?s.duration*1e3:6e4;return Math.round(r/tu(t))},qt=(e,n)=>{if(!e.heroic)return e.difficulty??0;const t=n[e.id]||0;return Math.round(e.heroic.baseDifficulty*Math.pow(e.heroic.difficultyScaling,t))},Bs=(e,n="realm1")=>{var r;const t=wt(n);let s=1;for(const a of t)if(((r=a.heroic)==null?void 0:r.rewardType)==="shard_drops"){const i=e[a.id]||0;i>0&&(s*=Math.pow(a.heroic.rewardScaling,i))}return s},Un=(e,n,t="realm1")=>{var i;const s=wt(t),r=n==="realm1"?"realm1_output":"realm2_output";let a=1;for(const o of s)if(((i=o.heroic)==null?void 0:i.rewardType)===r){const u=e[o.id]||0;u>0&&(a*=Math.pow(o.heroic.rewardScaling,u))}return a},ru=e=>e>=2,Fn=(e,n,t,s,r,a,i=1)=>{const o=Bs(t,a),u=vt(s.prestigeCounts,"artifact_shard").toNumber(),l=vt(s.prestigeCounts,"nullstone").toNumber(),d=Me(a).MODIFIERS.calculateSacrificeBonus,c=ga(r,d).toNumber(),f=ha(r,d).toNumber(),b={};return e.artifactShards&&(b.artifactShards=Math.round(e.artifactShards*n*o*u*c)),e.nullstone&&(b.nullstone=Math.round(e.nullstone*n*l*f)),e.arcaneBars&&(b.arcaneBars=Math.ceil(e.arcaneBars*i)),e.arcaneLogs&&(b.arcaneLogs=Math.ceil(e.arcaneLogs*i)),e.questBonusTiers&&(b.questBonusTiers=e.questBonusTiers),b},Ss=(e,n)=>{let t=1;for(const[s,r]of Object.entries(e)){if(r<=0)continue;const a=mn[s];!a||a.expeditionGroup!==n||(t+=Math.pow(r,a.exponent)/a.rewardDivisor)}return t},xt=(e,n)=>{let t=1;for(const[s,r]of Object.entries(e)){if(r<=0)continue;const a=mn[s];!a||a.expeditionGroup!==n||(t+=Math.pow(r,a.exponent)/a.difficultyDivisor)}return t},ho=e=>Object.keys(mn).filter(n=>mn[n].expeditionGroup===e),Rn=(e="realm1")=>({mana:new m(0),recipeInventory:As(),recipeCrafting:qs(),upgrades:ea(),autoBuyUpgrades:{},combat:va(),artifacts:fa(),altar:pa(),prestige:lo(),creatureUpgrades:{},creatureUnlocks:{},workshopAssignments:{},wonderAssignments:{},ascension:Xr()}),ya=()=>({realms:{realm1:Rn("realm1"),realm2:Rn("realm2"),realm3:Rn("realm3")},activeRealm:"realm1",realm2Unlocked:!1,realm3Unlocked:!1,globalTier:0,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0,paused:!1,backgroundImageOff:!1,tabHighlightingOff:!1,uiScale:1,totalPlaytime:0,skippedTime:0,timeWarpCharges:0,villageUnlocked:!1,collapsedSections:[],dismissedTips:[]}),wa=(e,n)=>{let t=e[1].mul($e[1].effect.value);for(const s of Ze.slice(1)){const r=e[s];if(r.gt(0)){const a=$e[s],i=new m(1).add(r.mul(a.effect.value.sub(1)));t=t.mul(i)}}return n&&(t=n(t)),t},Ja=(e,n,t,s)=>{const r=wa(n,s);return e.add(r.mul(t))},Sa=(e,n)=>e==="crafting"?`gem_${n}`:e==="flaskCrafting"?`flask_${n}`:String(n),ka=(e,n)=>{const t=e.activeRealm,s=e.realms[t],r={...s,...n(s)};return{realms:{...e.realms,[t]:r}}},vo=e=>{const n=bs(e.upgrades);return Ki(n,e.recipeCrafting)},Qs=(e,n,t)=>(s,r)=>{const a=n(),i=z(a),o=Sa(e,s),u=i.recipeCrafting[o],l=vo(i),d=(u==null?void 0:u.assignment)??0;let c=d+r;c=Math.max(0,c),c=Math.min(d+l,c),c!==d&&t(ka(a,f=>({recipeCrafting:{...f.recipeCrafting,[o]:{...f.recipeCrafting[o],assignment:c}}})))},Js=(e,n,t)=>s=>{const r=n(),a=z(r),i=Sa(e,s),o=a.recipeCrafting[i],u=vo(a),d=((o==null?void 0:o.assignment)??0)+u;t(ka(r,c=>({recipeCrafting:{...c.recipeCrafting,[i]:{...c.recipeCrafting[i],assignment:d}}})))},er=(e,n,t)=>s=>{const r=n(),a=Sa(e,s);t(ka(r,i=>({recipeCrafting:{...i.recipeCrafting,[a]:{...i.recipeCrafting[a],assignment:0,progress:0}}})))},bo=(e,n)=>{const t=e.activeRealm,s=e.realms[t],r={...s,...n(s)};return{realms:{...e.realms,[t]:r}}},au=(e,n)=>t=>{const s=e();if(s.activeRealm==="realm2"&&an.includes(t)||s.activeRealm==="realm1"&&rn.includes(t))return!1;const r=z(s),a=s.globalTier,i=Nt(r.recipeInventory),o=xn(r.recipeInventory);if(gt(r.upgrades,t,a)||!Kn(r.upgrades,t,r.mana,i,o,a,r.recipeInventory))return!1;let u=r.mana;const l={...r.recipeInventory};if(t in ht){const d=Yn(t,r.upgrades[t]);if(!d)return!1;for(const c of d)if(c.recipeId)we(l,c.recipeId,c.amount);else{const f=al(c.tier);we(l,f,c.amount)}}else{const d=ta(r.upgrades,t,a);if(!d)return!1;d.type==="mana"&&(u=u.sub(d.amount))}return n(bo(s,()=>({mana:u,recipeInventory:l,upgrades:{...r.upgrades,[t]:r.upgrades[t]+1}}))),!0},iu=(e,n)=>t=>{const s=e(),r=z(s),a=r.autoBuyUpgrades[t]??!1;n(bo(s,()=>({autoBuyUpgrades:{...r.autoBuyUpgrades,[t]:!a}})))},$a=(e,n)=>{const t=e.activeRealm,s=e.realms[t],r={...s,...n(s)};return{realms:{...e.realms,[t]:r}}},ou=(e,n)=>(t,s)=>{const r=e(),a=z(r),i={...a.combat.pendingRepeats};s.repeatIfUnitsAvailable||delete i[t],n($a(r,()=>({combat:{...a.combat,expeditionSetups:{...a.combat.expeditionSetups,[t]:s},pendingRepeats:i}})))},cu=(e,n)=>(t,s,r=!1)=>{const a=e(),i=z(a),o=yt(a.activeRealm,a.globalTier),u=Ye(t,a.activeRealm);if(!u||!pn(t,i.combat.completionsPerExpedition,a.activeRealm,a.globalTier))return!1;const l=Ls(i.upgrades);if(!nu(t,i.combat.activeExpeditions,l,a.activeRealm))return!1;u.heroic&&(r=!1);const d={};for(const H of o)d[H]=s[H]||0;const c=ys(d,a.activeRealm,a.globalTier),f=nt(d,a.activeRealm,a.globalTier),b=bt(f),y=ws(f),g=u.heroic?qt(u,i.combat.heroicVictories):u.difficulty??0,w=i.combat.expeditionSetups[t],p={};if(w!=null&&w.assignedEquipment&&u.group)for(const[H,_]of Object.entries(w.assignedEquipment))_>0&&(p[H]=_);const h=u.group?xt(p,u.group):1,x=u.group?Ss(p,u.group):1,S=g*b*h,$=a.activeRealm==="realm3"?Nn(a.realms.realm3.ascension):0,R=st(d,a.activeRealm,i.upgrades,i.artifacts,a.globalTier,$),k=Rr(S);if(R<k)return!1;let v=null,I=null,T={...i.recipeInventory},L=!1;if(a.activeRealm==="realm3"){for(const H of o){const _=d[H]||0;if(_>0&&(i.recipeInventory[H]??new m(0)).lt(_))return!1}for(const[H,_]of Object.entries(p))if(_>0&&D(T,H).lt(_))return!1;for(const H of o){const _=d[H]||0;_>0&&we(T,H,new m(_))}for(const[H,_]of Object.entries(p))_>0&&we(T,H,new m(_))}else{const H=Mt(a.realms.realm1.recipeInventory),_=Mt(a.realms.realm2.recipeInventory);if(!hl(H,_,d,a.activeRealm,a.globalTier))return!1;const J=vl(H,_,d,a.activeRealm,a.globalTier),ee=a.activeRealm==="realm1"?"realm2":"realm1",X=ee==="realm1"?H:_,re=ee==="realm1"?J.realm1:J.realm2;for(const ce of o){const B=X[ce]??new m(0),se=re[ce]??new m(0);if(!B.eq(se)){L=!0;break}}if(L){v={...a.realms.realm1.recipeInventory},I={...a.realms.realm2.recipeInventory};for(const ce of o)if((d[ce]||0)>0){const se=H[ce]??new m(0),ae=J.realm1[ce]??new m(0),fe=se.sub(ae);fe.gt(0)&&we(v,ce,fe);const me=_[ce]??new m(0),G=J.realm2[ce]??new m(0),W=me.sub(G);W.gt(0)&&we(I,ce,W)}}else for(const ce of o){const B=d[ce]||0;B>0&&we(T,ce,new m(B))}}const q={expeditionId:t,assignedUnits:d,strength:R,successRate:On(R,S),startTime:Date.now(),duration:gn(t,a.activeRealm,c),repeatIfUnitsAvailable:r,speed:c,tauntMultiplier:y,assignedEquipment:Object.keys(p).length>0?p:void 0,equipmentMultiplier:x!==1?x:void 0},j=i.combat.activeExpeditions[t]||[];return n(L&&v&&I?{realms:{...a.realms,realm1:{...a.realms.realm1,recipeInventory:v},realm2:{...a.realms.realm2,recipeInventory:I},[a.activeRealm]:{...a.realms[a.activeRealm],recipeInventory:a.activeRealm==="realm1"?v:I,combat:{...i.combat,activeExpeditions:{...i.combat.activeExpeditions,[t]:[...j,q]}}}}}:$a(a,()=>({recipeInventory:T,combat:{...i.combat,activeExpeditions:{...i.combat.activeExpeditions,[t]:[...j,q]}}}))),!0},lu=(e,n)=>t=>{const s=e(),r=z(s),a=yt(s.activeRealm,s.globalTier),i=r.combat.activeExpeditions[t]||[],o={...r.recipeInventory};for(const c of i){for(const f of a){const b=c.assignedUnits[f]||0;b>0&&He(o,f,new m(b))}if(c.assignedEquipment)for(const[f,b]of Object.entries(c.assignedEquipment))b>0&&He(o,f,new m(b))}const u={...r.combat.activeExpeditions};delete u[t];const l={...r.combat.expeditionSetups};delete l[t];const d={...r.combat.pendingRepeats};delete d[t],n($a(s,()=>({recipeInventory:o,combat:{...r.combat,activeExpeditions:u,expeditionSetups:l,pendingRepeats:d}})))},Bn=1e3,xo=(e,n)=>{const t=e.activeRealm,s=e.realms[t],r={...s,...n(s)};return{realms:{...e.realms,[t]:r}}},uu=(e,n)=>t=>{const s=e(),r=z(s),a=Ce[t];if(!a||et(r.artifacts,t))return!1;const i=D(r.recipeInventory,"artifact_shard").toNumber();if(!ro(t,i))return!1;const o={...r.recipeInventory};return we(o,"artifact_shard",a.cost.artifactShards),n(xo(s,()=>({recipeInventory:o,artifacts:{...r.artifacts,owned:{...r.artifacts.owned,[t]:!0},upgradeLevels:{...r.artifacts.upgradeLevels,[t]:1}}}))),!0},du=(e,n)=>t=>{const s=e(),r=z(s),a=Ce[t];if(!a||!et(r.artifacts,t))return!1;const i=r.artifacts.upgradeLevels[t]??0,o=xs(r.altar.tier,t);if(i>=o)return!1;const u=D(r.recipeInventory,"artifact_shard").toNumber();if(!ao(t,i,u,o))return!1;const l=da(a,i,o),d={...r.recipeInventory};return we(d,"artifact_shard",l.artifactShards),n(xo(s,()=>({recipeInventory:d,artifacts:{...r.artifacts,upgradeLevels:{...r.artifacts.upgradeLevels,[t]:i+1}}}))),!0},fu=(e,n)=>t=>{const s=e(),r=s.realms.realm1,a=s.realms.realm2;if(!et(r.artifacts,t)||D(r.recipeInventory,"nullstone").toNumber()<Bn)return!1;const o=r.artifacts.upgradeLevels[t]??0,u=et(a.artifacts,t),l=a.artifacts.upgradeLevels[t]??0;if(u&&o<=l)return!1;const d={...r.recipeInventory};we(d,"nullstone",new m(Bn));const c={...r.artifacts,owned:{...r.artifacts.owned,[t]:!1},upgradeLevels:{...r.artifacts.upgradeLevels,[t]:0}},f={...a.artifacts,owned:{...a.artifacts.owned,[t]:!0},upgradeLevels:{...a.artifacts.upgradeLevels,[t]:o}};return n({realms:{...s.realms,realm1:{...r,recipeInventory:d,artifacts:c},realm2:{...a,artifacts:f}}}),!0},yo=5,wo=Ze.map(e=>({id:`gem_${e}`,type:"gem",tier:e,name:`T${e} Mana Gem`})),So=tt.map(e=>({id:`flask_${e}`,type:"flask",tier:e,name:`T${e} Flask`})),Mr=[{id:"artifact_shard",type:"expedition_reward",name:"Artifact Shard"},{id:"nullstone",type:"expedition_reward",name:"Nullstone"}],ko=e=>{const n=Je(e),t=zn(e);return[...wo,...So,...n.map(s=>({id:`military_${s}`,type:"military",militaryId:s,name:t[s].name})),...e==="realm1"?Mr:[]]},Xn=e=>{if(e.startsWith("gem_")){const n=parseInt(e.slice(4));return wo.find(t=>t.tier===n)}if(e.startsWith("flask_")){const n=parseInt(e.slice(6));return So.find(t=>t.tier===n)}if(e.startsWith("military_")){const n=e.slice(9);return{id:e,type:"military",militaryId:n,name:n}}if(e==="artifact_shard")return Mr[0];if(e==="nullstone")return Mr[1]},hn={1:{manaRequirement:new m(1e20),crafterSpeedMultiplier:1.2,artifactUpgradeCap:10},2:{manaRequirement:new m(1e20),crafterSpeedMultiplier:7/6,artifactUpgradeCap:100}},Tr=2,$o=!0,ks=(e,n,t)=>{const s=n+1;if(s>Tr)return!1;const r=hn[s];if(!r)return!1;if(t!==void 0){if(s===2&&$o){if(t!=="realm2")return!1}else if(t!=="realm1")return!1}return e.gte(r.manaRequirement)},Mn=e=>e===2&&$o?"realm2":"realm1",mu=e=>{let n=1;for(let t=1;t<=e;t++)hn[t]&&(n*=hn[t].crafterSpeedMultiplier);return n},Io=(e,n)=>{const t=e.activeRealm,s=e.realms[t],r={...s,...n(s)};return{realms:{...e.realms,[t]:r}}},ei=(e,n,t,s="realm1")=>{const r=Rn(s),a={...e.altar,tier:n,activeSacrifice:null,sacrificeProgress:0},i={...r,altar:a,prestige:e.prestige,ascension:e.ascension,combat:{...r.combat,portalBuilt:e.combat.portalBuilt,heroicVictories:e.combat.heroicVictories,completionsPerExpedition:e.combat.completionsPerExpedition},...t&&{artifacts:e.artifacts}};if(t){const o=e.recipeCrafting.artifact_shard;o&&i.recipeCrafting.artifact_shard&&(i.recipeCrafting.artifact_shard.lifetimeProduced=o.lifetimeProduced);const u=e.recipeCrafting.nullstone;u&&i.recipeCrafting.nullstone&&(i.recipeCrafting.nullstone.lifetimeProduced=u.lifetimeProduced)}return i},pu=(e,n)=>()=>{const t=e(),s=z(t),r=t.globalTier+1,a=Mn(r);if(t.activeRealm!==a||!ks(s.mana,t.globalTier,t.activeRealm))return!1;const i=r>=2;if(r===2){const o={};for(const u of We){const l=t.realms[u];o[u]=ei(l,r,i,u)}n({realms:o,globalTier:r,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}else{const o=ei(s,r,i,t.activeRealm);n({realms:{...t.realms,[t.activeRealm]:o},globalTier:r,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}return!0},gu=(e,n)=>t=>{const s=e(),r=z(s);if(s.globalTier<1)return!1;const a=Xn(t);if(!a)return!1;const i=Me(s.activeRealm);if((r.altar.sacrificeCounts[t]||0)>=i.MODIFIERS.sacrificeCap)return!1;let u=null;return a.type==="gem"&&a.tier!==void 0?u=`gem_${a.tier}`:a.type==="flask"&&a.tier!==void 0?u=`flask_${a.tier}`:a.type==="military"&&a.militaryId!==void 0?u=a.militaryId:a.type==="expedition_reward"&&(u=t),(u?D(r.recipeInventory,u).gte(1):!1)?(n(Io(s,()=>({altar:{...r.altar,activeSacrifice:t,sacrificeProgress:0}}))),!0):!1},hu=(e,n)=>()=>{const t=e(),s=z(t);n(Io(t,()=>({altar:{...s.altar,activeSacrifice:null,sacrificeProgress:0}})))},vu=(e,n)=>t=>{const s=e(),r=s.activeRealm,a=z(s),i=D(a.recipeInventory,t),o=a.prestige.prestigeCounts[t]||0;if(!Us(t,i,o))return!1;const u=Os(o),l={...a.recipeInventory};l[t]=i.sub(u);const d={...a.prestige.prestigeCounts};return d[t]=o+1,n(c=>({realms:{...c.realms,[r]:{...c.realms[r],recipeInventory:l,prestige:{...c.realms[r].prestige,prestigeCounts:d}}}})),!0},bu=(e,n)=>t=>{const s=e(),r=s.activeRealm,i=z(s).prestige.autoPrestige[t]??!1;n(o=>({realms:{...o.realms,[r]:{...o.realms[r],prestige:{...o.realms[r].prestige,autoPrestige:{...o.realms[r].prestige.autoPrestige,[t]:!i}}}}}))},Cr=e=>{var r;const n=ne("soulforge"),t=((r=e.recipeCrafting.soulforge)==null?void 0:r.lifetimeProduced)??0,s=new m(n.escalatingCost??10).pow(t);return n.recipe[0].amount.mul(s)},xu=(e,n)=>()=>{var l;const t=e(),s=t.realms.realm1,r=t.realms.realm3,a=Cr(r);if(!Ns(s.recipeInventory,qn,a))return!1;const i={...s.recipeInventory};we(i,qn,a);const o={...r.recipeInventory};He(o,"soulforge",new m(1));const u={...r.recipeCrafting};return u.soulforge={...u.soulforge??{assignment:0,progress:0,lifetimeProduced:0},lifetimeProduced:(((l=u.soulforge)==null?void 0:l.lifetimeProduced)??0)+1},n({realms:{...t.realms,realm1:{...s,recipeInventory:i},realm3:{...r,recipeInventory:o,recipeCrafting:u}}}),!0},Er=e=>{var r;const n=ne("forge_enhancer"),t=((r=e.recipeCrafting.forge_enhancer)==null?void 0:r.lifetimeProduced)??0,s=new m(n.escalatingCost??10).pow(t);return n.recipe[0].amount.mul(s)},yu=(e,n)=>()=>{var l;const t=e(),s=t.realms.realm2,r=t.realms.realm3,a=Er(r);if(!Ns(s.recipeInventory,_n,a))return!1;const i={...s.recipeInventory};we(i,_n,a);const o={...r.recipeInventory};He(o,"forge_enhancer",new m(1));const u={...r.recipeCrafting};return u.forge_enhancer={...u.forge_enhancer??{assignment:0,progress:0,lifetimeProduced:0},lifetimeProduced:(((l=u.forge_enhancer)==null?void 0:l.lifetimeProduced)??0)+1},n({realms:{...t.realms,realm2:{...s,recipeInventory:i},realm3:{...r,recipeInventory:o,recipeCrafting:u}}}),!0},$n=(e,n)=>{var r;const t=Sr[e];return t?(((r=n[t.requiredRecipe])==null?void 0:r.lifetimeProduced)??0)>=t.lifetimeThreshold:!0},wu=(e,n)=>e==="one"?m.min(new m(1),m.floor(n)):e==="ten_percent"?m.max(1,m.floor(n.mul(.1))):m.floor(n),Su=(e,n)=>{const t=ne(n);if(t.recipe.length===0)return new m(1/0);let s=new m(1/0);for(const r of t.recipe)if(r.recipeId){const a=D(e,r.recipeId);s=m.min(s,m.floor(a.div(r.amount)))}return s},ku=(e,n,t)=>{const s=ne(n);for(const r of s.recipe)r.recipeId&&we(e,r.recipeId,r.amount.mul(t))},$u=(e,n)=>t=>{var c;const s=e(),r=s.realms.realm3,a=ne(t);if(a.category!=="building")return!1;const i=((c=r.recipeCrafting[t])==null?void 0:c.lifetimeProduced)??0,o=new m(a.escalatingCost??1).pow(i),u={...r.recipeInventory};for(const f of a.recipe)if(f.recipeId){const b=f.amount.mul(o);if(!Ns(u,f.recipeId,b))return!1}for(const f of a.recipe)f.recipeId&&we(u,f.recipeId,f.amount.mul(o));He(u,t,new m(1));const l={...r.recipeCrafting},d=l[t]??{assignment:0,progress:0,lifetimeProduced:0};return l[t]={...d,lifetimeProduced:d.lifetimeProduced+1},n({realms:{...s.realms,realm3:{...r,recipeInventory:u,recipeCrafting:l}}}),!0},Iu=(e,n)=>(t,s)=>{const r=e(),a=r.realms.realm3;if(!$n(t,a.recipeCrafting))return!1;const i=Su(a.recipeInventory,t),o=m.min(wu(s,i),i);if(o.lte(0))return!1;const u={...a.recipeInventory};ku(u,t,o),He(u,t,o);const l={...a.recipeCrafting},d=l[t]??{assignment:0,progress:0,lifetimeProduced:0};return l[t]={...d,lifetimeProduced:d.lifetimeProduced+o.toNumber()},n({realms:{...r.realms,realm3:{...a,recipeInventory:u,recipeCrafting:l}}}),!0},ti=["soulforge","forge_enhancer",...Object.keys(fn)],Ru=(e,n)=>()=>{const t=e(),s=t.realms.realm3;if(!ps(s.ascension.lifetimePixies))return!1;const r=ms(s.ascension.lifetimePixies);if(r<=0)return!1;const a=As();for(const c of ti)s.recipeInventory[c]&&(a[c]=s.recipeInventory[c]);const i=qs();for(const c of ti)s.recipeCrafting[c]&&(i[c]={...s.recipeCrafting[c]});s.recipeCrafting.arcane_soul&&(i.arcane_soul={...s.recipeCrafting.arcane_soul});const u={...va(),portalBuilt:s.combat.portalBuilt,heroicVictories:s.combat.heroicVictories},l={...s.ascension,ascendedSouls:s.ascension.ascendedSouls+r,lifetimePixies:0,totalAscensions:s.ascension.totalAscensions+1},d={};return n({realms:{...t.realms,realm3:{...s,mana:new m(0),recipeInventory:a,recipeCrafting:i,combat:u,creatureUpgrades:{},creatureUnlocks:{},workshopAssignments:{},wonderAssignments:d,ascension:l}}}),!0},Mu=(e,n)=>t=>{const s=e(),r=s.realms.realm3,a=Kr[t];if(!a)return!1;const i=ct(r.ascension,t);if(i>=a.maxLevel)return!1;const o=gs(t,i);if(r.ascension.ascendedSouls<o)return!1;const u={...r.ascension,ascendedSouls:r.ascension.ascendedSouls-o,upgrades:{...r.ascension.upgrades,[t]:i+1}};return n({realms:{...s.realms,realm3:{...r,ascension:u}}}),!0},Ia="0.87",tr=e=>({mana:e.mana.toString(),recipeInventory:il(e.recipeInventory),recipeCrafting:cl(e.recipeCrafting),upgrades:bl(e.upgrades),autoBuyUpgrades:e.autoBuyUpgrades,combat:Kl(e.combat),artifacts:Ll(e.artifacts),altar:Wl(e.altar),prestige:jl(e.prestige),creatureUpgrades:e.creatureUpgrades,creatureUnlocks:e.creatureUnlocks,workshopAssignments:e.workshopAssignments,wonderAssignments:e.wonderAssignments,ascension:e.ascension}),nr=(e,n="realm1")=>{var o,u;if(!e)return Rn(n);const t=e.artifacts?Pl(e.artifacts):fa(),s=e.combat?Jl(e.combat):va(),r=e.recipeInventory?ol(e.recipeInventory):As(),a=e.recipeCrafting?ll(e.recipeCrafting):qs();let i=e.upgrades?xl(e.upgrades):ea();if((o=e.upgrades)!=null&&o.r1MilitaryStrength&&!((u=e.upgrades)!=null&&u.t1KnightStrength)){const l=e.upgrades.r1MilitaryStrength;i={...i,t1KnightStrength:l,t4KnightStrength:l,t7KnightStrength:l}}return{mana:new m(e.mana||0),recipeInventory:r,recipeCrafting:a,upgrades:i,autoBuyUpgrades:e.autoBuyUpgrades||{},combat:s,artifacts:t,altar:e.altar?Yl(e.altar):pa(),prestige:e.prestige?Gl(e.prestige):lo(),creatureUpgrades:e.creatureUpgrades||{},creatureUnlocks:e.creatureUnlocks||{},workshopAssignments:e.workshopAssignments||{},wonderAssignments:e.wonderAssignments||{},ascension:e.ascension?e.ascension:Xr()}},Ro=e=>JSON.stringify({version:Ia,realms:{realm1:tr(e.realms.realm1),realm2:tr(e.realms.realm2),realm3:tr(e.realms.realm3)},activeRealm:e.activeRealm,realm2Unlocked:e.realm2Unlocked,realm3Unlocked:e.realm3Unlocked,globalTier:e.globalTier,backgroundImageOff:e.backgroundImageOff,uiScale:e.uiScale,lastFrameTimestamp:e.lastFrameTimestamp,totalPlaytime:e.totalPlaytime,skippedTime:e.skippedTime,timeWarpCharges:e.timeWarpCharges,villageUnlocked:e.villageUnlocked,collapsedSections:e.collapsedSections,dismissedTips:e.dismissedTips,paused:e.paused}),Mo=e=>{var n,t;try{const s=JSON.parse(e),r=s.version||null;if(!r)return{state:null,incompatible:!0,savedVersion:r};if(parseFloat(r)<.4)return{state:null,incompatible:!0,savedVersion:r};if(!s.realms||!((n=s.realms.realm1)!=null&&n.recipeInventory))return{state:null,incompatible:!0,savedVersion:r};const a=We.includes(s.activeRealm)?s.activeRealm:"realm1",i=nr(s.realms.realm1,"realm1"),o=nr(s.realms.realm2,"realm2"),u=nr(((t=s.realms)==null?void 0:t.realm3)??null,"realm3"),l=s.globalTier??i.altar.tier;return{state:{realms:{realm1:i,realm2:o,realm3:u},activeRealm:a,realm2Unlocked:s.realm2Unlocked??!1,realm3Unlocked:s.realm3Unlocked??!1,globalTier:l,backgroundImageOff:s.backgroundImageOff??!1,uiScale:s.uiScale??1,lastFrameTimestamp:s.lastFrameTimestamp||Date.now(),totalPlaytime:s.totalPlaytime??0,skippedTime:s.skippedTime??0,timeWarpCharges:s.timeWarpCharges??0,villageUnlocked:s.villageUnlocked??!1,collapsedSections:Array.isArray(s.collapsedSections)?s.collapsedSections:[],dismissedTips:Array.isArray(s.dismissedTips)?s.dismissedTips:[],paused:s.paused??!1},incompatible:!1,savedVersion:r}}catch{return{state:null,incompatible:!1,savedVersion:null}}},Dn="evercraft-save",Hn="evercraft-last-frame",jn="evercraft-last-save",Tu=5e3;let Ra=!1,Ma=0;const Cu=()=>Ra,Eu=()=>Ma,ni=()=>{Ra=!1,Ma=0},Ar=()=>Ia,Au=e=>()=>{localStorage.removeItem(Dn),localStorage.removeItem(Hn),localStorage.removeItem(jn),e(ya())},Nu=e=>()=>{const n=e();return btoa(Ro(n))},qu=(e,n,t)=>s=>{try{const r=atob(s),a=Mo(r);if(a.incompatible){let i=0;try{i=JSON.parse(r).globalTier??0}catch{}const o=ya();return n(o),localStorage.removeItem(Dn),localStorage.removeItem(Hn),localStorage.removeItem(jn),t(!0),{success:!1,incompatible:!0,oldTier:i}}return a.state?(n({...a.state}),t(!0),{success:!0,incompatible:!1}):{success:!1,incompatible:!1}}catch{return{success:!1,incompatible:!1}}},_u=(e,n)=>(t=!1)=>{const s=e(),r=Date.now();!t&&r-s.lastSaveTimestamp<Tu||(localStorage.setItem(Dn,Ro(s)),localStorage.setItem(Hn,s.lastFrameTimestamp.toString()),localStorage.setItem(jn,r.toString()),n({lastSaveTimestamp:r}))},Lu=e=>()=>{const n=localStorage.getItem(Dn),t=localStorage.getItem(Hn),s=localStorage.getItem(jn);if(n){const r=Mo(n);if(r.incompatible){try{Ma=JSON.parse(n).globalTier??0}catch{}Ra=!0,localStorage.removeItem(Dn),localStorage.removeItem(Hn),localStorage.removeItem(jn);return}r.state&&e({...r.state,lastFrameTimestamp:t?parseInt(t,10):Date.now(),lastSaveTimestamp:s?parseInt(s,10):0})}},si=(e,n,t)=>{const s=Pn(),r=t?io(t,n):new m(1);return s.mul(r)},$s=(e,n,t,s,r,a,i,o,u)=>{var c;const l=ne(e);let d;if(l.ignoreModifiers)d=new m(1);else{const f=l.tier,b=l.category,y=na(n);d=new m(i).mul(y),b==="gem"&&f?d=d.mul(Pn()).mul($r()).mul(Ka()).mul(ma(t,f)).mul(f<=4?za():1).mul(f>=5&&f<=6?Xa():1).mul(mo(s.sacrificeCounts,f,r)).mul(a).mul(sa(n)):b==="flask"&&f?d=d.mul(Pn()).mul($r()).mul(Ka()).mul(f<=4?za():1).mul(f>=5&&f<=6?Xa():1).mul(po(s.sacrificeCounts,f,r)).mul(a):b==="military"&&(d=d.mul(go(s.sacrificeCounts,e,r))),o&&(d=d.mul(vt(o.prestigeCounts,e)))}if(l.outputMultipliers&&u){for(const f of l.outputMultipliers)if(!(f.realmFilter&&u.realmId&&!f.realmFilter.includes(u.realmId))){if(f.type==="inventory"&&u.recipeInventory){const b=((c=u.recipeInventory[f.source])==null?void 0:c.toNumber())??0,y=f.formula(b);y!==1&&(d=d.mul(y))}else if(f.type==="ascension"&&u.ascension){const b=u.ascension.upgrades[f.source]??0,y=f.formula(b);y!==1&&(d=d.mul(y))}}}return d},sr=(e,n,t,s,r,a,i,o,u)=>{var y;const l=ne(e),d=l.tier,c=l.category,f=[];if((c==="gem"||c==="flask")&&d?(f.push({label:"Production mult",value:Pn()}),f.push({label:"Yield mult",value:$r()}),c==="gem"?(f.push({label:"Artifact output",value:ma(t,d)}),f.push({label:"Sacrifice bonus",value:mo(s.sacrificeCounts,d,r)}),f.push({label:"Gem Manufacturing",value:sa(n)})):f.push({label:"Sacrifice bonus",value:po(s.sacrificeCounts,d,r)}),f.push({label:"Quest bonus",value:new m(a)})):c==="military"&&f.push({label:"Sacrifice bonus",value:go(s.sacrificeCounts,e,r)}),f.push({label:"Heroic mastery",value:new m(i)}),f.push({label:"Crafter's Guild",value:na(n)}),f.push({label:"Prestige",value:o?vt(o.prestigeCounts,e):new m(1)}),l.outputMultipliers&&u)for(const g of l.outputMultipliers){if(g.realmFilter&&u.realmId&&!g.realmFilter.includes(u.realmId))continue;let w=new m(1);if(g.type==="inventory"&&u.recipeInventory){const p=((y=u.recipeInventory[g.source])==null?void 0:y.toNumber())??0;w=new m(g.formula(p))}else if(g.type==="ascension"&&u.ascension){const p=u.ascension.upgrades[g.source]??0;w=new m(g.formula(p))}f.push({label:g.label,value:w})}const b=f.reduce((g,w)=>g.mul(w.value),new m(1));return{multipliers:f,total:b}},rr=(e,n,t,s)=>{const r=ne(e),a=r.tier,i=r.category,o=[];if((i==="gem"||i==="flask")&&a&&(o.push({label:"Production mult",value:Pn()}),o.push({label:"Artifact input",value:io(t,a)})),i==="gem"&&o.push({label:"Cheaper Gems",value:aa(n)}),i==="flask"&&(o.push({label:"Flask recipe mult",value:new m(s)}),o.push({label:"Cheaper Flasks",value:ia(n)})),i==="military"){o.push({label:"Cheaper Expedition Units",value:oa(n)});const l=ca(n,e);l.eq(1)||o.push({label:"Sword Efficiency",value:l})}const u=o.reduce((l,d)=>l.mul(d.value),new m(1));return{multipliers:o,total:u}},Tn=(e,n,t,s)=>{const r=ne(e);if(r.ignoreModifiers)return r.recipe.map(o=>({type:o.type,recipeId:o.recipeId,amount:o.amount}));const a=r.tier,i=r.category;return r.recipe.map(o=>{let u=o.amount;if(i==="gem"&&a){if(!(a===1&&o.type==="mana")){const d=si(n,a,t);u=u.mul(d)}u=u.mul(aa(n))}else if(i==="flask"&&a){const l=si(n,a,t);u=u.mul(l).mul(s),u=u.mul(ia(n))}else i==="military"&&(u=u.mul(oa(n)),u=u.mul(ca(n,e)));return{type:o.type,recipeId:o.recipeId,amount:u}})},Ta=(e,n,t,s,r)=>{const a=ne(e);if(a.ignoreModifiers)return 1;let o=mu(s)/r;return a.category==="military"&&(o*=Tl()),o*=co(t),o},Pu=(e,n,t,s,r,a,i,o,u,l,d,c,f,b)=>{const y=Ps(u),g=l.completionsPerExpedition??{};let w=new m(0);const p={},h=Ln(u);for(const x of h){p[x]=new m(0);const S=e[x];if(!S||S.assignment<=0)continue;const $=ne(x),R=$.tier??0,k=y?y(R,g):1,I=Ta(x,n,t,r,a)/$.craftTime,T=$s(x,n,t,s,i,k,c,f,b);p[x]=p[x].add(new m(S.assignment).mul(I).mul(T));const L=Tn(x,n,t,d);for(const q of L){const j=q.amount.mul(S.assignment).mul(I);q.type==="mana"?w=w.sub(j):q.recipeId&&(p[q.recipeId]||(p[q.recipeId]=new m(0)),p[q.recipeId]=p[q.recipeId].sub(j))}}if(s.activeSacrifice&&o){const x=s.activeSacrifice;let S=null;x.startsWith("military_")?S=x.replace("military_",""):S=x,S&&p[S]!==void 0?p[S]=p[S].sub(new m(o)):S&&(p[S]=new m(-o))}return{mana:w,recipes:p}},Ou=(e,n)=>{var i;const t={};let s=0;const r=fs(e),a=n?An(n):1;for(const[o,u]of Object.entries(dn)){const l=((i=e[o])==null?void 0:i.toNumber())??0;if(l<=0)continue;const d=u.amountPerCycle/u.cycleDuration*l*r*a;u.produces==="mana"?s+=d:t[u.produces]=(t[u.produces]??0)+d}return{recipes:t,mana:s}},Uu=10080*60*1e3,ri=(e,n,t,s)=>{for(const r of e){const a=r.amount.mul(n);if(r.type==="mana"){if(t.lt(a))return!1}else if(r.recipeId&&!Ns(s,r.recipeId,a))return!1}return!0},Fu=(e,n,t,s)=>{let r=t;for(const a of e){const i=a.amount.mul(n);a.type==="mana"?r=r.sub(i):a.recipeId&&we(s,a.recipeId,i)}return r},Bu=(e,n,t,s,r,a={},i,o)=>{var Ne,U;const u=Me(e),l=u.MODIFIERS.craftTimeMultiplier,d=u.MODIFIERS.flaskRecipeMultiplier,c=u.MODIFIERS.manaModifier,f=u.MODIFIERS.calculateSacrificeBonus,b=u.MODIFIERS.sacrificeCap,y=u.MODIFIERS.sacrificeBatchSize,g=Ps(e),w=Un(a,e);let p=n.mana;const h={};for(const[A,E]of Object.entries(n.recipeInventory))h[A]=E;const x={};for(const[A,E]of Object.entries(n.recipeCrafting))x[A]={...E};const S=Ln(e),$={recipeInventory:h,ascension:i,realmId:e},R={},k={},v={};for(const A of S){const F=ne(A).tier??0,N=g?g(F,n.combat.completionsPerExpedition):1;R[A]=Tn(A,n.upgrades,n.artifacts,d),k[A]=$s(A,n.upgrades,n.artifacts,n.altar,f,N,w,n.prestige,$),v[A]=Ta(A,n.upgrades,n.artifacts,r,l)}const I=A=>{const E=x[A];if(!E||E.assignment<=0)return!1;const F=R[A];if(!ri(F,E.assignment,p,h))return!1;p=Fu(F,E.assignment,p,h);const N=k[A].mul(E.assignment);return He(h,A,N),E.lifetimeProduced+=N.toNumber(),E.progress=0,!0},T=()=>{for(const A of S){const E=x[A];E&&E.progress>=1&&I(A)}},L=()=>Nt(h);let q=t/1e3;const H=q>600,_=Yi(e),J=fs(h),ee=e==="realm3"?An(n.ascension):1;let X=0;const re=A=>{for(const E of _){const F=dn[E];if(!F)continue;const N=D(h,E).toNumber();if(N<=0)continue;const V=x[E]??{assignment:N,progress:0,lifetimeProduced:0};x[E]=V,V.assignment=N,V.progress+=A*ee/F.cycleDuration;const ie=Math.floor(V.progress);if(ie>0){const le=new m(ie*N).mul(F.amountPerCycle).mul(J);if(F.produces==="mana")p=p.add(le);else{He(h,F.produces,le);const oe=x[F.produces]??{assignment:0,progress:0,lifetimeProduced:0};x[F.produces]=oe,oe.lifetimeProduced+=le.toNumber(),F.produces==="pixie"&&(X+=le.toNumber())}V.progress-=ie}}},ce=hs(e),B={...n.workshopAssignments},se=A=>{for(const E of ce){const F=B[E]||0;if(F<=0)continue;const N=ne(E),V=x[E]??{assignment:F,progress:0,lifetimeProduced:0};x[E]=V,V.assignment=F,V.progress+=A/N.craftTime;const ie=Math.floor(V.progress);if(ie>0){const le=new m(ie*F);He(h,E,le),V.lifetimeProduced+=le.toNumber(),V.progress-=ie}}},ae=vs(e),fe={...n.wonderAssignments},me=A=>{for(const E of ae){const F=fe[E]||0;if(F<=0)continue;const N=fn[E];if(!N)continue;const V=D(h,E).toNumber(),ie=Math.pow(N.costEscalation,V),le=N.baseTicks*ie,oe=x[E]??{assignment:F,progress:0,lifetimeProduced:0};x[E]=oe,oe.assignment=F;const ue=F/N.secondsPerTick;let Pe=A*ue;for(const je of N.tickCost){const Re=je.amount,Ee=D(h,je.recipeId).div(Re).toNumber();Pe=Math.min(Pe,Ee)}if(Pe<=0)continue;const ft=oe.progress*le,kt=le-ft;Pe=Math.min(Pe,kt);for(const je of N.tickCost){const Re=je.amount*Pe;we(h,je.recipeId,new m(Re))}oe.progress+=Pe/le,oe.progress>=1-1e-9&&(He(h,E,new m(1)),oe.lifetimeProduced+=1,oe.progress=0)}};if(H){const E={};for(const N of S){const V=x[N];if(!V||V.assignment<=0||!Xe(N,x))continue;const ie=ne(N),le=v[N],ue=60/(ie.craftTime/le)*V.assignment;E[N]={costs:R[N].map(Ie=>({...Ie,amount:Ie.amount.mul(ue)})),output:k[N].mul(ue)}}let F=0;for(;q>0;){if(F++,F>10100){console.error(`[processRealm ${e}] crafting loop exceeded 10100 iterations, breaking!`);break}const N=Math.min(60,q),V=N/60;e!=="realm3"&&(p=Ja(p,L(),new m(N),c));const ie=[];for(const le in E){const oe=E[le];if(ri(oe.costs.map(ue=>({...ue,amount:ue.amount.mul(V)})),1,p,h)){for(const ue of oe.costs){const Ie=ue.amount.mul(V);ue.type==="mana"?p=p.sub(Ie):ue.recipeId&&we(h,ue.recipeId,Ie)}ie.push(le)}}for(const le of ie){const oe=E[le].output.mul(V);He(h,le,oe);const ue=x[le];ue&&(ue.lifetimeProduced+=oe.toNumber())}re(N),se(N),me(N),q-=N}for(const N of S){const V=x[N];V&&(V.progress=0)}}else{let A=0;for(;q>0;){if(A++,A>1e4){console.error(`[processRealm ${e}] crafting loop exceeded 10000 iterations, breaking!`);break}T();let E=q,F=null;for(const N of S){const V=x[N];if(!V||V.assignment<=0||!Xe(N,x)||V.progress>=1)continue;const ie=ne(N),le=v[N]/ie.craftTime,oe=(1-V.progress)/le;oe<=E&&(E=oe,F=N)}for(const N of _){const V=dn[N];if(!V)continue;const ie=D(h,N).toNumber();if(ie<=0)continue;const le=x[N]??{assignment:ie,progress:0,lifetimeProduced:0};x[N]=le;const oe=le.progress%1,ue=(oe<1e-9?1:1-oe)*V.cycleDuration;ue<E&&(E=ue,F=null)}e!=="realm3"&&(p=Ja(p,L(),new m(E),c)),re(E),se(E),me(E);for(const N of S){const V=x[N];if(!V||V.assignment<=0||!Xe(N,x)||V.progress>=1)continue;const ie=ne(N),le=v[N]/ie.craftTime;V.progress+=E*le}if(q-=E,F===null){if(q<=0)break;continue}I(F)||(x[F].progress=1)}for(const E of S){const F=x[E];F&&(F.progress=Math.min(1,F.progress))}}const G={};let W={...n.combat},he=0;const pe=[],ge=Ls(n.upgrades);let ve=0;for(;;){if(ve++,ve>1e4){console.error(`[processRealm ${e}] expedition loop exceeded 10000 iterations, breaking!`);break}let A=s+1,E=null,F=-1;for(const[Re,Ee]of Object.entries(W.activeExpeditions))for(let De=0;De<Ee.length;De++){const Ge=Ee[De],Oe=Ge.startTime+Ge.duration;Oe<=s&&Oe<A&&(A=Oe,E=Re,F=De)}if(E===null)break;const N=W.activeExpeditions[E],V=N[F],le=Math.random()<V.successRate,oe=Ye(E,e);let ue,Ie=0,Pe=0;if(le&&oe){ue=oe.rewards;const Re=V.tauntMultiplier??1,Ee=Bs(W.heroicVictories,e),De=vt(n.prestige.prestigeCounts,"artifact_shard").toNumber(),Ge=vt(n.prestige.prestigeCounts,"nullstone").toNumber(),Oe=ga(n.altar.sacrificeCounts,f).toNumber(),qe=ha(n.altar.sacrificeCounts,f).toNumber();Ie=Math.round((ue.artifactShards||0)*Re*Ee*De*Oe),Pe=Math.round((ue.nullstone||0)*Re*Ge*qe),Ie>0&&(He(h,"artifact_shard",new m(Ie)),x.artifact_shard&&(x.artifact_shard.lifetimeProduced+=Ie)),he+=Pe;const Te=V.equipmentMultiplier??1,Ve=Math.ceil((ue.arcaneBars||0)*Te),mt=Math.ceil((ue.arcaneLogs||0)*Te);Ve>0&&He(h,"arcane_bar",new m(Ve)),mt>0&&He(h,"arcane_log",new m(mt)),W={...W,completionsPerExpedition:{...W.completionsPerExpedition,[E]:(W.completionsPerExpedition[E]||0)+1}},oe.heroic&&(W={...W,heroicVictories:{...W.heroicVictories,[E]:(W.heroicVictories[E]||0)+1}})}const ft=V.equipmentMultiplier??1,kt=ue&&{...ue,...ue.artifactShards?{artifactShards:Ie}:{},...ue.nullstone?{nullstone:Pe}:{},...ue.arcaneBars?{arcaneBars:Math.ceil(ue.arcaneBars*ft)}:{},...ue.arcaneLogs?{arcaneLogs:Math.ceil(ue.arcaneLogs*ft)}:{}};pe.push({expeditionId:E,success:le,successRate:V.successRate,timestamp:A,rewards:kt});const je=[...N];if(je.splice(F,1),je.length>0)W={...W,activeExpeditions:{...W.activeExpeditions,[E]:je}};else{const{[E]:Re,...Ee}=W.activeExpeditions;if(W={...W,activeExpeditions:Ee},oe!=null&&oe.heroic&&W.expeditionSetups[E]){const{[E]:De,...Ge}=W.expeditionSetups;W={...W,expeditionSetups:Ge}}}if(V.repeatIfUnitsAvailable){const Re=W.expeditionSetups[E];if(Re&&Re.repeatIfUnitsAvailable&&oe){let Ee=!0;for(const[at,ze]of Object.entries(Re.assignedUnits)){if(ze<=0)continue;const Ke=Rt[at],it=(Ke==null?void 0:Ke.crossRealmPooling)&&r>=Ke.crossRealmPooling.minGlobalTier&&(!Ke.crossRealmPooling.targetRealms||Ke.crossRealmPooling.targetRealms.includes(e));if(it&&o){const Qn=Ke.realmId,Wt=((Ne=G[Qn])==null?void 0:Ne[at])||0;if((o[Qn]?D(o[Qn],at).sub(Wt):new m(0)).lt(ze)){Ee=!1;break}}else if(it){Ee=!1;break}else if(D(h,at).lt(ze)){Ee=!1;break}}const De=Re.assignedEquipment||{};for(const[at,ze]of Object.entries(De))if(ze>0&&D(h,at).lt(ze)){Ee=!1;break}const Ge=W.activeExpeditions[E]||[],Oe=Ge.length<ge,qe=ys(Re.assignedUnits,e,r),Te=nt(Re.assignedUnits,e,r),Ve=bt(Te),mt=ws(Te),$t=oe.group?xt(De,oe.group):1,Vs=oe.group?Ss(De,oe.group):1,Ba=(oe.heroic?Math.round(oe.heroic.baseDifficulty*Math.pow(oe.heroic.difficultyScaling,W.heroicVictories[E]||0)):oe.difficulty??0)*Ve*$t,ac=e==="realm3"?Nn(n.ascension):0,Ws=st(Re.assignedUnits,e,n.upgrades,n.artifacts,r,ac),ic=Rr(Ba),Da=Ws>=ic;if(Ee&&Oe&&Da){for(const[ze,Ke]of Object.entries(Re.assignedUnits)){if(Ke<=0)continue;const it=Rt[ze];if((it==null?void 0:it.crossRealmPooling)&&r>=it.crossRealmPooling.minGlobalTier&&(!it.crossRealmPooling.targetRealms||it.crossRealmPooling.targetRealms.includes(e))){const Wt=it.realmId;G[Wt]||(G[Wt]={}),G[Wt][ze]=(G[Wt][ze]||0)+Ke}else we(h,ze,new m(Ke))}for(const[ze,Ke]of Object.entries(De))Ke>0&&we(h,ze,new m(Ke));const at={expeditionId:E,assignedUnits:{...Re.assignedUnits},strength:Ws,successRate:On(Ws,Ba),startTime:A,duration:gn(E,e,qe),repeatIfUnitsAvailable:!0,speed:qe,tauntMultiplier:mt,assignedEquipment:Object.keys(De).length>0?{...De}:void 0,equipmentMultiplier:Vs!==1?Vs:void 0};W={...W,activeExpeditions:{...W.activeExpeditions,[E]:[...Ge,at]}}}else if(!Ee&&Oe&&Da){const at=W.pendingRepeats[E]||0;W={...W,pendingRepeats:{...W.pendingRepeats,[E]:at+1}}}}}}if(pe.length>0){const A=[...W.expeditionLog,...pe],E={};for(const N of A)E[N.expeditionId]||(E[N.expeditionId]=[]),E[N.expeditionId].push(N);const F=[];for(const N of Object.values(E))F.push(...N.slice(-20));F.sort((N,V)=>N.timestamp-V.timestamp),W={...W,expeditionLog:F}}for(const[A,E]of Object.entries(W.pendingRepeats)){if(E<=0)continue;const F=W.expeditionSetups[A],N=Ye(A,e);if(!F||!N)continue;const V=W.activeExpeditions[A]||[];if(V.length>=ge)continue;const ie=ys(F.assignedUnits,e,r),le=nt(F.assignedUnits,e,r),oe=bt(le),ue=ws(le),Ie=F.assignedEquipment||{},Pe=N.group?xt(Ie,N.group):1,ft=N.group?Ss(Ie,N.group):1,je=(N.heroic?Math.round(N.heroic.baseDifficulty*Math.pow(N.heroic.difficultyScaling,W.heroicVictories[A]||0)):N.difficulty??0)*oe*Pe,Re=e==="realm3"?Nn(n.ascension):0,Ee=st(F.assignedUnits,e,n.upgrades,n.artifacts,r,Re),De=Rr(je);if(Ee<De)continue;let Ge=!0;for(const[Oe,qe]of Object.entries(F.assignedUnits)){if(qe<=0)continue;const Te=Rt[Oe],Ve=(Te==null?void 0:Te.crossRealmPooling)&&r>=Te.crossRealmPooling.minGlobalTier&&(!Te.crossRealmPooling.targetRealms||Te.crossRealmPooling.targetRealms.includes(e));if(Ve&&o){const mt=Te.realmId,$t=((U=G[mt])==null?void 0:U[Oe])||0;if((o[mt]?D(o[mt],Oe).sub($t):new m(0)).lt(qe)){Ge=!1;break}}else if(Ve){Ge=!1;break}else if(D(h,Oe).lt(qe)){Ge=!1;break}}for(const[Oe,qe]of Object.entries(Ie))if(qe>0&&D(h,Oe).lt(qe)){Ge=!1;break}if(Ge){for(const[qe,Te]of Object.entries(F.assignedUnits)){if(Te<=0)continue;const Ve=Rt[qe];if((Ve==null?void 0:Ve.crossRealmPooling)&&r>=Ve.crossRealmPooling.minGlobalTier&&(!Ve.crossRealmPooling.targetRealms||Ve.crossRealmPooling.targetRealms.includes(e))){const $t=Ve.realmId;G[$t]||(G[$t]={}),G[$t][qe]=(G[$t][qe]||0)+Te}else we(h,qe,new m(Te))}for(const[qe,Te]of Object.entries(Ie))Te>0&&we(h,qe,new m(Te));const Oe={expeditionId:A,assignedUnits:{...F.assignedUnits},strength:Ee,successRate:On(Ee,je),startTime:s,duration:gn(A,e,ie),repeatIfUnitsAvailable:!0,speed:ie,tauntMultiplier:ue,assignedEquipment:Object.keys(Ie).length>0?{...Ie}:void 0,equipmentMultiplier:ft!==1?ft:void 0};W={...W,activeExpeditions:{...W.activeExpeditions,[A]:[...V,Oe]},pendingRepeats:{...W.pendingRepeats,[A]:E-1}}}}let Z={...n.altar};if(Z.activeSacrifice&&r>=1){const A=Xn(Z.activeSacrifice);if(A)if((Z.sacrificeCounts[Z.activeSacrifice]||0)>=b)Z={...Z,activeSacrifice:null,sacrificeProgress:0};else{const F=t/1e3;let N=Z.sacrificeProgress+F,V={...Z.sacrificeCounts};for(;N>=1;){let ie=null;A.type==="military"&&A.militaryId?ie=A.militaryId:A.type==="expedition_reward"?ie=A.id:A.tier!==void 0&&(ie=`${A.type}_${A.tier}`);let le=!1;if(ie&&(A.type==="gem"&&A.tier===1?le=D(h,ie).gt(yo+y-1):le=D(h,ie).gte(y)),!le){Z={...Z,sacrificeProgress:1,sacrificeCounts:V};break}const oe=V[Z.activeSacrifice]||0;if(oe>=b){Z={...Z,activeSacrifice:null,sacrificeProgress:0,sacrificeCounts:V};break}const ue=Math.min(y,b-oe);ie&&we(h,ie,new m(ue)),V[Z.activeSacrifice]=oe+ue,N-=1}Z.activeSacrifice&&(Z={...Z,sacrificeProgress:N,sacrificeCounts:V})}}const Le=e==="realm3"&&X>0?{...n.ascension,lifetimePixies:n.ascension.lifetimePixies+X}:n.ascension;return{updatedRealmState:{mana:p,recipeInventory:h,recipeCrafting:x,upgrades:n.upgrades,autoBuyUpgrades:n.autoBuyUpgrades,combat:W,artifacts:n.artifacts,altar:Z,prestige:n.prestige,creatureUpgrades:n.creatureUpgrades,creatureUnlocks:n.creatureUnlocks,workshopAssignments:n.workshopAssignments,wonderAssignments:n.wonderAssignments,ascension:Le},nullstoneEarned:he,crossRealmDeductions:G}},Du=()=>{var u;const e=M.getState(),n=Date.now();if(e.paused){M.setState({lastFrameTimestamp:n}),e.saveToStorage();return}let t=n-e.lastFrameTimestamp;if(t=Math.min(t,Uu),t<=0){M.setState({lastFrameTimestamp:n}),e.saveToStorage();return}const s={};let r=0;const a=e.realms.realm1.combat.heroicVictories,i=[],o={};for(const l of We)o[l]=e.realms[l].recipeInventory;for(const l of We){let d=e.realms[l];if(l==="realm3"){const f=D(d.recipeInventory,"soulforge").toNumber(),b=((u=d.recipeCrafting.arcane_soul)==null?void 0:u.assignment)??0;f!==b&&(d={...d,recipeCrafting:{...d.recipeCrafting,arcane_soul:{...d.recipeCrafting.arcane_soul??{progress:0,lifetimeProduced:0},assignment:f}}})}const c=Bu(l,d,t,n,e.globalTier,a,e.realms.realm3.ascension,o);s[l]=c.updatedRealmState,r+=c.nullstoneEarned,i.push(c.crossRealmDeductions)}for(const l of i)for(const[d,c]of Object.entries(l)){const f=s[d].recipeInventory;for(const[b,y]of Object.entries(c))we(f,b,new m(y))}if(r>0){const l=s.realm1.recipeInventory,d=s.realm1.recipeCrafting;He(l,"nullstone",new m(r)),d.nullstone&&(d.nullstone.lifetimeProduced+=r)}if(M.setState({realms:s,lastFrameTimestamp:n,totalPlaytime:e.totalPlaytime+t}),e.globalTier>=1){const l=M.getState(),d=z(l),c=l.globalTier;for(const f of _s)l.activeRealm==="realm2"&&an.includes(f)||l.activeRealm==="realm1"&&rn.includes(f)||d.autoBuyUpgrades[f]&&(gt(d.upgrades,f,c)||Kn(d.upgrades,f,d.mana,Nt(d.recipeInventory),xn(d.recipeInventory),c,d.recipeInventory)&&M.getState().purchaseUpgrade(f))}if(e.globalTier>=2)for(const l of We){const c=M.getState().realms[l],{autoPrestige:f,prestigeCounts:b}=c.prestige;for(const y of Object.keys(f)){if(!f[y])continue;const g=D(c.recipeInventory,y),w=b[y]||0;if(Us(y,g,w)){const p=Os(w),h={...c.recipeInventory};h[y]=g.sub(p);const x={...b};x[y]=w+1,M.setState(S=>({realms:{...S.realms,[l]:{...S.realms[l],recipeInventory:h,prestige:{...S.realms[l].prestige,prestigeCounts:x}}}}))}}}e.saveToStorage()},Pt=(e,n)=>{const t=e.activeRealm,s=e.realms[t],r={...s,...n(s)};return{realms:{...e.realms,[t]:r}}},M=cc()((e,n)=>{const t=_u(n,e);return{...ya(),setMana:s=>{e(r=>Pt(r,()=>({mana:s})))},addMana:s=>{e(r=>Pt(r,a=>({mana:a.mana.add(s)})))},spendMana:s=>{const r=n();return z(r).mana.gte(s)?(e(i=>Pt(i,o=>({mana:o.mana.sub(s)}))),!0):!1},addGem:(s,r)=>{e(a=>Pt(a,i=>{const o=Ya(s),u={...i.recipeInventory};return He(u,o,r),{recipeInventory:u}}))},removeGem:(s,r)=>{e(a=>Pt(a,i=>{const o=Ya(s),u={...i.recipeInventory};return we(u,o,r),{recipeInventory:u}}))},getManaPerSecond:()=>{const s=z(n());return wa(Nt(s.recipeInventory))},assignCrafter:Qs("crafting",n,e),assignAllCrafters:Js("crafting",n,e),unassignAllCrafters:er("crafting",n,e),assignFlaskCrafter:Qs("flaskCrafting",n,e),assignAllFlaskCrafters:Js("flaskCrafting",n,e),unassignAllFlaskCrafters:er("flaskCrafting",n,e),assignMilitaryCrafter:Qs("militaryCrafting",n,e),assignAllMilitaryCrafters:Js("militaryCrafting",n,e),unassignAllMilitaryCrafters:er("militaryCrafting",n,e),getTotalCrafters:()=>{const s=z(n());return bs(s.upgrades)},getAvailableCrafters:()=>{const s=z(n());return Ki(bs(s.upgrades),s.recipeCrafting)},purchaseUpgrade:au(n,e),toggleAutoBuy:iu(n,e),startExpedition:cu(n,e),saveExpeditionSetup:ou(n,e),clearExpedition:lu(n,e),craftArtifact:uu(n,e),upgradeArtifact:du(n,e),shipArtifact:fu(n,e),prestigeRecipe:vu(n,e),toggleAutoPrestige:bu(n,e),togglePause:()=>{e(s=>({paused:!s.paused}))},toggleBackgroundImage:()=>{e(s=>({backgroundImageOff:!s.backgroundImageOff}))},toggleTabHighlighting:()=>{e(s=>({tabHighlightingOff:!s.tabHighlightingOff}))},setUiScale:s=>{e({uiScale:Math.max(.5,Math.min(1.3,s))})},tierReset:pu(n,e),startSacrifice:gu(n,e),stopSacrifice:hu(n,e),setActiveRealm:s=>{const r=n();s==="realm2"&&!r.realm2Unlocked||s==="realm3"&&!r.realm3Unlocked||e({activeRealm:s})},unlockRealm2:()=>{e({realm2Unlocked:!0})},unlockRealm3:()=>{e({realm3Unlocked:!0})},setWorkshopAssignment:(s,r)=>{e(a=>Pt(a,i=>({workshopAssignments:{...i.workshopAssignments,[s]:Math.max(0,r)}})))},setWonderAssignment:(s,r)=>{e(a=>Pt(a,i=>({wonderAssignments:{...i.wonderAssignments,[s]:Math.max(0,r)}})))},craftSoulforge:xu(n,e),craftForgeEnhancer:yu(n,e),buyCreature:Iu(n,e),buyBuilding:$u(n,e),ascend:Ru(n,e),purchaseAscensionUpgrade:Mu(n,e),hardReset:Au(e),exportSave:Nu(n),importSave:qu(n,e,t),saveToStorage:t,loadFromStorage:Lu(e)}}),Is=(e,n)=>(e instanceof m?e:new m(e)).toExponential(n).replace("e+","e"),P=e=>{const n=e instanceof m?e.toNumber():e;if(!Number.isFinite(n))return e instanceof m?Is(e,1):n.toString();const t=Math.abs(n),s=n<0?"-":"";if(t<10)return s+t.toFixed(2);if(t<100)return s+t.toFixed(1);if(t<1e3)return s+t.toFixed(0);if(t<1e6){const r=t/1e3;return r<10?s+r.toFixed(2)+"k":r<100?s+r.toFixed(1)+"k":s+r.toFixed(0)+"k"}if(t<1e9){const r=t/1e6;return r<10?s+r.toFixed(2)+"m":r<100?s+r.toFixed(1)+"m":s+r.toFixed(0)+"m"}if(t<1e12){const r=t/1e9;return r<10?s+r.toFixed(2)+"b":r<100?s+r.toFixed(1)+"b":s+r.toFixed(0)+"b"}if(t<1e15){const r=t/1e12;return r<10?s+r.toFixed(2)+"t":r<100?s+r.toFixed(1)+"t":s+r.toFixed(0)+"t"}return s+Is(t,1)},Y=e=>{const n=e instanceof m?e.toNumber():e;if(!Number.isFinite(n))return e instanceof m?Is(e,0):n.toString();const t=Math.abs(n),s=n<0?"-":"";if(t<1e3)return s+Math.floor(t).toString();if(t<1e6){const r=t/1e3;return s+r.toFixed(r<10?1:0)+"k"}if(t<1e9){const r=t/1e6;return s+r.toFixed(r<10?1:0)+"m"}if(t<1e12){const r=t/1e9;return s+r.toFixed(r<10?1:0)+"b"}if(t<1e15){const r=t/1e12;return s+r.toFixed(r<10?1:0)+"t"}return s+Is(t,0)},Jn=e=>{const n=e.trim().toLowerCase();if(n==="")return NaN;const t={k:1e3,m:1e6,b:1e9,t:1e12},s=n[n.length-1];if(t[s]){const a=parseFloat(n.slice(0,-1));return isNaN(a)?NaN:Math.floor(a*t[s])}const r=parseFloat(n);return isNaN(r)?NaN:Math.floor(r)},Gt=e=>{const n=e instanceof m?e.toNumber():e;return n===0?"":`(${n>0?"+":""}${P(n)}/s)`},vn=(e,n,t="arcane")=>e?"border-muted--30 text-muted--50 line-through cursor-not-allowed":n?`border-${t} text-${t} hover-bg-${t}--20 cursor-pointer`:"border-muted--30 text-muted--50 cursor-not-allowed",ai=(e,n,t="arcane")=>e||!n?"border-muted--30 cursor-not-allowed":`border-${t} hover-bg-${t}--20 cursor-pointer`,To=()=>{let e="";return n=>n===e?!1:(e=n,!0)},on=(e,n,t=!1)=>{e&&(e.style.width=`${n*100}%`,e.className=`h-full craft-progress-fill${t?" blocked":""}`)},Co=e=>`absolute inset-0 ${e>=1?"bg-steel--40":"bg-steel--30"}`,Tt=(e,n)=>`<div ${n} class="${Co(e)}" style="width: ${e*100}%"></div>`,Ct=(e,n,t=!1)=>{e&&(t?e.style.display="none":(e.style.display="",e.style.width=`${n*100}%`,e.className=Co(n)))},Hu=e=>e===0?"":`<span class="text-xs font-mono ${e>0?"text-positive":"text-red"}">${Gt(e)}</span>`,pt=(e,n)=>{e&&(e.innerHTML=Hu(n))},Ca=(e,n,t,s="")=>e.map((r,a)=>`
    <span class="flex items-center gap-1">
      ${a>0?'<span class="text-text mx-1">+</span>':""}
      <img src="${r.icon}" alt="${r.alt}" style="width: 40px; height: 40px;" class="object-contain">
      <span class="text-text text-sm" data-${n}recipe-amount="${t}-${a}">${r.amount.eq(0)?"free":P(r.amount)}${s}</span>
    </span>
  `).join(""),cn=(e,n,t)=>{let s="";n&&(s+=`<div class="tooltip-title">${n}</div>`,s+='<div class="tooltip-divider"></div>');for(const a of e)s+='<div class="tooltip-row">',s+=`<span class="tooltip-label">${a.label}</span>`,a.value!==void 0&&(s+=`<span class="tooltip-value ${a.valueClass??""}">${a.value}</span>`),s+="</div>";return`<span class="hover-tooltip-wrapper">${t??'<span class="text-muted cursor-help">?</span>'}<div class="hover-tooltip">${s}</div></span>`},xe={Inventory:1,Crafting:2,Upgrades:4,Combat:8,Artifacts:16,Altar:32,Tier:64,Realm:128,Prestige:512,Ascension:256,TabBar:1024,Village:2048},ju=Object.values(xe).reduce((e,n)=>e|n,0);let Ut=0,Nr=xe.Crafting;const Gu=e=>{Ut|=e},Eo=()=>{Ut=ju},Ao=e=>{Nr=e,Gu(e)},Cn=new Map,Gn=(e,n)=>{Cn.set(e,n)},No=e=>{Cn.delete(e)},Vu=()=>{var e,n,t;Ut!==0&&(Ut&xe.Inventory&&((e=Cn.get(xe.Inventory))==null||e()),Ut&xe.TabBar&&((n=Cn.get(xe.TabBar))==null||n()),Ut&Nr&&((t=Cn.get(Nr))==null||t()),Ut=0)},Wu={arcane_soul:"SOUL",arcane_warden:"WARD"},Yu=(e,n)=>Wu[e]??n.slice(0,4).toUpperCase(),Ku=(e,n,t,s=0)=>{const r=e[1],a=r.mul($e[1].effect.value),i=[];let o=a;for(const d of Ze.slice(1)){const c=e[d];if(c.gt(0)){const f=$e[d],b=new m(1).add(c.mul(f.effect.value.sub(1)));i.push({tier:d,count:c,individualMultiplier:f.effect.value,tierMultiplier:b}),o=o.mul(b)}}const u=t!==void 0,l=t?t(o):o;return{baseGeneration:a,t1Count:r,multipliers:i,preModifierTotal:o,hasModifier:u,totalGeneration:l,craftingRate:n.toNumber(),pixieRate:s,netRate:l.add(n).toNumber()+s}},ar=e=>{const n={};for(const t of Object.values(e.activeExpeditions))for(const s of t){if(!s.repeatIfUnitsAvailable)continue;const r=s.duration/1e3;if(!(r<=0))for(const[a,i]of Object.entries(s.assignedUnits))i<=0||(n[a]=(n[a]||0)+i/r)}return n},zu=(e,n,t,s)=>{let r=0,a=0,i=0,o=0;const u=Bs(e.heroicVictories,n),l=vt(t.prestigeCounts,"artifact_shard").toNumber(),d=vt(t.prestigeCounts,"nullstone").toNumber(),c=Me(n).MODIFIERS.calculateSacrificeBonus,f=ga(s,c).toNumber(),b=ha(s,c).toNumber();for(const[y,g]of Object.entries(e.activeExpeditions))for(const w of g){if(!w.repeatIfUnitsAvailable)continue;const p=Ye(y,n);if(!p)continue;const h=w.tauntMultiplier??1,x=p.rewards.artifactShards||0,S=p.rewards.nullstone||0,$=Math.round(x*h*u*l*f),R=Math.round(S*h*d*b),k=w.duration/1e3;if(k>0){r+=$*w.successRate/k,a+=R*w.successRate/k;const v=w.equipmentMultiplier??1,I=p.rewards.arcaneBars||0,T=p.rewards.arcaneLogs||0;i+=I*v*w.successRate/k,o+=T*v*w.successRate/k}}return{shardsPerSecond:r,nullstonePerSecond:a,arcaneBarsPerSecond:i,arcaneLogsPerSecond:o}},_e={gems:!1,flasks:!1,military:!1,expeditions:!1,creatures:!1};let de=null,Rs=!1,is=null,os=null;const Xu=e=>{const n=is;if(!n)return;const t=n.querySelector("[data-tooltip-t1]");if(t){const l=t.querySelector(".tooltip-label"),d=t.querySelector(".tooltip-value");l&&(l.innerHTML=`<img src="${$e[1].icon}" class="tooltip-icon"> ${P(e.t1Count)} T1 gems  ${P($e[1].effect.value)}/s`),d&&(d.textContent=`+${P(e.baseGeneration)}/s`)}const s=n.querySelector("[data-tooltip-multipliers]");if(s)if(e.multipliers.length>0){s.classList.remove("hidden");let l='<div class="tooltip-section">Multipliers</div>';for(const d of e.multipliers)l+='<div class="tooltip-row">',l+='<span class="tooltip-label">',l+=`<img src="${$e[d.tier].icon}" class="tooltip-icon"> `,l+=`${P(d.count)} T${d.tier} gems`,l+="</span>",l+=`<span class="tooltip-value text-gold"> x${P(d.tierMultiplier)} multiplier</span>`,l+="</div>";s.innerHTML=l}else s.classList.add("hidden");const r=n.querySelector("[data-tooltip-mana-globe]");r&&r.classList.add("hidden");const a=n.querySelector("[data-tooltip-modifier]");if(a)if(e.hasModifier){a.classList.remove("hidden");const l=a.querySelector(".tooltip-label"),d=a.querySelector(".tooltip-value");l&&(l.textContent=`${P(e.preModifierTotal)} (R2 effect)`),d&&(d.textContent=`=${P(e.totalGeneration)}/s`)}else a.classList.add("hidden");const i=n.querySelector("[data-tooltip-crafting]");if(i)if(e.craftingRate!==0){i.classList.remove("hidden");const l=i.querySelector(".tooltip-label"),d=i.querySelector(".tooltip-value");l&&(l.textContent=`Crafting ${e.craftingRate>0?"production":"consumption"}`),d&&(d.textContent=Gt(e.craftingRate),d.className=`tooltip-value ${e.craftingRate>0?"text-positive":"text-red"}`)}else i.classList.add("hidden");const o=n.querySelector("[data-tooltip-pixie]");if(o)if(e.pixieRate>0){o.classList.remove("hidden");const l=o.querySelector(".tooltip-label"),d=o.querySelector(".tooltip-value");l&&(l.textContent="Pixie generation"),d&&(d.textContent=Gt(e.pixieRate))}else o.classList.add("hidden");const u=n.querySelector("[data-tooltip-total]");if(u){const l=u.querySelector(".tooltip-value");l&&(l.textContent=Gt(e.netRate),l.className=`tooltip-value ${e.netRate>=0?"text-positive":"text-red"}`)}},Zu=()=>{let e='<div class="mana-tooltip">';return e+='<div class="tooltip-title">Mana Generation Breakdown</div>',e+='<div class="tooltip-divider"></div>',e+='<div class="tooltip-row" data-tooltip-t1>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value text-positive"></span>',e+="</div>",e+='<div class="tooltip-divider"></div>',e+="<div data-tooltip-multipliers></div>",e+='<div class="tooltip-row hidden" data-tooltip-mana-globe>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value text-gold"></span>',e+="</div>",e+='<div class="tooltip-row hidden" data-tooltip-modifier>',e+='<span class="tooltip-label text-red"></span>',e+='<span class="tooltip-value text-red"></span>',e+="</div>",e+='<div class="tooltip-divider"></div>',e+='<div class="tooltip-row hidden" data-tooltip-crafting>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value"></span>',e+="</div>",e+='<div class="tooltip-row hidden" data-tooltip-pixie>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value text-positive"></span>',e+="</div>",e+='<div class="tooltip-divider"></div>',e+='<div class="tooltip-row tooltip-total" data-tooltip-total>',e+='<span class="tooltip-label">Net mana rate</span>',e+='<span class="tooltip-value"></span>',e+="</div>",e+="</div>",e},Qu=()=>{const e=ne("arcane_soul");let n='<div class="mana-tooltip soul-tooltip">';if(n+='<div class="tooltip-title">Arcane Soul Production Breakdown</div>',n+='<div class="tooltip-divider"></div>',n+='<div class="tooltip-row" data-soul-tooltip-base>',n+='<span class="tooltip-label"></span>',n+='<span class="tooltip-value text-positive"></span>',n+="</div>",e.outputMultipliers)for(const t of e.outputMultipliers)n+=`<div class="tooltip-row hidden" data-soul-tooltip-mult="${t.source}">`,n+='<span class="tooltip-label"></span>',n+='<span class="tooltip-value text-gold"></span>',n+="</div>";return n+='<div class="tooltip-divider"></div>',n+='<div class="tooltip-row tooltip-total" data-soul-tooltip-total>',n+='<span class="tooltip-label">Net soul rate</span>',n+='<span class="tooltip-value"></span>',n+="</div>",n+="</div>",n},Ju=(e,n,t)=>{var l;const s=os;if(!s)return;const r=D(e,"soulforge").toNumber(),a=ne("arcane_soul"),i=r>0?r/a.craftTime:0,o=s.querySelector("[data-soul-tooltip-base]");if(o){const d=o.querySelector(".tooltip-label"),c=o.querySelector(".tooltip-value"),f=ne("soulforge");d&&(d.innerHTML=`<img src="${f.icon}" class="tooltip-icon"> ${P(r)} soulforge${r!==1?"s":""}  ${P(1/a.craftTime)}/s`),c&&(c.textContent=`+${P(i)}/s`)}if(a.outputMultipliers)for(const d of a.outputMultipliers){const c=s.querySelector(`[data-soul-tooltip-mult="${d.source}"]`);if(!c)continue;let f=0,b=d.label;if(d.type==="inventory"){f=((l=e[d.source])==null?void 0:l.toNumber())??0;const g=ne(d.source);b=`${P(f)} ${g.name}${f!==1?"s":""}`}else d.type==="ascension"&&t&&(f=t.upgrades[d.source]??0);const y=d.formula(f);if(y!==1){c.classList.remove("hidden");const g=c.querySelector(".tooltip-label"),w=c.querySelector(".tooltip-value");if(d.type==="inventory"){const p=ne(d.source);g&&(g.innerHTML=`<img src="${p.icon}" class="tooltip-icon"> ${b}`)}else g&&(g.textContent=d.label);w&&(w.textContent=`x${y.toFixed(2)} multiplier`)}else c.classList.add("hidden")}const u=s.querySelector("[data-soul-tooltip-total]");if(u){const d=u.querySelector(".tooltip-value");d&&(d.textContent=Gt(n),d.className=`tooltip-value ${n>=0?"text-positive":"text-red"}`)}},Kt=(e,n)=>{const t=_e[e];return`
    <div class="flex items-center gap-2 py-1 px-1 border-b border-muted--30 cursor-pointer hover-bg-panel--50" data-collapse-toggle="${e}">
      <span class="text-steel text-xs w-4">${t?"+":""}</span>
      <span class="text-gold text-sm font-mono">${n}</span>
    </div>
  `},qr=()=>{var Be,Ne;if(!de)return;const e=M.getState(),n=z(e),{mana:t,recipeInventory:s,recipeCrafting:r,upgrades:a,artifacts:i,altar:o}=n,u=Nt(s),l=xn(s),d=Mt(s),c=Nl(e.activeRealm,e.globalTier),f=yn(e.activeRealm,e.globalTier),b=yt(e.activeRealm,e.globalTier),y=Zr(r,b),g=Me(e.activeRealm),w=g.MODIFIERS.manaModifier,p=e.activeRealm==="realm3",h=p?new m(0):wa(u,w),x=Un(e.realms.realm1.combat.heroicVictories,e.activeRealm),S={recipeInventory:s,ascension:e.realms.realm3.ascension,realmId:e.activeRealm},$=Pu(r,a,i,o,e.globalTier,g.MODIFIERS.craftTimeMultiplier,g.MODIFIERS.calculateSacrificeBonus,g.MODIFIERS.sacrificeBatchSize,e.activeRealm,n.combat,g.MODIFIERS.flaskRecipeMultiplier,x,n.prestige,S),R=p?0:h.add($.mana).toNumber(),k=p?null:Ku(u,$.mana,w),v=Ze.filter(U=>{var F;if((((F=r[`gem_${U}`])==null?void 0:F.lifetimeProduced)??0)===0)return!1;const A=u[U].toNumber(),E=($.recipes[`gem_${U}`]??new m(0)).toNumber();return A!==0||E!==0}),I=tt.filter(U=>{var A;return(((A=r[`flask_${U}`])==null?void 0:A.lifetimeProduced)??0)>0}),T=c?Jr(Mt(e.realms.realm1.recipeInventory),Mt(e.realms.realm2.recipeInventory),e.activeRealm,e.globalTier):d,L=b.filter(U=>{var F;if((((F=r[U])==null?void 0:F.lifetimeProduced)??0)===0)return!1;const A=(T[U]||new m(0)).toNumber(),E=($.recipes[U]||new m(0)).toNumber();return A!==0||E!==0}),q=tt.some(U=>Xe(`flask_${U}`,r)),j=b.some(U=>(y.lifetimeCrafted[U]??0)>0),H=(((Be=r.artifact_shard)==null?void 0:Be.lifetimeProduced)??0)>0,_=e.activeRealm==="realm1"&&(((Ne=e.realms.realm1.recipeCrafting.nullstone)==null?void 0:Ne.lifetimeProduced)??0)>0,J=D(s,"arcane_bar").gt(0),ee=D(s,"arcane_log").gt(0),X=H||_||J||ee,ce=Yi(e.activeRealm).filter(U=>p&&U==="arcane_soul"?!1:D(s,U).gt(0)||U==="arcane_soul"&&D(s,"soulforge").gt(0)),B=ce.length>0,ae=hs(e.activeRealm).filter(U=>D(s,U).gt(0)),fe=ae.length>0,me=v.join(","),G=I.join(","),W=L.join(","),he=ce.join(","),pe=ae.join(","),ge=`${_e.gems}|${_e.flasks}|${_e.military}|${_e.expeditions}|${_e.creatures}|${_e.equipment}`,ve=`${q}|${j}|${H}|${_}|${J}|${ee}|${B}|${fe}`,Z=`${ge}|${ve}|${me}|${G}|${W}|${he}|${pe}|${e.activeRealm}`;if(!Rs||de.dataset.structureKey!==Z){let U=`
      <div class="inventory-sections overflow-y-auto pr-2" style="flex: 1; min-height: 0;">`;if(p){const A=ne("arcane_soul");U+=`
      <div class="soul-row-wrapper">
        <table style="table-layout: fixed; width: 100%;">
          <colgroup>
            <col style="width: 50px;">
            <col style="width: 36px;">
            <col style="width: 70px;">
            <col>
          </colgroup>
          <tbody>
            <tr>
              <td class="text-text text-sm pr-2">SOUL</td>
              <td>
                <img src="${A.icon}" alt="Arcane Soul" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-r3-soul-value></td>
              <td class="text-right" data-r3-soul-rate></td>
            </tr>
          </tbody>
        </table>
        ${Qu()}
      </div>`}else U+=`
      <div class="mana-row-wrapper">
        <table style="table-layout: fixed; width: 100%;">
          <colgroup>
            <col style="width: 50px;">
            <col style="width: 36px;">
            <col style="width: 70px;">
            <col>
          </colgroup>
          <tbody>
            <tr class="mana-row">
              <td class="text-text text-sm pr-2">Mana</td>
              <td>
                <img src="${O("icons/mana.png")}" alt="Mana" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-mana-value></td>
              <td class="text-right" data-mana-rate></td>
            </tr>
          </tbody>
        </table>
        ${Zu()}
      </div>`;if(U+=`
    `,e.activeRealm!=="realm3"&&(U+=Kt("gems","Gems"),!_e.gems)){if(U+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,v.length===0)U+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No gems yet</td></tr>';else for(const A of v)U+=`
            <tr data-gem-row="${A}">
              <td class="text-text text-sm">T${A}</td>
              <td>
                <img src="${$e[A].icon}" alt="${$e[A].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-gem-count="${A}"></td>
              <td class="text-right" data-gem-rate="${A}"></td>
            </tr>
          `;U+="</tbody></table>"}if(q&&e.activeRealm!=="realm3"&&(U+=Kt("flasks","Flasks"),!_e.flasks)){if(U+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,I.length===0)U+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No flasks yet</td></tr>';else for(const A of I)U+=`
            <tr data-flask-row="${A}">
              <td class="text-text text-sm">T${A}</td>
              <td>
                <img src="${un[A].icon}" alt="${un[A].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-flask-count="${A}"></td>
              <td class="text-right" data-flask-rate="${A}"></td>
            </tr>
          `;U+="</tbody></table>"}if(j&&e.activeRealm!=="realm3"&&(U+=Kt("military","Expedition Units"),!_e.military)){if(U+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,L.length===0)U+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No units yet</td></tr>';else for(const A of L)U+=`
            <tr data-military-row="${A}">
              <td class="text-text text-sm">${f[A].name.slice(0,2)}</td>
              <td>
                <img src="${f[A].icon}" alt="${f[A].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-military-count="${A}"></td>
              <td class="text-right" data-military-rate="${A}"></td>
            </tr>
          `;U+="</tbody></table>"}if(B&&(U+=Kt("creatures","Magical Creatures"),!_e.creatures)){U+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`;for(const A of ce){const E=ne(A);U+=`
          <tr>
            <td class="text-text text-sm">${Yu(A,E.name)}</td>
            <td>
              <img src="${E.icon}" alt="${E.name}" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-creature-count="${A}"></td>
            <td class="text-right" data-creature-rate="${A}"></td>
          </tr>
        `}U+="</tbody></table>"}if(fe&&(U+=Kt("equipment","Expedition Equipment"),!_e.equipment)){U+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`;for(const A of ae){const E=ne(A),F=A==="pickaxe"?"PICK":A==="axe"?"AXE":A.slice(0,4).toUpperCase();U+=`
          <tr>
            <td class="text-text text-sm">${F}</td>
            <td>
              <img src="${E.icon}" alt="${E.name}" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-equipment-count="${A}"></td>
            <td class="text-right" data-equipment-rate="${A}"></td>
          </tr>
        `}U+="</tbody></table>"}X&&(U+=Kt("expeditions","Expedition Loot"),_e.expeditions||(U+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,H&&(U+=`
          <tr>
            <td class="text-text text-sm">SHRD</td>
            <td>
              <img src="${O("icons/artifact shard.png")}" alt="Artifact Shards" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-shards></td>
            <td class="text-right" data-combat-shards-rate></td>
          </tr>
        `),_&&(U+=`
          <tr>
            <td class="text-text text-sm">NULS</td>
            <td>
              <img src="${O("icons/nullstone.png")}" alt="Nullstone" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-nullstone></td>
            <td class="text-right" data-combat-nullstone-rate></td>
          </tr>
        `),J&&(U+=`
          <tr>
            <td class="text-text text-sm">BAR</td>
            <td>
              <img src="${O("icons/arcane bar.png")}" alt="Arcane Bar" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-arcane-bars></td>
            <td class="text-right" data-combat-arcane-bars-rate></td>
          </tr>
        `),ee&&(U+=`
          <tr>
            <td class="text-text text-sm">LOG</td>
            <td>
              <img src="${O("icons/arcane log.png")}" alt="Arcane Log" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-arcane-logs></td>
            <td class="text-right" data-combat-arcane-logs-rate></td>
          </tr>
        `),U+="</tbody></table>")),U+="</div>",de.innerHTML=U,de.dataset.structureKey=Z,Rs=!0,p||td(),p&&nd()}if(p){const U=de.querySelector("[data-r3-soul-value]");U&&(U.textContent=P(D(s,"arcane_soul")));const A=de.querySelector("[data-r3-soul-rate]");if(A){const E=($.recipes.arcane_soul??new m(0)).toNumber();E!==0?A.innerHTML=`<span class="text-xs font-mono ${E>0?"text-positive":"text-red"}">${Gt(E)}</span>`:A.innerHTML="",Ju(s,E,e.realms.realm3.ascension)}}else{const U=de.querySelector("[data-mana-value]");U&&(U.textContent=P(t));const A=de.querySelector("[data-mana-rate]");A&&(R!==0?A.innerHTML=`<span class="text-xs font-mono ${R>0?"text-positive":"text-red"}">${Gt(R)}</span>`:A.innerHTML=""),k&&Xu(k)}for(const U of v){const A=u[U].toNumber(),E=($.recipes[`gem_${U}`]??new m(0)).toNumber(),F=de.querySelector(`[data-gem-count="${U}"]`);F&&(F.textContent=P(A)),pt(de.querySelector(`[data-gem-rate="${U}"]`),E)}for(const U of I){const A=l[U].toNumber(),E=($.recipes[`flask_${U}`]??new m(0)).toNumber(),F=de.querySelector(`[data-flask-count="${U}"]`);F&&(F.textContent=P(A)),pt(de.querySelector(`[data-flask-rate="${U}"]`),E)}const Le=ar(n.combat);for(const U of We){if(U===e.activeRealm)continue;const A=ar(e.realms[U].combat);for(const[E,F]of Object.entries(A)){if(F<=0)continue;const N=Rt[E],V=(N==null?void 0:N.realmId)===e.activeRealm,ie=c&&(N==null?void 0:N.realmId)===U;(V||ie)&&(Le[E]=(Le[E]||0)+F)}}for(const U of L){const A=(T[U]||new m(0)).toNumber(),E=($.recipes[U]||new m(0)).toNumber()-(Le[U]||0),F=de.querySelector(`[data-military-count="${U}"]`);F&&(F.textContent=P(A)),pt(de.querySelector(`[data-military-rate="${U}"]`),E)}if(!_e.expeditions){const U=de.querySelector("[data-combat-shards]");U&&(U.textContent=P(D(s,"artifact_shard").toNumber()));const A=de.querySelector("[data-combat-nullstone]");A&&(A.textContent=Y(D(e.realms.realm1.recipeInventory,"nullstone").toNumber()));const E=zu(n.combat,e.activeRealm,n.prestige,n.altar.sacrificeCounts),F=($.recipes.artifact_shard??new m(0)).toNumber(),N=($.recipes.nullstone??new m(0)).toNumber();pt(de.querySelector("[data-combat-shards-rate]"),E.shardsPerSecond+F),pt(de.querySelector("[data-combat-nullstone-rate]"),E.nullstonePerSecond+N);let V=0,ie=0;if(p)for(const ue of vs("realm3")){const Ie=n.wonderAssignments[ue]||0;if(Ie<=0)continue;const Pe=fn[ue];if(!Pe)continue;const ft=Ie/Pe.secondsPerTick;for(const kt of Pe.tickCost){const je=kt.amount*ft;kt.recipeId==="arcane_bar"&&(V+=je),kt.recipeId==="arcane_log"&&(ie+=je)}}const le=de.querySelector("[data-combat-arcane-bars]");le&&(le.textContent=P(D(s,"arcane_bar").toNumber())),pt(de.querySelector("[data-combat-arcane-bars-rate]"),(E.arcaneBarsPerSecond??0)-V);const oe=de.querySelector("[data-combat-arcane-logs]");oe&&(oe.textContent=P(D(s,"arcane_log").toNumber())),pt(de.querySelector("[data-combat-arcane-logs-rate]"),(E.arcaneLogsPerSecond??0)-ie)}if(!_e.creatures){const U=p?ar(n.combat):{},A=p?Ou(s,e.realms.realm3.ascension):{recipes:{}};for(const E of ce){const F=D(s,E),N=de.querySelector(`[data-creature-count="${E}"]`);N&&(N.textContent=P(F));let V=A.recipes[E]??0;V-=U[E]||0,pt(de.querySelector(`[data-creature-rate="${E}"]`),V)}}if(!_e.equipment){const U={};for(const A of Object.values(n.combat.activeExpeditions))for(const E of A){if(!E.repeatIfUnitsAvailable||!E.assignedEquipment)continue;const F=E.duration/1e3;if(!(F<=0))for(const[N,V]of Object.entries(E.assignedEquipment))V<=0||(U[N]=(U[N]||0)+V/F)}for(const A of ae){const E=D(s,A),F=de.querySelector(`[data-equipment-count="${A}"]`);F&&(F.textContent=P(E));const N=n.workshopAssignments[A]||0,V=ne(A),ie=(N>0?N/V.craftTime:0)-(U[A]||0);pt(de.querySelector(`[data-equipment-rate="${A}"]`),ie)}}};let ii=!1;const ed=e=>{const t=e.target.closest("[data-collapse-toggle]");if(t){const s=t.getAttribute("data-collapse-toggle");_e[s]=!_e[s],Rs=!1,qr()}};let zt=!1,ir=null;const td=()=>{const e=de==null?void 0:de.querySelector(".mana-row-wrapper"),n=de==null?void 0:de.querySelector(".mana-tooltip");if(!e||!n)return;is&&is.remove(),document.body.appendChild(n),is=n,ir&&ir();const t=r=>{const a=e.contains(r.target);if(a&&!zt){const i=e.getBoundingClientRect();n.style.top=`${i.bottom+4}px`,n.style.left=`${i.left}px`,n.classList.add("visible"),zt=!0}else!a&&zt&&(n.classList.remove("visible"),zt=!1)},s=()=>{zt&&(n.classList.remove("visible"),zt=!1)};document.addEventListener("mousemove",t),document.addEventListener("mouseleave",s),ir=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseleave",s)}};let Xt=!1,or=null;const nd=()=>{const e=de==null?void 0:de.querySelector(".soul-row-wrapper"),n=de==null?void 0:de.querySelector(".soul-tooltip");if(!e||!n)return;os&&os.remove(),document.body.appendChild(n),os=n,or&&or();const t=r=>{const a=e.contains(r.target);if(a&&!Xt){const i=e.getBoundingClientRect();n.style.top=`${i.bottom+4}px`,n.style.left=`${i.left}px`,n.classList.add("visible"),Xt=!0}else!a&&Xt&&(n.classList.remove("visible"),Xt=!1)},s=()=>{Xt&&(n.classList.remove("visible"),Xt=!1)};document.addEventListener("mousemove",t),document.addEventListener("mouseleave",s),or=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseleave",s)}},oi=()=>{de=document.getElementById("inventory"),de&&(Rs=!1,ii||(de.addEventListener("click",ed),ii=!0),qr(),Gn(xe.Inventory,qr))},lt={},sd=()=>{const{collapsedSections:e}=M.getState();for(const n of e)lt[n]=!1};let _r=!1;const rd=()=>{_r||(_r=!0,sd())},ad=()=>{const e=Object.entries(lt).filter(([,n])=>!n).map(([n])=>n);M.setState({collapsedSections:e})},ut=(e,n,t,s=!0,r="")=>{rd(),lt[e]===void 0&&(lt[e]=s);const a=lt[e];return`
    <div>
      <div class="w-full flex items-center" style="padding: 8px 12px; gap: 10px;">
        <button
          data-action="toggle-collapsible"
          data-id="${e}"
          class="hover-opacity-100"
          style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; opacity: 0.6; cursor: pointer; color: var(--color-steel); font-size: 16px;"
        >
          ${a?"":"+"}
        </button>
        <span style="color: var(--color-steel);">${n}</span>
        ${r?`<div class="ml-auto">${r}</div>`:""}
      </div>
      <div data-collapsible-content="${e}" class="p-3 pt-0" style="${a?"":"display: none;"}">${t}</div>
    </div>
  `},id=e=>{lt[e]=!lt[e],ad()},Ea=()=>{for(const e of Object.keys(lt))delete lt[e];_r=!1};document.addEventListener("click",e=>{const t=e.target.closest('[data-action="toggle-collapsible"]');if(t){const s=t.getAttribute("data-id");id(s);const r=lt[s];t.textContent=r?"":"+";const a=document.querySelector(`[data-collapsible-content="${s}"]`);a&&(a.style.display=r?"":"none")}});const St=(e,n,t)=>{let s=null;const r=()=>{var i;(i=t==null?void 0:t.onCleanup)==null||i.call(t),No(e),s=null};return{cleanup:r,render:i=>{r(),s=i;const o=n(s);Gn(e,()=>{s&&o()}),o()},getContainer:()=>s}},es=[{recipeId:"pixie"},{recipeId:"arcane_warden"},{recipeId:"eidolon"},{recipeId:"mana_wisp"},{recipeId:"anima_core"},{recipeId:"luminary"}],ci=(e,n)=>n.every(t=>t.recipeId?D(e,t.recipeId).gte(t.amount):!0),od=e=>e.map(n=>{if(n.recipeId){const t=ne(n.recipeId);return`<img src="${t.icon}" alt="${t.name}" style="width: 40px; height: 40px;" class="object-contain"><span>${P(n.amount)}</span>`}return""}).filter(Boolean).join(""),cd=e=>{const n=()=>{const t=M.getState(),s=z(t),{recipeCrafting:r}=s,a=D(s.recipeInventory,"soulforge"),i=D(s.recipeInventory,"forge_enhancer"),o=ne("soulforge"),u=ne("forge_enhancer"),l=ne("arcane_soul"),d=r.arcane_soul,c=(d==null?void 0:d.progress)??0,f=c>=1,b=a.toNumber(),y=i.toNumber(),g={recipeInventory:s.recipeInventory,ascension:s.ascension,realmId:"realm3"},w=Un(t.realms.realm1.combat.heroicVictories,"realm3"),p=$s("arcane_soul",s.upgrades,s.artifacts,s.altar,()=>new m(1),1,w,s.prestige,g),h=b>0?b*p.toNumber()/l.craftTime:0;let x='<div class="mobile-scroll-x">';x+='<table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 750px">',x+="<colgroup>",x+='<col style="width: 230px">',x+='<col style="width: 75px">',x+='<col style="width: 280px">',x+='<col style="width: 130px">',x+='<col style="width: 60px">',x+="</colgroup>",x+="<tbody>",x+='<tr style="background-color: var(--color-tooltip-bg)">',x+='<td class="py-2 px-2"><span class="inline-flex items-center gap-1.5">',x+=`<img src="${o.icon}" alt="Soulforge" style="width: 40px; height: 40px;" class="object-contain">`,x+='<span class="text-magenta">Soulforge</span>',x+="</span></td>",x+=`<td class="text-left px-2" data-r3-soulforge-count>x${Y(b)}</td>`,x+='<td class="px-2"><span class="inline-flex items-center gap-1">',x+=`<img src="${l.icon}" alt="Arcane Soul" style="width: 40px; height: 40px;" class="object-contain">`,x+='<span class="text-gold">Arcane Soul</span>',x+=`<span class="text-positive" data-r3-rate>${b>0?`(${P(h)}/s)`:""}</span>`,x+="</span></td>",x+='<td class="px-2"><div class="inline-flex items-center gap-2">',x+='<div class="h-4 overflow-hidden craft-progress-bg" style="width: 80px">',x+=`<div data-r3-progress-bar="arcane_soul" class="h-full craft-progress-fill${f?" blocked":""}" style="width: ${c*100}%"></div>`,x+="</div></div></td>",x+=`<td class="px-2 text-steel text-xs" data-r3-craft-time="arcane_soul">${P(l.craftTime)}s</td>`,x+="</tr>",y>0&&(x+='<tr style="background-color: var(--color-row-odd)" data-r3-forge-enhancer-row>',x+='<td class="py-2 px-2"><span class="inline-flex items-center gap-1.5">',x+=`<img src="${u.icon}" alt="Forge Enhancer" style="width: 40px; height: 40px;" class="object-contain">`,x+='<span class="text-magenta">Forge Enhancer</span>',x+="</span></td>",x+=`<td class="text-left px-2" data-r3-forge-enhancer-count>x${Y(y)}</td>`,x+=`<td class="px-2 text-positive" colspan="3" data-r3-forge-enhancer-mult>Soulforge output x${p.toNumber().toFixed(2)}</td>`,x+="</tr>"),x+="</tbody></table>",x+="</div>",a.eq(0)&&(x+='<div class="text-muted text-sm mt-4">Craft Soulforges in the Prime Realm to begin generating Arcane Souls.</div>');const S=T=>`border-${T} text-${T} hover-bg-${T}--20 cursor-pointer`,$="border-muted--30 text-muted cursor-not-allowed",R=["var(--color-tooltip-bg)","var(--color-row-odd)"],k=An(s.ascension),v=fs(s.recipeInventory),I=(T,L)=>{var me;if(!$n(T.recipeId,r)){const G=Sr[T.recipeId];if(!G||!$n(G.requiredRecipe,r))return"";const W=((me=r[G.requiredRecipe])==null?void 0:me.lifetimeProduced)??0,he=ne(G.requiredRecipe);return`<tr data-r3-creature-locked="${T.recipeId}" style="background-color: ${R[L%2]}">
          <td class="py-2 px-2" colspan="6">
            <span class="text-muted text-sm">???  Craft ${Y(G.lifetimeThreshold)} ${he.name}s (<span data-r3-locked-progress="${T.recipeId}">${Y(W)}</span>/${Y(G.lifetimeThreshold)})</span>
          </td>
        </tr>`}const q=ne(T.recipeId),j=D(s.recipeInventory,T.recipeId),H=dn[T.recipeId],_=r[T.recipeId],J=(_==null?void 0:_.progress)??0,ee=q.recipe.length>0,X=ee?od(q.recipe):'<span class="text-positive text-xs">Free</span>',re=!ee||ci(s.recipeInventory,q.recipe),ce=re?S("cyan"):$,B=H?H.amountPerCycle*v:0,se=H?`<span class="inline-flex items-center gap-1 text-positive">
            <img src="${ne(H.produces).icon}" alt="${ne(H.produces).name}" style="width: 40px; height: 40px;" class="object-contain">
            <span data-r3-produces="${T.recipeId}">${P(new m(B))}</span>
          </span>`:'<span class="text-muted text-xs"></span>',ae=H?`<div class="inline-flex items-center gap-2">
            <div class="h-4 overflow-hidden craft-progress-bg" style="width: 80px">
              <div data-r3-progress-bar="${T.recipeId}" class="h-full craft-progress-fill" style="width: ${J*100}%"></div>
            </div>
            <span class="text-steel text-xs" data-r3-cycle-time="${T.recipeId}">${P(H.cycleDuration/k)}s</span>
          </div>`:"",fe=ee?`<button data-action="buy-creature" data-creature="${T.recipeId}" data-mode="one" class="px-2 py-1 text-xs font-mono border ${ce}" ${re?"":"disabled"}>1</button>
           <button data-action="buy-creature" data-creature="${T.recipeId}" data-mode="ten_percent" class="px-2 py-1 text-xs font-mono border ${ce}" ${re?"":"disabled"}>10%</button>
           <button data-action="buy-creature" data-creature="${T.recipeId}" data-mode="all" class="px-2 py-1 text-xs font-mono border ${ce}" ${re?"":"disabled"}>100%</button>`:`<button data-action="buy-creature" data-creature="${T.recipeId}" data-mode="one" class="px-2 py-1 text-xs font-mono border ${S("cyan")}">+1</button>`;return`<tr data-r3-creature-row="${T.recipeId}" style="background-color: ${R[L%2]}">
        <td class="py-2 px-2">
          <span class="inline-flex items-center gap-1.5">
            <img src="${q.icon}" alt="${q.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span class="text-cyan">${q.name}</span>
          </span>
        </td>
        <td class="text-left px-2" data-r3-count="${T.recipeId}">${P(j)}</td>
        <td class="px-2">${se}</td>
        <td class="px-2">${ae}</td>
        <td class="px-2">
          <span class="inline-flex items-center gap-1">${X}</span>
        </td>
        <td class="text-center px-2">
          <div class="inline-flex items-center gap-1">${fe}</div>
        </td>
      </tr>`};x+=`<div class="mt-4 mobile-scroll-x">
      <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1000px">
        <colgroup>
          <col style="width: 180px">
          <col style="width: 75px">
          <col style="width: 120px">
          <col style="width: 145px">
          <col style="width: 200px">
          <col style="width: 180px">
        </colgroup>
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="text-left py-1 px-2">Creature</th>
            <th class="text-left py-1 px-2">Owned</th>
            <th class="text-left py-1 px-2">Produces</th>
            <th class="text-left py-1 px-2">Progress</th>
            <th class="text-left py-1 px-2">Cost</th>
            <th class="text-center py-1 px-2">Buy</th>
          </tr>
        </thead>
        <tbody>
          ${es.map((T,L)=>I(T,L)).join("")}
        </tbody>
      </table>
    </div>`,e.innerHTML=x,e.querySelectorAll('[data-action="buy-creature"]').forEach(T=>{T.addEventListener("click",()=>{const L=T.getAttribute("data-creature"),q=T.getAttribute("data-mode");M.getState().buyCreature(L,q)})})};return n(),()=>{var R;const t=M.getState(),s=z(t),a=D(s.recipeInventory,"soulforge").toNumber(),i=D(s.recipeInventory,"forge_enhancer").toNumber(),o=ne("arcane_soul"),u={recipeInventory:s.recipeInventory,ascension:s.ascension,realmId:"realm3"},l=Un(t.realms.realm1.combat.heroicVictories,"realm3"),d=$s("arcane_soul",s.upgrades,s.artifacts,s.altar,()=>new m(1),1,l,s.prestige,u),c=a>0?a*d.toNumber()/o.craftTime:0,f=e.querySelector("[data-r3-soulforge-count]");f&&(f.textContent=`x${Y(a)}`);const b=e.querySelector("[data-r3-forge-enhancer-count]");b&&(b.textContent=`x${Y(i)}`);const y=e.querySelector("[data-r3-forge-enhancer-mult]");y&&(y.textContent=`Soulforge output x${d.toNumber().toFixed(2)}`);const g=e.querySelector("[data-r3-forge-enhancer-row]");if(i>0&&!g||i===0&&g){n();return}const w=e.querySelector("[data-r3-rate]");w&&(w.textContent=a>0?`(${P(c)}/s)`:"");const p=s.recipeCrafting.arcane_soul,h=(p==null?void 0:p.progress)??0,x=h>=1;on(e.querySelector('[data-r3-progress-bar="arcane_soul"]'),h,x);const S=An(s.ascension),$=fs(s.recipeInventory);for(const k of es){const v=ne(k.recipeId),I=D(s.recipeInventory,k.recipeId),T=dn[k.recipeId],L=$n(k.recipeId,s.recipeCrafting),q=e.querySelector(`[data-r3-count="${k.recipeId}"]`);if(q&&(q.textContent=P(I)),T){const j=e.querySelector(`[data-r3-produces="${k.recipeId}"]`);j&&(j.textContent=P(new m(T.amountPerCycle*$)));const H=s.recipeCrafting[k.recipeId],_=(H==null?void 0:H.progress)??0;on(e.querySelector(`[data-r3-progress-bar="${k.recipeId}"]`),_,!1);const J=e.querySelector(`[data-r3-cycle-time="${k.recipeId}"]`);J&&(J.textContent=`${P(T.cycleDuration/S)}s`)}if(L&&v.recipe.length>0){const j=ci(s.recipeInventory,v.recipe);e.querySelectorAll(`[data-action="buy-creature"][data-creature="${k.recipeId}"]`).forEach(H=>{const _=H;j?(_.disabled=!1,_.className="px-2 py-1 text-xs font-mono border border-cyan text-cyan hover-bg-cyan--20 cursor-pointer"):(_.disabled=!0,_.className="px-2 py-1 text-xs font-mono border border-muted--30 text-muted cursor-not-allowed")})}}for(const k of es){const v=e.querySelector(`[data-r3-locked-progress="${k.recipeId}"]`);if(v){const I=Sr[k.recipeId];if(I){const T=((R=s.recipeCrafting[I.requiredRecipe])==null?void 0:R.lifetimeProduced)??0;v.textContent=Y(T)}}}for(const k of es){const v=$n(k.recipeId,s.recipeCrafting),I=e.querySelector(`[data-r3-creature-row="${k.recipeId}"]`);if(v&&!I){n();return}}}},cr=e=>{const n=M.getState(),t=z(n),s=Me(n.activeRealm),r=ne(e),a=Ta(e,t.upgrades,t.artifacts,n.globalTier,s.MODIFIERS.craftTimeMultiplier);return r.craftTime/a},Zt=(e,n,t)=>`<span class="text-text" style="display: inline-block; width: 68px">${e}</span><span class="${t}">(${n}/s)</span>`,ld="grid-template-columns: 120px 210px 20px 225px 90px 110px 55px 70px; gap: 16px; padding-left: 12px;",Aa=(e,n)=>{const t=n%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",s=e.type==="gem"?"assign-crafter":e.type==="flask"?"assign-flask-crafter":"assign-military-crafter",r=e.type==="military"?`data-id="${e.id}"`:`data-tier="${e.id}"`,a=e.type==="gem"?"":e.type==="flask"?"flask-":"military-";return`
    <div class="grid items-center py-1" style="${ld} background-color: ${t}">
      <div class="text-gold text-sm whitespace-nowrap">${e.name}</div>
      <div class="flex items-center"><span class="hover-tooltip-wrapper">${e.ingredients}<div class="hover-tooltip" data-${a}input-tooltip="${e.id}">${e.inputTooltipHtml??""}</div></span></div>
      <div class="text-text text-center"></div>
      <div class="flex items-center gap-1 mr-2.5">
        <span class="hover-tooltip-wrapper"><span class="flex items-center gap-1"><img src="${e.icon}" alt="${e.name}" style="width: 40px; height: 40px;" class="object-contain"><span class="text-text text-sm" data-${a}recipe-output="${e.id}">${e.outputAmount}</span></span><div class="hover-tooltip" data-${a}output-tooltip="${e.id}">${e.outputTooltipHtml??""}</div></span>
      </div>
      <div class="flex items-center gap-1">
        <button data-action="${s}" ${r} data-delta="-1" class="text-red hover-text-white hover-bg-red--20 font-mono text-xl font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
        <span data-${a}crafter-count="${e.id}" class="text-positive text-center font-mono text-sm w-6">${Y(e.assigned)}</span>
        <button data-action="${s}" ${r} data-delta="1" class="text-positive hover-text-white hover-bg-positive--20 font-mono text-xl font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
      </div>
      <div class="w-24 h-4 overflow-hidden craft-progress-bg">
        <div data-${a}progress-bar="${e.id}" class="h-full craft-progress-fill${e.blocked?" blocked":""}" style="width: ${e.progress*100}%"></div>
      </div>
      <div class="text-sm text-text" data-${a}craft-time="${e.id}">${P(e.craftTime)}s</div>
      <div class="text-sm text-positive">${e.effectText||""}</div>
    </div>
  `},Qt=(e,n,t,s,r,a,i)=>{const o=[];o.push({label:n,value:P(t)});for(const l of s){const d=l.value instanceof m?l.value:new m(l.value);d.eq(1)||o.push({label:l.label,value:`x${P(d)}`,valueClass:"text-steel"})}r>1&&o.push({label:"Crafters",value:`x${r}`,valueClass:"text-positive"}),r>0?(o.push({label:"Craft speed",value:`${P(a)}/s`,valueClass:"text-steel"}),o.push({label:"Total",value:`${P(i)}/s`,valueClass:"text-gold"})):o.push({label:"Total",value:P(i),valueClass:"text-gold"});let u=`<div class="tooltip-title">${e}</div><div class="tooltip-divider"></div>`;for(const l of o)u+=`<div class="tooltip-row"><span class="tooltip-label">${l.label}</span>`,l.value!==void 0&&(u+=`<span class="tooltip-value ${l.valueClass??""}">${l.value}</span>`),u+="</div>";return u},ud=(e,n)=>{const t=$e[e],s=t.effect.type==="flat"?`+${P(t.effect.value)}/s`:`x${P(t.effect.value)}`,r=t.recipe.map(a=>({icon:a.type==="mana"?O("icons/mana.png"):$e[a.tier].icon,alt:a.type==="mana"?"Mana":`T${a.tier}`,amount:new m(0)}));return Aa({type:"gem",id:String(e),name:t.name,icon:t.icon,ingredients:Ca(r,"",e,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0,effectText:s},n)},dd=(e,n)=>{const t=un[e],s=t.recipe.map(r=>({icon:$e[r.tier].icon,alt:`T${r.tier}`,amount:new m(0)}));return Aa({type:"flask",id:String(e),name:t.name,icon:t.icon,ingredients:Ca(s,"flask-",e,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0},n)},fd=(e,n)=>{const t=M.getState(),r=zn(t.activeRealm)[e],a=r.recipe.map(i=>({icon:i.type==="mana"?O("icons/mana.png"):$e[i.tier].icon,alt:i.type==="mana"?"Mana":`T${i.tier}`,amount:new m(0)}));return Aa({type:"military",id:e,name:r.name,icon:r.icon,ingredients:Ca(a,"military-",e,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0},n)};let li=null,ts=null,lr=null,ui=!1,di=!1,ns=null;const md=e=>{const n=()=>{var h,x,S,$,R,k;ns=null;const t=M.getState(),s=z(t),{recipeCrafting:r}=s,a=Ze.map(v=>`gem_${v}`),i=tt.map(v=>`flask_${v}`),o=Je(t.activeRealm),u=Ze.filter(v=>Xe(`gem_${v}`,r)),l=tt.filter(v=>Xe(`flask_${v}`,r)),d=Yt(a,r),c=d?parseInt(d.replace("gem_","")):null;li=d,ts=Yt(i,r),lr=Yt(o,r);let f=u.map((v,I)=>ud(v,I)).join("");if(c){const v=u.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";f+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${v}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${$e[c-1].icon}" alt="T${c-1}" style="width: 40px; height: 40px;" class="object-contain">
          <span data-unlock-progress>to unlock</span>
        </div>
      </div>
    `}const b=t.activeRealm==="realm1"&&Xe("soulforge",r),y=t.activeRealm==="realm1"&&!c&&!b;if(ui=b,y){const v=u.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";f+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-soulforge-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${v}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${$e[8].icon}" alt="T8" style="width: 40px; height: 40px;" class="object-contain">
          <span data-soulforge-unlock-progress>to unlock</span>
        </div>
      </div>
    `}if(b){const v=ne("soulforge"),I=t.realms.realm3,T=D(I.recipeInventory,"soulforge"),L=Cr(I),q=D(s.recipeInventory,"gem_8"),j=q.gte(L),H=Math.min(1,q.div(L).toNumber()),_=u.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",J=j?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";f+=`
      <div class="flex items-center gap-4 py-2 px-3" style="background-color: ${_}">
        <img src="${v.icon}" alt="Soulforge" style="width: 40px; height: 40px;" class="object-contain">
        <div class="flex-1">
          <span class="text-magenta font-mono text-sm">Soulforge</span>
          <span class="text-steel text-xs ml-2">Forges arcane souls in the Realm of Magic</span>
        </div>
        <span class="text-sm text-text font-mono" data-soulforge-count>Owned: ${P(T)}</span>
        <button
          data-action="craft-soulforge"
          ${j?"":"disabled"}
          class="relative px-3 py-1 text-sm font-mono border overflow-hidden ${J}"
          style="min-width: 180px;"
        >
          ${Tt(H,"data-soulforge-progress")}
          <span class="relative z-10 flex items-center justify-center gap-2">
            Forge -
            <span class="inline-flex items-center gap-1">
              <span data-soulforge-cost>${P(L)}</span>
              <img src="${$e[8].icon}" alt="T8" style="width: 20px; height: 20px;" class="object-contain">
            </span>
          </span>
        </button>
      </div>
    `}const g=t.activeRealm==="realm2"&&Xe("forge_enhancer",r),w=t.activeRealm==="realm2"&&!c&&!g;if(di=g,w){const v=(u.length+(b?1:0))%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";f+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-forge-enhancer-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${v}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${$e[8].icon}" alt="T8" style="width: 40px; height: 40px;" class="object-contain">
          <span data-forge-enhancer-unlock-progress>to unlock</span>
        </div>
      </div>
    `}if(g){const v=ne("forge_enhancer"),I=t.realms.realm3,T=D(I.recipeInventory,"forge_enhancer"),L=Er(I),q=D(s.recipeInventory,"gem_8"),j=q.gte(L),H=Math.min(1,q.div(L).toNumber()),_=(u.length+(b?1:0))%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",J=j?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";f+=`
      <div class="flex items-center gap-4 py-2 px-3" style="background-color: ${_}">
        <img src="${v.icon}" alt="Forge Enhancer" style="width: 40px; height: 40px;" class="object-contain">
        <div class="flex-1">
          <span class="text-magenta font-mono text-sm">Forge Enhancer</span>
          <span class="text-steel text-xs ml-2">Doubles arcane soul production in the Realm of Magic</span>
        </div>
        <span class="text-sm text-text font-mono" data-forge-enhancer-count>Owned: ${P(T)}</span>
        <button
          data-action="craft-forge-enhancer"
          ${j?"":"disabled"}
          class="relative px-3 py-1 text-sm font-mono border overflow-hidden ${J}"
          style="min-width: 180px;"
        >
          ${Tt(H,"data-forge-enhancer-progress")}
          <span class="relative z-10 flex items-center justify-center gap-2">
            Forge -
            <span class="inline-flex items-center gap-1">
              <span data-forge-enhancer-cost>${P(L)}</span>
              <img src="${$e[8].icon}" alt="T8" style="width: 20px; height: 20px;" class="object-contain">
            </span>
          </span>
        </button>
      </div>
    `}const p=`<div class="mobile-scroll-x">${f}</div>`;if(t.activeRealm==="realm3"){ns=cd(e);return}{let v=`
    <div class="mb-4 flex items-center gap-2 text-sm font-mono">
      <span class="text-steel">Crafters:</span>
      <span class="text-gold" data-crafters-available></span>
      <span class="text-muted">/</span>
      <span class="text-text" data-crafters-total></span>
      <span class="text-muted ml-2">|</span>
      <span class="text-steel ml-2">Buy crafter</span>
      <button
        data-action="purchase-crafter"
        disabled
        class="relative px-2 py-1 text-sm font-mono border overflow-hidden ${ai(!1,!1)}"
      >
        ${Tt(0,"data-crafter-progress")}
        <span class="relative z-10 flex items-center gap-1">
          <img src="${O("icons/mana.png")}" alt="Mana" class="w-5 h-5 object-contain">
          <span data-crafter-cost class="text-text"></span>
        </span>
      </button>
    </div>
  `;t.dismissedTips.includes("crafter-rightclick")||(v+=`
      <div data-tip="crafter-rightclick" class="mb-4 flex items-center gap-2 text-sm">
        <button data-action="dismiss-tip" data-tip-id="crafter-rightclick" class="text-muted hover-text-positive cursor-pointer border-none bg-transparent" title="Dismiss tip">&#x2714;</button>
        <span class="text-muted">Tip: right-click crafter buttons to assign/unassign all crafters</span>
      </div>
    `),v+=ut("mana-gems","Mana gems",p);const T=((h=r.gem_1)==null?void 0:h.lifetimeProduced)??0,L=T>=100,q=ts?parseInt(ts.replace("flask_","")):null;let j=l.map((X,re)=>dd(X,re)).join("");if(q){const X=l.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";j+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-flask-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${X}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${$e[q].icon}" alt="T${q}" style="width: 40px; height: 40px;" class="object-contain">
          <span data-flask-unlock-progress>to unlock</span>
        </div>
      </div>
    `}if(L){const X=`<div class="mobile-scroll-x">${j}</div>`;v+=`<div class="mt-4">${ut("research-flasks","Research flasks",X)}</div>`}const _=Je(t.activeRealm).filter(X=>Xe(X,r)),J=lr;if(T>=500){let X=_.map((ce,B)=>fd(ce,B)).join("");if(J){const ce=_.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",B=ne(J),se=B.unlockCondition?((x=$e[parseInt(B.unlockCondition.recipeId.replace("gem_",""))])==null?void 0:x.icon)??"":"";X+=`
        <div class="unlock-progress-bg text-steel text-sm py-1">
          <div data-military-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${ce}"></div>
          <div class="unlock-progress-label">
            <span>Craft</span>
            <img src="${se}" alt="" style="width: 40px; height: 40px;" class="object-contain">
            <span data-military-unlock-progress>to unlock</span>
          </div>
        </div>
      `}const re=`<div class="mobile-scroll-x">${X}</div>`;v+=`<div class="mt-4">${ut("military","Expedition Units",re)}</div>`}e.innerHTML=v}e.querySelectorAll('[data-action="assign-crafter"]').forEach(v=>{v.addEventListener("click",()=>{const I=parseInt(v.getAttribute("data-tier")),T=parseInt(v.getAttribute("data-delta"));M.getState().assignCrafter(I,T)}),v.addEventListener("contextmenu",I=>{I.preventDefault();const T=parseInt(v.getAttribute("data-tier"));parseInt(v.getAttribute("data-delta"))>0?M.getState().assignAllCrafters(T):M.getState().unassignAllCrafters(T)})}),e.querySelectorAll('[data-action="assign-flask-crafter"]').forEach(v=>{v.addEventListener("click",()=>{const I=parseInt(v.getAttribute("data-tier")),T=parseInt(v.getAttribute("data-delta"));M.getState().assignFlaskCrafter(I,T)}),v.addEventListener("contextmenu",I=>{I.preventDefault();const T=parseInt(v.getAttribute("data-tier"));parseInt(v.getAttribute("data-delta"))>0?M.getState().assignAllFlaskCrafters(T):M.getState().unassignAllFlaskCrafters(T)})}),e.querySelectorAll('[data-action="assign-military-crafter"]').forEach(v=>{v.addEventListener("click",()=>{const I=v.getAttribute("data-id"),T=parseInt(v.getAttribute("data-delta"));M.getState().assignMilitaryCrafter(I,T)}),v.addEventListener("contextmenu",I=>{I.preventDefault();const T=v.getAttribute("data-id");parseInt(v.getAttribute("data-delta"))>0?M.getState().assignAllMilitaryCrafters(T):M.getState().unassignAllMilitaryCrafters(T)})}),(S=e.querySelector('[data-action="purchase-crafter"]'))==null||S.addEventListener("click",()=>{M.getState().purchaseUpgrade("crafters")}),($=e.querySelector('[data-action="craft-soulforge"]'))==null||$.addEventListener("click",()=>{M.getState().craftSoulforge()}),(R=e.querySelector('[data-action="craft-forge-enhancer"]'))==null||R.addEventListener("click",()=>{M.getState().craftForgeEnhancer()}),(k=e.querySelector('[data-action="dismiss-tip"]'))==null||k.addEventListener("click",v=>{var L;const I=v.currentTarget.getAttribute("data-tip-id"),T=M.getState();M.setState({dismissedTips:[...T.dismissedTips,I]}),(L=e.querySelector(`[data-tip="${I}"]`))==null||L.remove()})};return n(),()=>{const t=M.getState(),s=z(t);if(ns){ns();return}const{recipeCrafting:r}=s,a=Ze.map(B=>`gem_${B}`),i=tt.map(B=>`flask_${B}`),o=Je(t.activeRealm),u=Yt(a,r),l=Yt(i,r),d=Yt(o,r);if(u!==li||l!==ts||d!==lr){n();return}const c=t.getAvailableCrafters(),f=t.getTotalCrafters(),b=e.querySelector("[data-crafters-available]");b&&(b.textContent=Y(c));const y=e.querySelector("[data-crafters-total]");y&&(y.textContent=Y(f));const g=ta(s.upgrades,"crafters"),w=Kn(s.upgrades,"crafters",s.mana,Nt(s.recipeInventory),xn(s.recipeInventory)),p=gt(s.upgrades,"crafters"),h=p||!g?1:Math.min(1,s.mana.div(g.amount).toNumber()),x=e.querySelector("[data-crafter-cost]");x&&g&&(x.textContent=P(g.amount));const S=e.querySelector('[data-action="purchase-crafter"]');if(S){const B=ai(p,w);S.className=`relative px-2 py-1 text-sm font-mono border overflow-hidden ${B}`,p||!w?S.setAttribute("disabled",""):S.removeAttribute("disabled")}Ct(e.querySelector("[data-crafter-progress]"),h,p);const $=Me(t.activeRealm),R=Ps(t.activeRealm),k=Un(t.realms.realm1.combat.heroicVictories,t.activeRealm),v={recipeInventory:s.recipeInventory,ascension:t.realms.realm3.ascension,realmId:t.activeRealm};for(const B of Ze){const se=`gem_${B}`,ae=r[se],fe=(ae==null?void 0:ae.progress)??0,me=fe>=1,G=(ae==null?void 0:ae.assignment)??0,W=$e[B],he=R(B,s.combat.completionsPerExpedition),pe=cr(se),ge=1/pe;on(e.querySelector(`[data-progress-bar="${B}"]`),fe,me);const ve=e.querySelector(`[data-crafter-count="${B}"]`);ve&&(ve.textContent=Y(G));const Z=Tn(se,s.upgrades,s.artifacts,1);Z.forEach((F,N)=>{const V=e.querySelector(`[data-recipe-amount="${B}-${N}"]`);if(V)if(F.amount.eq(0))V.innerHTML="free";else{const ie=P(F.amount);V.innerHTML=G>0?`${Zt(ie,P(F.amount.mul(G).mul(ge)),"text-text")}`:ie}});const Le=sr(se,s.upgrades,s.artifacts,s.altar,$.MODIFIERS.calculateSacrificeBonus,he,k,s.prestige,v),Be=Le.total,Ne=e.querySelector(`[data-recipe-output="${B}"]`);if(Ne){const F=P(Be);Ne.innerHTML=G>0?`${Zt(F,P(Be.mul(G).mul(ge)),"text-positive")}`:F,Ne.classList.toggle("text-positive",G>0),Ne.classList.toggle("text-text",G<=0)}const U=e.querySelector(`[data-input-tooltip="${B}"]`);if(U){const F=rr(se,s.upgrades,s.artifacts,1),N=W.recipe.length>0?W.recipe[0].amount:new m(0),V=Z.length>0?G>0?Z[0].amount.mul(G).mul(ge):F.total.mul(N):new m(0);U.innerHTML=Qt(G>0?"Input per second":"Input per craft","Base cost/craft",N,F.multipliers,G,ge,V)}const A=e.querySelector(`[data-output-tooltip="${B}"]`);A&&(A.innerHTML=Qt(G>0?"Output per second":"Output per craft","Base output/craft",new m(1),Le.multipliers,G,ge,G>0?Be.mul(G).mul(ge):Be));const E=e.querySelector(`[data-craft-time="${B}"]`);E&&(E.textContent=`${P(pe)}s`)}for(const B of tt){const se=`flask_${B}`,ae=r[se],fe=(ae==null?void 0:ae.progress)??0,me=fe>=1,G=(ae==null?void 0:ae.assignment)??0,W=un[B],he=R(B,s.combat.completionsPerExpedition),pe=cr(se),ge=1/pe;on(e.querySelector(`[data-flask-progress-bar="${B}"]`),fe,me);const ve=e.querySelector(`[data-flask-crafter-count="${B}"]`);ve&&(ve.textContent=Y(G));const Z=$.MODIFIERS.flaskRecipeMultiplier,Le=Tn(se,s.upgrades,s.artifacts,Z);Le.forEach((N,V)=>{const ie=e.querySelector(`[data-flask-recipe-amount="${B}-${V}"]`);if(ie)if(N.amount.eq(0))ie.innerHTML="free";else{const le=P(N.amount);ie.innerHTML=G>0?`${Zt(le,P(N.amount.mul(G).mul(ge)),"text-text")}`:le}});const Be=sr(se,s.upgrades,s.artifacts,s.altar,$.MODIFIERS.calculateSacrificeBonus,he,k,s.prestige,v),Ne=Be.total,U=e.querySelector(`[data-flask-recipe-output="${B}"]`);if(U){const N=P(Ne);U.innerHTML=G>0?`${Zt(N,P(Ne.mul(G).mul(ge)),"text-positive")}`:N,U.classList.toggle("text-positive",G>0),U.classList.toggle("text-text",G<=0)}const A=e.querySelector(`[data-flask-input-tooltip="${B}"]`);if(A){const N=rr(se,s.upgrades,s.artifacts,Z),V=W.recipe.length>0?W.recipe[0].amount:new m(0),ie=Le.length>0?G>0?Le[0].amount.mul(G).mul(ge):N.total.mul(V):new m(0);A.innerHTML=Qt(G>0?"Input per second":"Input per craft","Base cost/craft",V,N.multipliers,G,ge,ie)}const E=e.querySelector(`[data-flask-output-tooltip="${B}"]`);E&&(E.innerHTML=Qt(G>0?"Output per second":"Output per craft","Base output/craft",new m(1),Be.multipliers,G,ge,G>0?Ne.mul(G).mul(ge):Ne));const F=e.querySelector(`[data-flask-craft-time="${B}"]`);F&&(F.textContent=`${P(pe)}s`)}const I=u?Sn(u,r):null,T=e.querySelector("[data-unlock-progress]");if(T&&I){T.textContent=`to unlock (${P(I.required-I.current)} more)`;const B=e.querySelector("[data-unlock-bar]");B&&(B.style.width=`${Math.min(100,I.current/I.required*100)}%`)}const L=l?Sn(l,r):null,q=e.querySelector("[data-flask-unlock-progress]");if(q&&L){q.textContent=`to unlock (${P(L.required-L.current)} more)`;const B=e.querySelector("[data-flask-unlock-bar]");B&&(B.style.width=`${Math.min(100,L.current/L.required*100)}%`)}const j=Je(t.activeRealm),H=zn(t.activeRealm);for(const B of j){const se=B,ae=r[se],fe=(ae==null?void 0:ae.progress)??0,me=fe>=1,G=(ae==null?void 0:ae.assignment)??0,W=H[B];if(!W)continue;const he=cr(se),pe=1/he;on(e.querySelector(`[data-military-progress-bar="${B}"]`),fe,me);const ge=e.querySelector(`[data-military-crafter-count="${B}"]`);ge&&(ge.textContent=Y(G));const ve=Tn(se,s.upgrades,s.artifacts,1);ve.forEach((E,F)=>{const N=e.querySelector(`[data-military-recipe-amount="${B}-${F}"]`);if(N)if(E.amount.eq(0))N.innerHTML="free";else{const V=P(E.amount);N.innerHTML=G>0?`${Zt(V,P(E.amount.mul(G).mul(pe)),"text-text")}`:V}});const Z=sr(se,s.upgrades,s.artifacts,s.altar,$.MODIFIERS.calculateSacrificeBonus,1,k,s.prestige,v),Le=Z.total,Be=e.querySelector(`[data-military-recipe-output="${B}"]`);if(Be){const E=P(Le);Be.innerHTML=G>0?`${Zt(E,P(Le.mul(G).mul(pe)),"text-positive")}`:E,Be.classList.toggle("text-positive",G>0),Be.classList.toggle("text-text",G<=0)}const Ne=e.querySelector(`[data-military-input-tooltip="${B}"]`);if(Ne){const E=rr(se,s.upgrades,s.artifacts,1),F=W.recipe.length>0?W.recipe[0].amount:new m(0),N=ve.length>0?G>0?ve[0].amount.mul(G).mul(pe):E.total.mul(F):new m(0);Ne.innerHTML=Qt(G>0?"Input per second":"Input per craft","Base cost/craft",F,E.multipliers,G,pe,N)}const U=e.querySelector(`[data-military-output-tooltip="${B}"]`);U&&(U.innerHTML=Qt(G>0?"Output per second":"Output per craft","Base output/craft",new m(1),Z.multipliers,G,pe,G>0?Le.mul(G).mul(pe):Le));const A=e.querySelector(`[data-military-craft-time="${B}"]`);A&&(A.textContent=`${P(he)}s`)}const _=d?Sn(d,r):null,J=e.querySelector("[data-military-unlock-progress]");if(J&&_){J.textContent=`to unlock (${P(_.required-_.current)} more)`;const B=e.querySelector("[data-military-unlock-bar]");B&&(B.style.width=`${Math.min(100,_.current/_.required*100)}%`)}const ee=t.activeRealm==="realm1"&&Xe("soulforge",r);if(ee!==ui){n();return}const X=e.querySelector("[data-soulforge-unlock-progress]");if(X){const B=Sn("soulforge",r);if(B){X.textContent=`to unlock (${P(B.required-B.current)} more)`;const se=e.querySelector("[data-soulforge-unlock-bar]");se&&(se.style.width=`${Math.min(100,B.current/B.required*100)}%`)}}if(ee){const B=t.realms.realm3,se=D(B.recipeInventory,"soulforge"),ae=Cr(B),fe=D(s.recipeInventory,"gem_8"),me=fe.gte(ae),G=Math.min(1,fe.div(ae).toNumber()),W=e.querySelector("[data-soulforge-count]");W&&(W.textContent=`Owned: ${P(se)}`);const he=e.querySelector("[data-soulforge-cost]");he&&(he.textContent=P(ae)),Ct(e.querySelector("[data-soulforge-progress]"),G);const pe=e.querySelector('[data-action="craft-soulforge"]');if(pe){pe.disabled=!me;const ge=me?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";pe.className=`relative px-4 py-2 text-sm font-mono border overflow-hidden ${ge}`}}const re=t.activeRealm==="realm2"&&Xe("forge_enhancer",r);if(re!==di){n();return}const ce=e.querySelector("[data-forge-enhancer-unlock-progress]");if(ce){const B=Sn("forge_enhancer",r);if(B){ce.textContent=`to unlock (${P(B.required-B.current)} more)`;const se=e.querySelector("[data-forge-enhancer-unlock-bar]");se&&(se.style.width=`${Math.min(100,B.current/B.required*100)}%`)}}if(re){const B=t.realms.realm3,se=D(B.recipeInventory,"forge_enhancer"),ae=Er(B),fe=D(s.recipeInventory,"gem_8"),me=fe.gte(ae),G=Math.min(1,fe.div(ae).toNumber()),W=e.querySelector("[data-forge-enhancer-count]");W&&(W.textContent=`Owned: ${P(se)}`);const he=e.querySelector("[data-forge-enhancer-cost]");he&&(he.textContent=P(ae)),Ct(e.querySelector("[data-forge-enhancer-progress]"),G);const pe=e.querySelector('[data-action="craft-forge-enhancer"]');if(pe){pe.disabled=!me;const ge=me?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";pe.className=`relative px-4 py-2 text-sm font-mono border overflow-hidden ${ge}`}}}},qo=St(xe.Crafting,md),pd=qo.cleanup,gd=qo.render,Lr={t1KnightStrength:"t1_knight",t4KnightStrength:"t4_knight",t7KnightStrength:"t7_knight"},Pr={t4SwordEfficiency:"t4_sword",t5SwordEfficiency:"t5_sword",t6SwordEfficiency:"t6_sword"},fi=(e,n)=>{if(e==="craftersGuild")return na(n);if(e==="gemManufacturing")return sa(n);if(e==="cheaperGems")return aa(n);if(e==="cheaperFlasks")return ia(n);if(e==="cheaperMilitary")return oa(n);const t=Lr[e];if(t)return new m(Ji(n,t));const s=Pr[e];return s?ca(n,s):new m(1)},hd=(e,n,t,s)=>{const r=Yn(e,n);if(!r)return 1;let a=1;for(const i of r){let o;i.recipeId&&s?o=D(s,i.recipeId):o=t[i.tier];const u=i.amount.gt(0)?Math.min(1,o.div(i.amount).toNumber()):1;a=Math.min(a,u)}return a},vd=(e,n,t)=>{let s="";const r=t>=1;for(const a of e){const i=ht[a],o=gt(n,a,t),u=vn(o,!1);s+=`
      <tr data-upgrade-row="${a}" class="${o?"text-muted--50":""}">
        <td data-upgrade-name="${a}" class="w-76 ${o?"line-through":"text-gold"}">
          <span class="inline-flex items-center gap-1.5">
            ${cn(i.tooltip.split(`
`).map(l=>({label:l})))}
            ${i.name}
          </span>
        </td>
        <td data-upgrade-level="${a}" class="w-24 text-steel"></td>
        <td data-upgrade-cost="${a}" class="w-50"></td>
        <td data-upgrade-effect="${a}" class="w-48"></td>
        <td class="w-28">
          <button
            data-action="purchase-upgrade"
            data-id="${a}"
            disabled
            class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${u}"
          >
            ${o?"":Tt(0,`data-upgrade-progress="${a}"`)}
            <span data-upgrade-btn-text="${a}" class="relative z-10">${o?"MAX":"Buy"}</span>
          </button>
        </td>
        ${r?`<td class="w-20 text-center">
          ${o?"":`<input type="checkbox" data-action="toggle-autobuy" data-id="${a}" class="cursor-pointer accent-gold">`}
        </td>`:""}
      </tr>`}return s},bd=(e,n,t,s)=>{if(e.length===0)return"";const r=e.every(i=>gt(n,i,t));let a="";return r&&(a+='<div class="text-muted text-sm mb-4">All research upgrades maxed.</div>'),a+=`<div class="mobile-scroll-x"><table class="text-sm font-mono mb-6" data-upgrade-table="${s}">
    <thead>
      <tr class="text-steel border-b border-muted--30">
        <th class="w-76 text-left">Upgrade</th>
        <th class="w-24 text-left">Level</th>
        <th class="w-50 text-left">Cost</th>
        <th class="w-48 text-left">Effect</th>
        <th class="w-28"></th>
        ${t>=1?`<th class="w-20 text-center"><span data-action="toggle-all-autobuy" data-table="${s}" class="cursor-pointer text-steel hover-text-text" style="text-decoration: underline" title="Toggle all auto-buy"><span data-autobuy-header-check="${s}"></span> Auto</span></th>`:""}
      </tr>
    </thead>
    <tbody>${vd(e,n,t)}</tbody>
  </table></div>`,a},xd=e=>{let n=M.getState().activeRealm,t=M.getState().globalTier,s=0,r=!0;const a=()=>{e.querySelectorAll("[data-upgrade-row]").forEach(o=>{const u=o;r&&u.classList.contains("text-muted--50")?u.style.display="none":u.style.display=""})},i=()=>{var w;const o=M.getState(),u=z(o),{upgrades:l}=u,d=o.globalTier;if(n=o.activeRealm,t=d,o.activeRealm==="realm3"){e.innerHTML=`<div class="p-4 font-mono">
        <div class="text-steel text-sm mb-4">The Realm of Magic has no upgrades yet.</div>
      </div>`;return}const c=Qr.filter(p=>{var h,x;if(an.includes(p)){if(o.activeRealm!=="realm1")return!1;const S=Lr[p];if(S&&(((h=u.recipeCrafting[S])==null?void 0:h.lifetimeProduced)??0)===0)return!1}if(rn.includes(p)){if(o.activeRealm!=="realm2")return!1;const S=Pr[p];if(S&&(((x=u.recipeCrafting[S])==null?void 0:x.lifetimeProduced)??0)===0)return!1}return!0});s=c.filter(p=>an.includes(p)||rn.includes(p)).length;const f=c.some(p=>gt(l,p,d));let b='<div class="p-4 font-mono">';f&&(b+=`<label class="inline-flex items-center gap-2 text-sm text-steel cursor-pointer mb-4">
        <input type="checkbox" data-action="toggle-hide-maxed" ${r?"checked":""} class="cursor-pointer accent-gold">
        Hide maxed upgrades
      </label>`),d>=1&&!o.dismissedTips.includes("research-auto-toggle")&&(b+=`
      <div data-tip="research-auto-toggle" class="mb-4 flex items-center gap-2 text-sm">
        <button data-action="dismiss-tip" data-tip-id="research-auto-toggle" class="text-muted hover-text-positive cursor-pointer border-none bg-transparent" title="Dismiss tip">&#x2714;</button>
        <span class="text-muted">Tip: click the Auto header to toggle all automations</span>
      </div>`),b+=bd(c,l,d,"research"),b+="</div>",e.innerHTML=b;const y=e.querySelector('[data-action="toggle-hide-maxed"]');y&&y.addEventListener("change",()=>{r=y.checked,a()}),a(),e.querySelectorAll('[data-action="purchase-upgrade"]').forEach(p=>{p.addEventListener("click",()=>{const h=p.getAttribute("data-id");M.getState().purchaseUpgrade(h)})});const g=z(M.getState());e.querySelectorAll('[data-action="toggle-autobuy"]').forEach(p=>{const h=p.getAttribute("data-id");p.checked=g.autoBuyUpgrades[h]??!1,p.addEventListener("change",()=>{M.getState().toggleAutoBuy(h)})}),e.querySelectorAll('[data-action="toggle-all-autobuy"]').forEach(p=>{p.addEventListener("click",()=>{const h=p.getAttribute("data-table"),x=e.querySelector(`[data-upgrade-table="${h}"]`);if(!x)return;const S=[];x.querySelectorAll('[data-action="toggle-autobuy"]').forEach(v=>{S.push(v.getAttribute("data-id"))});const $=M.getState(),R=z($),k=S.every(v=>R.autoBuyUpgrades[v]);for(const v of S){const I=R.autoBuyUpgrades[v]??!1;(k?I:!I)&&M.getState().toggleAutoBuy(v)}})}),(w=e.querySelector('[data-action="dismiss-tip"]'))==null||w.addEventListener("click",p=>{var S;const h=p.currentTarget.getAttribute("data-tip-id"),x=M.getState();M.setState({dismissedTips:[...x.dismissedTips,h]}),(S=e.querySelector(`[data-tip="${h}"]`))==null||S.remove()})};return i(),()=>{const o=M.getState(),u=z(o),{upgrades:l}=u,d=xn(u.recipeInventory),c=Nt(u.recipeInventory),f=o.globalTier;if(o.activeRealm==="realm3")return;const b=an.filter(g=>{var p;const w=Lr[g];return w&&(((p=u.recipeCrafting[w])==null?void 0:p.lifetimeProduced)??0)>0}).length+rn.filter(g=>{var p;const w=Pr[g];return w&&(((p=u.recipeCrafting[w])==null?void 0:p.lifetimeProduced)??0)>0}).length;if(o.activeRealm!==n||o.globalTier!==t||b!==s){i();return}const y=e.querySelectorAll("[data-upgrade-row]");for(const g of y){const w=g.getAttribute("data-upgrade-row");if(gt(l,w,f)&&!g.classList.contains("text-muted--50")){i();return}}e.querySelectorAll("[data-upgrade-row]").forEach(g=>{const w=g.getAttribute("data-upgrade-row"),p=l[w],h=yl(w,f),x=gt(l,w,f),S=Yn(w,p),$=Kn(l,w,u.mana,c,d,f,u.recipeInventory),R=x?1:hd(w,p,d,u.recipeInventory),k=e.querySelector(`[data-upgrade-level="${w}"]`);k&&(k.textContent=`${Y(p)}/${Y(h)}`);const v=e.querySelector(`[data-upgrade-cost="${w}"]`);v&&(x||!S?v.innerHTML="-":v.innerHTML=`<div class="flex items-center gap-2 flex-nowrap">${S.map(q=>{const j=q.recipeId?q.recipeId.replace("_"," "):`t${q.tier} flask`;let H;return q.recipeId?H=D(u.recipeInventory,q.recipeId).gte(q.amount):H=Zi(d,q.tier,q.amount),`<div class="flex items-center gap-0.5">
              <img src="${O(`icons/${j}.png`)}" alt="" class="w-8 h-8 object-contain">
              <span class="${H?"text-text":"text-muted--50"}">${P(q.amount)}</span>
            </div>`}).join("")}</div>`);const I=e.querySelector(`[data-upgrade-effect="${w}"]`);if(I){const q=fi(w,l);if(x)I.innerHTML=`<span class="text-steel">x${P(q)}</span>`;else{const j={...l,[w]:p+1},H=fi(w,j);I.innerHTML=`<span class="text-steel">x${P(q)}</span><span class="text-muted">  </span><span class="text-positive">x${P(H)}</span>`}}const T=e.querySelector(`[data-action="purchase-upgrade"][data-id="${w}"]`);if(T){const q=vn(x,$);T.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${q}`,x||!$?T.setAttribute("disabled",""):T.removeAttribute("disabled");const j=e.querySelector(`[data-upgrade-btn-text="${w}"]`);j&&(j.textContent=x?"MAX":"Buy"),Ct(e.querySelector(`[data-upgrade-progress="${w}"]`),R,x)}const L=e.querySelector(`[data-action="toggle-autobuy"][data-id="${w}"]`);L&&(L.checked=u.autoBuyUpgrades[w]??!1)}),e.querySelectorAll("[data-autobuy-header-check]").forEach(g=>{const w=g.getAttribute("data-autobuy-header-check"),p=e.querySelector(`[data-upgrade-table="${w}"]`);if(!p)return;const h=[];p.querySelectorAll('[data-action="toggle-autobuy"]').forEach(S=>{h.push(S.getAttribute("data-id"))});const x=h.length>0&&h.every(S=>u.autoBuyUpgrades[S]);g.textContent=x?"":""}),a()}},_o=St(xe.Upgrades,xd),yd=_o.cleanup,wd=_o.render,mi=(e,n="w-10 h-10")=>e.map(t=>`
    <span class="inline-flex items-center gap-0.5">
      <img src="${t.icon}" alt="" class="${n} object-contain">
      <span class="${t.canAfford?"text-text":"text-red"}">${P(t.amount)}</span>
    </span>
  `).join(""),pi=()=>{const e=M.getState(),n=z(e),{artifacts:t}=n;if(!dt.some(u=>t.owned[u]))return"";const r=[],a=u=>`<img src="${u}" alt="" style="width:40px;height:40px" class="object-contain">`;for(let u=1;u<=8;u++){const l=ma(t,u);l.eq(1)||r.push(`<tr><td class="pr-2">${a(O(`icons/t${u} gem.png`))}</td><td class="text-positive">x${P(l)}</td><td class="pl-1 text-muted">gem output</td></tr>`)}const i=oo(t);i>1&&r.push(`<tr><td class="pr-2">${a(O("icons/combat artifact.png"))}</td><td class="text-positive">x${P(i)}</td><td class="pl-1 text-muted">combat strength</td></tr>`);const o=co(t);return o>1&&r.push(`<tr><td class="pr-2">${a(O("icons/crafting speed.png"))}</td><td class="text-positive">x${P(o)}</td><td class="pl-1 text-muted">craft speed</td></tr>`),r.length===0?"":`
    <div class="artifact-bonuses-box p-2 border border-muted--20" style="width:fit-content">
      <div class="text-xs text-muted mb-1">Active Bonuses</div>
      <table class="text-sm font-mono">
        ${r.join("")}
      </table>
    </div>
  `},ot=(e,n)=>{const t=Ce[e];if(t.type==="crafting_speed"){const r=1+t.upgradeBonus*n;return r===1?"x1":`x${P(r)}`}const s=Math.pow(1+t.upgradeBonus,n);return s===1?"x1":`x${P(s)}`},Jt=e=>{const n=Ce[e];return n.type==="combat"?"combat strength":n.type==="crafting_speed"?"craft speed":"gem output"},gi=e=>{if(e.length===0)return 0;let n=1;for(const t of e)if(t.amount.gt(0)){const s=Math.min(1,t.have.div(t.amount).toNumber());s<n&&(n=s)}return n},Ms=e=>{const n=M.getState(),t=z(n),s=et(t.artifacts,e),r=t.artifacts.upgradeLevels[e]??0,a=xs(n.globalTier,e);if(n.activeRealm==="realm2")return{costHtml:"",canAct:!1,action:"none",progress:0};const o=D(t.recipeInventory,"artifact_shard").toNumber();if(!s){const d=Ol(e,o),c=ro(e,o);return{costHtml:mi(d),canAct:c,action:"buy",progress:gi(d)}}if(r>=a)return{costHtml:"",canAct:!1,action:"maxed",progress:0};const u=Ul(e,r,a,o),l=ao(e,r,o,a);return{costHtml:mi(u),canAct:l,action:"upgrade",progress:gi(u)}},Sd=["ring","general"],kd={ring:"Rings",general:"General"},$d=e=>{const n=Ce[e];return n.type==="combat"||n.type==="crafting_speed"?"general":"ring"},hi=()=>{const e=M.getState(),n=z(e);return e.activeRealm==="realm2"?dt.filter(s=>n.artifacts.owned[s]):dt.filter(s=>{var a,i;const r=Ce[s];return n.artifacts.owned[s]||e.realms.realm2.artifacts.owned[s]?!0:r.tier===1?(((a=n.recipeCrafting.artifact_shard)==null?void 0:a.lifetimeProduced)??0)>0:(((i=n.recipeCrafting.artifact_shard)==null?void 0:i.lifetimeProduced)??0)>0})},vi=e=>{const{costHtml:n,action:t}=Ms(e);return t==="none"||t==="maxed"?"":`<span class="inline-flex items-center gap-1 text-xs">${n}</span>`},bi=e=>{const{canAct:n,action:t,progress:s}=Ms(e);return t==="none"?"":t==="maxed"?'<span class="text-gold text-xs">MAX</span>':`
      <button
        data-action="${t}-artifact"
        data-id="${e}"
        ${n?"":"disabled"}
        class="relative px-2 py-0.5 text-xs font-mono border overflow-hidden ${n?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"} whitespace-nowrap"
      >${Tt(s,`data-forge-progress="${e}"`)}<span class="relative z-10">Forge</span></button>
  `},Id=e=>{const n=()=>{var u;const t=M.getState(),s=z(t),r=t.activeRealm==="realm2";if(!r&&(((u=s.recipeCrafting.artifact_shard)==null?void 0:u.lifetimeProduced)??0)===0){e.innerHTML=`
        <div class="flex items-center justify-center h-64">
          <div class="text-center text-muted">
            <div class="text-lg mb-2">You must get artifact shards from expeditions before you can craft artifacts</div>
          </div>
        </div>
      `;return}const a=hi();if(a.length===0&&r){e.innerHTML=`
        <div class="p-4 font-mono">
          <h2 class="text-lg text-gold mb-2">Artifacts</h2>
          <div class="text-muted text-center py-8">
            No artifacts shipped yet. Use the Realm tab to ship artifacts from the Prime Realm.
          </div>
        </div>
      `;return}let i='<div class="p-4 font-mono">';i+='<div class="flex items-start gap-4 flex-wrap-mobile">',i+='<div class="flex-1 min-w-0">',i+='<h2 class="text-lg text-gold mb-2">Artifacts</h2>',i+=`<div class="text-sm text-steel mb-4">${r?"Artifacts shipped from the Prime Realm.":"Craft and upgrade artifacts with artifact shards from expeditions."}</div>`,r||(i+=`
        <div class="text-sm mb-4">
          <span class="text-muted">Artifact Shards:</span>
          <span class="text-text" data-artifact-shards>${P(D(s.recipeInventory,"artifact_shard").toNumber())}</span>
        </div>
      `);const o={ring:[],general:[]};for(const l of a)o[$d(l)].push(l);for(const l of Sd){const d=o[l];if(d.length===0)continue;let c=`<div class="mobile-scroll-x"><table class="text-sm font-mono" style="table-layout:fixed" data-artifacts-table="${l}">
        <colgroup>
          <col style="width:200px">
          <col style="width:70px">
          <col style="width:320px">
          <col style="width:80px">
          <col style="width:80px">
        </colgroup>
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="text-left">Artifact</th>
            <th class="text-left">Level</th>
            <th class="text-left">Effect</th>
            <th class="text-left">Cost</th>
            <th class="text-right">Forge</th>
          </tr>
        </thead>
        <tbody>`;for(const f of d){const b=Ce[f],y=et(s.artifacts,f),g=s.artifacts.upgradeLevels[f]??0,w=xs(t.globalTier,f),p=g>=w;let h="";if(y)if(p)h=`<span class="text-text">${ot(f,g)}</span> <span class="text-muted">${Jt(f)}</span>`;else{const x=ot(f,g),S=ot(f,g+1),$=Jt(f);h=`<span class="text-text">${x}</span> <span class="text-steel"></span> <span class="text-positive">${S}</span> <span class="text-muted">${$}</span>`}else{const x=ot(f,1),S=Jt(f);h=`<span class="text-text">${ot(f,0)}</span> <span class="text-steel"></span> <span class="text-positive">${x}</span> <span class="text-muted">${S}</span>`}c+=`
          <tr data-artifact-row="${f}">
            <td class="py-1">
              <span class="inline-flex items-center gap-1.5">
                <img src="${b.icon}" alt="${b.name}" style="width: 48px; height: 48px;" class="object-contain">
                <span class="text-gold">${b.name}</span>
              </span>
            </td>
            <td class="text-steel" data-artifact-level="${f}">${y?g:"-"}</td>
            <td data-artifact-effect-cell="${f}">${h}</td>
            <td data-artifact-cost="${f}">${vi(f)}</td>
            <td class="text-right" data-artifact-action="${f}">${bi(f)}</td>
          </tr>`}c+="</tbody></table></div>",i+=`<div class="mb-4">${ut(`artifacts-${l}`,kd[l],c)}</div>`}i+="</div>",i+=`<div data-artifacts-bonuses class="flex-shrink-0">${pi()}</div>`,i+="</div>",i+="</div>",e.innerHTML=i,Rd(e),e.querySelectorAll("[data-artifact-action]").forEach(l=>{const d=l.getAttribute("data-artifact-action"),{action:c}=Ms(d);l.setAttribute("data-prev-action",c)})};return n(),()=>{var d;const t=M.getState(),s=z(t),r=t.activeRealm==="realm2",a=e.querySelectorAll("[data-artifact-row]");let i=!1;const o=hi();for(const c of o)if(!e.querySelector(`[data-artifact-row="${c}"]`)){i=!0;break}if(!i)for(const c of a){const f=c.getAttribute("data-artifact-row"),b=et(s.artifacts,f),y=e.querySelector(`[data-artifact-level="${f}"]`);if(y&&y.textContent!=="-"!==b){i=!0;break}}if(!r&&(((d=s.recipeCrafting.artifact_shard)==null?void 0:d.lifetimeProduced)??0)>0&&!e.querySelector("[data-artifacts-bonuses]")&&(i=!0),i){n();return}const u=e.querySelector("[data-artifacts-bonuses]");u&&(u.innerHTML=pi());const l=e.querySelector("[data-artifact-shards]");l&&(l.textContent=P(D(s.recipeInventory,"artifact_shard").toNumber()));for(const c of a){const f=c.getAttribute("data-artifact-row"),b=et(s.artifacts,f),y=s.artifacts.upgradeLevels[f]??0,g=xs(t.globalTier,f),w=y>=g,p=e.querySelector(`[data-artifact-level="${f}"]`);p&&(p.textContent=b?String(y):"-");const h=e.querySelector(`[data-artifact-effect-cell="${f}"]`);if(h){let $="";if(b)if(w)$=`<span class="text-text">${ot(f,y)}</span> <span class="text-muted">${Jt(f)}</span>`;else{const R=ot(f,y),k=ot(f,y+1),v=Jt(f);$=`<span class="text-text">${R}</span> <span class="text-steel"></span> <span class="text-positive">${k}</span> <span class="text-muted">${v}</span>`}else{const R=ot(f,1),k=Jt(f);$=`<span class="text-text">${ot(f,0)}</span> <span class="text-steel"></span> <span class="text-positive">${R}</span> <span class="text-muted">${k}</span>`}h.innerHTML=$}const x=e.querySelector(`[data-artifact-cost="${f}"]`);x&&(x.innerHTML=vi(f));const S=e.querySelector(`[data-artifact-action="${f}"]`);if(S){const{canAct:$,action:R,progress:k}=Ms(f),v=e.querySelector(`[data-forge-progress="${f}"]`);Ct(v,k);const I=S.querySelector("button");if(I){const q=$?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed";I.className=`relative px-2 py-0.5 text-xs font-mono border overflow-hidden ${q} whitespace-nowrap`,I.disabled=!$}const T=S.getAttribute("data-prev-action")??"",L=R;if(T!==L){S.setAttribute("data-prev-action",L),S.innerHTML=bi(f);const q=S.querySelector("button");q&&q.addEventListener("click",j=>{j.stopPropagation(),Lo(f)})}}}}},Lo=e=>{const n=M.getState(),t=z(n);et(t.artifacts,e)?M.getState().upgradeArtifact(e):M.getState().craftArtifact(e)},Rd=e=>{e.querySelectorAll('[data-action="buy-artifact"], [data-action="upgrade-artifact"]').forEach(n=>{n.addEventListener("click",t=>{t.stopPropagation();const s=n.getAttribute("data-id");Lo(s)})})},Po=St(xe.Artifacts,Id),Md=Po.render,Td=Po.cleanup,bn=e=>{const n=Math.ceil(e/1e3),t=Math.floor(n/60),s=n%60;if(t===0)return`${s}s`;if(t>=60){const r=Math.floor(t/60),a=t%60;return`${r}h ${a}m`}return`${t}m ${s}s`},Cd=e=>{const t=Date.now()-e,s=Math.floor(t/1e3),r=Math.floor(s/60),a=Math.floor(r/60);return a>0?`${a}h ago`:r>0?`${r}m ago`:`${s}s ago`},Ds=(e,n="normal")=>{const t=[],s=n==="small"?40:32,r=`width: ${s}px; height: ${s}px;`,a=n==="small"?"text-muted":"text-xs text-muted",i=n==="small"?"font-size: 14px;":"";if(e.artifactShards&&t.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/artifact shard.png")}" style="${r}"><span class="${a}" style="${i}">${Y(e.artifactShards)}</span></span>`),e.nullstone&&t.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/nullstone.png")}" style="${r}"><span class="${a}" style="${i}">${Y(e.nullstone)}</span></span>`),e.arcaneBars&&t.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/arcane bar.png")}" style="${r}"><span class="${a}" style="${i}">${Y(e.arcaneBars)}</span></span>`),e.arcaneLogs&&t.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/arcane log.png")}" style="${r}"><span class="${a}" style="${i}">${Y(e.arcaneLogs)}</span></span>`),e.questBonusTiers&&e.questBonusTiers.length>0){const o=e.questBonusTiers.length===1?`T${e.questBonusTiers[0]}`:`T${Math.min(...e.questBonusTiers)}-T${Math.max(...e.questBonusTiers)}`;t.push(`<span class="text-xs text-yellow">${o} Output Bonus</span>`)}return t.join(" ")},Oo=(e,n)=>{const t={};return e.artifactShards&&(t.artifactShards=e.artifactShards*n),e.nullstone&&(t.nullstone=e.nullstone*n),e.arcaneBars&&(t.arcaneBars=e.arcaneBars*n),e.arcaneLogs&&(t.arcaneLogs=e.arcaneLogs*n),e.questBonusTiers&&(t.questBonusTiers=e.questBonusTiers),t},Hs=(e,n,t=1)=>{if(n<=0)return"";const s=n/1e3,r=[];if(e.artifactShards){const a=e.artifactShards/s*t;r.push(`${P(a)}/s`)}if(e.nullstone){const a=e.nullstone/s*t;r.push(`${P(a)}/s`)}if(e.arcaneBars){const a=e.arcaneBars/s*t;r.push(`${P(a)}/s`)}if(e.arcaneLogs){const a=e.arcaneLogs/s*t;r.push(`${P(a)}/s`)}return r.length===0?"":`(${r.join(", ")})`},Na=(e,n,t)=>e.unlockRequirement?n.find(s=>s.id===e.unlockRequirement):t>0?n[t-1]:void 0,Ts=(e,n,t,s,r=0)=>{if(pn(e,t,s,r))return!(e==="heroic_war_mastery"&&!M.getState().realms.realm1.combat.portalBuilt);const a=n.find(u=>u.id===e);if(a!=null&&a.heroic)return!1;const i=n.findIndex(u=>u.id===e);if(!a)return!1;const o=Na(a,n,i);return o?pn(o.id,t,s,r):i===0},wn=()=>{const e=M.getState();if(e.activeRealm==="realm3"){const n=e.realms.realm3.recipeInventory,t={};for(const s of Je("realm3"))t[s]=n[s]||new m(0);return t}return Jr(Mt(e.realms.realm1.recipeInventory),Mt(e.realms.realm2.recipeInventory),e.activeRealm,e.globalTier)},Uo=(e,n)=>{const t=Ps(e);let s=!1;for(let a=1;a<=6;a++)if(t(a,n)>1){s=!0;break}if(!s)return"";let r='<div class="mb-4 p-3 border border-yellow--30 bg-yellow--5">';r+='<div class="text-sm font-bold text-yellow mb-2">Quest Output Bonuses</div>',r+='<div class="flex gap-4 text-xs">';for(let a=1;a<=6;a++){const i=t(a,n),o=i>1?`x${i.toFixed(2)}`:"",u=i>1?"text-yellow":"text-muted";r+=`<div class="flex flex-col items-center"><span class="text-muted">T${a}</span><span class="${u} font-mono">${o}</span></div>`}return r+="</div></div>",r},At=()=>{const e=M.getState();return e.activeRealm==="realm3"?Nn(e.realms.realm3.ascension):0};let Se=null,K=xa();const Ed=()=>Se,Ad=()=>{Se=null,K=xa()},Nd=(e,n)=>{var i;const t=M.getState(),s=z(t);if(!pn(e,s.combat.completionsPerExpedition,t.activeRealm,t.globalTier))return;Se=e;const r=Ye(e,t.activeRealm),a=s.combat.expeditionSetups[e];if(a){let o={...a.assignedUnits};if(r!=null&&r.heroic){const u=yn(t.activeRealm,t.globalTier);for(const l of Object.keys(o))((i=u[l])==null?void 0:i.unitRole)==="taunt"&&delete o[l]}K={assignedUnits:o,assignedEquipment:a.assignedEquipment?{...a.assignedEquipment}:void 0,repeatIfUnitsAvailable:r!=null&&r.heroic?!1:a.repeatIfUnitsAvailable}}else K=xa();Yd(n),Qe(n)},Or=e=>{Se=null;const n=e.querySelector("[data-setup-modal]");n&&n.classList.add("hidden")},qd=(e,n)=>{if(!Se)return;const t=Se;M.getState().saveExpeditionSetup(t,K),Or(e),_d(t),n()},_d=e=>{const n=M.getState(),s=z(n).combat.expeditionSetups[e];s&&n.startExpedition(e,s.assignedUnits,s.repeatIfUnitsAvailable)},js=e=>{var s;const n=M.getState();return((s=yn(n.activeRealm,n.globalTier)[e])==null?void 0:s.unitRole)??"strength"},qa=e=>{if(!Se)return;const n=M.getState(),t=z(n),s=Ye(Se,n.activeRealm);if(!s)return;const r=!!s.heroic,a=nt(K.assignedUnits,n.activeRealm,n.globalTier),i=bt(a),o=s.group?xt(K.assignedEquipment||{},s.group):1,l=(r?qt(s,t.combat.heroicVictories):s.difficulty??0)*i*o;if(st(K.assignedUnits,n.activeRealm,t.upgrades,t.artifacts,n.globalTier,At())<=l)return;const c=yt(n.activeRealm,n.globalTier),f=yn(n.activeRealm,n.globalTier),b=c.filter(h=>{const x=f[h];return(x==null?void 0:x.unitRole)==="strength"&&(K.assignedUnits[h]||0)>0});if(b.length===0)return;let y=0,g=1,w=0;for(let h=0;h<50;h++){const x=(y+g)/2,S={...K.assignedUnits};for(const R of b)S[R]=Math.max(0,Math.floor((K.assignedUnits[R]||0)*x));st(S,n.activeRealm,t.upgrades,t.artifacts,n.globalTier,At())>=l?(w=x,g=x):y=x}const p={...K.assignedUnits};for(const h of b)p[h]=Math.max(0,Math.floor((K.assignedUnits[h]||0)*w));K={...K,assignedUnits:p},Qe(e)},Qe=e=>{var H;if(!Se)return;const n=M.getState(),t=z(n),{upgrades:s}=t,r=wn(),a=Ye(Se,n.activeRealm);if(!a)return;const i=ys(K.assignedUnits,n.activeRealm,n.globalTier),o=nt(K.assignedUnits,n.activeRealm,n.globalTier),u=bt(o),l=ws(o),d=a.heroic?qt(a,t.combat.heroicVictories):a.difficulty??0,c=a.group?xt(K.assignedEquipment||{},a.group):1,f=a.group?Ss(K.assignedEquipment||{},a.group):1,b=d*u*c,y=st(K.assignedUnits,n.activeRealm,s,t.artifacts,n.globalTier,At()),g=On(y,b),w=g>0,p=yt(n.activeRealm,n.globalTier);for(const _ of p){const J=(r[_]||{toNumber:()=>0}).toNumber(),ee=e.querySelector(`[data-modal-available-${_}]`);ee&&(ee.textContent=Y(J));const X=e.querySelector(`[data-modal-input-${_}]`);X&&document.activeElement!==X&&(X.value=Y(K.assignedUnits[_]||0))}const h=e.querySelector("[data-modal-strength]");h&&(h.textContent=P(y),h.className=`font-mono ${w?"text-positive":"text-red"}`);const x=e.querySelector("[data-modal-success-rate]");x&&(x.textContent=`${(g*100).toFixed(1)}%`,x.className=`font-mono ${g>0?"text-positive":"text-red"}`);const S=e.querySelector("[data-modal-speed]");if(S){const _=gn(Se,n.activeRealm,i);S.textContent=i>0?`${bn(_)}`:"",S.className=`font-mono ${i>0?"text-cyan":"text-muted"}`}const $=e.querySelector("[data-modal-taunt-diff]");$&&($.textContent=o>0?`x${u.toFixed(2)}`:"",$.className=`font-mono ${o>0?"text-magenta":"text-muted"}`);const R=e.querySelector("[data-modal-taunt-reward]");R&&(R.textContent=o>0?`x${l.toFixed(2)}`:"",R.className=`font-mono ${o>0?"text-magenta":"text-muted"}`);const k=e.querySelector("[data-modal-equip-diff]");k&&(k.textContent=c>1?`x${c.toFixed(2)}`:"",k.className=`font-mono ${c>1?"text-gold":"text-muted"}`);const v=e.querySelector("[data-modal-equip-reward]");v&&(v.textContent=f>1?`x${f.toFixed(2)}`:"",v.className=`font-mono ${f>1?"text-gold":"text-muted"}`);const I=a.group?ho(a.group):[];for(const _ of I){const J=D(t.recipeInventory,_).toNumber(),ee=e.querySelector(`[data-modal-equip-available-${_}]`);ee&&(ee.textContent=Y(J));const X=e.querySelector(`[data-modal-equip-input-${_}]`);X&&document.activeElement!==X&&(X.value=Y(((H=K.assignedEquipment)==null?void 0:H[_])||0))}const T=e.querySelector("[data-modal-effective-difficulty]");if(T){const _=u>1||c>1;T.textContent=Y(Math.round(b)),T.className=_?"text-magenta font-mono":"font-mono"}const L=e.querySelector("[data-modal-effective-rewards]");if(L&&!!!a.heroic){const J=Fn(a.rewards,l,t.combat.heroicVictories,t.prestige,t.altar.sacrificeCounts,n.activeRealm,f);L.innerHTML=Ds(J,"small"),l>1||f>1?L.classList.add("text-magenta"):L.classList.remove("text-magenta");const X=e.querySelector("[data-modal-rewards-rate]");if(X){const re=gn(Se,n.activeRealm,i);X.textContent=Hs(J,re,g)}}const q=e.querySelector("[data-repeat-checkbox]");q&&(q.checked=K.repeatIfUnitsAvailable);const j=e.querySelector("[data-save-setup]");j&&(w?(j.disabled=!1,j.classList.remove("line-through","text-muted"),j.classList.add("text-steel","cursor-pointer")):(j.disabled=!0,j.classList.add("line-through","text-muted"),j.classList.remove("text-steel","cursor-pointer")))},Ur=(e,n,t)=>{if(!Se)return;const s=M.getState(),r=Ye(Se,s.activeRealm);if(!r)return;const a=wn(),i=Math.floor((a[e]||{toNumber:()=>0}).toNumber());let u=(K.assignedUnits[e]||0)+n;u=Math.max(0,u),u=Math.min(i,u);const l=!!r.heroic,d=js(e);if(n>0&&d==="strength"){const f=nt(K.assignedUnits,s.activeRealm,s.globalTier),b=bt(f),y=r.group?xt(K.assignedEquipment||{},r.group):1,w=(l?qt(r,z(M.getState()).combat.heroicVictories):r.difficulty??0)*b*y,p=z(M.getState()),{upgrades:h}=p,x=i;let S=x;const $=z(M.getState()).artifacts;for(let R=0;R<=x;R++){const k={...K.assignedUnits,[e]:R};if(st(k,s.activeRealm,h,$,s.globalTier,At())>=w){S=R;break}}u=Math.min(u,S)}const c=d==="taunt"?nt(K.assignedUnits,s.activeRealm,s.globalTier):0;if(K={...K,assignedUnits:{...K.assignedUnits,[e]:u}},d==="taunt"&&n<0&&nt(K.assignedUnits,s.activeRealm,s.globalTier)<c){qa(t);return}Qe(t)},Ld=(e,n)=>{if(!Se)return;const t=js(e);if(K={...K,assignedUnits:{...K.assignedUnits,[e]:0}},t==="taunt"){qa(n);return}Qe(n)},xi=(e,n,t)=>{if(!Se)return;const s=M.getState(),r=z(s),a=Ye(Se,s.activeRealm);if(!a)return;const i=wn(),o=Math.floor((i[e]||{toNumber:()=>0}).toNumber());let u=Math.max(0,Math.floor(n));u=Math.min(o,u);const l=!!a.heroic,d=js(e);if(d==="strength"){const f=nt(K.assignedUnits,s.activeRealm,s.globalTier),b=bt(f),y=a.group?xt(K.assignedEquipment||{},a.group):1,w=(l?qt(a,r.combat.heroicVictories):a.difficulty??0)*b*y,p={...K.assignedUnits,[e]:0},h=st(p,s.activeRealm,r.upgrades,r.artifacts,s.globalTier,At()),x=w-h;let S;if(x<=0)S=0;else{const R=yn(s.activeRealm,s.globalTier)[e],k=Qi(r.upgrades),v=((R==null?void 0:R.strengthMultiplier)??1)+k,I=(R==null?void 0:R.strengthExponent)??1;S=Math.ceil(Math.pow(x/v,1/I))}u=Math.min(u,S)}const c=K.assignedUnits[e]||0;if(K={...K,assignedUnits:{...K.assignedUnits,[e]:u}},d==="taunt"&&u<c){qa(t);return}Qe(t)},Pd=(e,n)=>{if(!Se)return;const t=M.getState(),s=z(t),r=Ye(Se,t.activeRealm);if(!r)return;const a=wn(),i=Math.floor((a[e]||{toNumber:()=>0}).toNumber()),o=!!r.heroic,u=i;if(js(e)!=="strength"){K={...K,assignedUnits:{...K.assignedUnits,[e]:u}},Qe(n);return}const d=nt(K.assignedUnits,t.activeRealm,t.globalTier),c=bt(d),f=r.group?xt(K.assignedEquipment||{},r.group):1,y=(o?qt(r,s.combat.heroicVictories):r.difficulty??0)*c*f;let g=0,w=u,p=u;for(;g<=w;){const h=Math.floor((g+w)/2),x={...K.assignedUnits,[e]:h};st(x,t.activeRealm,s.upgrades,s.artifacts,t.globalTier,At())>=y?(p=h,w=h-1):g=h+1}K={...K,assignedUnits:{...K.assignedUnits,[e]:p}},Qe(n)},Od=(e,n)=>{if(!Se)return;const t=M.getState(),s=z(t),r=Ye(Se,t.activeRealm);if(!r)return;const a=wn(),i=Math.floor((a[e]||{toNumber:()=>0}).toNumber()),o=!!r.heroic,u=nt(K.assignedUnits,t.activeRealm,t.globalTier),l=bt(u),d=r.group?xt(K.assignedEquipment||{},r.group):1,f=(o?qt(r,s.combat.heroicVictories):r.difficulty??0)*l*d,b=st(K.assignedUnits,t.activeRealm,s.upgrades,s.artifacts,t.globalTier,At()),y=On(b,f),g=Math.min(y+.1,1),w=f*g;let p=K.assignedUnits[e]||0,h=i,x=h;for(;p<=h;){const S=Math.floor((p+h)/2),$={...K.assignedUnits,[e]:S};st($,t.activeRealm,s.upgrades,s.artifacts,t.globalTier,At())>=w?(x=S,h=S-1):p=S+1}K={...K,assignedUnits:{...K.assignedUnits,[e]:x}},Qe(n)},Fo=e=>{var o;const n=M.getState(),s=((o=z(n).recipeCrafting[e])==null?void 0:o.lifetimeProduced)??0;if(s<=0)return[1,10,100];const r=s*.01,a=Math.floor(Math.log10(Math.max(1,r))),i=Math.max(1,Math.pow(10,a));return[i/100,i/10,i]},Ud=(e,n,t)=>{Ur(e,n,t)},Fd=e=>{K={...K,repeatIfUnitsAvailable:!K.repeatIfUnitsAvailable},Qe(e)},Bd=(e,n,t)=>{var u;if(!Se)return;const s=M.getState(),r=z(s),a=D(r.recipeInventory,e).toNumber(),i=((u=K.assignedEquipment)==null?void 0:u[e])||0,o=Math.max(0,Math.min(Math.floor(a),i+n));K={...K,assignedEquipment:{...K.assignedEquipment,[e]:o}},Qe(t)},yi=(e,n,t)=>{if(!Se)return;const s=M.getState(),r=z(s),a=D(r.recipeInventory,e).toNumber(),i=Math.max(0,Math.min(Math.floor(a),Math.floor(n)));K={...K,assignedEquipment:{...K.assignedEquipment,[e]:i}},Qe(t)},Dd=(e,n)=>{Se&&(K={...K,assignedEquipment:{...K.assignedEquipment,[e]:0}},Qe(n))},Hd=(e,n)=>{const t={strength:[],speed:[],taunt:[]};for(const s of e){const r=n[s];r&&t[r.unitRole].push(s)}return t},jd={strength:"Army",speed:"Fleet",taunt:"Beacons"},Gd={strength:"Increases combat strength, improving success rate",speed:"Reduces expedition duration",taunt:"Increases rewards (2x) and difficulty (1x)"},Vd={strength:[{label:"Success rate",value:"strength / difficulty"},{label:"Capped at 100%"},{label:"On success",value:"all units lost, rewards granted"},{label:"On failure",value:"all units lost, no rewards"}],speed:[{label:"Duration",value:"base / (1 + speed / "+eo+")"},{label:"Higher fleet value = faster expeditions"}],taunt:[{label:"Reward mult",value:"1 + taunt / "+no},{label:"Difficulty mult",value:"1 + taunt / "+to},{label:"Reward bonus is 2x the difficulty bonus"}]},Wd=(e,n)=>{const t=[{label:Gd[e.unitRole]},{label:"Formula",value:`n^${e.strengthExponent}  ${P(e.strengthMultiplier)}`},...Vd[e.unitRole]],s=`${n}<span class="text-muted cursor-help">?</span>`;return cn(t,e.name,s)},ur=(e,n,t,s)=>{if(n.length===0)return"";let r="";const a="h-6 text-xs border border-muted text-muted hover-border-steel hover-text-steel cursor-pointer";for(const o of n){const u=t[o],l=(s[o]||{toNumber:()=>0}).toNumber(),d=K.assignedUnits[o]||0,c=`<img src="${u.icon}" alt="${u.name}" style="width: 32px; height: 32px;">`;let f;if(e==="strength")f=`
          <button data-modal-assign="clear" data-unit="${o}" class="${a}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all assigned units">--</button>
          <input type="text" data-modal-input-${o} data-unit="${o}" value="${Y(d)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
          <button data-modal-assign="plus10" data-unit="${o}" class="${a}" style="min-width: 40px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add units to increase success rate by 10%">+10%</button>
          <button data-modal-assign="max" data-unit="${o}" class="${a}" style="min-width: 40px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add minimum units for 100% success rate">100%</button>
      `;else{const[b,y,g]=Fo(o);f=`
          <button data-modal-assign="clear" data-unit="${o}" class="${a}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all assigned units">--</button>
          <input type="text" data-modal-input-${o} data-unit="${o}" value="${Y(d)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
          <span class="text-muted text-xs" style="line-height: 1;">+</span>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button data-modal-assign="static" data-unit="${o}" data-amount="${g}" class="${a}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${Y(g)} units">${Y(g)}</button>
            <button data-modal-assign="static" data-unit="${o}" data-amount="${y}" class="${a}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${Y(y)} units">${Y(y)}</button>
            <button data-modal-assign="static" data-unit="${o}" data-amount="${b}" class="${a}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${Y(b)} units">${Y(b)}</button>
          </div>
      `}r+=`
      <div class="flex items-center mb-1" style="gap: 20px;">
        <span class="flex items-center gap-1">
          ${Wd(u,c)}
        </span>
        <span class="text-muted text-xs font-mono" style="width: 48px;" data-modal-available-${o}>${Y(l)}</span>
        <div class="flex items-center gap-1">
          ${f}
        </div>
      </div>
    `}return`
    <div class="min-w-0" style="flex: 1;">
      <div class="mb-2 pb-1 border-b border-muted--30">
        <span class="text-xs ${e==="strength"?"text-red":e==="speed"?"text-cyan":"text-magenta"} font-bold">${jd[e]}</span>
      </div>
      ${r}
    </div>
  `},Yd=e=>{if(!Se)return;const n=M.getState(),t=Ye(Se,n.activeRealm);if(!t)return;const s=z(n),r=wn(),a=gn(t.id,n.activeRealm),i=t.heroic?qt(t,s.combat.heroicVictories):t.difficulty??0,o=!!t.heroic,u=Bs(s.combat.heroicVictories,n.activeRealm);let l=t.rewards;u!==1&&t.rewards.artifactShards&&(l={...l,artifactShards:Math.round(t.rewards.artifactShards*u)});const d=yt(n.activeRealm,n.globalTier),c=yn(n.activeRealm,n.globalTier),f=t.group?ho(t.group):[],b=Hd(d,c),y=b.speed.length>0,g=!o&&b.taunt.length>0,w=1+(y?1:0)+(g?1:0),p=ur("strength",b.strength,c,r),h=y?ur("speed",b.speed,c,r):"",x=g?ur("taunt",b.taunt,c,r):"",S=e.querySelector("[data-setup-modal]");if(S){const $=w>=3?"max-w-5xl":w>=2?"max-w-4xl":"max-w-2xl";S.innerHTML=`
      <div data-modal-backdrop class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
        <div class="bg-black border border-muted--50 p-6 ${$} w-full mx-4">
          <div class="flex items-center gap-3 mb-4">
            <div>
              <h3 class="text-gold font-bold">${t.name}</h3>
              <div class="text-xs text-muted">
                Difficulty: <span data-modal-effective-difficulty class="font-mono">${Y(i)}</span>
                | Duration: ${bn(a)}
                | Done: ${o?s.combat.heroicVictories[t.id]||0:s.combat.completionsPerExpedition[t.id]||0}
              </div>
            </div>
            <button data-close-modal class="ml-auto text-muted hover-text-text text-2xl cursor-pointer">&times;</button>
          </div>

          <div class="mb-2">
            ${o?`<div class="text-xs text-muted">&#8226; ${t.heroic.rewardType==="shard_drops"?"Artifact shard drops":t.heroic.rewardType==="realm1_output"?"R1 output":"R2 output"} x${t.heroic.rewardScaling} per victory (compounding)</div><div class="text-xs text-muted">&#8226; Difficulty scales x${t.heroic.difficultyScaling} per victory</div>`:`<div class="flex items-center gap-2"><span class="text-xs text-muted">Rewards:</span> <span data-modal-effective-rewards>${Ds(l,"small")}</span> <span data-modal-rewards-rate class="text-xs text-cyan font-mono">${Hs(l,a)}</span></div>`}
          </div>

          <div class="mb-4">
            <div class="flex gap-4">
              ${p}
              ${h}
              ${x}
            </div>
          </div>

          ${f.length>0?`<div class="mb-4">
            <div class="mb-2 pb-1 border-b border-muted--30">
              <span class="text-xs text-gold font-bold">Equipment</span>
            </div>
            ${f.map(k=>{var _;const v=ne(k),I=D(s.recipeInventory,k).toNumber(),T=((_=K.assignedEquipment)==null?void 0:_[k])||0,L="h-6 text-xs border border-muted text-muted hover-border-steel hover-text-steel cursor-pointer",[q,j,H]=Fo(k);return`<div class="flex items-center mb-1" style="gap: 20px;">
                <span class="flex items-center gap-1">
                  <img src="${v.icon}" alt="${v.name}" style="width: 32px; height: 32px;">
                  <span class="text-muted cursor-help">${v.name}</span>
                </span>
                <span class="text-muted text-xs font-mono" style="width: 48px;" data-modal-equip-available-${k}>${Y(I)}</span>
                <div class="flex items-center gap-1">
                  <button data-modal-equip-assign="clear" data-equip="${k}" class="${L}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all">--</button>
                  <input type="text" data-modal-equip-input-${k} data-equip="${k}" value="${Y(T)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
                  <span class="text-muted text-xs" style="line-height: 1;">+</span>
                  <div style="display: flex; flex-direction: column; gap: 2px;">
                    <button data-modal-equip-assign="static" data-equip="${k}" data-amount="${H}" class="${L}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;">${Y(H)}</button>
                    <button data-modal-equip-assign="static" data-equip="${k}" data-amount="${j}" class="${L}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;">${Y(j)}</button>
                    <button data-modal-equip-assign="static" data-equip="${k}" data-amount="${q}" class="${L}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;">${Y(q)}</button>
                  </div>
                </div>
              </div>`}).join("")}
          </div>`:""}

          <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Strength:</span>
              <span data-modal-strength class="font-mono text-text">0</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Success:</span>
              <span data-modal-success-rate class="font-mono text-red">0%</span>
            </div>
            ${y?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Duration:</span>
              <span data-modal-speed class="font-mono text-muted"></span>
            </div>`:""}
            ${g?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Beacon Diff:</span>
              <span data-modal-taunt-diff class="font-mono text-muted"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Beacon Reward:</span>
              <span data-modal-taunt-reward class="font-mono text-muted"></span>
            </div>`:""}
            ${f.length>0?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Equip Diff:</span>
              <span data-modal-equip-diff class="font-mono text-muted"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Equip Reward:</span>
              <span data-modal-equip-reward class="font-mono text-muted"></span>
            </div>`:""}
          </div>

          ${o?"":`<div class="mb-4">
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" data-repeat-checkbox ${K.repeatIfUnitsAvailable?"checked":""} class="w-4 h-4 accent-cyan">
              <span class="text-sm text-text">Repeat if units available</span>
            </label>
          </div>`}

          <div class="flex gap-2">
            <button data-close-modal class="flex-1 px-4 py-2 border border-muted text-muted hover-border-text hover-text-text cursor-pointer">Cancel</button>
            <button data-save-setup class="flex-1 px-4 py-2 border border-steel text-steel cursor-pointer">Save and Start</button>
          </div>
        </div>
      </div>
    `,S.classList.remove("hidden");const R=S.querySelector("[data-repeat-checkbox]");R&&R.addEventListener("change",()=>{Fd(e)});for(const k of d){const v=S.querySelector(`[data-modal-input-${k}]`);v&&(v.addEventListener("change",()=>{const I=Jn(v.value);isNaN(I)||xi(k,I,e)}),v.addEventListener("keydown",I=>{if(I.key==="Enter"){const T=Jn(v.value);isNaN(T)||xi(k,T,e),v.blur()}}))}for(const k of f){const v=S.querySelector(`[data-modal-equip-input-${k}]`);v&&(v.addEventListener("change",()=>{const I=Jn(v.value);isNaN(I)||yi(k,I,e)}),v.addEventListener("keydown",I=>{if(I.key==="Enter"){const T=Jn(v.value);isNaN(T)||yi(k,T,e),v.blur()}}))}}},Fr=(e,n,t)=>{const s=wt(n);let r=`
    <select data-log-filter class="bg-black text-text border border-muted--30 text-xs px-2 py-1 rounded">
      <option value="all"${t==="all"?" selected":""}>All Expeditions</option>
  `;for(const l of s)r+=`<option value="${l.id}"${t===l.id?" selected":""}>${l.name}</option>`;r+="</select>";const i=(t==="all"?e:e.filter(l=>l.expeditionId===t)).slice(-20);if(i.length===0)return`
      <div class="flex items-center gap-3 mb-2">${r}</div>
      <div class="text-muted text-sm">No expeditions completed yet.</div>
    `;const o=[...i].reverse();let u=`
    <div class="flex items-center gap-3 mb-2">${r}</div>
    <table class="w-full border-collapse text-xs">
      <thead>
        <tr class="border-b border-muted--30 text-muted">
          <th class="py-1 px-2 text-left w-6"></th>
          <th class="py-1 px-2 text-left">Expedition</th>
          <th class="py-1 px-2 text-right">Chance</th>
          <th class="py-1 px-2 text-right">Rewards</th>
          <th class="py-1 px-2 text-right">Time</th>
        </tr>
      </thead>
      <tbody>
  `;for(const l of o){const d=Ye(l.expeditionId,n),c=(d==null?void 0:d.name)||l.expeditionId,f=l.success?"text-positive":"text-red",b=l.success?"":"",y=`${(l.successRate*100).toFixed(0)}%`;let g="";if(l.success&&l.rewards){const w=[];l.rewards.artifactShards&&w.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/artifact shard.png")}" style="width: 32px; height: 32px;">+${Y(l.rewards.artifactShards)}</span>`),l.rewards.nullstone&&w.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/nullstone.png")}" style="width: 32px; height: 32px;">+${Y(l.rewards.nullstone)}</span>`),l.rewards.arcaneBars&&w.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/arcane bar.png")}" style="width: 32px; height: 32px;">+${Y(l.rewards.arcaneBars)}</span>`),l.rewards.arcaneLogs&&w.push(`<span class="inline-flex items-center gap-1"><img src="${O("icons/arcane log.png")}" style="width: 32px; height: 32px;">+${Y(l.rewards.arcaneLogs)}</span>`),g=w.join(" ")}u+=`
      <tr class="border-b border-muted--20" data-log-entry="${l.timestamp}">
        <td class="py-1 px-2 ${f}">${b}</td>
        <td class="py-1 px-2 text-text">${c}</td>
        <td class="py-1 px-2 text-muted text-right">${y}</td>
        <td class="py-1 px-2 text-muted text-right">${g}</td>
        <td class="py-1 px-2 text-muted text-right" data-log-time="${l.timestamp}">${Cd(l.timestamp)}</td>
      </tr>
    `}return u+="</tbody></table>",u};let be=null,ln=null,Ft=null,Bt="all",Vn="",Br="",Dr="";const Kd=()=>{No(xe.Combat),ln&&(clearInterval(ln),ln=null),Ft&&be&&(be.removeEventListener("click",Ft),Ft=null),be=null,Ad(),Bt="all",Vn="",Br="",Dr=""},Bo=(e,n)=>{if(e.length===0)return"";let t="";for(let s=0;s<e.length;s++){const r=e[s],i=Date.now()-r.startTime,o=Math.max(0,r.duration-i),u=Math.min(i/r.duration,1),l=Math.round(u*100);t+=`
      <div data-progress-slot="${s}" class="flex items-center gap-2">
        <div class="w-16 h-2 bg-muted--30 overflow-hidden">
          <div data-progress-bar="${s}" class="h-full transition-none" style="width: ${l}%; min-width: ${l>0?"2px":"0"}; background-color: var(--color-cyan);"></div>
        </div>
        <span data-remaining-time="${s}" class="text-xs text-muted font-mono w-16 text-left">${bn(o)}</span>
      </div>
    `}return t},zd=()=>{if(!be)return;const e=M.getState(),n=z(e),{combat:t}=n,s=wt(e.activeRealm);for(const r of s){const a=t.activeExpeditions[r.id]||[],i=be.querySelector(`[data-expedition-row="${r.id}"]`);if(!i)continue;const o=i.querySelector("[data-progress-bars]");if(!o||o.querySelectorAll("[data-progress-slot]").length!==a.length)continue;const l=Date.now();for(let d=0;d<a.length;d++){const c=a[d],f=l-c.startTime,b=Math.max(0,c.duration-f),y=Math.round(Math.min(f/c.duration,1)*100),g=o.querySelector(`[data-progress-bar="${d}"]`);g&&(g.style.width=`${y}%`,g.style.minWidth=y>0?"2px":"0");const w=o.querySelector(`[data-remaining-time="${d}"]`);w&&(w.textContent=bn(b))}}},Xd=(e,n,t,s,r,a,i)=>{var d,c;const o=[s,String(r),a,i],u=wt(s);for(const f of u){const b=e.activeExpeditions[f.id]||[];o.push(`${f.id}:${e.completionsPerExpedition[f.id]||0}:${b.length}:${e.heroicVictories[f.id]||0}:${e.pendingRepeats[f.id]||0}:${JSON.stringify(((d=e.expeditionSetups[f.id])==null?void 0:d.assignedUnits)||{})}:${((c=e.expeditionSetups[f.id])==null?void 0:c.repeatIfUnitsAvailable)||!1}`)}const l=Je(s);for(const f of l){const b=(n[f]||{toNumber:()=>0}).toNumber();o.push(`${f}:${Math.floor(b)}`)}for(const f of l)o.push(`lc${f}:${t.lifetimeCrafted[f]??0}`);return o.join("|")},ss=()=>{var p,h;if(!be)return;const e=M.getState(),n=z(e),{combat:t}=n,s=Je(e.activeRealm),r=e.activeRealm==="realm3"?Object.fromEntries(s.map(x=>[x,n.recipeInventory[x]??new m(0)])):Mt(n.recipeInventory),a=Zr(n.recipeCrafting,s),i=JSON.stringify(n.prestige.prestigeCounts),o=JSON.stringify(n.altar.sacrificeCounts),u=Xd(t,r,a,e.activeRealm,e.globalTier,i,o);if(u===Br)return;Br=u;const l=wt(e.activeRealm),d=ua(e.activeRealm);if(Je(e.activeRealm).some(x=>(a.lifetimeCrafted[x]??0)>0||D(n.recipeInventory,x).gt(0))&&!be.querySelector("[data-expedition-row]")){cs(be);return}Ls(n.upgrades);for(let x=0;x<l.length;x++){const S=l[x],$=be.querySelector(`[data-expedition-row="${S.id}"]`);if(!$){if(Ts(S.id,l,t.completionsPerExpedition,e.activeRealm,e.globalTier)){cs(be);return}continue}const R=pn(S.id,t.completionsPerExpedition,e.activeRealm,e.globalTier),k=Ts(S.id,l,t.completionsPerExpedition,e.activeRealm,e.globalTier),v=t.activeExpeditions[S.id]||[],I=t.completionsPerExpedition[S.id]||0;if(k)$.classList.remove("hidden");else{$.classList.add("hidden");continue}const T=$.querySelector("[data-setup-btn]");if(R&&!T){cs(be);return}const L=$.querySelector("[data-locked-info]");if(L)if(R)L.classList.add("hidden");else{L.classList.remove("hidden");const ee=Na(S,l,x);if(ee){const X=t.completionsPerExpedition[ee.id]||0,re=d-X;L.innerHTML=`<span class="text-red">&#128274;</span> ${re} more`}}const q=$.querySelector("[data-completions]");if(q&&(S.heroic?q.textContent=`${t.heroicVictories[S.id]||0}`:q.textContent=`${I}`),S.heroic){const ee=$.querySelector(`[data-heroic-stats="${S.id}"]`);if(ee){const re=t.heroicVictories[S.id]||0,ce=S.heroic.rewardType==="shard_drops"?"Shards":S.heroic.rewardType==="realm1_output"?"R1 out":"R2 out";ee.textContent=`${ce} x${(S.heroic.rewardScaling**re).toFixed(2)}`}const X=$.querySelector(`[data-heroic-victory-count="${S.id}"]`);X&&(X.textContent=`W: ${t.heroicVictories[S.id]||0}`)}const j=$.querySelector(`[data-quest-bonus="${S.id}"]`);if(j&&S.rewards.questBonusTiers&&S.rewards.questBonusTiers.length>0){const ee=S.rewards.questBonusTiers.length===1?`T${S.rewards.questBonusTiers[0]}`:`T${Math.min(...S.rewards.questBonusTiers)}-T${Math.max(...S.rewards.questBonusTiers)}`;let X="";I>0&&(X=` (+${Math.sqrt(I*.1).toFixed(2)})`),j.textContent=`${ee} Output${X}`}const H=$.querySelector(`[data-reward-icons="${S.id}"]`);if(H){const ee=Fn(S.rewards,1,t.heroicVictories,n.prestige,n.altar.sacrificeCounts,e.activeRealm);H.innerHTML=Ds(ee,"small");const X=$.querySelector(`[data-reward-rate="${S.id}"]`);if(X)if(v.length>0){const re=v[0].tauntMultiplier??1,ce=v[0].equipmentMultiplier??1,B=Fn(S.rewards,re,t.heroicVictories,n.prestige,n.altar.sacrificeCounts,e.activeRealm,ce);X.textContent=Hs(Oo(B,v.length),v[0].duration,v[0].successRate)}else X.textContent=""}const _=$.querySelector("[data-progress-bars]");_&&_.querySelectorAll("[data-progress-slot]").length!==v.length&&(v.length>0?_.innerHTML=Bo(v):_.innerHTML="");const J=$.querySelector(`[data-clear-expedition="${S.id}"]`);J&&(v.length>0||!!t.expeditionSetups[S.id]?J.classList.remove("hidden"):J.classList.add("hidden"))}Ed()&&Qe(be);const b=((p=t.expeditionLog[0])==null?void 0:p.timestamp)??0,y=((h=t.expeditionLog[t.expeditionLog.length-1])==null?void 0:h.timestamp)??0,g=`${Bt}-${t.expeditionLog.length}-${b}-${y}`;if(g!==Vn){Vn=g;const x=be.querySelector("[data-expedition-log]");x&&(x.innerHTML=Fr(t.expeditionLog,e.activeRealm,Bt))}const w=JSON.stringify(t.completionsPerExpedition);if(w!==Dr){Dr=w;const x=be.querySelector("[data-quest-bonuses]");x&&(x.innerHTML=Uo(e.activeRealm,t.completionsPerExpedition))}},cs=e=>{be=e;const n=M.getState(),t=z(n),{combat:s}=t,r=Je(n.activeRealm),a=Zr(t.recipeCrafting,r);if(!r.some(p=>(a.lifetimeCrafted[p]??0)>0||D(t.recipeInventory,p).gt(0))){e.innerHTML=`
      <div class="flex items-center justify-center h-64">
        <div class="text-center text-muted">
          <div class="text-lg mb-2">You must craft expedition units before you can start an expedition</div>
        </div>
      </div>
    `,Gn(xe.Combat,ss);return}Ls(t.upgrades);const o=wt(n.activeRealm),u=ua(n.activeRealm),l=[],d=new Map;for(const p of o){const h=p.group||"Expeditions";if(!d.has(h)){const x=[];d.set(h,x),l.push({name:h,expeditions:x})}d.get(h).push(p)}const c=(p,h)=>{const x=pn(p.id,s.completionsPerExpedition,n.activeRealm,n.globalTier),S=s.activeExpeditions[p.id]||[],$=s.completionsPerExpedition[p.id]||0,R=h.indexOf(p);if(!Ts(p.id,h,s.completionsPerExpedition,n.activeRealm,n.globalTier))return"";if(x){const k=!!p.heroic,v=k&&s.heroicVictories[p.id]||0;let I="";if(k){const L=p.heroic.rewardType==="shard_drops"?"Shards":p.heroic.rewardType==="realm1_output"?"R1 out":"R2 out";I=`<div class="text-xs text-yellow font-mono" data-heroic-stats="${p.id}">${L} x${(p.heroic.rewardScaling**v).toFixed(2)}</div><div class="text-xs text-muted" data-heroic-victory-count="${p.id}">W: ${v}</div>`}else if(p.rewards.questBonusTiers&&p.rewards.questBonusTiers.length>0){const L=p.rewards.questBonusTiers.length===1?`T${p.rewards.questBonusTiers[0]}`:`T${Math.min(...p.rewards.questBonusTiers)}-T${Math.max(...p.rewards.questBonusTiers)}`;I=`<div class="text-xs text-yellow" data-quest-bonus="${p.id}">${L} Output${$>0?` (+${Math.sqrt($*.1).toFixed(2)})`:""}</div>`}else{const L=Fn(p.rewards,1,s.heroicVictories,t.prestige,t.altar.sacrificeCounts,n.activeRealm);let q="";if(S.length>0){const j=S[0].tauntMultiplier??1,H=S[0].equipmentMultiplier??1,_=Fn(p.rewards,j,s.heroicVictories,t.prestige,t.altar.sacrificeCounts,n.activeRealm,H);q=Hs(Oo(_,S.length),S[0].duration,S[0].successRate)}I=`<span data-reward-icons="${p.id}">${Ds(L,"small")}</span><div class="text-xs text-cyan font-mono" data-reward-rate="${p.id}">${q}</div>`}const T=S.length>0||!!s.expeditionSetups[p.id];return`
        <div data-expedition-row="${p.id}" data-expedition-click="${p.id}" class="border border-muted--30 p-2 cursor-pointer hover-border-steel hover-bg-row-odd-bright relative flex flex-col" style="width: 160px; height: 160px; background: var(--color-row-odd); overflow: hidden;">
          <div class="flex flex-col items-center gap-1">
            ${I}
          </div>
          <div data-progress-bars class="flex flex-col gap-1 mt-1 w-full">
            ${Bo(S)}
          </div>
          <span data-completions class="hidden">${k?v:$}</span>
          <span data-difficulty="${p.id}" class="hidden"></span>
          <span data-heroic-reward="${p.id}" class="hidden"></span>
          <div data-locked-info class="hidden"></div>
          <button data-setup-btn="${p.id}" class="hidden"></button>
          <button data-clear-expedition="${p.id}" class="mt-auto w-full text-xs border border-muted--30 text-muted hover-border-red hover-text-red cursor-pointer py-1 ${T?"":"hidden"}">Clear</button>
        </div>
      `}else{let k="";const v=Na(p,h,R);if(v){const I=s.completionsPerExpedition[v.id]||0;k=`<span class="text-red">&#128274;</span> ${u-I} more`}return`
        <div data-expedition-row="${p.id}" class="border border-muted--20 p-2 flex items-center justify-center" style="width: 160px; height: 160px; opacity: 0.5; background: var(--color-row-odd);">
          <div data-locked-info class="text-xs text-muted text-center">${k}</div>
        </div>
      `}},f={"Shards & CP":"+Shards<br>+Combat Points",Nullstones:"+Nullstones","Heroic Expeditions":"Heroic","Output Bonuses":"Output Bonuses"};let b="";for(const p of l){let h="";for(const S of p.expeditions)h+=c(S,o);if(!h)continue;const x=f[p.name]||p.name;b+=`
      <div class="flex items-center gap-4 mb-4">
        <div class="text-xs text-muted font-bold font-mono" style="width: 130px; flex-shrink: 0;">${x}</div>
        <div class="flex flex-wrap gap-2 items-center">
          ${h}
        </div>
      </div>
    `}const g=l.some(p=>p.name==="Heroic Expeditions"&&p.expeditions.some(h=>Ts(h.id,o,s.completionsPerExpedition,n.activeRealm,n.globalTier)))?'<div class="text-xs text-muted mb-4" style="margin-left: 146px;">Heroic expeditions never reset.</div>':"",w=Uo(n.activeRealm,s.completionsPerExpedition);e.innerHTML=`
    <div>
      <div data-quest-bonuses>${w}</div>
      ${b}
      ${g}
      <div class="mt-6">
        ${ut("expedition-log","Expedition Log",`<div data-expedition-log class="max-w-2xl">
            ${Fr(s.expeditionLog,n.activeRealm,Bt)}
          </div>`,!0)}
      </div>
      <div data-setup-modal class="hidden"></div>
    </div>
  `,Ft&&e.removeEventListener("click",Ft),Ft=p=>{const h=p.target,x=h.closest("[data-clear-expedition]");if(x){const I=x.getAttribute("data-clear-expedition");I&&M.getState().clearExpedition(I);return}const S=h.closest("[data-expedition-click]");if(S){const I=S.getAttribute("data-expedition-click");if(I){Nd(I,be);return}}if(h.hasAttribute("data-close-modal")){Or(be);return}if(h.hasAttribute("data-modal-backdrop")){Or(be);return}if(h.hasAttribute("data-save-setup")&&!h.disabled){qd(be,ss);return}const $=h.getAttribute("data-modal-assign"),R=h.getAttribute("data-unit");if($&&R){switch($){case"clear":Ld(R,be);break;case"sub1":Ur(R,-1,be);break;case"add1":Ur(R,1,be);break;case"max":Pd(R,be);break;case"plus10":Od(R,be);break;case"static":{const I=Number(h.getAttribute("data-amount")||"0");I>0&&Ud(R,I,be);break}}return}const k=h.getAttribute("data-modal-equip-assign"),v=h.getAttribute("data-equip");if(k&&v){switch(k){case"clear":Dd(v,be);break;case"static":{const I=Number(h.getAttribute("data-amount")||"0");I>0&&Bd(v,I,be);break}}return}},e.addEventListener("click",Ft),e.addEventListener("change",p=>{var x,S;const h=p.target;if(h.matches("[data-log-filter]")){Bt=h.value,Vn="";const $=be==null?void 0:be.querySelector("[data-expedition-log]");if($){const R=M.getState(),k=z(R).combat;$.innerHTML=Fr(k.expeditionLog,R.activeRealm,Bt);const v=((x=k.expeditionLog[0])==null?void 0:x.timestamp)??0,I=((S=k.expeditionLog[k.expeditionLog.length-1])==null?void 0:S.timestamp)??0;Vn=`${Bt}-${k.expeditionLog.length}-${v}-${I}`}}}),Gn(xe.Combat,ss),ln&&clearInterval(ln),ln=setInterval(zd,100),ss()},wi=(e,n)=>{if(e.lte(0))return 0;if(e.gte(n))return 1;const t=e.log10().toNumber(),s=n.log10().toNumber(),r=0;return t<=r?0:Math.min(1,Math.max(0,(t-r)/(s-r)))};let Dt=null;const Zd=e=>{const n=hn[e];if(!n)return"";const s=Mn(e)==="realm2"?"in R2":"";return`${P(n.manaRequirement)} mana${s?` ${s}`:""}`},Si=[{tier:1,bonuses:["x1.2 Crafter Speed"],unlocks:["Altar of Sacrifice","Upgrade Auto-Buy"]},{tier:2,bonuses:["x1.4 Crafter Speed (total)","Artifacts persist on reset"],unlocks:["Heroic Expeditions","T4+ Swords usable in Prime Realm","Auto-Prestige"],requiredRealm:"realm2",notes:"Resets BOTH realms"}],Qd=(e,n,t,s,r)=>{const a=n>=e.tier,i=n===e.tier-1,o=a?"border-positive bg-positive--20":"bg-panel border-muted--30",u=a?"text-positive":"text-gold",l=a?"text-positive":"text-text",d=e.bonuses.map(w=>`<div class="text-sm ${l}"> ${w}</div>`).join(""),c=e.unlocks.map(w=>`<div class="text-sm ${l}"> ${w}</div>`).join("");let f="";a?f='<span class="text-positive font-mono text-sm"> Complete</span>':i&&(f=`
      <button
        data-action="tier-reset"
        ${s?"":"disabled"}
        class="px-4 py-2 font-mono border ${s?"border-gold text-gold hover-bg-gold--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"}"
      >Reset</button>
    `);const b=Zd(e.tier),y=i?`
    <div class="mt-3 h-2 bg-muted--20 border border-muted--30 overflow-hidden">
      <div data-tier-progress="${e.tier}" class="h-full ${s?"bg-positive":"bg-arcane"}" style="width: ${r*100}%"></div>
    </div>
  `:"",g=e.notes&&!a?`
    <div class="text-xs text-yellow mt-2">${e.notes}</div>
  `:"";return`
    <div data-milestone="${e.tier}" class="border ${o} p-4">
      <div class="flex items-start gap-4">
        <div class="text-2xl font-mono ${u} w-12 flex-shrink-0">T${e.tier}</div>
        <div class="flex-1 min-w-0">
          <div class="text-sm ${l} mb-2">
            <span class="text-steel">Req:</span> ${b}
            ${i?`<span class="text-muted ml-2">(Current: <span data-current-mana class="${s?"text-positive":"text-text"}">${t}</span>)</span>`:""}
          </div>
          <div class="flex gap-4 flex-wrap">
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Bonuses</div>
              ${d}
            </div>
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Unlocks</div>
              ${c||'<div class="text-sm text-muted"></div>'}
            </div>
          </div>
          ${g}
          ${y}
          ${f?`<div class="mt-3">${f}</div>`:""}
        </div>
      </div>
    </div>
  `},Jd=e=>{const n=()=>{const t=M.getState(),s=t.globalTier,a=Si.filter(d=>d.tier<=s+1).slice().reverse().map(d=>{var h;const c=Mn(d.tier),f=t.realms[c].mana,y=t.activeRealm===c&&ks(f,s,c)&&s===d.tier-1,g=((h=hn[d.tier])==null?void 0:h.manaRequirement)??new m(1),w=wi(f,g),p=P(f);return Qd(d,s,p,y,w)}).join(""),i=s+1,o=i<=Tr?Mn(i):null,l=!(o===t.activeRealm)&&o?`
      <div class="mb-4 p-3 border border-yellow text-yellow text-sm">
        T${i} reset requires ${sl[o]}. ${t.realm2Unlocked?"Switch realms to perform the reset.":"Advance through expeditions to unlock the Realm tab and open a portal to the Realm of War."}
      </div>
    `:"";e.innerHTML=`
      <div class="max-w-5xl">
        <div class="mb-6">
          <h2 class="text-xl font-mono text-gold mb-2">Tier Milestones</h2>
          <p class="text-sm text-steel">Reset your progress to unlock permanent bonuses. Bonuses persist through future resets.</p>
        </div>
        ${l}
        <div class="flex flex-col gap-2">
          ${a}
        </div>
      </div>
    `,Dt&&e.removeEventListener("click",Dt),Dt=d=>{d.target.getAttribute("data-action")==="tier-reset"&&M.getState().tierReset()},e.addEventListener("click",Dt)};return n(),()=>{var f;const t=M.getState(),s=t.globalTier,r=Si.filter(b=>b.tier<=s+1),a=e.querySelectorAll("[data-milestone]").length;if(r.length!==a){n();return}const i=s+1,o=Mn(i),u=t.realms[o].mana,d=t.activeRealm===o&&ks(u,s,t.activeRealm),c=e.querySelector("[data-current-mana]");if(c&&(c.textContent=P(u),c.className=d?"text-positive":"text-text"),i<=Tr){const b=((f=hn[i])==null?void 0:f.manaRequirement)??new m(1),y=wi(u,b),g=e.querySelector(`[data-tier-progress="${i}"]`);g&&(g.style.width=`${y*100}%`,g.className=`h-full ${d?"bg-positive":"bg-arcane"}`);const w=e.querySelector('[data-action="tier-reset"]');w&&(w.disabled=!d,w.className=`px-4 py-2 font-mono border ${d?"border-gold text-gold hover-bg-gold--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"}`)}}},_a=St(xe.Tier,Jd,{onCleanup:()=>{var e;Dt&&((e=_a.getContainer())==null||e.removeEventListener("click",Dt),Dt=null)}}),ef=_a.cleanup,tf=_a.render,nf=e=>{const n=Math.abs(e),t=e<0?"-":"";return n<1e3?t+n.toFixed(0):n<1e6?t+(n/1e3).toFixed(2)+"k":n<1e9?t+(n/1e6).toFixed(2)+"m":n<1e12?t+(n/1e9).toFixed(2)+"b":n<1e15?t+(n/1e12).toFixed(2)+"t":e.toExponential(2)},sf=(e,n)=>`
    <div class="h-2 border border-muted--30 overflow-hidden">
      <div data-progress-bar class="h-full ${n?"bg-red":"bg-positive"}" style="width: ${e*100}%"></div>
    </div>
  `;let Ht=null;const rf=e=>{var t,s;const n=Xn(e);if(!n)return"";if(n.type==="gem"&&n.tier!==void 0)return $e[n.tier].icon;if(n.type==="flask"&&n.tier!==void 0)return un[n.tier].icon;if(n.type==="military"&&n.militaryId!==void 0){const r=M.getState();return((t=zn(r.activeRealm)[n.militaryId])==null?void 0:t.icon)??""}else if(n.type==="expedition_reward")return((s=ne(n.id))==null?void 0:s.icon)??"";return""},Do=e=>{var a;const n=M.getState(),t=z(n),s=Xn(e);if(!s)return 0;const r=s.type==="military"&&s.militaryId?s.militaryId:e;return((a=t.recipeInventory[r])==null?void 0:a.toNumber())??0},Ho=e=>e==="gem_1"?yo:1,af=e=>{const n=M.getState(),t=z(n);if(t.altar.activeSacrifice!==e||t.altar.sacrificeProgress<1)return!1;const s=Do(e),r=Ho(e);return s<=r},of=()=>{const e=M.getState(),n=Me(e.activeRealm),t=n.MODIFIERS.sacrificeCap,s=n.MODIFIERS.sacrificeBatchSize,r=n.MODIFIERS.calculateSacrificeBonus,a=r(t),i=ko(e.activeRealm),o=i.filter(g=>g.type==="gem"),u=i.filter(g=>g.type==="flask"),l=i.filter(g=>g.type==="military"),d=i.filter(g=>g.type==="expedition_reward"),c=(g,w)=>{if(!Xn(g))return"";const h=`
      <button
        data-action="start-sacrifice"
        data-item="${g}"
        disabled
        class="px-2 py-1 text-xs font-mono border border-muted--30 text-muted--50 cursor-not-allowed"
      >Sacrifice</button>
    `;return`
      <tr data-sacrifice-row="${g}">
        <td class="py-2 pr-4" style="width: 200px;">
          <div class="flex items-center gap-3">
            <img src="${rf(g)}" alt="${w}" class="w-8 h-8 object-contain">
            <span class="text-text text-sm whitespace-nowrap">${w}</span>
          </div>
        </td>
        <td class="text-text font-mono text-sm text-left pl-2" style="width: 110px;" data-item-count="${g}"></td>
        <td class="text-steel font-mono text-sm text-left pl-2" style="width: 110px;" data-sacrifice-count="${g}"></td>
        <td class="text-positive font-mono text-sm text-left pl-2" style="width: 100px;" data-sacrifice-bonus="${g}"></td>
        <td style="width: 200px;" data-sacrifice-action="${g}">${h}</td>
      </tr>
    `},f=(g,w)=>w.length===0?"":`
      <div class="mb-6 mobile-scroll-x">
        <table style="width: 720px; table-layout: fixed;">
          <thead>
            <tr class="text-xs text-steel">
              <th class="text-left pb-2 text-orange" style="width: 200px;">${g}</th>
              <th class="text-left pb-2 pl-2" style="width: 110px;">Owned</th>
              <th class="text-left pb-2 pl-2" style="width: 110px;">Sacrificed</th>
              <th class="text-left pb-2 pl-2" style="width: 100px;">Bonus</th>
              <th style="width: 200px;"></th>
            </tr>
          </thead>
          <tbody>
            ${w.map(p=>c(p.id,p.name)).join("")}
          </tbody>
        </table>
      </div>
    `,b=s>1?` Sacrifices ${s} items at a time.`:"";return`
    <div class="text-lg font-mono text-gold mb-3">Altar of Sacrifice</div>
    <div class="text-sm text-steel mb-4">
      ${`Sacrifice items to permanently increase their output bonus.<br>
        Altar bonuses do not reset on tier up. Cap: ${Y(t)} sacrificed (x${P(a)} max).${b}`}
    </div>
    <hr class="border-muted--30 mb-6">
    ${f("Gem",o)}
    ${f("Flask",u)}
    ${f("Unit",l)}
    ${f("Reward",d)}
  `},cf=e=>{const n=()=>{const t=M.getState();if(!Ir(t.globalTier)){e.innerHTML=`
        <div class="flex items-center justify-center h-64">
          <div class="text-center text-muted">
            <div class="text-lg mb-2">The Altar is locked</div>
            <div class="text-sm">Perform a Tier 1 reset to unlock the Altar.</div>
          </div>
        </div>
      `;return}e.innerHTML=`
      <div class="max-w-4xl">
        ${of()}
      </div>
    `,Ht&&e.removeEventListener("click",Ht),Ht=s=>{const r=s.target,a=r.getAttribute("data-action");if(a==="start-sacrifice"){const i=r.getAttribute("data-item");i&&M.getState().startSacrifice(i)}else a==="stop-sacrifice"&&M.getState().stopSacrifice()},e.addEventListener("click",Ht)};return n(),()=>{const t=M.getState(),s=z(t),r=Me(t.activeRealm),{altar:a}=s,i=r.MODIFIERS.sacrificeCap,o=r.MODIFIERS.calculateSacrificeBonus;if(!e.querySelector("[data-sacrifice-row]")&&Ir(t.globalTier)){n();return}const u=ko(t.activeRealm);for(const l of u){const d=e.querySelector(`[data-sacrifice-row="${l.id}"]`);if(!d)continue;const c=a.sacrificeCounts[l.id]||0,f=o(c),b=c>=i,y=a.activeSacrifice===l.id,g=Do(l.id),w=Ho(l.id),p=g>w&&!b,h=d.querySelector(`[data-item-count="${l.id}"]`);h&&(h.textContent=Y(g));const x=d.querySelector(`[data-sacrifice-count="${l.id}"]`);x&&(x.textContent=nf(c));const S=d.querySelector(`[data-sacrifice-bonus="${l.id}"]`);S&&(S.textContent=`x${P(f)}`);const $=d.querySelector(`[data-sacrifice-action="${l.id}"]`);if($)if(y){const R=af(l.id);let k=$.querySelector("[data-progress-bar]");k?on(k,a.sacrificeProgress,R):$.innerHTML=`
              <div class="flex items-center gap-2">
                <div class="w-24">${sf(a.sacrificeProgress,R)}</div>
                <button
                  data-action="stop-sacrifice"
                  class="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red--20 cursor-pointer"
                >Stop</button>
              </div>
            `}else if(b)$.innerHTML='<span class="text-gold text-xs">MAX</span>';else{const R=p?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed",k=$.querySelector('[data-action="start-sacrifice"]');if(!k)$.innerHTML=`
              <button
                data-action="start-sacrifice"
                data-item="${l.id}"
                ${p?"":"disabled"}
                class="px-2 py-1 text-xs font-mono border ${R}"
              >Sacrifice</button>
            `;else{const v=k;v.className=`px-2 py-1 text-xs font-mono border ${R}`,v.disabled=!p}}}}},La=St(xe.Altar,cf,{onCleanup:()=>{var e;Ht&&((e=La.getContainer())==null||e.removeEventListener("click",Ht),Ht=null)}}),lf=La.cleanup,uf=La.render,Ot=10,en=1e6;let jt=null;const df=e=>{const n=M.getState(),t=n.realms.realm1,s=n.realms.realm2,r=Ce[e],a=et(t.artifacts,e),i=t.artifacts.upgradeLevels[e]??0,o=et(s.artifacts,e),u=s.artifacts.upgradeLevels[e]??0;if(!a)return"";const l=D(n.realms.realm1.recipeInventory,"nullstone").toNumber(),d=l>=Bn&&(!o||i>u),c=o;let f,b,y=!1;d?c?(f="border-gold text-gold hover-bg-gold--20 cursor-pointer",b=`Overwrite (+${i-u})`):(f="border-lime text-lime hover-bg-lime--20 cursor-pointer",b="Ship"):l<Bn?(f="border-muted--30 text-muted--50 cursor-not-allowed",b="Ship",y=!0):(f="border-muted--30 text-muted--50 cursor-not-allowed line-through",b="Already in R2",y=!0);const g=i>0?`<span class="text-cyan">+${i}</span>`:"";let w="";return o&&(w=`<div class="text-xs text-steel">In R2: +${u}</div>`),`
    <div class="flex items-center gap-3 p-2 border border-muted--30 bg-black--30" data-ship-card="${e}">
      <img src="${r.icon}" alt="${r.name}" class="w-12 h-12 object-contain">
      <div class="flex-1 min-w-0">
        <div class="text-sm font-mono text-text">${r.name} ${g}</div>
        <div class="text-xs text-steel">T${r.tier} ${r.type}</div>
        ${w}
      </div>
      <button
        data-action="ship-artifact"
        data-artifact-id="${e}"
        ${y?"disabled":""}
        class="px-3 py-1 text-xs font-mono border ${f}"
      >${b}</button>
    </div>
  `},ki=()=>{const e=M.getState(),n=D(e.realms.realm1.recipeInventory,"nullstone").toNumber(),t=e.realms.realm1,s=dt.filter(a=>et(t.artifacts,a));if(s.length===0)return`
      <div data-shipping-section class="mt-8 p-4 border border-muted--30">
        <h3 class="text-lg font-mono text-gold mb-2">Ship Artifacts to Realm of War</h3>
        <p class="text-sm text-steel">
          You don't have any artifacts in the Prime Realm to ship.
          Craft artifacts in the Artifacts tab first.
        </p>
      </div>
    `;const r=s.map(a=>df(a)).join("");return`
    <div data-shipping-section class="mt-8 p-4 border border-muted--30">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-mono text-gold">Ship Artifacts to Realm of War</h3>
          <p class="text-xs text-steel">
            In the Realm of War, you cannot craft artifacts - only receive shipments from the Prime Realm.
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-text">
            <span data-ship-nullstone-count>${Y(n)}</span>
            <img src="${O("icons/nullstone.png")}" alt="Nullstone" class="w-4 h-4 inline ml-1">
          </div>
          <div class="text-xs text-steel">Cost: ${Bn} per artifact</div>
        </div>
      </div>
      <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
        ${r}
      </div>
      <div class="mt-3 text-xs text-steel">
        Shipped artifacts are removed from the Prime Realm and must be re-crafted.
        You can overwrite a Realm of War artifact only if the Prime Realm version has a higher upgrade level.
      </div>
    </div>
  `},$i=()=>{const e=M.getState(),n=e.realms.realm1.artifacts,t=e.realms.realm2.artifacts;return JSON.stringify({nullstone:D(e.realms.realm1.recipeInventory,"nullstone").toNumber(),r1Owned:n.owned,r1Levels:n.upgradeLevels,r2Owned:t.owned,r2Levels:t.upgradeLevels})},ff={realm1:{icon:"icons/r0.png",name:"Prime Realm",color:"cyan"},realm2:{icon:"icons/portal.png",name:"Realm of War",color:"arcane"},realm3:{icon:"icons/r3.png",name:"Realm of Magic",color:"magenta"}},mf=()=>`
  <div class="tooltip-title" style="color: var(--color-magenta);">Realm of Magic</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">A magical realm powered by arcane souls.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Soulforges</span>
    <span class="tooltip-value" style="color: var(--color-magenta);">Generate arcane souls</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Recipes</span>
    <span class="tooltip-value" style="color: var(--color-magenta);">Require arcane souls</span>
  </div>
`,pf=()=>`
  <div class="tooltip-title" style="color: var(--color-cyan);">Prime Realm</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">The standard realm with normal mechanics.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Mana generation</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Normal</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Craft speed</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Normal</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Artifacts</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Craftable</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Heroic expeditions</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Available</span>
  </div>
`,dr=(e,n)=>{const t=ff[e],s=e==="realm1"?pf():e==="realm2"?ec():mf(),r=n?"1":"0.4",a=n?`<span class="text-${t.color} text-xs font-mono">Current realm</span>`:'<span class="text-steel text-xs font-mono">Click to enter</span>';return`
    <div class="flex flex-col items-center gap-2 portal-card" data-portal-card="${e}" data-portal-active="${n}">
      <div class="realm-tooltip-wrapper" style="display: inline-block;">
        <div
          ${n?"":'data-action="switch-realm"'}
          data-realm-target="${e}"
          style="cursor: ${n?"default":"pointer"}; opacity: ${r};"
          class="portal-card-img"
        >
          <img
            src="${O(t.icon)}"
            alt="${t.name}"
            style="width: 160px; height: 160px;"
            class="object-contain"
          >
        </div>
        <div class="realm-tooltip" style="left: 50%; transform: translateX(-50%);">
          ${s}
        </div>
      </div>
      <div class="text-${t.color} font-mono" style="opacity: ${r};">${t.name}</div>
      <div style="opacity: ${r};">${a}</div>
    </div>
  `},gf=e=>{const n=To();let t=null;const s=()=>{const r=M.getState(),a=D(r.realms.realm1.recipeInventory,"nullstone").toNumber(),{portalBuilt:i}=r.realms.realm1.combat,o=Math.min(1,a/Ot),u=a>=Ot;let l,d="";if(i){t=r.activeRealm;let c=`
        ${dr("realm1",r.activeRealm==="realm1")}
        ${dr("realm2",r.activeRealm==="realm2")}
      `;if(r.realm3Unlocked&&(c+=dr("realm3",r.activeRealm==="realm3")),l=`
        <div class="flex items-start justify-center gap-12 flex-wrap">
          ${c}
        </div>
      `,!r.realm3Unlocked){const f=D(r.realms.realm3.recipeInventory,"soulforge"),b=f.gte(1),y=a>=en,g=b&&y;l+=`
          <div class="mt-8 flex flex-col items-center gap-4" data-r3-portal-section>
            <button
              data-action="build-r3-portal"
              ${g?"":"disabled"}
              class="px-6 py-3 font-mono text-lg border ${g?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}"
              style="min-width: 340px;"
            >
              Open Portal to Realm of Magic
            </button>
            <div class="text-sm text-steel flex flex-col items-center gap-1">
              <div>Requires: <span class="${b?"text-positive":"text-red"}" data-r3-soulforge-req>${P(f)} / 1 Soulforge</span></div>
              <div>Cost: <span class="${y?"text-positive":"text-red"}" data-r3-nullstone-req>${Y(a)} / ${Y(en)} Nullstone</span></div>
            </div>
          </div>
        `}r.activeRealm==="realm2"&&(d=ki(),n($i()))}else l=`
        <div class="flex flex-col items-center gap-4">
          <button
            data-action="build-portal"
            ${u?"":"disabled"}
            class="relative px-6 py-3 font-mono text-lg border ${u?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"} overflow-hidden"
            style="min-width: 300px;"
          >
            ${Tt(o,"data-portal-progress")}
            <span class="relative flex items-center justify-center gap-2">
              Build a portal to another realm -
              <span class="inline-flex items-center gap-1 bg-black--50 px-2 py-0.5 rounded">
                ${Ot}
                <img src="${O("icons/nullstone.png")}" alt="Nullstone" style="width: 18px; height: 18px;" class="object-contain">
              </span>
            </span>
          </button>
          <div class="text-sm text-steel">
            You have <span data-nullstone-count class="text-text font-mono">${a}</span> nullstone
          </div>
        </div>
      `;e.innerHTML=`
      <div class="max-w-3xl mx-auto">
        <div class="mb-8 text-center">
          <h2 class="text-xl font-mono text-arcane mb-2">Realm Portal</h2>
          <p class="text-sm text-steel">Harness the power of nullstone to open a gateway to another realm.</p>
        </div>
        ${l}
        ${d}
      </div>
    `,jt&&e.removeEventListener("click",jt),jt=c=>{const b=c.target.closest("[data-action]");if(!b)return;const y=b.getAttribute("data-action");if(y==="build-portal"){const g=M.getState();if(D(g.realms.realm1.recipeInventory,"nullstone").toNumber()>=Ot){const p=g.realms.realm1,h={...p.recipeInventory};we(h,"nullstone",new m(Ot)),M.setState({realms:{...g.realms,realm1:{...p,recipeInventory:h,combat:{...p.combat,portalBuilt:!0}}}})}}else if(y==="build-r3-portal"){const g=M.getState(),w=D(g.realms.realm1.recipeInventory,"nullstone").toNumber(),p=D(g.realms.realm3.recipeInventory,"soulforge");if(w>=en&&p.gte(1)){const h=g.realms.realm1,x={...h.recipeInventory};we(x,"nullstone",new m(en)),M.setState({realms:{...g.realms,realm1:{...h,recipeInventory:x}}}),g.unlockRealm3()}}else if(y==="switch-realm"){const g=M.getState(),w=b.getAttribute("data-realm-target");if(!w||w===g.activeRealm)return;w==="realm2"&&!g.realm2Unlocked&&g.unlockRealm2(),g.setActiveRealm(w)}else if(y==="ship-artifact"){const g=b.getAttribute("data-artifact-id");g&&M.getState().shipArtifact(g)}},e.addEventListener("click",jt)};return s(),()=>{const r=M.getState(),a=D(r.realms.realm1.recipeInventory,"nullstone").toNumber(),{portalBuilt:i}=r.realms.realm1.combat,o=e.querySelector("[data-portal-card]"),u=e.querySelector('[data-action="build-portal"]');if(i&&!o){s();return}if(i&&o&&r.activeRealm!==t){s();return}if(r.realm3Unlocked&&e.querySelector("[data-r3-portal-section]")){s();return}if(!i&&u){const l=Math.min(1,a/Ot),d=a>=Ot;Ct(e.querySelector("[data-portal-progress]"),l);const c=e.querySelector("[data-nullstone-count]");c&&(c.textContent=String(a));const f=u;f.disabled=!d,f.className=`relative px-6 py-3 font-mono text-lg border overflow-hidden ${d?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}`}if(i&&r.activeRealm==="realm2")if(n($i())){const l=e.querySelector("[data-shipping-section]");l&&(l.outerHTML=ki())}else{const l=e.querySelector("[data-ship-nullstone-count]");l&&(l.textContent=Y(a))}if(i&&!r.realm3Unlocked){const l=D(r.realms.realm3.recipeInventory,"soulforge"),d=l.gte(1),c=a>=en,f=d&&c,b=e.querySelector('[data-action="build-r3-portal"]');b&&(b.disabled=!f,b.className=`px-6 py-3 font-mono text-lg border ${f?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}`);const y=e.querySelector("[data-r3-soulforge-req]");y&&(y.textContent=`${P(l)} / 1 Soulforge`,y.className=d?"text-positive":"text-red");const g=e.querySelector("[data-r3-nullstone-req]");g&&(g.textContent=`${Y(a)} / ${Y(en)} Nullstone`,g.className=c?"text-positive":"text-red")}}},Pa=St(xe.Realm,gf,{onCleanup:()=>{var e;jt&&((e=Pa.getContainer())==null||e.removeEventListener("click",jt),jt=null)}}),hf=Pa.cleanup,vf=Pa.render,bf=["gem","flask","military","expedition_reward","special","magical_creature","building"],xf={gem:"Mana Gems",flask:"Research Flasks",military:"Expedition Units",expedition_reward:"Expedition Rewards",special:"Special",magical_creature:"Magical Creatures",building:"Buildings",equipment:"Expedition Equipment",arcane_wonder:"Arcane Wonders"},yf=e=>{const n=()=>{var l;const t=M.getState(),s=z(t),{prestige:r}=s,a=[...Ln(t.activeRealm),...kr];let i='<div class="p-4 font-mono">';i+='<h2 class="text-lg text-gold mb-2">Prestige</h2>',i+=`<div class="text-sm text-steel mb-4">Spend items from a recipe's inventory for permanent output multipliers. Prestige is not reset on tier.</div>`,i+=`<div class="mb-4">${ut("prestige-explanation","How prestige works",`
      <div class="text-sm border border-muted--30 bg-panel p-3">
        <div class="text-muted mb-1"> Each prestige subtracts the requirement from inventory</div>
        <div class="text-muted mb-1"> <span class="text-positive">Recipe bonus:</span> +x0.2 output multiplier for that recipe per prestige</div>
        <div class="text-muted mb-1"> <span class="text-cyan">Global bonus:</span> +x0.01 output multiplier for <span class="text-text">all</span> recipes per prestige (any recipe)</div>
        <div class="text-muted"> Cost scales x100 per prestige (1.00k  100k  10.0m  ...)</div>
      </div>`)}</div>`,i+='<div class="text-sm mb-4">',i+='<span class="text-muted">Global prestige bonus:</span> ',i+='<span class="text-positive" data-prestige-global-mult></span>',i+='<span class="text-muted"> (all recipes)</span>',i+="</div>",t.globalTier>=2&&!t.dismissedTips.includes("prestige-auto-toggle")&&(i+=`
      <div data-tip="prestige-auto-toggle" class="mb-4 flex items-center gap-2 text-sm">
        <button data-action="dismiss-tip" data-tip-id="prestige-auto-toggle" class="text-muted hover-text-positive cursor-pointer border-none bg-transparent" title="Dismiss tip">&#x2714;</button>
        <span class="text-muted">Tip: click the Auto header to toggle all automations in that section</span>
      </div>`);const u={gem:[],flask:[],military:[],expedition_reward:[],special:[],magical_creature:[],building:[],equipment:[],arcane_wonder:[]};for(const d of a){const c=ne(d);u[c.category].push(d)}for(const d of bf){const c=u[d];if(c.length===0)continue;const f=c.filter(y=>{const g=D(s.recipeInventory,y),w=r.prestigeCounts[y]||0;return g.gt(0)||w>0});if(f.length===0)continue;let b=`<table class="text-sm font-mono w-full" data-prestige-table="${d}">
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="w-40 text-left">Recipe</th>
            <th class="w-24 text-center">Count</th>
            <th class="w-28 text-center">Inventory</th>
            <th class="w-28 text-center">Cost</th>
            <th class="w-28 text-center text-positive">Recipe</th>
            <th class="w-28 text-center text-cyan">Total</th>
            <th class="w-28"></th>
            <th class="w-10 text-center" data-auto-prestige-header style="display: none">
              <span data-action="toggle-all-auto-prestige" data-category="${d}" class="cursor-pointer text-steel hover-text-text" style="text-decoration: underline" title="Toggle all auto-prestige"><span data-auto-prestige-header-check="${d}"></span> Auto</span>
            </th>
          </tr>
        </thead>
        <tbody>`;for(const y of f){const g=ne(y),w=vn(!1,!1);b+=`
          <tr data-prestige-row="${y}">
            <td class="w-40 py-1">
              <span class="inline-flex items-center gap-1.5">
                <img src="${g.icon}" alt="${g.name}" style="width: 28px; height: 28px;" class="object-contain">
                <span class="text-gold">${g.name}</span>
              </span>
            </td>
            <td class="w-24 text-center text-steel" data-prestige-count="${y}"></td>
            <td class="w-28 text-center text-muted--50" data-prestige-inventory="${y}"></td>
            <td class="w-28 text-center text-text" data-prestige-cost="${y}"></td>
            <td class="w-28 text-center text-positive" data-prestige-recipe-mult="${y}"></td>
            <td class="w-28 text-center text-cyan" data-prestige-total-mult="${y}"></td>
            <td class="w-28">
              <button
                data-action="prestige-recipe"
                data-id="${y}"
                disabled
                class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${w}"
              >
                ${Tt(0,`data-prestige-progress="${y}"`)}
                <span class="relative z-10">Prestige</span>
              </button>
            </td>
            <td class="w-10 text-center" data-auto-prestige-cell="${y}" style="display: none">
              <input type="checkbox" data-action="toggle-auto-prestige" data-id="${y}" title="Auto-prestige" class="cursor-pointer" />
            </td>
          </tr>`}b+="</tbody></table>",i+=`<div class="mb-4">${ut(`prestige-${d}`,xf[d],b)}</div>`}if(i+="</div>",e.innerHTML=i,e.querySelectorAll('[data-action="prestige-recipe"]').forEach(d=>{d.addEventListener("click",()=>{const c=d.getAttribute("data-id");M.getState().prestigeRecipe(c)})}),e.querySelectorAll('[data-action="toggle-auto-prestige"]').forEach(d=>{d.addEventListener("change",()=>{const c=d.getAttribute("data-id");M.getState().toggleAutoPrestige(c)})}),e.querySelectorAll('[data-action="toggle-all-auto-prestige"]').forEach(d=>{d.addEventListener("click",()=>{const c=d.getAttribute("data-category"),f=M.getState(),b=z(f),y=e.querySelector(`[data-prestige-table="${c}"]`);if(!y)return;const g=[];y.querySelectorAll("[data-prestige-row]").forEach(p=>{g.push(p.getAttribute("data-prestige-row"))});const w=g.every(p=>b.prestige.autoPrestige[p]);for(const p of g){const h=b.prestige.autoPrestige[p]??!1;(w?h:!h)&&M.getState().toggleAutoPrestige(p)}})}),(l=e.querySelector('[data-action="dismiss-tip"]'))==null||l.addEventListener("click",d=>{var b;const c=d.currentTarget.getAttribute("data-tip-id"),f=M.getState();M.setState({dismissedTips:[...f.dismissedTips,c]}),(b=e.querySelector(`[data-tip="${c}"]`))==null||b.remove()}),t.globalTier>=2){e.querySelectorAll("[data-auto-prestige-header]").forEach(d=>d.style.display=""),e.querySelectorAll("[data-auto-prestige-cell]").forEach(d=>d.style.display="");for(const d of a){const c=e.querySelector(`[data-action="toggle-auto-prestige"][data-id="${d}"]`);c&&(c.checked=s.prestige.autoPrestige[d]??!1)}}};return n(),()=>{const t=M.getState(),s=z(t),{prestige:r}=s,a=fo(r.prestigeCounts),i=e.querySelectorAll("[data-prestige-row]");let o=!1;for(const c of i){const f=c.getAttribute("data-prestige-row"),b=D(s.recipeInventory,f),y=r.prestigeCounts[f]||0;if(b.eq(0)&&y>0){const g=e.querySelector(`[data-prestige-count="${f}"]`);if(g&&g.textContent!==Y(y)){o=!0;break}}}const u=[...Ln(t.activeRealm),...kr];for(const c of u){const f=D(s.recipeInventory,c),b=r.prestigeCounts[c]||0;if((f.gt(0)||b>0)&&!e.querySelector(`[data-prestige-row="${c}"]`)){o=!0;break}}o&&n();const l=e.querySelector("[data-prestige-global-mult]");l&&(l.textContent=`x${P(a)}`);const d=o?e.querySelectorAll("[data-prestige-row]"):i;for(const c of d){const f=c.getAttribute("data-prestige-row"),b=r.prestigeCounts[f]||0,y=D(s.recipeInventory,f),g=Os(b),w=Us(f,y,b),p=y.gt(0)?Math.min(1,y.div(g).toNumber()):0,h=uo(r.prestigeCounts,f),x=vt(r.prestigeCounts,f),S=e.querySelector(`[data-prestige-count="${f}"]`);S&&(S.textContent=Y(b));const $=e.querySelector(`[data-prestige-inventory="${f}"]`);$&&($.textContent=P(y),$.className=`w-28 text-center ${y.gte(g)?"text-text":"text-muted--50"}`);const R=e.querySelector(`[data-prestige-cost="${f}"]`);R&&(R.textContent=P(g));const k=e.querySelector(`[data-prestige-recipe-mult="${f}"]`);k&&(k.textContent=`x${P(h)}`);const v=e.querySelector(`[data-prestige-total-mult="${f}"]`);v&&(v.textContent=`x${P(x)}`);const I=e.querySelector(`[data-action="prestige-recipe"][data-id="${f}"]`);if(I){const L=vn(!1,w);I.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${L}`,w?I.removeAttribute("disabled"):I.setAttribute("disabled",""),Ct(e.querySelector(`[data-prestige-progress="${f}"]`),p,!1)}const T=e.querySelector(`[data-action="toggle-auto-prestige"][data-id="${f}"]`);T&&T.checked!==(r.autoPrestige[f]??!1)&&(T.checked=r.autoPrestige[f]??!1)}e.querySelectorAll("[data-auto-prestige-header-check]").forEach(c=>{const f=c.getAttribute("data-auto-prestige-header-check"),b=e.querySelector(`[data-prestige-table="${f}"]`);if(!b)return;const y=[];b.querySelectorAll("[data-prestige-row]").forEach(w=>{y.push(w.getAttribute("data-prestige-row"))});const g=y.length>0&&y.every(w=>r.autoPrestige[w]);c.textContent=g?"":""})}},jo=St(xe.Prestige,yf),wf=jo.cleanup,Sf=jo.render,Ii=(e,n)=>{if(!e)return"";if(e.population>0)return`+${e.population} population`;if(e.creatureProductionMultiplier){const t=e.creatureProductionMultiplier,s=Math.pow(t,n),r=Math.pow(t,n+1),a=i=>i>=10?i.toFixed(1):i.toFixed(2);return`<span class="leading-tight">x${a(s)}  x${a(r)}</span>`}return""},kf={arcane_dwelling:"Provides 1 population per building. Population is used to assign workers in the Workshop and Arcane Wonders."},$f={arcane_sanctum:"Multiplies all creature passive production by x2 per level. Built by assigning population. Persists through ascension."},Ri=(e,n)=>{const t=e.creatureProductionMultiplier,s=Math.pow(t,n),r=Math.pow(t,n+1),a=i=>i>=10?i.toFixed(1):i.toFixed(2);return`<span class="leading-tight">x${a(s)}  x${a(r)}</span>`},If={pickaxe:"Assigned to Mine expeditions. Increases both rewards and difficulty.",axe:"Assigned to Forest expeditions. Increases both rewards and difficulty."},Hr=(e,n)=>{const t=ne(e),s=new m(t.escalatingCost??1).pow(n);return t.recipe.filter(r=>r.recipeId).map(r=>({recipeId:r.recipeId,amount:r.amount.mul(s)}))},Mi=(e,n,t)=>Hr(n,t).every(r=>D(e,r.recipeId).gte(r.amount)),rs=(e,n=0)=>{let t=0;for(const[s,r]of Object.entries(ds)){const a=D(e,s).toNumber(),i=r.population+(r.population>0?n:0);t+=a*i}return t},as=(e,n={})=>{let t=0;for(const s of Object.values(e))t+=s;for(const s of Object.values(n))t+=s;return t},Rf=e=>((()=>{var S;const t=M.getState(),s=z(t),{recipeInventory:r,workshopAssignments:a,wonderAssignments:i}=s,o=Wa("realm3"),u=hs("realm3"),l=vs("realm3"),d=$=>`border-${$} text-${$} hover-bg-${$}--20 cursor-pointer`,c="border-muted--30 text-muted cursor-not-allowed",f=["var(--color-tooltip-bg)","var(--color-row-odd)"],b=kn(s.ascension),y=rs(r,b),g=as(a,i),w=Math.max(0,y-g);let p="";const x=`<div class="mobile-scroll-x">
      <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1050px">
        <colgroup>
          <col style="width: 230px">
          <col style="width: 80px">
          <col style="width: 200px">
          <col style="width: 440px">
          <col style="width: 100px">
        </colgroup>
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="text-left py-1 px-2">Building</th>
            <th class="text-left py-1 px-2">Owned</th>
            <th class="text-left py-1 px-2">Effect</th>
            <th class="text-left py-1 px-2">Cost</th>
            <th class="text-center py-1 px-2">Buy</th>
          </tr>
        </thead>
        <tbody>${o.map(($,R)=>{const k=ne($),v=ds[$],I=D(r,$).toNumber(),T=Hr($,I),L=Mi(r,$,I),q=L?d("cyan"):c,j=T.map(X=>{const re=ne(X.recipeId);return`<span class="inline-flex items-center gap-1">
          <img src="${re.icon}" alt="${re.name}" style="width: 40px; height: 40px;" class="object-contain">
          <span>${P(X.amount)}</span>
        </span>`}).join(" "),H=Ii(v,I),_=`<span class="inline-flex items-center gap-1.5">
            <img src="${k.icon}" alt="${k.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span class="text-cyan">${k.name}</span>
          </span>`,J=kf[$],ee=J?cn([{label:J}],k.name,_):_;return`<tr data-village-building-row="${$}" style="background-color: ${f[R%2]}">
        <td class="py-2 px-2">
          ${ee}
        </td>
        <td class="text-left px-2 font-mono" data-village-owned="${$}">${Y(I)}</td>
        <td class="text-left px-2 text-sm text-positive" data-village-effect="${$}">${H}</td>
        <td class="px-2">
          <span class="inline-flex items-center gap-2 font-mono text-sm" data-village-cost="${$}">${j}</span>
        </td>
        <td class="text-center px-2">
          <button data-action="buy-building" data-building="${$}" class="px-3 py-1 text-xs font-mono border ${q}" ${L?"":"disabled"}>Buy</button>
        </td>
      </tr>`}).join("")}</tbody>
      </table>
    </div>`;if(p+=ut("village-arcane-buildings","Arcane Buildings",x),p+='<div class="mb-4 flex items-center gap-2 text-sm font-mono">',p+='<span class="text-steel">Population:</span>',p+=`<span class="text-gold" data-village-available>${Y(w)}</span>`,p+='<span class="text-muted">/</span>',p+=`<span class="text-text" data-village-population>${Y(y)}</span>`,p+="</div>",l.length>0){const R=`<div class="mobile-scroll-x">
        <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1050px">
          <colgroup>
            <col style="width: 230px">
            <col style="width: 80px">
            <col style="width: 200px">
            <col style="width: 110px">
            <col style="width: 170px">
            <col style="width: 260px">
          </colgroup>
          <thead>
            <tr class="text-steel border-b border-muted--30">
              <th class="text-left py-1 px-2">Wonder</th>
              <th class="text-left py-1 px-2">Owned</th>
              <th class="text-left py-1 px-2">Effect</th>
              <th class="text-left py-1 px-2">Workers</th>
              <th class="text-left py-1 px-2">Progress</th>
              <th class="text-left py-1 px-2">Cost</th>
            </tr>
          </thead>
          <tbody>${l.map((v,I)=>{var G;const T=ne(v),L=fn[v];if(!L)return"";const q=D(r,v).toNumber(),j=i[v]||0,H=w>0,_=j>0,J=Math.pow(L.costEscalation,q),ee=L.baseTicks*J,X=((G=s.recipeCrafting[v])==null?void 0:G.progress)??0,re=Math.floor(X*ee),ce=Math.min(100,X*100),B=Ri(L,q),se=L.tickCost.map(W=>{const he=ne(W.recipeId),pe=W.amount;return`<span class="inline-flex items-center gap-1">
            <img src="${he.icon}" alt="${he.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span>${P(new m(pe))}</span>
          </span>`}).join(" "),ae=`<span class="inline-flex items-center gap-1.5">
              <img src="${T.icon}" alt="${T.name}" style="width: 40px; height: 40px;" class="object-contain">
              <span class="text-cyan">${T.name}</span>
            </span>`,fe=$f[v],me=fe?cn([{label:fe}],T.name,ae):ae;return`<tr data-wonder-row="${v}" style="background-color: ${f[I%2]}">
          <td class="py-2 px-2">
            ${me}
          </td>
          <td class="text-left px-2 font-mono" data-wonder-owned="${v}">${Y(q)}</td>
          <td class="text-left px-2 text-sm text-positive" data-wonder-effect="${v}">${B}</td>
          <td class="px-2">
            <div class="flex items-center gap-1">
              <button data-action="wonder-remove" data-wonder="${v}" class="${_?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${_?"border-text":"border-muted--30"} focus-outline-none relative${_?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${_?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
              <span class="text-positive text-center font-mono text-sm w-6" data-wonder-workers="${v}">${Y(j)}</span>
              <button data-action="wonder-add" data-wonder="${v}" class="${H?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${H?"border-text":"border-muted--30"} focus-outline-none relative${H?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${H?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
            </div>
          </td>
          <td class="px-2">
            <div class="w-full" style="min-width: 120px;">
              <div class="flex justify-between text-xs font-mono mb-0.5">
                <span class="text-muted" data-wonder-ticks="${v}">${P(new m(re))} / ${P(new m(ee))}</span>
              </div>
              <div class="h-2 border border-muted--30" style="background: transparent;">
                <div data-wonder-bar="${v}" class="h-full bg-cyan" style="width: ${ce}%; transition: none;"></div>
              </div>
              <div class="text-xs font-mono text-muted mt-0.5" data-wonder-eta="${v}">${j>0?bn((ee-re)*L.secondsPerTick/j*1e3):""}</div>
            </div>
          </td>
          <td class="px-2">
            <span class="inline-flex items-center gap-2 font-mono text-xs text-muted" data-wonder-cost="${v}">${se}</span>
          </td>
        </tr>`}).join("")}</tbody>
        </table>
      </div>`;p+=ut("village-arcane-wonders","Arcane Wonders",R),t.dismissedTips.includes("wonder-ascension")||(p+=`
          <div data-tip="wonder-ascension" class="mb-4 flex items-center gap-2 text-sm">
            <button data-action="dismiss-tip" data-tip-id="wonder-ascension"
                    class="text-muted hover-text-positive cursor-pointer border-none bg-transparent"
                    title="Dismiss tip">&#x2714;</button>
            <span class="text-muted">Tip: arcane wonder progress and completions do not reset on ascension</span>
          </div>
        `)}if(u.length>0){const R=`<div class="mobile-scroll-x">
        <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1050px">
          <colgroup>
            <col style="width: 230px">
            <col style="width: 80px">
            <col style="width: 200px">
            <col style="width: 540px">
          </colgroup>
          <thead>
            <tr class="text-steel border-b border-muted--30">
              <th class="text-left py-1 px-2">Equipment</th>
              <th class="text-left py-1 px-2">Owned</th>
              <th class="text-left py-1 px-2">Rate</th>
              <th class="text-left py-1 px-2">Workers</th>
            </tr>
          </thead>
          <tbody>${u.map((k,v)=>{const I=ne(k),T=D(r,k).toNumber(),L=a[k]||0,q=w>0,j=L>0,H=L/I.craftTime,_=`<span class="inline-flex items-center gap-1.5">
              <img src="${I.icon}" alt="${I.name}" style="width: 40px; height: 40px;" class="object-contain">
              <span class="text-cyan">${I.name}</span>
            </span>`,J=If[k],ee=mn[k],X=J?[{label:J}]:[];ee&&(X.push({label:`Reward: 1 + count / ${ee.rewardDivisor}`}),X.push({label:`Difficulty: 1 + count / ${ee.difficultyDivisor}`}));const re=X.length>0?cn(X,I.name,_):_;return`<tr data-workshop-row="${k}" style="background-color: ${f[v%2]}">
          <td class="py-2 px-2">
            ${re}
          </td>
          <td class="text-left px-2 font-mono" data-workshop-owned="${k}">${Y(T)}</td>
          <td class="text-left px-2 font-mono text-sm text-muted" data-workshop-rate="${k}">${H>0?`${H.toFixed(1)}/s`:""}</td>
          <td class="px-2">
            <div class="flex items-center gap-1">
              <button data-action="workshop-remove" data-equip="${k}" class="${j?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${j?"border-text":"border-muted--30"} focus-outline-none relative${j?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${j?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
              <span class="text-positive text-center font-mono text-sm w-6" data-workshop-workers="${k}">${Y(L)}</span>
              <button data-action="workshop-add" data-equip="${k}" class="${q?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${q?"border-text":"border-muted--30"} focus-outline-none relative${q?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${q?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
            </div>
          </td>
        </tr>`}).join("")}</tbody>
        </table>
      </div>`;p+=ut("village-workshop","Workshop",R)}e.innerHTML=p,e.querySelectorAll('[data-action="buy-building"]').forEach($=>{$.addEventListener("click",()=>{const R=$.getAttribute("data-building");M.getState().buyBuilding(R)})}),e.querySelectorAll('[data-action="workshop-add"]').forEach($=>{$.addEventListener("click",()=>{const R=$.getAttribute("data-equip"),k=M.getState(),I=z(k).workshopAssignments[R]||0;k.setWorkshopAssignment(R,I+1)}),$.addEventListener("contextmenu",R=>{R.preventDefault();const k=$.getAttribute("data-equip"),v=M.getState(),I=z(v),T=kn(I.ascension),L=rs(I.recipeInventory,T),q=as(I.workshopAssignments,I.wonderAssignments),j=Math.max(0,L-q),H=I.workshopAssignments[k]||0;v.setWorkshopAssignment(k,H+j)})}),e.querySelectorAll('[data-action="workshop-remove"]').forEach($=>{$.addEventListener("click",()=>{const R=$.getAttribute("data-equip"),k=M.getState(),I=z(k).workshopAssignments[R]||0;k.setWorkshopAssignment(R,Math.max(0,I-1))}),$.addEventListener("contextmenu",R=>{R.preventDefault();const k=$.getAttribute("data-equip");M.getState().setWorkshopAssignment(k,0)})}),e.querySelectorAll('[data-action="wonder-add"]').forEach($=>{$.addEventListener("click",()=>{const R=$.getAttribute("data-wonder"),k=M.getState(),I=z(k).wonderAssignments[R]||0;k.setWonderAssignment(R,I+1)}),$.addEventListener("contextmenu",R=>{R.preventDefault();const k=$.getAttribute("data-wonder"),v=M.getState(),I=z(v),T=kn(I.ascension),L=rs(I.recipeInventory,T),q=as(I.workshopAssignments,I.wonderAssignments),j=Math.max(0,L-q),H=I.wonderAssignments[k]||0;v.setWonderAssignment(k,H+j)})}),e.querySelectorAll('[data-action="wonder-remove"]').forEach($=>{$.addEventListener("click",()=>{const R=$.getAttribute("data-wonder"),k=M.getState(),I=z(k).wonderAssignments[R]||0;k.setWonderAssignment(R,Math.max(0,I-1))}),$.addEventListener("contextmenu",R=>{R.preventDefault();const k=$.getAttribute("data-wonder");M.getState().setWonderAssignment(k,0)})}),(S=e.querySelector('[data-action="dismiss-tip"]'))==null||S.addEventListener("click",$=>{var v;const R=$.currentTarget.getAttribute("data-tip-id"),k=M.getState();M.setState({dismissedTips:[...k.dismissedTips,R]}),(v=e.querySelector(`[data-tip="${R}"]`))==null||v.remove()})})(),()=>{var w;const t=M.getState(),s=z(t),{recipeInventory:r,workshopAssignments:a,wonderAssignments:i}=s,o=Wa("realm3"),u=hs("realm3"),l=vs("realm3"),d=kn(s.ascension),c=rs(r,d),f=as(a,i),b=Math.max(0,c-f),y=e.querySelector("[data-village-population]");y&&(y.textContent=Y(c));const g=e.querySelector("[data-village-available]");g&&(g.textContent=Y(b));for(const p of u){const h=ne(p),x=D(r,p).toNumber(),S=a[p]||0,$=S/h.craftTime,R=b>0,k=S>0,v=e.querySelector(`[data-workshop-owned="${p}"]`);v&&(v.textContent=Y(x));const I=e.querySelector(`[data-workshop-workers="${p}"]`);I&&(I.textContent=Y(S));const T=e.querySelector(`[data-workshop-rate="${p}"]`);T&&(T.textContent=$>0?`${$.toFixed(1)}/s`:"");const L=e.querySelector(`[data-action="workshop-add"][data-equip="${p}"]`);L&&(L.disabled=!R,L.className=`${R?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${R?"border-text":"border-muted--30"} focus-outline-none relative${R?"":" cursor-not-allowed"}`);const q=e.querySelector(`[data-action="workshop-remove"][data-equip="${p}"]`);q&&(q.disabled=!k,q.className=`${k?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${k?"border-text":"border-muted--30"} focus-outline-none relative${k?"":" cursor-not-allowed"}`)}for(const p of o){const h=D(r,p).toNumber(),x=Hr(p,h),S=Mi(r,p,h),$=e.querySelector(`[data-village-owned="${p}"]`);$&&($.textContent=Y(h));const R=e.querySelector(`[data-village-effect="${p}"]`);R&&(R.innerHTML=Ii(ds[p],h));const k=e.querySelector(`[data-village-cost="${p}"]`);k&&(k.innerHTML=x.map(I=>{const T=ne(I.recipeId);return`<span class="inline-flex items-center gap-1">
            <img src="${T.icon}" alt="${T.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span>${P(I.amount)}</span>
          </span>`}).join(" "));const v=e.querySelector(`[data-action="buy-building"][data-building="${p}"]`);v&&(S?(v.disabled=!1,v.className="px-3 py-1 text-xs font-mono border border-cyan text-cyan hover-bg-cyan--20 cursor-pointer"):(v.disabled=!0,v.className="px-3 py-1 text-xs font-mono border border-muted--30 text-muted cursor-not-allowed"))}for(const p of l){const h=fn[p];if(!h)continue;const x=D(r,p).toNumber(),S=i[p]||0,$=b>0,R=S>0,k=Math.pow(h.costEscalation,x),v=h.baseTicks*k,I=((w=s.recipeCrafting[p])==null?void 0:w.progress)??0,T=Math.floor(I*v),L=Math.min(100,I*100),q=e.querySelector(`[data-wonder-owned="${p}"]`);q&&(q.textContent=Y(x));const j=e.querySelector(`[data-wonder-effect="${p}"]`);j&&(j.innerHTML=Ri(h,x));const H=e.querySelector(`[data-wonder-workers="${p}"]`);H&&(H.textContent=Y(S));const _=e.querySelector(`[data-wonder-ticks="${p}"]`);_&&(_.textContent=`${P(new m(T))} / ${P(new m(v))}`);const J=e.querySelector(`[data-wonder-bar="${p}"]`);J&&(J.style.width=`${L}%`);const ee=e.querySelector(`[data-wonder-eta="${p}"]`);ee&&(ee.textContent=S>0?bn((v-T)*h.secondsPerTick/S*1e3):"");const X=e.querySelector(`[data-wonder-cost="${p}"]`);X&&(X.innerHTML=h.tickCost.map(B=>{const se=ne(B.recipeId),ae=B.amount;return`<span class="inline-flex items-center gap-1">
            <img src="${se.icon}" alt="${se.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span>${P(new m(ae))}</span>
          </span>`}).join(" "));const re=e.querySelector(`[data-action="wonder-add"][data-wonder="${p}"]`);re&&(re.disabled=!$,re.className=`${$?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${$?"border-text":"border-muted--30"} focus-outline-none relative${$?"":" cursor-not-allowed"}`);const ce=e.querySelector(`[data-action="wonder-remove"][data-wonder="${p}"]`);ce&&(ce.disabled=!R,ce.className=`${R?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${R?"border-text":"border-muted--30"} focus-outline-none relative${R?"":" cursor-not-allowed"}`)}}),Go=St(xe.Village,Rf),Mf=Go.render,Tf=Go.cleanup,Cf=e=>{const n=To(),t=()=>{const r=M.getState().realms.realm3,{ascension:a}=r,i=ms(a.lifetimePixies),o=ps(a.lifetimePixies);let u=`
      <div style="display:flex;gap:24px;align-items:flex-start">
      <div style="flex:1;min-width:0">
      <div class="mb-4 flex items-center gap-4">
        <div class="flex items-center gap-1" data-asc-souls-indicator>
          <img src="icons/ascended souls.png" alt="" style="width:32px;height:32px">
          <span class="text-gold font-mono" data-asc-souls-count>${Y(a.ascendedSouls)}</span>
        </div>
        <button
          data-asc-btn
          style="min-width:300px" class="px-8 py-3 text-sm font-mono border ${o?"text-yellow border-yellow hover-bg-yellow hover-text-black cursor-pointer":"text-muted border-muted"}"
          ${o?"":"disabled"}
        >
          ${o?`Ascend +${Y(i)} <img src="icons/ascended souls.png" alt="" class="inline-icon">`:"Ascend (not enough pixies)"}
        </button>
      </div>
      <div class="mobile-scroll-x"><table class="text-sm font-mono mb-6">
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="w-76 text-left">Ascended upgrades</th>
            <th class="w-24 text-left">Level</th>
            <th class="w-40 text-left">Cost</th>
            <th class="w-48 text-left">Effect</th>
            <th class="w-28"></th>
          </tr>
        </thead>
        <tbody>`;for(const d of tn){const c=ct(a,d.id),f=c>=d.maxLevel,b=f?0:gs(d.id,c),y=!f&&a.ascendedSouls>=b,g=f?1:a.ascendedSouls/Math.max(b,1),w=vn(f,y),p=[{label:d.description}];u+=`
        <tr data-asc-upgrade-row="${d.id}" class="${f?"text-muted--50":""}">
          <td data-asc-name="${d.id}" class="w-76 ${f?"line-through":"text-gold"}">
            <span class="inline-flex items-center gap-1.5">
              ${cn(p)}
              ${d.name}
            </span>
          </td>
          <td data-asc-level="${d.id}" class="w-24 text-steel">${c}/${d.maxLevel}</td>
          <td data-asc-cost="${d.id}" class="w-40">${f?"-":`<span class="${y?"text-text":"text-muted--50"}"><img src="icons/ascended souls.png" alt="" class="inline-icon"> ${Y(b)}</span>`}</td>
          <td data-asc-effect="${d.id}" class="w-48">${f?`<span class="text-steel">${d.effectDescription(c)}</span>`:`<span class="text-steel">${d.effectDescription(c)}</span><span class="text-muted">  </span><span class="text-positive">${d.effectDescription(c+1)}</span>`}</td>
          <td class="w-28">
            <button
              data-asc-buy="${d.id}"
              ${f||!y?"disabled":""}
              class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${w}"
            >
              ${f?"":Tt(Math.min(1,g),`data-asc-progress="${d.id}"`)}
              <span data-asc-btn-text="${d.id}" class="relative z-10">${f?"MAX":"Buy"}</span>
            </button>
          </td>
        </tr>`}u+=`
        </tbody>
      </table></div>
      </div>
      <div style="width:450px;flex-shrink:0" class="border border-muted--30 p-4 px-6 font-mono text-sm">
        <div class="text-gold mb-3">About Ascension</div>
        <div class="text-steel mb-3">Ascension grants <img src="icons/ascended souls.png" alt="" class="inline-icon"> Ascended Souls which can be used to buy Ascended upgrades. <img src="icons/ascended souls.png" alt="" class="inline-icon"> gain is based on pixies produced this ascension. The formula is (pixies/100k)^0.5</div>
        <div class="text-red mb-1">Ascension resets:</div>
        <ul class="text-steel mb-3 ml-4" style="list-style:disc">
          <li>Arcane Souls</li>
          <li>Creatures</li>
          <li>Expedition equipment</li>
          <li>Expedition loot</li>
          <li>Arcane buildings</li>
        </ul>
        <div class="text-positive mb-1">Ascension does not reset:</div>
        <ul class="text-steel ml-4" style="list-style:disc">
          <li>Arcane Wonders</li>
          <li>Soulforges</li>
          <li>Forge Enhancers</li>
          <li>Ascended upgrades</li>
          <li>Anything outside Realm of Magic</li>
        </ul>
      </div>
      </div>`,e.innerHTML=u;const l=e.querySelector("[data-asc-btn]");l&&(l.onclick=()=>{M.getState().ascend()&&t()});for(const d of tn){const c=e.querySelector(`[data-asc-buy="${d.id}"]`);c&&(c.onclick=()=>{M.getState().purchaseAscensionUpgrade(d.id)})}};return t(),()=>{const r=M.getState().realms.realm3,{ascension:a}=r,i=ms(a.lifetimePixies),o=ps(a.lifetimePixies),u=`${a.ascendedSouls}|${i}|${o}|${a.totalAscensions}|${JSON.stringify(a.upgrades)}`;if(!n(u))return;let l=!1;for(const f of tn){const b=ct(a,f.id),y=e.querySelector(`[data-asc-level="${f.id}"]`);if(y&&y.textContent!==`${b}/${f.maxLevel}`){l=!0;break}}if(l){t();return}const d=e.querySelector("[data-asc-btn]");d&&(d.innerHTML=o?`Ascend +${Y(i)} <img src="icons/ascended souls.png" alt="" class="inline-icon">`:"Ascend (not enough pixies)",d.disabled=!o,d.style.minWidth="300px",d.className=`px-8 py-3 text-sm font-mono border ${o?"text-yellow border-yellow hover-bg-yellow hover-text-black cursor-pointer":"text-muted border-muted"}`);const c=e.querySelector("[data-asc-souls-count]");c&&(c.textContent=`${Y(a.ascendedSouls)}`);for(const f of tn){const b=ct(a,f.id),y=b>=f.maxLevel,g=y?0:gs(f.id,b),w=!y&&a.ascendedSouls>=g,p=y?1:Math.min(1,a.ascendedSouls/Math.max(g,1)),h=e.querySelector(`[data-asc-cost="${f.id}"]`);h&&(y?h.innerHTML="-":h.innerHTML=`<span class="${w?"text-text":"text-muted--50"}"><img src="icons/ascended souls.png" alt="" class="inline-icon"> ${Y(g)}</span>`);const x=e.querySelector(`[data-asc-effect="${f.id}"]`);x&&(y?x.innerHTML=`<span class="text-steel">${f.effectDescription(b)}</span>`:x.innerHTML=`<span class="text-steel">${f.effectDescription(b)}</span><span class="text-muted">  </span><span class="text-positive">${f.effectDescription(b+1)}</span>`);const S=e.querySelector(`[data-asc-buy="${f.id}"]`);if(S){const $=vn(y,w);S.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${$}`,y||!w?S.setAttribute("disabled",""):S.removeAttribute("disabled");const R=e.querySelector(`[data-asc-btn-text="${f.id}"]`);R&&(R.textContent=y?"MAX":"Buy"),Ct(e.querySelector(`[data-asc-progress="${f.id}"]`),p,y)}}}},Vo=St(xe.Ascension,Cf),Ef=Vo.render,Af=Vo.cleanup,Nf={0:0,1:100,2:200,3:300},qf=e=>Nf[Math.min(e,3)]??0,Gs=e=>{var a,i;const n=qf(e),t=document.createElement("div");t.className="fixed inset-0 bg-black--90 flex items-center justify-center z-50";const s=n>0?`
      <p class="text-text mb-2">
        Based on your previous progress (Tier ${e}), you are eligible for
        <span class="text-yellow font-bold">${n} Time Warp charges</span>.
      </p>
      <p class="text-steel mb-4" style="font-size: 13px;">
        Each charge skips 5 minutes of game time, helping you get back to where you were faster.
        You can use them from the tab bar at any time.
      </p>
      <div class="flex gap-4 justify-center">
        <button data-action="accept" class="px-6 py-2 border-2 border-yellow text-yellow hover-bg-yellow hover-text-black font-mono cursor-pointer">
          Accept ${n} Charges
        </button>
        <button data-action="decline" class="px-6 py-2 border-2 border-steel text-steel hover-bg-steel hover-text-black font-mono cursor-pointer">
          No Thanks
        </button>
      </div>
    `:`
      <button data-action="decline" class="px-6 py-2 border-2 border-steel text-steel hover-bg-steel hover-text-black font-mono cursor-pointer">
        OK
      </button>
    `,r=n>0?`<p class="text-text mb-4">
        To help you get back to where you were, a <span class="text-yellow font-bold">Time Warp</span> feature is available.
        Time Warp charges let you fast-forward through the early game.
      </p>`:"";t.innerHTML=`
    <div class="bg-black border-2 border-red p-6 max-w-lg text-center">
      <h2 class="text-xl text-red font-bold mb-4">v${Ar()}  Incompatible Save</h2>
      <p class="text-text mb-4">
        Version ${Ar()} is incompatible with previous versions and your progress has been reset. Sorry about that!
      </p>
      ${r}
      ${s}
    </div>
  `,document.body.appendChild(t),(a=t.querySelector('[data-action="accept"]'))==null||a.addEventListener("click",()=>{M.setState({timeWarpCharges:n}),t.remove(),ni()}),(i=t.querySelector('[data-action="decline"]'))==null||i.addEventListener("click",()=>{t.remove(),ni()})},Wo="evercraft-hotkeys",Ti={tabLeft:{label:"Cycle Tab Left",key:"a"},tabRight:{label:"Cycle Tab Right",key:"d"},swapRealm:{label:"Swap Realm",key:"q"}};let Wn=_f();function _f(){var e;try{const n=localStorage.getItem(Wo);if(n){const t=JSON.parse(n),s={...Ti};for(const r of Object.keys(s))(e=t[r])!=null&&e.key&&(s[r]={...s[r],key:t[r].key});return s}}catch{}return{...Ti}}function Lf(){const e={};for(const[n,t]of Object.entries(Wn))e[n]={key:t.key};localStorage.setItem(Wo,JSON.stringify(e))}const Pf=()=>Wn,Of=(e,n)=>{Wn[e]={...Wn[e],key:n},Lf()},Uf=e=>{const n=e.toLowerCase();for(const[t,s]of Object.entries(Wn))if(s.key.toLowerCase()===n)return t;return null},Ff=["tabLeft","tabRight","swapRealm"],Bf=e=>e===" "?"Space":e.length===1?e.toUpperCase():e,Df=[{version:"0.87",changes:['Renamed "Sword Efficiency" research upgrades to "Cheaper Swords" for consistency with other cost-reduction upgrades',"Fixed T7 Knight icon not being orange","Fixed export save notification causing screen flash when it expires while on another tab","Artifacts tab: Active Bonuses now shows as a compact horizontal strip on mobile instead of taking up the full screen"]},{version:"0.86",changes:["Fixed expeditions with cross-realm swords not looping correctly","Fixed R2 inventory not showing consumption rate for swords used in R1 expeditions"]},{version:"0.85",changes:["Fixed cross-realm swords not being consumed when expeditions repeat in loop mode"]},{version:"0.84",changes:["Shard 4 reward increased x5 (200K  1M shards)","Fixed expedition reward icons and log not including prestige and sacrifice multipliers for shards and nullstone"]},{version:"0.83",changes:["Added clickable Auto header to toggle all automations on Prestige and Research tabs","Auto header shows dynamic checkmark reflecting current toggle state","Added dismissible tips explaining the Auto toggle-all feature"]},{version:"0.82",changes:["Fixed R3 expedition modal overstating arcane rewards when beacon assigned","Fixed equipment bonuses being lost to rounding on low base rewards","Fixed equipment tooltip showing wrong exponent (0.8 instead of 0.6)"]},{version:"0.81",changes:["Reverted beacon and R3 equipment to increase expedition difficulty again","R3 equipment reward bonus tripled","Renamed R1 shard expeditions to Shard 1-4, removed Shard 5","Reverted Shard 1-3 difficulty and rewards to pre-0.80 values","Added Shard 4: difficulty 100M, 6M shard reward"]},{version:"0.80",changes:["Beacons no longer increase expedition difficulty; beacon reward bonus reduced by 3x","R3 equipment no longer increases expedition difficulty; equipment reward bonus reduced by 3x"]},{version:"0.79",changes:["Fixed R3 expedition equipment not persisting across save/reload (also affected repeat expeditions after reload)"]},{version:"0.78",changes:["Fixed R3 expedition log not showing equipment-boosted rewards for arcane bars and logs"]},{version:"0.77",changes:["Village tab now stays unlocked permanently once expedition loot is obtained (no longer disappears after ascension)","Arcane Wonders and Workshop sections now stay visible after ascension","R3 creature cycle time display now reflects Production Speed ascension upgrade","Ascension tab now formats large numbers (ascended souls, costs, gains)",'Fixed R3 creature "Produces" column not reflecting Arcane Sanctum multiplier',"Fixed Arcane Sanctum cost per tick incorrectly scaling with level (only tick count should increase)","Fixed Arcane Wonder workers staying assigned after ascension despite population resetting to 0","Fixed expedition reward rates not accounting for equipment multiplier in Combat tab and Inventory panel"]},{version:"0.76",changes:["Reduced icon file sizes for faster loading"]},{version:"0.75",changes:["Capped game loop at 60fps on high refresh rate monitors"]},{version:"0.74",changes:["Fixed ascension upgrade buy buttons becoming unclickable after purchasing an upgrade"]},{version:"0.73",changes:["Hidden Altar and Artifacts tabs in Realm of Magic","Added 3 new creatures: Mana Wisp, Anima Core, Luminary  each produces the previous creature tier","Added Workshop: assign population to craft Pickaxes and Axes for expeditions","Added Arcane Wonders: build Arcane Sanctum (x2 creature production per level) using population workers and expedition loot","Added Mine IV/V and Forest IV/V expeditions with equipment multipliers","Equipment (Pickaxes, Axes) increases both expedition rewards and difficulty","Added Forge Enhancer: crafted in Realm of War from 1B T8 gems, multiplies arcane soul production by 1 + count","Added Ascension prestige system: reset creatures, equipment, and village to earn Ascended Souls","Ascension upgrades: Arcane Soul Production, Production Speed, Pixie Strength, T8 Gem Production (cross-realm), Bigger Dwelling","Arcane Dwelling cost reduced (1000  100 souls, x3  x1.7 scaling)","Mine/Forest II-III expedition difficulty and rewards rebalanced"]},{version:"0.72",changes:["UI scale minimum lowered from 80% to 50%"]},{version:"0.71",changes:["Fixed Upgrades tab highlight not appearing when research upgrades are affordable"]},{version:"0.70",changes:["Added Realm of Magic. See requirements in the realm tab. Realm of Magic is partially done, more content coming soon."]},{version:"0.69",changes:["Boats (speed units) can now be used in heroic expeditions to reduce duration","Fixed expedition card income rate not being formatted for large numbers"]},{version:"0.68",changes:["Tweaked inventory panel alignment"]},{version:"0.67",changes:['Fixed combat tab message to say "expedition units" instead of "military unit"',"Altar tab hidden until first tier reset; Artifacts tab hidden until an expedition unit has been crafted","Added dismissable tip under crafters about right-click to assign/unassign all"]},{version:"0.66",changes:["Mobile browser support: responsive layout, collapsible inventory sidebar, horizontally scrollable tables and crafting grids, smaller fonts and spacing on small screens"]},{version:"0.65",changes:["Expedition dialog: replaced unit assignment buttons with role-specific controls  Army gets +10% and 100% success rate buttons, Fleet/Beacons get three scaled static-amount buttons"]},{version:"0.64",changes:["Added favicon (T1 gem icon)","Altar of Sacrifice: removed extra border wrapper, moved section labels into table headers"]},{version:"0.63",changes:["Prepared realm tab to support R3","Fixed realm portal button shrinking on narrow browsers","Removed title header from nav bar to give tabs more space","New display setting: Tab Highlighting toggle  disables glow and count indicators on tabs"]},{version:"0.62",changes:["Reduced R2 sword gem cost scaling from x10 to x4 per tier for T4+ (T1-T3 unchanged)","New R2 research upgrades: T4/T5/T6 Sword Efficiency  reduces sword input costs by 12% per level (max 8 levels, costs flasks + swords)"]},{version:"0.61",changes:['Auto-Prestige unlocked at T2: checkbox next to each prestige button to automatically prestige when affordable. Click "Auto" column header to toggle all in a category.',"Heroic expedition setup is now automatically cleared when the expedition finishes","New Realm 2 expedition: T5-T6 Quest (difficulty 2M)  grants scaling output bonus to T5 and T6 recipes"]},{version:"0.60",changes:["Reduced T1 Knight Strength research base cost from 50k to 1k flasks","Expedition unit tooltips now show on icon hover and explain how stats affect success rate, duration, and rewards","Expeditions now consume all assigned units on success (previously half were returned)"]},{version:"0.59",changes:["Prestige now subtracts the requirement cost instead of resetting the recipe to 0","Pause state now persists across refresh  no offline time is processed for a paused game","Expedition modal: unit icons now have hover tooltips showing role description and strength formula"]},{version:"0.58",changes:["New artifact: Combat Artifact (x1.1 combat strength per level, max 100, 50 shard base cost)","New artifact: Crafting Speed (+5% crafting speed per level, max 40, 200 shard base cost)","Fix: Expeditions 3 and 4 no longer reset to locked on page refresh"]},{version:"0.57",changes:["Removed Cave Exploration expedition; remaining expeditions renumbered","Expedition unlock requirement reduced from 20 to 5 completions","Expedition difficulty reduced: Mountain Pass, Ancient Ruins, Wraith Stronghold","Beacons now increase rewards by twice as much as difficulty (was equal), and beacon effect strengthened 5x","Knight strength exponent increased from 0.7 to 0.8","Prestige tab: explanation section is now collapsible, collapse state persists across saves"]},{version:"0.56",changes:["Prestige tab: added mechanics explanation, split bonus column into separate Recipe and Total columns"]},{version:"0.55",changes:["Reduced base cost of knight strength research from 1M to 50K flasks","Fixed inventory panel scrollbar not flush with right border"]},{version:"0.54",changes:["Crafter's Guild bonus now caps at 30 crafters (the 31st+ crafter no longer increases the bonus)"]},{version:"0.53",changes:["Crafting tab now always shows per-craft amounts, with per-second rate in parentheses when crafters are assigned","Fixed Altar tab in Realm of War showing Nullstone and Artifact Shard sacrifice options (these are only earnable in Realm 1)"]},{version:"0.52",changes:["Fixed tooltips getting clipped when near the bottom of the screen"]},{version:"0.51",changes:["Fixed collapsible sections breaking the page when collapsed"]},{version:"0.50",changes:["Mountain Pass expedition rebalanced: difficulty 50k10k, duration 3h1h, shards 400150"]},{version:"0.49",changes:["Tier tab warning now guides players to advance through expeditions when Realm of War is not yet unlocked","Recipe output rate now displays in green when crafters are actively producing","Renamed Upgrades tab to Research","Fixed research upgrades table showing blank Level, Cost, and Effect columns",'Added "Hide maxed upgrades" checkbox to Research tab (on by default)']},{version:"0.48",changes:["R1 military unlock thresholds now scale per unit (x100 craft cost) instead of flat 100k","Buffed all ring artifact upgrade bonuses from x1.3 to x1.35 per level","Reduced T2 ring shard cost from 100 to 50 and T3 ring shard cost from 1000 to 500","Forest Patrol expedition difficulty reduced from 10 to 5 and duration from 2m to 1m"]},{version:"0.47",changes:["Reduced T1 tier reset mana requirement from 1e21 to 1e20"]},{version:"0.46",changes:["New research upgrade: Cheaper Gems  reduces gem input costs by 5% per level (10 levels)","New research upgrade: Cheaper Expedition Units  reduces military input costs by 5% per level (10 levels)","New research upgrade: Cheaper Flasks  reduces flask input costs by 5% per level (10 levels)","Buffed T4T8 gem mana multipliers (T4: x1.6x3, T5: x2x4, T6: x2.4x5, T7: x3x10, T8: x5x20)"]},{version:"0.45",changes:['Mana tooltip now shows cleaner format: "605 T2 gems  x605 multiplier"',"R1 military unlock thresholds increased to 100k lifetime gems","R1 boat and beacon gem crafting costs increased"]},{version:"0.44",changes:["Knight strength upgrades are now hidden until the corresponding knight has been produced","Expedition unit unlock conditions increased (more lifetime gems required)"]},{version:"0.43",changes:["T2 global military changed: only Realm of War T4+ Swords are usable cross-realm (previously all units were global)","Gem Manufacturing research upgrade rebalanced: 16 levels with alternating 10/50 flask costs climbing through tiers"]},{version:"0.42",changes:["Fix: Inventory panel nullstone/shard rates now include prestige and sacrifice bonus multipliers","Fix: Expedition rewards/s now factors in success rate instead of assuming 100%","New military unit: T7 Knight (Realm 1)","Auto-buy checkboxes on upgrades tab are now hidden before Tier 1","R1 Military Strength upgrade split into 3 per-knight upgrades (T1/T4/T7). Existing levels migrate to all three."]},{version:"0.41",changes:["Playtime clock now visible for all players","Fix: Time Warp button now appears immediately after migration grants charges"]},{version:"0.40",changes:["Major rework, too many changes to list","V0.39 incompatible. Receive time warps as compensation based on tier reached."]},{version:"0.39",changes:["T1 Mana Gems are now free to craft (no mana cost)","Starting mana is now 0","Fix: crafting progress bars now animate correctly"]},{version:"0.38",changes:["Fix: offline time calculation no longer undercounts production"]},{version:"0.37",changes:["Internal: centralized UI update system with dirty flags for better performance","Internal: split large combat and artifact UI modules into smaller files","Internal: removed code duplication with tab manager factory and fingerprint utility","Fix: mana regeneration tooltip no longer cut off by inventory panel"]},{version:"0.36",changes:["Ring artifacts now only increase output (no longer increase input costs)","Tier milestones now display in chronological order"]},{version:"0.35",changes:["New artifact: Mana Globe (x10 mana generation, x10 per upgrade level)","New artifact: Crafting Speed (+30% crafting speed, +2% per upgrade level)","New expedition: Abyssal Rift (artifact shards + combat points)","New expedition: Void Sanctum (nullstone)","New heroic expedition: Combat Mastery (scales combat point drops)","Added 3 more artifact slots (6-8)","Expedition reward icons now reflect heroic multipliers","Added T5 Sword and T6 Sword military units in Realm of War","Molds now always give 100% of their effect (no longer need to be slotted)"]},{version:"0.34",changes:["Fixed tier reset corrupting Realm of War military crafters (NaN bug)","Expedition UI simplified: compact reward squares replace icon cards","Click any expedition square to open the setup dialog","Category labels shown to the left of each expedition group"]},{version:"0.33",changes:["Heroic expeditions no longer have a 9,999 unit cap","Expedition unlocks now persist across tier resets"]},{version:"0.32",changes:["Expedition UI redesigned: side-by-side icon cards replace table rows","Custom expedition icons for R1 (Forest Patrol, Cave, Mountain, Ruins, Wraith)","R2 quest icons now use gem icons instead of enemy icons","Heroic expedition cards show victories and bonus multiplier","R2 quest cards show completions and output bonus","Setup dialog: unit controls use table layout for proper alignment","Setup dialog: expedition icon enlarged to 96x96","Performance: separated lightweight progress bar updates from full state updates"]},{version:"0.31",changes:["Added automatic update notification when a new version is available"]},{version:"0.30",changes:["Upgrades and Tier tabs glow when an action is available","Expedition setup now saves and starts in one click","Expedition log is now collapsible","Early game pacing tweaked to be faster"]},{version:"0.29",changes:["Removed mold artifacts from the game","Artifact shards spent on molds (purchase + upgrades) are refunded automatically"]},{version:"0.28",changes:["Added Heroic Expeditions"]},{version:"0.27",changes:["Fixed inventory sections not collapsible in R2","Removed spinner arrows from expedition unit assignment input","Fixed +/- buttons not working on expedition assignment until ++ was used first","Fixed expedition log not updating when switching realms while on Expeditions tab",'Removed misleading "T3 reset only here" from Realm of War tooltip (T3 resets both realms)',"R2 expedition dialog now shows the bonus formula per completion"]},{version:"0.26",changes:["Added UI Scale slider in Settings under new Display section (0.8x to 1.3x)","Moved Background Image toggle from Game to Display section"]},{version:"0.25",changes:["Added realm background images (blended with 70% black overlay)",'Added "Background Image" toggle in Settings under Game',"Crafting row backgrounds now semi-transparent to show background image"]},{version:"0.24",changes:["Expedition log now shows last 20 entries per expedition type","Added filter dropdown to expedition log to view specific expedition types","Tab content now scrolls independently instead of the whole page"]},{version:"0.23",changes:["Added Combat Artifact: costs 100k Artifact Shards, 100k Ghost Knights, and 100k Wisps","Combat Artifact grants +30% military strength (+3% per upgrade level)","Expeditions can now reach 100% success rate (was capped at 80%)"]},{version:"0.22",changes:["Added Realm of War tooltip on realm switch button and portal gate","Added Q hotkey to swap realms","Added rebindable hotkeys dialog in Settings"]},{version:"0.21",changes:["Increased max units per expedition from 5,000 to 9,999","Lowered military research upgrade costs","Increased T6 gem multiplier from x2.0 to x2.4"]},{version:"0.2",changes:["Added Realm of War"]},{version:"0.17",changes:["T2 reset now grants x1.4 total crafter speed and unlocks Military Research","Added Military Research upgrades: Knight Strength and Wisp Strength","Improved Tier milestone UI with two-column layout"]},{version:"0.16",changes:["T4-T6 ring and mold artifacts","Added T5-T6 Output combat upgrade","Added T5-T6 Output mana upgrades","Rebalanced artifact slot and artifact costs","Fixed expedition unit assignment buttons firing multiple times when switching tabs","Fixed military strength formula to apply exponent to count before multiplier"]},{version:"0.15",changes:["Added Tier system - prestige mechanic with permanent bonuses","Added Altar of Sacrifice - sacrifice items for permanent output bonuses","T1 reset requires 1e21 mana, grants x1.2 crafter speed and unlocks Altar","T2 reset requires 1e40 mana, grants x1.4 total crafter speed and unlocks Military Research","T1 gems require minimum 5 to prevent softlock when sacrificing","Craft time display now reflects tier speed bonuses"]},{version:"0.14",changes:["Removed Village system (did not playtest well)"]},{version:"0.13",changes:["Added military crafting speed combat upgrade","Fixed crafting input display to include artifact bonuses"]},{version:"0.12",changes:["Added keyboard hotkeys: A/D to cycle main tabs, [/] to cycle inventory tabs"]},{version:"0.11",changes:["Renamed Combat tab to Expeditions","Artifacts tab now shows a message when you have no lifetime artifact shards","Expeditions tab now shows a message when you have no lifetime ghost knights","Added lifetime artifact shards tracking","Added changelog to settings"]},{version:"0.1",changes:["Initial release"]}];let fr=!1,Oa=!1,ls=!1,Vt=null,nn="",Cs="",mr=null;const Zn=e=>{Cs=e,mr&&clearTimeout(mr),mr=window.setTimeout(()=>{Cs="";const n=ye==null?void 0:ye.querySelector("[data-message]");n&&n.remove()},3e3),Fe()},Hf=async()=>{const e=M.getState().exportSave();await navigator.clipboard.writeText(e),Zn("Copied to clipboard!")},jf=()=>{const e=M.getState().exportSave(),n=new Blob([e],{type:"text/plain"}),t=URL.createObjectURL(n),s=document.createElement("a");s.href=t,s.download=`evercraft-save-${Date.now()}.txt`,s.click(),URL.revokeObjectURL(t),Zn("File downloaded!")},Gf=async()=>{const e=await navigator.clipboard.readText(),n=M.getState().importSave(e);n.success?Ea():n.incompatible?Gs(n.oldTier??0):Zn("Invalid save data!")},Vf=()=>{const e=M.getState().importSave(nn);e.success?(nn="",Ea()):e.incompatible?Gs(e.oldTier??0):Zn("Invalid save data!")},Wf=e=>{const n=new FileReader;n.onload=t=>{var a;const s=(a=t.target)==null?void 0:a.result,r=M.getState().importSave(s);r.success?Ea():r.incompatible?Gs(r.oldTier??0):Zn("Invalid save data!")},n.readAsText(e)},Yf=()=>{M.getState().hardReset(),window.location.reload()},Kf=()=>{M.getState().togglePause(),Fe()},zf=()=>{M.getState().toggleBackgroundImage(),sc(M.getState().activeRealm),Fe()},Xf=()=>{M.getState().toggleTabHighlighting(),Fe()},pr=e=>{const n=M.getState().uiScale,t=Math.round((n+e)*100)/100;M.getState().setUiScale(t),Ua(t),Fe()},Ua=e=>{const n=document.getElementById("root");n&&(n.style.zoom=`${e}`,n.style.height=`${100/e}vh`,n.style.width=`${100/e}vw`)},Zf=()=>{Oa=!0,Fe()},Ci=()=>{Oa=!1,Fe()},Qf=()=>Oa?`
    <div data-changelog-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-2xl w-full mx-4 max-h-80vh flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Changelog</h2>
          <button data-action="close-changelog" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div class="overflow-y-auto flex-1 pr-2">
          ${Df.map(n=>`
    <div class="mb-6">
      <h3 class="text-lg text-gold font-mono mb-2">v${n.version}</h3>
      <ul class="list-disc list-inside text-text">
        ${n.changes.map(t=>`<li class="mb-1">${t}</li>`).join("")}
      </ul>
    </div>
  `).join("")}
        </div>
      </div>
    </div>
  `:"",Jf=()=>{if(!ls)return"";const e=Pf();return`
    <div data-hotkey-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Hotkeys</h2>
          <button data-action="close-hotkeys" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div>
          ${Ff.map(t=>{const s=e[t],r=Vt===t,a=r?'<span class="text-gold animate-pulse">Press a key...</span>':`<span class="text-cyan font-mono">${Bf(s.key)}</span>`;return`
      <div class="flex items-center justify-between py-2 border-b border-muted--20">
        <span class="text-text">${s.label}</span>
        <div class="flex items-center gap-3">
          ${a}
          <button
            data-action="rebind-hotkey"
            data-hotkey-action="${t}"
            class="px-3 py-1 text-xs font-mono border ${r?"border-gold text-gold":"border-steel text-steel hover-bg-steel hover-text-black"}"
          >${r?"Cancel":"Rebind"}</button>
        </div>
      </div>
    `}).join("")}
        </div>
        <div class="mt-4 text-xs text-steel">Click Rebind, then press any key to assign it.</div>
      </div>
    </div>
  `};let En=null;const em=e=>{Vt=e,Fe(),En=n=>{if(n.preventDefault(),n.stopPropagation(),n.key==="Escape"){Yo();return}Of(e,n.key),Vt=null,Es(),Fe()},document.addEventListener("keydown",En,!0)},Yo=()=>{Vt=null,Es(),Fe()},Es=()=>{En&&(document.removeEventListener("keydown",En,!0),En=null)};let ye=null;const Fe=()=>{var u,l,d,c,f,b,y,g,w,p,h,x,S,$,R,k,v;if(!ye)return;const e=M.getState().paused,n=M.getState().backgroundImageOff,t=M.getState().tabHighlightingOff,s=M.getState().uiScale;ye.innerHTML=`
    ${Cs?`<div data-message class="mb-4 p-2 border-2 border-arcane text-arcane">${Cs}</div>`:""}

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Game</h2>
      <div class="flex items-center gap-4">
        <button data-action="toggle-pause" class="px-4 py-2 border-2 ${e?"border-positive text-positive hover-bg-positive hover-text-black":"border-gold text-gold hover-bg-gold hover-text-black"} bg-black font-mono transition-colors">
          ${e?"Resume Game":"Pause Game"}
        </button>
        <button data-action="show-hotkeys" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Hotkeys
        </button>
        <a href="https://discord.gg/fCp7jCDqgg" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-discord text-discord bg-black font-mono hover-bg-discord hover-text-white transition-colors">
          <svg width="20" height="20" viewBox="0 -28.5 256 256" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid">
            <path d="M216.856 16.597A208.502 208.502 0 0 0 164.042 0c-2.275 4.113-4.933 9.645-6.766 14.046-19.692-2.961-39.203-2.961-58.533 0-1.832-4.4-4.55-9.933-6.846-14.046a207.809 207.809 0 0 0-52.855 16.638C5.618 67.147-3.443 116.4 1.087 164.956c22.169 16.555 43.653 26.612 64.775 33.193A161.094 161.094 0 0 0 79.735 175.3a136.413 136.413 0 0 1-21.846-10.632 108.636 108.636 0 0 0 5.356-4.237c42.122 19.702 87.89 19.702 129.51 0a131.66 131.66 0 0 0 5.355 4.237 136.07 136.07 0 0 1-21.886 10.653c4.006 8.02 8.638 15.67 13.873 22.848 21.142-6.58 42.646-16.637 64.815-33.213 5.316-56.288-9.08-105.09-38.056-148.36ZM85.474 135.095c-12.645 0-23.015-11.805-23.015-26.18s10.149-26.2 23.015-26.2c12.867 0 23.236 11.804 23.015 26.2.02 14.375-10.148 26.18-23.015 26.18Zm85.051 0c-12.645 0-23.014-11.805-23.014-26.18s10.148-26.2 23.014-26.2c12.867 0 23.236 11.804 23.015 26.2 0 14.375-10.148 26.18-23.015 26.18Z" fill="currentColor"/>
          </svg>
          Join Discord
        </a>
        ${e?'<span class="text-red">Game is paused - time is not accumulating</span>':""}
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Display</h2>
      <div class="flex items-center gap-4 mb-4">
        <button data-action="toggle-bg-image" class="px-4 py-2 border-2 ${n?"border-steel text-steel hover-bg-steel hover-text-black":"border-positive text-positive hover-bg-positive hover-text-black"} bg-black font-mono transition-colors">
          Background Image ${n?"Off":"On"}
        </button>
        <button data-action="toggle-tab-highlighting" class="px-4 py-2 border-2 ${t?"border-steel text-steel hover-bg-steel hover-text-black":"border-positive text-positive hover-bg-positive hover-text-black"} bg-black font-mono transition-colors">
          Tab Highlighting ${t?"Off":"On"}
        </button>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-steel font-mono">UI Scale</span>
        <button data-action="ui-scale-down" ${s<=.5?"disabled":""} class="px-3 py-1 font-mono border-2 ${s<=.5?"border-muted--30 text-muted--30 cursor-not-allowed":"border-steel text-steel hover-bg-steel hover-text-black"} bg-black transition-colors">&minus;</button>
        <span class="text-text font-mono" data-ui-scale-value style="min-width: 3.5em; text-align: center;">${Math.round(s*100)}%</span>
        <button data-action="ui-scale-up" ${s>=1.3?"disabled":""} class="px-3 py-1 font-mono border-2 ${s>=1.3?"border-muted--30 text-muted--30 cursor-not-allowed":"border-steel text-steel hover-bg-steel hover-text-black"} bg-black transition-colors">+</button>
        <button data-action="reset-ui-scale" class="px-2 py-1 text-xs font-mono border border-steel text-steel hover-bg-steel hover-text-black transition-colors">Reset</button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Export</h2>
      <div class="flex gap-4">
        <button data-action="export-clipboard" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Copy to Clipboard
        </button>
        <button data-action="export-file" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Download File
        </button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Import</h2>
      <div class="flex gap-4 mb-4">
        <button data-action="import-clipboard" class="px-4 py-2 border-2 border-arcane text-arcane bg-black font-mono hover-bg-arcane hover-text-black transition-colors">
          Paste from Clipboard
        </button>
        <label class="px-4 py-2 border-2 border-arcane text-arcane bg-black font-mono cursor-pointer hover-bg-arcane hover-text-black transition-colors">
          Load File
          <input type="file" accept=".txt" data-action="import-file" class="hidden">
        </label>
      </div>
      <div class="flex gap-4">
        <input
          type="text"
          data-input="import-text"
          value="${nn}"
          placeholder="Paste save data here..."
          class="flex-1 px-4 py-2 bg-panel border-2 border-text text-text font-mono placeholder-text-muted"
        >
        <button
          data-action="import-text"
          ${nn?"":"disabled"}
          class="px-4 py-2 border-2 font-mono ${nn?"border-arcane text-arcane bg-black hover-bg-arcane hover-text-black transition-colors":"border-muted--30 text-muted--30 cursor-not-allowed line-through"}"
        >
          Import
        </button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Danger Zone</h2>
      ${fr?`
        <div class="flex gap-4 items-center">
          <span class="text-red">Are you sure?</span>
          <button data-action="hard-reset" class="px-4 py-2 border-2 border-red text-red bg-black font-mono hover-bg-red hover-text-black transition-colors">
            Yes, Reset Everything
          </button>
          <button data-action="cancel-reset" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
            Cancel
          </button>
        </div>
      `:`
        <button data-action="show-reset-confirm" class="px-4 py-2 border-2 border-red text-red bg-black font-mono hover-bg-red hover-text-black transition-colors">
          Hard Reset
        </button>
      `}
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">About</h2>
      <div class="flex items-center gap-4">
        <span class="text-muted">Version ${Ar()}</span>
        <button data-action="show-changelog" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          View Changelog
        </button>
      </div>
    </div>

    ${Qf()}
    ${Jf()}
  `,(u=ye.querySelector('[data-action="toggle-pause"]'))==null||u.addEventListener("click",Kf),(l=ye.querySelector('[data-action="toggle-bg-image"]'))==null||l.addEventListener("click",zf),(d=ye.querySelector('[data-action="toggle-tab-highlighting"]'))==null||d.addEventListener("click",Xf),(c=ye.querySelector('[data-action="ui-scale-down"]'))==null||c.addEventListener("click",()=>pr(-.05)),(f=ye.querySelector('[data-action="ui-scale-up"]'))==null||f.addEventListener("click",()=>pr(.05)),(b=ye.querySelector('[data-action="reset-ui-scale"]'))==null||b.addEventListener("click",()=>pr(1-M.getState().uiScale)),(y=ye.querySelector('[data-action="export-clipboard"]'))==null||y.addEventListener("click",Hf),(g=ye.querySelector('[data-action="export-file"]'))==null||g.addEventListener("click",jf),(w=ye.querySelector('[data-action="import-clipboard"]'))==null||w.addEventListener("click",Gf),(p=ye.querySelector('[data-action="import-text"]'))==null||p.addEventListener("click",Vf),(h=ye.querySelector('[data-action="show-reset-confirm"]'))==null||h.addEventListener("click",()=>{fr=!0,Fe()}),(x=ye.querySelector('[data-action="hard-reset"]'))==null||x.addEventListener("click",Yf),(S=ye.querySelector('[data-action="cancel-reset"]'))==null||S.addEventListener("click",()=>{fr=!1,Fe()}),($=ye.querySelector('[data-action="show-changelog"]'))==null||$.addEventListener("click",Zf),(R=ye.querySelector('[data-action="close-changelog"]'))==null||R.addEventListener("click",Ci);const r=ye.querySelector("[data-changelog-dialog]");r==null||r.addEventListener("click",I=>{I.target===r&&Ci()}),(k=ye.querySelector('[data-action="show-hotkeys"]'))==null||k.addEventListener("click",()=>{ls=!0,Fe()}),(v=ye.querySelector('[data-action="close-hotkeys"]'))==null||v.addEventListener("click",()=>{ls=!1,Vt=null,Es(),Fe()});const a=ye.querySelector("[data-hotkey-dialog]");a==null||a.addEventListener("click",I=>{I.target===a&&(ls=!1,Vt=null,Es(),Fe())}),ye.querySelectorAll('[data-action="rebind-hotkey"]').forEach(I=>{I.addEventListener("click",()=>{const T=I.getAttribute("data-hotkey-action");Vt===T?Yo():em(T)})});const i=ye.querySelector('[data-action="import-file"]');i==null||i.addEventListener("change",I=>{var L;const T=(L=I.target.files)==null?void 0:L[0];T&&(Wf(T),i.value="")});const o=ye.querySelector('[data-input="import-text"]');o==null||o.addEventListener("input",I=>{nn=I.target.value,Fe()})},tm=e=>{ye=e,Fe()};let Ae="crafting";const Ko={crafting:xe.Crafting,upgrades:xe.Upgrades,prestige:xe.Prestige,combat:xe.Combat,artifacts:xe.Artifacts,village:xe.Village,ascension:xe.Ascension,tier:xe.Tier,altar:xe.Altar,realm:xe.Realm,settings:0},zo=e=>{Ae=e,Ao(Ko[e]),In(),Gr()},nm=["crafting","upgrades","prestige","combat","village","ascension","artifacts","tier","altar","realm","settings"],Fa=()=>{const e=M.getState(),n=D(e.realms.realm1.recipeInventory,"nullstone").gte(1)||e.realms.realm1.combat.portalBuilt,t=Ir(e.globalTier),s=We.some(a=>{const i=e.realms[a].recipeCrafting;return rl(a).some(o=>{var u;return(((u=i[o])==null?void 0:u.lifetimeProduced)??0)>0})}),r=e.activeRealm;return nm.filter(a=>{if(a==="realm")return n;if(a==="altar")return t&&r!=="realm3";if(a==="artifacts")return s&&r!=="realm3";if(a==="upgrades"&&r==="realm3"||a==="prestige"&&r==="realm3")return!1;if(a==="village"){if(r!=="realm3")return!1;if(e.villageUnlocked)return!0;const i=e.realms.realm3.recipeInventory;return D(i,"arcane_bar").gt(0)||D(i,"arcane_log").gt(0)?(M.setState({villageUnlocked:!0}),!0):!1}return a==="ascension"?r==="realm3":!0})},Ei=e=>{const n=Fa(),s=(n.indexOf(Ae)+e+n.length)%n.length;zo(n[s])},sn={crafting:"Main",upgrades:"Research",prestige:"Prestige",artifacts:"Artifacts",combat:"Expeditions",village:"Village",ascension:"Ascension",tier:"Tier",altar:"Altar",realm:"Realm",settings:"Settings"},sm=()=>{var r,a,i;const e=M.getState();if(e.activeRealm==="realm3")return[];const n=z(e),{recipeCrafting:t}=n,s=[];for(const o of zi){if(o==="crafters")continue;const l=o.match(/manaT(\d)Output/);if(l){const d=parseInt(l[1]);if((((r=t[`gem_${d}`])==null?void 0:r.lifetimeProduced)??0)<=0)continue}s.push(o)}for(const o of Qr){if(an.includes(o)){if(e.activeRealm!=="realm1")continue;const u={t1KnightStrength:"t1_knight",t4KnightStrength:"t4_knight",t7KnightStrength:"t7_knight"};if(u[o]&&(((a=t[u[o]])==null?void 0:a.lifetimeProduced)??0)===0)continue}if(rn.includes(o)){if(e.activeRealm!=="realm2")continue;const u={t4SwordEfficiency:"t4_sword",t5SwordEfficiency:"t5_sword",t6SwordEfficiency:"t6_sword"};if(u[o]&&(((i=t[u[o]])==null?void 0:i.lifetimeProduced)??0)===0)continue}s.push(o)}return s},Xo=()=>{const e=M.getState(),n=z(e),{mana:t,upgrades:s}=n,r=Nt(n.recipeInventory),a=xn(n.recipeInventory),i=e.globalTier;return sm().filter(o=>!gt(s,o,i)&&Kn(s,o,t,r,a,i,n.recipeInventory)).length},Zo=()=>{const e=M.getState(),n=z(e);return ks(n.mana,e.globalTier,e.activeRealm)},Qo=()=>{const e=M.getState(),n=z(e),{prestige:t}=n,s=[...Ln(e.activeRealm),...kr];let r=0;for(const a of s){const i=D(n.recipeInventory,a),o=t.prestigeCounts[a]||0;Us(a,i,o)&&r++}return r},Jo=()=>window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",Ai=e=>{const n=Math.floor(e/6e4),t=Math.floor(n/60),s=Math.floor(t/24);if(s>=1){const a=t%24;return`${s}d ${a}h`}const r=n%60;return`${t}h ${String(r).padStart(2,"0")}m`},ec=()=>`
    <div class="tooltip-title" style="color: var(--color-row-special);">Realm of War</div>
    <div class="tooltip-section" style="margin-bottom: 4px;">A harsher realm with unique mechanics:</div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-penalty); margin-bottom: 2px; font-weight: bold;">Penalties</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Mana generation</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">Square rooted</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Craft speed</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">x4 slower</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Flask gem costs</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">x4 higher</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Artifacts</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">Cannot craft</span>
    </div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-bonus); margin-bottom: 2px; font-weight: bold;">Bonuses</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice cap</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">200k (vs 20k)</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice batch</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">10 at once</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice scaling</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">Up to x9.94</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Quest bonuses</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">Tier output multipliers</span>
    </div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-special); margin-bottom: 2px; font-weight: bold;">Unique</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Military</span>
      <span class="tooltip-value" style="color: var(--color-text);">T1-T4 Swords</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Quest unlock</span>
      <span class="tooltip-value" style="color: var(--color-text);">15 completions</span>
    </div>
    <div style="font-size: 11px; color: var(--color-muted); margin-top: 8px;">Click to switch to Prime Realm.</div>
  `,jr=e=>{const n=M.getState(),t={...n.realms};for(const s of We){const r=n.realms[s],a={};for(const[i,o]of Object.entries(r.combat.activeExpeditions))a[i]=o.map(u=>({...u,startTime:u.startTime-e}));t[s]={...r,combat:{...r.combat,activeExpeditions:a}}}M.setState({lastFrameTimestamp:n.lastFrameTimestamp-e,realms:t,skippedTime:n.skippedTime+e})},In=()=>{const e=document.getElementById("tab-buttons");e.innerHTML="";const n=M.getState();if(n.realm2Unlocked){const c=n.activeRealm,b=O({realm1:{icon:"icons/r0.png",name:"Prime Realm"},realm2:{icon:"icons/portal.png",name:"Realm of War"},realm3:{icon:"icons/r3.png",name:"Realm of Magic"}}[c].icon),y="border-white",g=["realm1","realm2"];n.realm3Unlocked&&g.push("realm3");const w=document.createElement("div");w.className="realm-tooltip-wrapper mr-2 flex-shrink-0";const p=document.createElement("button");p.className=`px-2 py-1 border ${y} hover-bg-panel--50 cursor-pointer flex items-center`,p.innerHTML=`<img src="${b}" alt="Realm" style="width: 24px; height: 24px;" class="object-contain">`,p.onclick=()=>{const x=M.getState(),S=g.indexOf(x.activeRealm),$=g[(S+1)%g.length];x.setActiveRealm($)},w.appendChild(p);const h=document.createElement("div");h.className="realm-tooltip",c==="realm2"?h.innerHTML=ec():c==="realm3"?h.innerHTML=`<div class="tooltip-title text-magenta">Realm of Magic</div>
        <div class="tooltip-section">Click to switch realm.</div>`:h.innerHTML=`<div class="tooltip-title text-cyan">Prime Realm</div>
        <div class="tooltip-section">Click to switch realm.</div>`,w.appendChild(h),e.appendChild(w)}const t=Fa(),s=n.tabHighlightingOff,r=s?0:Xo(),a=s?0:Qo(),i=s?!1:Zo(),o={upgrades:r>0,prestige:a>0,tier:i},u={upgrades:r,prestige:a};for(const c of t){const f=document.createElement("button"),b=Ae===c,y=!b&&(o[c]??!1);f.className=`px-4 py-2 font-mono transition-colors ${b?"tab-active":"tab-inactive"}${y?" tab-glow":""}`;const g=u[c]??0,w=g>0&&!b?`${sn[c]} (${g})`:sn[c];if(f.textContent=w,(c==="upgrades"||c==="prestige"||c==="tier")&&(f.setAttribute("data-tab",c),y)){const p=document.createElement("div");p.className="tab-glow-bg",f.prepend(p)}f.onclick=()=>zo(c),e.appendChild(f)}const l=document.createElement("div");l.className="flex items-center gap-4 ml-auto",l.setAttribute("data-right-container","");const d=document.createElement("span");if(d.className="font-mono text-steel text-sm",d.setAttribute("data-playtime-clock",""),l.appendChild(d),n.timeWarpCharges>0){const c=document.createElement("button");c.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black cursor-pointer",c.setAttribute("data-time-warp-btn",""),c.textContent=`Time Warp (${n.timeWarpCharges})`,c.onclick=()=>{const f=M.getState();f.timeWarpCharges<=0||(jr(300*1e3),M.setState({timeWarpCharges:f.timeWarpCharges-1}))},l.appendChild(c)}if(Jo()){const c=document.createElement("button");c.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black",c.textContent="+5min",c.onclick=()=>jr(300*1e3),l.appendChild(c)}l.childNodes.length>0&&e.appendChild(l)},Gr=()=>{const e=document.getElementById("main-content");pd(),yd(),wf(),Td(),Kd(),Tf(),Af(),ef(),lf(),hf(),e.innerHTML="",Ae==="crafting"?gd(e):Ae==="upgrades"?wd(e):Ae==="prestige"?Sf(e):Ae==="artifacts"?Md(e):Ae==="combat"?cs(e):Ae==="village"?Mf(e):Ae==="ascension"?Ef(e):Ae==="tier"?tf(e):Ae==="altar"?uf(e):Ae==="realm"?vf(e):Ae==="settings"&&tm(e)};let gr=!1,hr=!1,vr=!1,br="realm1",xr=0,yr=0,Ni=!1,wr=0;const tc={realm1:{color:"var(--color-background)",image:'url("icons/r1%20bg.png")'},realm2:{color:"var(--color-realm2-bg)",image:'url("icons/r2%20bg.png")'},realm3:{color:"var(--color-background)",image:'url("icons/r3%20bg.png")',overlay:.82}},nc=(e,n)=>{if(e.style.backgroundColor=n.color,n.image){const t=n.overlay??.7;e.style.backgroundImage=`linear-gradient(rgba(0,0,0,${t}), rgba(0,0,0,${t})), ${n.image}`,e.style.backgroundSize="cover",e.style.backgroundPosition="center",e.style.backgroundRepeat="no-repeat"}else e.style.backgroundImage="none"},sc=e=>{const n=tc[e],t=M.getState().backgroundImageOff;nc(document.body,t?{color:n.color}:n);const s=document.querySelector("#root > div");s&&(s.style.backgroundColor="transparent",s.style.backgroundImage="none")},rm=()=>{const e=M.getState(),n=tc[e.activeRealm];nc(document.body,e.backgroundImageOff?{color:n.color}:n);const t=document.getElementById("root");t.innerHTML=`
    <div class="h-full flex flex-col p-2 gap-2 overflow-hidden">
      <nav>
        <div id="tab-buttons" class="flex items-center px-4" style="border: 1px solid var(--color-brown);"></div>
      </nav>
      <div id="update-banner" class="update-banner hidden"></div>
      <div class="flex flex-1 overflow-hidden gap-2 mobile-layout">
        <div id="inventory" class="pt-2 pb-2 pl-2 flex-shrink-0 flex flex-col overflow-hidden" style="border: 1px solid var(--color-brown); width: 280px;"></div>
        <main id="main-content" class="flex-1 p-6 overflow-auto" style="border: 1px solid var(--color-brown);"></main>
      </div>
    </div>
  `;const s=document.getElementById("inventory"),r=t.querySelector("nav"),a=document.createElement("button");a.className="mobile-inventory-toggle",a.textContent="Inventory",a.setAttribute("data-mobile-inv-toggle",""),a.onclick=()=>{s.classList.toggle("mobile-open"),a.textContent=s.classList.contains("mobile-open")?"Hide Inventory":"Inventory"},r.appendChild(a),e.uiScale!==1&&Ua(e.uiScale),gr=D(e.realms.realm1.recipeInventory,"nullstone").gte(1)||e.realms.realm1.combat.portalBuilt,hr=e.realm2Unlocked,vr=e.realm3Unlocked,br=e.activeRealm,wr=e.timeWarpCharges,In(),oi(),Gr();const i=()=>{const o=M.getState(),u=D(o.realms.realm1.recipeInventory,"nullstone").gte(1)||o.realms.realm1.combat.portalBuilt;u!==gr&&(gr=u,In()),(o.realm2Unlocked!==hr||o.realm3Unlocked!==vr)&&(hr=o.realm2Unlocked,vr=o.realm3Unlocked,In()),o.activeRealm!==br&&(br=o.activeRealm,sc(o.activeRealm),Fa().includes(Ae)||(Ae="crafting",Ao(Ko.crafting)),In(),Gr(),oi(),Eo());const l=o.tabHighlightingOff,d=(g,w,p)=>{if(w===p)return p;const h=document.querySelector(`[data-tab="${g}"]`);if(h&&Ae!==g){const x=h.querySelector(".tab-glow-bg");if(w&&!x){h.classList.add("tab-glow");const S=document.createElement("div");S.className="tab-glow-bg",h.prepend(S)}else!w&&x&&(h.classList.remove("tab-glow"),x.remove())}return w},c=l?0:Xo();if(c!==xr){const g=xr>0,w=c>0;xr=c;const p=document.querySelector('[data-tab="upgrades"]');if(p&&Ae!=="upgrades"){if(w!==g){const h=p.querySelector(".tab-glow-bg");if(w&&!h){p.classList.add("tab-glow");const x=document.createElement("div");x.className="tab-glow-bg",p.prepend(x)}else!w&&h&&(p.classList.remove("tab-glow"),h.remove())}if(p.textContent=w?`${sn.upgrades} (${c})`:sn.upgrades,w&&!p.querySelector(".tab-glow-bg")){const h=document.createElement("div");h.className="tab-glow-bg",p.prepend(h)}}}const f=l?0:Qo();if(f!==yr){const g=yr>0,w=f>0;yr=f;const p=document.querySelector('[data-tab="prestige"]');if(p&&Ae!=="prestige"){if(w!==g){const h=p.querySelector(".tab-glow-bg");if(w&&!h){p.classList.add("tab-glow");const x=document.createElement("div");x.className="tab-glow-bg",p.prepend(x)}else!w&&h&&(p.classList.remove("tab-glow"),h.remove())}if(p.textContent=w?`${sn.prestige} (${f})`:sn.prestige,w&&!p.querySelector(".tab-glow-bg")){const h=document.createElement("div");h.className="tab-glow-bg",p.prepend(h)}}}Ni=d("tier",l?!1:Zo(),Ni);const b=o.timeWarpCharges;if(b!==wr)if(wr=b,b<=0){const g=document.querySelector("[data-time-warp-btn]");g&&g.remove()}else{let g=document.querySelector("[data-time-warp-btn]");if(g)g.textContent=`Time Warp (${b})`;else{const w=document.querySelector("[data-right-container]");w&&(g=document.createElement("button"),g.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black cursor-pointer",g.setAttribute("data-time-warp-btn",""),g.textContent=`Time Warp (${b})`,g.onclick=()=>{const p=M.getState();p.timeWarpCharges<=0||(jr(300*1e3),M.setState({timeWarpCharges:p.timeWarpCharges-1}))},w.prepend(g))}}const y=document.querySelector("[data-playtime-clock]");if(y){const g=o.totalPlaytime;let w=Ai(g);Jo()&&o.skippedTime>0&&(w+=` (${Ai(o.skippedTime)} skipped)`),y.textContent=w}};Gn(xe.TabBar,i),document.addEventListener("keydown",o=>{const u=o.target;if(u.tagName==="INPUT"||u.tagName==="TEXTAREA")return;const l=Uf(o.key);if(l)switch(l){case"tabLeft":Ei(-1);break;case"tabRight":Ei(1);break;case"swapRealm":{const d=M.getState();if(d.realm2Unlocked){const c=["realm1","realm2"];d.realm3Unlocked&&c.push("realm3");const f=c.indexOf(d.activeRealm),b=c[(f+1)%c.length];d.setActiveRealm(b)}break}}}),document.addEventListener("mouseover",o=>{var d,c;const u=(c=(d=o.target).closest)==null?void 0:c.call(d,".hover-tooltip-wrapper");if(!u)return;const l=u.getBoundingClientRect();u.classList.toggle("tooltip-above",l.top>window.innerHeight/2)})},rc="evercraft_analytics_tiers",am=()=>{try{const e=localStorage.getItem(rc);return e?new Set(JSON.parse(e)):new Set}catch{return new Set}},im=e=>{localStorage.setItem(rc,JSON.stringify([...e]))},om=e=>{const n=window.gtag;typeof n=="function"&&n("event","tier_reached",{tier:e})},Vr=()=>{const e=M.getState();let n=0;for(const t of We){const s=e.realms[t];if(s)for(const r of Ze)Xe(`gem_${r}`,s.recipeCrafting)&&r>n&&(n=r)}return n},qi=()=>{const e=Vr(),n=am();let t=!1;for(let s=0;s<=e;s++)n.has(s)||(om(s),n.add(s),t=!0);t&&im(n)},cm=()=>{qi();let e=Vr();M.subscribe(()=>{const n=Vr();n!==e&&(e=n,qi())})},lm=()=>{const e=M.getState().uiScale;e!==1&&Ua(e),Cu()&&Gs(Eu()),cm();let n=0;const t=1e3/60,s=r=>{requestAnimationFrame(s),!(r-n<t)&&(n=r,Du(),Eo(),Vu())};requestAnimationFrame(s)},um=6e4;let dm=null,_i=null;const fm=()=>{if(_i!==null)return;const e=async()=>{try{const n=await fetch(O("version.json")+"?t="+Date.now());if(!n.ok)return;const t=await n.json();t.version&&parseFloat(t.version)>parseFloat(Ia)&&(dm=t.version,mm(t.version))}catch{}};e(),_i=window.setInterval(e,um)},mm=e=>{const n=document.getElementById("update-banner");if(!n)return;const t=O("changelog.txt");n.innerHTML=`V${e} is out, refresh to update (<a href="${t}" target="_blank" class="text-cyan" style="text-decoration: underline;">changelog</a>)`,n.classList.remove("hidden")};M.getState().loadFromStorage();rm();lm();fm();
