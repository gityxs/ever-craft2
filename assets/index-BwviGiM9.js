(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function e(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=e(a);fetch(a.href,s)}})();const ki=t=>{let n;const e=new Set,r=(l,m)=>{const u=typeof l=="function"?l(n):l;if(!Object.is(u,n)){const f=n;n=m??(typeof u!="object"||u===null)?u:Object.assign({},n,u),e.forEach(b=>b(n,f))}},a=()=>n,o={setState:r,getState:a,getInitialState:()=>c,subscribe:l=>(e.add(l),()=>e.delete(l))},c=n=t(r,a,o);return o},Ti=(t=>ki),K=t=>t.realms[t.activeRealm];function $r(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function Sa(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function Cr(t,n,e){return n&&Sa(t.prototype,n),e&&Sa(t,e),Object.defineProperty(t,"prototype",{writable:!1}),t}var Mi=(function(){function t(n){$r(this,t),this.map=new Map,this.first=void 0,this.last=void 0,this.maxSize=n}return Cr(t,[{key:"size",get:function(){return this.map.size}},{key:"get",value:function(e){var r=this.map.get(e);if(r!==void 0)return r!==this.first&&(r===this.last?(this.last=r.prev,this.last.next=void 0):(r.prev.next=r.next,r.next.prev=r.prev),r.next=this.first,this.first.prev=r,this.first=r),r.value}},{key:"set",value:function(e,r){if(!(this.maxSize<1)){if(this.map.has(e))throw new Error("Cannot update existing keys in the cache");var a=new Ii(e,r);for(this.first===void 0?(this.first=a,this.last=a):(a.next=this.first,this.first.prev=a,this.first=a),this.map.set(e,a);this.map.size>this.maxSize;){var s=this.last;this.map.delete(s.key),this.last=s.prev,this.last.next=void 0}}}}]),t})(),Ii=Cr(function t(n,e){$r(this,t),this.next=void 0,this.prev=void 0,this.key=n,this.value=e}),Pn=17,wt=9e15,Ri=Math.log10(9e15),Xt=1/9e15,$i=308,Ci=-324,ka=5,Ei=1023,Ni=(function(){for(var t=[],n=Ci+1;n<=$i;n++)t.push(+("1e"+n));var e=323;return function(r){return t[r+e]}})(),Qt=[2,Math.E,3,4,5,6,7,8,9,10],Ai=[[1,1.0891180521811203,1.1789767925673957,1.2701455431742086,1.3632090180450092,1.4587818160364217,1.5575237916251419,1.6601571006859253,1.767485818836978,1.8804192098842727,2],[1,1.1121114330934079,1.231038924931609,1.3583836963111375,1.4960519303993531,1.6463542337511945,1.8121385357018724,1.996971324618307,2.2053895545527546,2.4432574483385254,Math.E],[1,1.1187738849693603,1.2464963939368214,1.38527004705667,1.5376664685821402,1.7068895236551784,1.897001227148399,2.1132403089001035,2.362480153784171,2.6539010333870774,3],[1,1.1367350847096405,1.2889510672956703,1.4606478703324786,1.6570295196661111,1.8850062585672889,2.1539465047453485,2.476829779693097,2.872061932789197,3.3664204535587183,4],[1,1.1494592900767588,1.319708228183931,1.5166291280087583,1.748171114438024,2.0253263297298045,2.3636668498288547,2.7858359149579424,3.3257226212448145,4.035730287722532,5],[1,1.159225940787673,1.343712473580932,1.5611293155111927,1.8221199554561318,2.14183924486326,2.542468319282638,3.0574682501653316,3.7390572020926873,4.6719550537360774,6],[1,1.1670905356972596,1.3632807444991446,1.5979222279405536,1.8842640123816674,2.2416069644878687,2.69893426559423,3.3012632110403577,4.121250340630164,5.281493033448316,7],[1,1.1736630594087796,1.379783782386201,1.6292821855668218,1.9378971836180754,2.3289975651071977,2.8384347394720835,3.5232708454565906,4.478242031114584,5.868592169644505,8],[1,1.1793017514670474,1.394054150657457,1.65664127441059,1.985170999970283,2.4069682290577457,2.9647310119960752,3.7278665320924946,4.814462547283592,6.436522247411611,9],[1,1.1840100246247336,1.4061375836156955,1.6802272208863964,2.026757028388619,2.4770056063449646,3.080525271755482,3.9191964192627284,5.135152840833187,6.989961179534715,10]],qi=[[-1,-.9194161097107025,-.8335625019330468,-.7425599821143978,-.6466611521029437,-.5462617907227869,-.4419033816638769,-.3342645487554494,-.224140440909962,-.11241087890006762,0],[-1,-.90603157029014,-.80786507256596,-.7064666939634,-.60294836853664,-.49849837513117,-.39430303318768,-.29147201034755,-.19097820800866,-.09361896280296,0],[-1,-.9021579584316141,-.8005762598234203,-.6964780623319391,-.5911906810998454,-.486050182576545,-.3823089430815083,-.28106046722897615,-.1831906535795894,-.08935809204418144,0],[-1,-.8917227442365535,-.781258746326964,-.6705130326902455,-.5612813129406509,-.4551067709033134,-.35319256652135966,-.2563741554088552,-.1651412821106526,-.0796919581982668,0],[-1,-.8843387974366064,-.7678744063886243,-.6529563724510552,-.5415870994657841,-.4352842206588936,-.33504449124791424,-.24138853420685147,-.15445285440944467,-.07409659641336663,0],[-1,-.8786709358426346,-.7577735191184886,-.6399546189952064,-.527284921869926,-.4211627631006314,-.3223479611761232,-.23107655627789858,-.1472057700818259,-.07035171210706326,0],[-1,-.8740862815291583,-.7497032990976209,-.6297119746181752,-.5161838335958787,-.41036238255751956,-.31277212146489963,-.2233976621705518,-.1418697367979619,-.06762117662323441,0],[-1,-.8702632331800649,-.7430366914122081,-.6213373075161548,-.5072025698095242,-.40171437727184167,-.30517930701410456,-.21736343968190863,-.137710238299109,-.06550774483471955,0],[-1,-.8670016295947213,-.7373984232432306,-.6143173985094293,-.49973884395492807,-.394584953527678,-.2989649949848695,-.21245647317021688,-.13434688362382652,-.0638072667348083,0],[-1,-.8641642839543857,-.732534623168535,-.6083127477059322,-.4934049257184696,-.3885773075899922,-.29376029055315767,-.2083678561173622,-.13155653399373268,-.062401588652553186,0]],w=function(n){return d.fromValue_noAlloc(n)},H=function(n,e,r){return d.fromComponents(n,e,r)},z=function(n,e,r){return d.fromComponents_noNormalize(n,e,r)},jt=function(n,e){var r=e+1,a=Math.ceil(Math.log10(Math.abs(n))),s=Math.round(n*Math.pow(10,r-a))*Math.pow(10,a-r);return parseFloat(s.toFixed(Math.max(r-a,0)))},On=function(n){return Math.sign(n)*Math.log10(Math.abs(n))},_i=function(n){if(!isFinite(n))return n;if(n<-50)return n===Math.trunc(n)?Number.NEGATIVE_INFINITY:0;for(var e=1;n<10;)e=e*n,++n;n-=1;var r=.9189385332046727;r=r+(n+.5)*Math.log(n),r=r-n;var a=n*n,s=n;return r=r+1/(12*s),s=s*a,r=r-1/(360*s),s=s*a,r=r+1/(1260*s),s=s*a,r=r-1/(1680*s),s=s*a,r=r+1/(1188*s),s=s*a,r=r-691/(360360*s),s=s*a,r=r+7/(1092*s),s=s*a,r=r-3617/(122400*s),Math.exp(r)/e},Li=.36787944117144233,cs=.5671432904097838,Bn=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e-10,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,a,s;if(!Number.isFinite(n))return n;if(r){if(n===0)return n;if(n===1)return cs;n<10?a=0:a=Math.log(n)-Math.log(Math.log(n))}else{if(n===0)return-1/0;n<=-.1?a=-2:a=Math.log(-n)-Math.log(-Math.log(-n))}for(var i=0;i<100;++i){if(s=(n*Math.exp(-a)+a*a)/(a+1),Math.abs(s-a)<e*Math.abs(s))return s;a=s}throw Error("Iteration failed to converge: ".concat(n.toString()))};function Ta(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e-10,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r,a,s,i;if(!Number.isFinite(t.mag))return new d(t);if(e){if(t.eq(d.dZero))return z(0,0,0);if(t.eq(d.dOne))return d.fromNumber(cs);r=d.ln(t)}else{if(t.eq(d.dZero))return new d(d.dNegInf);r=d.ln(t.neg())}for(var o=0;o<100;++o){if(a=r.neg().exp(),s=r.sub(t.mul(a)),i=r.sub(s.div(r.add(1).sub(r.add(2).mul(s).div(d.mul(2,r).add(2))))),d.abs(i.sub(r)).lt(d.abs(i).mul(n)))return i;r=i}throw Error("Iteration failed to converge: ".concat(t.toString()))}var d=(function(){function t(n){$r(this,t),this.sign=0,this.mag=0,this.layer=0,n instanceof t?this.fromDecimal(n):typeof n=="number"?this.fromNumber(n):typeof n=="string"&&this.fromString(n)}return Cr(t,[{key:"m",get:function(){if(this.sign===0)return 0;if(this.layer===0){var e=Math.floor(Math.log10(this.mag)),r;return this.mag===5e-324?r=5:r=this.mag/Ni(e),this.sign*r}else if(this.layer===1){var a=this.mag-Math.floor(this.mag);return this.sign*Math.pow(10,a)}else return this.sign},set:function(e){this.layer<=2?this.fromMantissaExponent(e,this.e):(this.sign=Math.sign(e),this.sign===0&&(this.layer=0,this.exponent=0))}},{key:"e",get:function(){return this.sign===0?0:this.layer===0?Math.floor(Math.log10(this.mag)):this.layer===1?Math.floor(this.mag):this.layer===2?Math.floor(Math.sign(this.mag)*Math.pow(10,Math.abs(this.mag))):this.mag*Number.POSITIVE_INFINITY},set:function(e){this.fromMantissaExponent(this.m,e)}},{key:"s",get:function(){return this.sign},set:function(e){e===0?(this.sign=0,this.layer=0,this.mag=0):this.sign=e}},{key:"mantissa",get:function(){return this.m},set:function(e){this.m=e}},{key:"exponent",get:function(){return this.e},set:function(e){this.e=e}},{key:"normalize",value:function(){if(this.sign===0||this.mag===0&&this.layer===0||this.mag===Number.NEGATIVE_INFINITY&&this.layer>0&&Number.isFinite(this.layer))return this.sign=0,this.mag=0,this.layer=0,this;if(this.layer===0&&this.mag<0&&(this.mag=-this.mag,this.sign=-this.sign),this.mag===Number.POSITIVE_INFINITY||this.layer===Number.POSITIVE_INFINITY||this.mag===Number.NEGATIVE_INFINITY||this.layer===Number.NEGATIVE_INFINITY)return this.mag=Number.POSITIVE_INFINITY,this.layer=Number.POSITIVE_INFINITY,this;if(this.layer===0&&this.mag<Xt)return this.layer+=1,this.mag=Math.log10(this.mag),this;var e=Math.abs(this.mag),r=Math.sign(this.mag);if(e>=wt)return this.layer+=1,this.mag=r*Math.log10(e),this;for(;e<Ri&&this.layer>0;)this.layer-=1,this.layer===0?this.mag=Math.pow(10,this.mag):(this.mag=r*Math.pow(10,e),e=Math.abs(this.mag),r=Math.sign(this.mag));return this.layer===0&&(this.mag<0?(this.mag=-this.mag,this.sign=-this.sign):this.mag===0&&(this.sign=0)),(Number.isNaN(this.sign)||Number.isNaN(this.layer)||Number.isNaN(this.mag))&&(this.sign=Number.NaN,this.layer=Number.NaN,this.mag=Number.NaN),this}},{key:"fromComponents",value:function(e,r,a){return this.sign=e,this.layer=r,this.mag=a,this.normalize(),this}},{key:"fromComponents_noNormalize",value:function(e,r,a){return this.sign=e,this.layer=r,this.mag=a,this}},{key:"fromMantissaExponent",value:function(e,r){return this.layer=1,this.sign=Math.sign(e),e=Math.abs(e),this.mag=r+Math.log10(e),this.normalize(),this}},{key:"fromMantissaExponent_noNormalize",value:function(e,r){return this.fromMantissaExponent(e,r),this}},{key:"fromDecimal",value:function(e){return this.sign=e.sign,this.layer=e.layer,this.mag=e.mag,this}},{key:"fromNumber",value:function(e){return this.mag=Math.abs(e),this.sign=Math.sign(e),this.layer=0,this.normalize(),this}},{key:"fromString",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=e,s=t.fromStringCache.get(a);if(s!==void 0)return this.fromDecimal(s);if(e=e.replace(",",""),e.toLowerCase()==="nan")return this.fromDecimal(t.dNaN);if(e.toLowerCase()==="infinity")return this.fromDecimal(t.dInf);if(e.toLowerCase()==="-infinity")return this.fromDecimal(t.dNegInf);var i=e.split("^^^");if(i.length===2){var o=parseFloat(i[0]),c=parseFloat(i[1]),l=i[1].split(";"),m=1;if(l.length===2&&(m=parseFloat(l[1]),isFinite(m)||(m=1)),isFinite(o)&&isFinite(c)){var u=t.pentate(o,c,m,r);return this.sign=u.sign,this.layer=u.layer,this.mag=u.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}}var f=e.split("^^");if(f.length===2){var b=parseFloat(f[0]),x=parseFloat(f[1]),p=f[1].split(";"),g=1;if(p.length===2&&(g=parseFloat(p[1]),isFinite(g)||(g=1)),isFinite(b)&&isFinite(x)){var h=t.tetrate(b,x,g,r);return this.sign=h.sign,this.layer=h.layer,this.mag=h.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}}var v=e.split("^");if(v.length===2){var y=parseFloat(v[0]),T=parseFloat(v[1]);if(isFinite(y)&&isFinite(T)){var M=t.pow(y,T);return this.sign=M.sign,this.layer=M.layer,this.mag=M.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}}e=e.trim().toLowerCase();var E,I,R=e.split("pt");if(R.length===2){E=10;var _=!1;R[0][0]=="-"&&(_=!0,R[0]=R[0].slice(1)),I=parseFloat(R[0]),R[1]=R[1].replace("(",""),R[1]=R[1].replace(")","");var V=parseFloat(R[1]);if(isFinite(V)||(V=1),isFinite(E)&&isFinite(I)){var B=t.tetrate(E,I,V,r);return this.sign=B.sign,this.layer=B.layer,this.mag=B.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),_&&(this.sign*=-1),this}}if(R=e.split("p"),R.length===2){E=10;var $=!1;R[0][0]=="-"&&($=!0,R[0]=R[0].slice(1)),I=parseFloat(R[0]),R[1]=R[1].replace("(",""),R[1]=R[1].replace(")","");var C=parseFloat(R[1]);if(isFinite(C)||(C=1),isFinite(E)&&isFinite(I)){var Y=t.tetrate(E,I,C,r);return this.sign=Y.sign,this.layer=Y.layer,this.mag=Y.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),$&&(this.sign*=-1),this}}if(R=e.split("f"),R.length===2){E=10;var F=!1;R[0][0]=="-"&&(F=!0,R[0]=R[0].slice(1)),R[0]=R[0].replace("(",""),R[0]=R[0].replace(")","");var q=parseFloat(R[0]);if(R[1]=R[1].replace("(",""),R[1]=R[1].replace(")",""),I=parseFloat(R[1]),isFinite(q)||(q=1),isFinite(E)&&isFinite(I)){var tt=t.tetrate(E,I,q,r);return this.sign=tt.sign,this.layer=tt.layer,this.mag=tt.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),F&&(this.sign*=-1),this}}var j=e.split("e"),ot=j.length-1;if(ot===0){var U=parseFloat(e);if(isFinite(U))return this.fromNumber(U),t.fromStringCache.size>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}else if(ot===1){var k=parseFloat(e);if(isFinite(k)&&Math.abs(k)>1e-307)return this.fromNumber(k),t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}var W=e.split("e^");if(W.length===2){this.sign=1,W[0].charAt(0)=="-"&&(this.sign=-1);for(var P="",D=0;D<W[1].length;++D){var X=W[1].charCodeAt(D);if(X>=43&&X<=57||X===101)P+=W[1].charAt(D);else{if(this.layer=parseFloat(P),this.mag=parseFloat(W[1].substr(D+1)),this.layer<0||this.layer%1!=0){var N=t.tetrate(10,this.layer,this.mag,r);this.sign=N.sign,this.layer=N.layer,this.mag=N.mag}return this.normalize(),t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}}}if(ot<1)return this.sign=0,this.layer=0,this.mag=0,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this;var A=parseFloat(j[0]);if(A===0)return this.sign=0,this.layer=0,this.mag=0,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this;var O=parseFloat(j[j.length-1]);if(ot>=2){var J=parseFloat(j[j.length-2]);isFinite(J)&&(O*=Math.sign(J),O+=On(J))}if(!isFinite(A))this.sign=j[0]==="-"?-1:1,this.layer=ot,this.mag=O;else if(ot===1)this.sign=Math.sign(A),this.layer=1,this.mag=O+Math.log10(Math.abs(A));else if(this.sign=Math.sign(A),this.layer=ot,ot===2){var lt=t.mul(H(1,2,O),w(A));return this.sign=lt.sign,this.layer=lt.layer,this.mag=lt.mag,t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}else this.mag=O;return this.normalize(),t.fromStringCache.maxSize>=1&&t.fromStringCache.set(a,t.fromDecimal(this)),this}},{key:"fromValue",value:function(e){return e instanceof t?this.fromDecimal(e):typeof e=="number"?this.fromNumber(e):typeof e=="string"?this.fromString(e):(this.sign=0,this.layer=0,this.mag=0,this)}},{key:"toNumber",value:function(){return this.mag===Number.POSITIVE_INFINITY&&this.layer===Number.POSITIVE_INFINITY&&this.sign===1?Number.POSITIVE_INFINITY:this.mag===Number.POSITIVE_INFINITY&&this.layer===Number.POSITIVE_INFINITY&&this.sign===-1?Number.NEGATIVE_INFINITY:Number.isFinite(this.layer)?this.layer===0?this.sign*this.mag:this.layer===1?this.sign*Math.pow(10,this.mag):this.mag>0?this.sign>0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:0:Number.NaN}},{key:"mantissaWithDecimalPlaces",value:function(e){return isNaN(this.m)?Number.NaN:this.m===0?0:jt(this.m,e)}},{key:"magnitudeWithDecimalPlaces",value:function(e){return isNaN(this.mag)?Number.NaN:this.mag===0?0:jt(this.mag,e)}},{key:"toString",value:function(){return isNaN(this.layer)||isNaN(this.sign)||isNaN(this.mag)?"NaN":this.mag===Number.POSITIVE_INFINITY||this.layer===Number.POSITIVE_INFINITY?this.sign===1?"Infinity":"-Infinity":this.layer===0?this.mag<1e21&&this.mag>1e-7||this.mag===0?(this.sign*this.mag).toString():this.m+"e"+this.e:this.layer===1?this.m+"e"+this.e:this.layer<=ka?(this.sign===-1?"-":"")+"e".repeat(this.layer)+this.mag:(this.sign===-1?"-":"")+"(e^"+this.layer+")"+this.mag}},{key:"toExponential",value:function(e){return this.layer===0?(this.sign*this.mag).toExponential(e):this.toStringWithDecimalPlaces(e)}},{key:"toFixed",value:function(e){return this.layer===0?(this.sign*this.mag).toFixed(e):this.toStringWithDecimalPlaces(e)}},{key:"toPrecision",value:function(e){return this.e<=-7?this.toExponential(e-1):e>this.e?this.toFixed(e-this.exponent-1):this.toExponential(e-1)}},{key:"valueOf",value:function(){return this.toString()}},{key:"toJSON",value:function(){return this.toString()}},{key:"toStringWithDecimalPlaces",value:function(e){return this.layer===0?this.mag<1e21&&this.mag>1e-7||this.mag===0?(this.sign*this.mag).toFixed(e):jt(this.m,e)+"e"+jt(this.e,e):this.layer===1?jt(this.m,e)+"e"+jt(this.e,e):this.layer<=ka?(this.sign===-1?"-":"")+"e".repeat(this.layer)+jt(this.mag,e):(this.sign===-1?"-":"")+"(e^"+this.layer+")"+jt(this.mag,e)}},{key:"abs",value:function(){return z(this.sign===0?0:1,this.layer,this.mag)}},{key:"neg",value:function(){return z(-this.sign,this.layer,this.mag)}},{key:"negate",value:function(){return this.neg()}},{key:"negated",value:function(){return this.neg()}},{key:"sgn",value:function(){return this.sign}},{key:"round",value:function(){return this.mag<0?z(0,0,0):this.layer===0?H(this.sign,0,Math.round(this.mag)):new t(this)}},{key:"floor",value:function(){return this.mag<0?this.sign===-1?z(-1,0,1):z(0,0,0):this.sign===-1?this.neg().ceil().neg():this.layer===0?H(this.sign,0,Math.floor(this.mag)):new t(this)}},{key:"ceil",value:function(){return this.mag<0?this.sign===1?z(1,0,1):z(0,0,0):this.sign===-1?this.neg().floor().neg():this.layer===0?H(this.sign,0,Math.ceil(this.mag)):new t(this)}},{key:"trunc",value:function(){return this.mag<0?z(0,0,0):this.layer===0?H(this.sign,0,Math.trunc(this.mag)):new t(this)}},{key:"add",value:function(e){var r=w(e);if(this.eq(t.dInf)&&r.eq(t.dNegInf)||this.eq(t.dNegInf)&&r.eq(t.dInf))return new t(t.dNaN);if(!Number.isFinite(this.layer))return new t(this);if(!Number.isFinite(r.layer))return new t(r);if(this.sign===0)return new t(r);if(r.sign===0)return new t(this);if(this.sign===-r.sign&&this.layer===r.layer&&this.mag===r.mag)return z(0,0,0);var a,s;if(this.layer>=2||r.layer>=2)return this.maxabs(r);if(t.cmpabs(this,r)>0?(a=new t(this),s=new t(r)):(a=new t(r),s=new t(this)),a.layer===0&&s.layer===0)return t.fromNumber(a.sign*a.mag+s.sign*s.mag);var i=a.layer*Math.sign(a.mag),o=s.layer*Math.sign(s.mag);if(i-o>=2)return a;if(i===0&&o===-1){if(Math.abs(s.mag-Math.log10(a.mag))>Pn)return a;var c=Math.pow(10,Math.log10(a.mag)-s.mag),l=s.sign+a.sign*c;return H(Math.sign(l),1,s.mag+Math.log10(Math.abs(l)))}if(i===1&&o===0){if(Math.abs(a.mag-Math.log10(s.mag))>Pn)return a;var m=Math.pow(10,a.mag-Math.log10(s.mag)),u=s.sign+a.sign*m;return H(Math.sign(u),1,Math.log10(s.mag)+Math.log10(Math.abs(u)))}if(Math.abs(a.mag-s.mag)>Pn)return a;var f=Math.pow(10,a.mag-s.mag),b=s.sign+a.sign*f;return H(Math.sign(b),1,s.mag+Math.log10(Math.abs(b)))}},{key:"plus",value:function(e){return this.add(e)}},{key:"sub",value:function(e){return this.add(w(e).neg())}},{key:"subtract",value:function(e){return this.sub(e)}},{key:"minus",value:function(e){return this.sub(e)}},{key:"mul",value:function(e){var r=w(e);if(this.eq(t.dInf)&&r.eq(t.dNegInf)||this.eq(t.dNegInf)&&r.eq(t.dInf))return new t(t.dNegInf);if(this.mag==Number.POSITIVE_INFINITY&&r.eq(t.dZero)||this.eq(t.dZero)&&this.mag==Number.POSITIVE_INFINITY)return new t(t.dNaN);if(this.eq(t.dNegInf)&&r.eq(t.dNegInf))return new t(t.dInf);if(!Number.isFinite(this.layer))return new t(this);if(!Number.isFinite(r.layer))return new t(r);if(this.sign===0||r.sign===0)return z(0,0,0);if(this.layer===r.layer&&this.mag===-r.mag)return z(this.sign*r.sign,0,1);var a,s;if(this.layer>r.layer||this.layer==r.layer&&Math.abs(this.mag)>Math.abs(r.mag)?(a=new t(this),s=new t(r)):(a=new t(r),s=new t(this)),a.layer===0&&s.layer===0)return t.fromNumber(a.sign*s.sign*a.mag*s.mag);if(a.layer>=3||a.layer-s.layer>=2)return H(a.sign*s.sign,a.layer,a.mag);if(a.layer===1&&s.layer===0)return H(a.sign*s.sign,1,a.mag+Math.log10(s.mag));if(a.layer===1&&s.layer===1)return H(a.sign*s.sign,1,a.mag+s.mag);if(a.layer===2&&s.layer===1){var i=H(Math.sign(a.mag),a.layer-1,Math.abs(a.mag)).add(H(Math.sign(s.mag),s.layer-1,Math.abs(s.mag)));return H(a.sign*s.sign,i.layer+1,i.sign*i.mag)}if(a.layer===2&&s.layer===2){var o=H(Math.sign(a.mag),a.layer-1,Math.abs(a.mag)).add(H(Math.sign(s.mag),s.layer-1,Math.abs(s.mag)));return H(a.sign*s.sign,o.layer+1,o.sign*o.mag)}throw Error("Bad arguments to mul: "+this+", "+e)}},{key:"multiply",value:function(e){return this.mul(e)}},{key:"times",value:function(e){return this.mul(e)}},{key:"div",value:function(e){var r=w(e);return this.mul(r.recip())}},{key:"divide",value:function(e){return this.div(e)}},{key:"divideBy",value:function(e){return this.div(e)}},{key:"dividedBy",value:function(e){return this.div(e)}},{key:"recip",value:function(){return this.mag===0?new t(t.dNaN):this.mag===Number.POSITIVE_INFINITY?z(0,0,0):this.layer===0?H(this.sign,0,1/this.mag):H(this.sign,this.layer,-this.mag)}},{key:"reciprocal",value:function(){return this.recip()}},{key:"reciprocate",value:function(){return this.recip()}},{key:"mod",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=w(e),s=a.abs();if(this.eq(t.dZero)||s.eq(t.dZero))return z(0,0,0);if(r){var i=this.abs().mod(s);return this.sign==-1!=(a.sign==-1)&&(i=a.abs().sub(i)),i.mul(a.sign)}var o=this.toNumber(),c=s.toNumber();return isFinite(o)&&isFinite(c)&&o!=0&&c!=0?new t(o%c):this.sub(s).eq(this)?z(0,0,0):s.sub(this).eq(s)?new t(this):this.sign==-1?this.abs().mod(s).neg():this.sub(this.div(s).floor().mul(s))}},{key:"modulo",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.mod(e,r)}},{key:"modular",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.mod(e,r)}},{key:"cmp",value:function(e){var r=w(e);return this.sign>r.sign?1:this.sign<r.sign?-1:this.sign*this.cmpabs(e)}},{key:"cmpabs",value:function(e){var r=w(e),a=this.mag>0?this.layer:-this.layer,s=r.mag>0?r.layer:-r.layer;return a>s?1:a<s?-1:this.mag>r.mag?1:this.mag<r.mag?-1:0}},{key:"compare",value:function(e){return this.cmp(e)}},{key:"isNan",value:function(){return isNaN(this.sign)||isNaN(this.layer)||isNaN(this.mag)}},{key:"isFinite",value:(function(n){function e(){return n.apply(this,arguments)}return e.toString=function(){return n.toString()},e})(function(){return isFinite(this.sign)&&isFinite(this.layer)&&isFinite(this.mag)})},{key:"eq",value:function(e){var r=w(e);return this.sign===r.sign&&this.layer===r.layer&&this.mag===r.mag}},{key:"equals",value:function(e){return this.eq(e)}},{key:"neq",value:function(e){return!this.eq(e)}},{key:"notEquals",value:function(e){return this.neq(e)}},{key:"lt",value:function(e){return this.cmp(e)===-1}},{key:"lte",value:function(e){return!this.gt(e)}},{key:"gt",value:function(e){return this.cmp(e)===1}},{key:"gte",value:function(e){return!this.lt(e)}},{key:"max",value:function(e){var r=w(e);return this.lt(r)?new t(r):new t(this)}},{key:"min",value:function(e){var r=w(e);return this.gt(r)?new t(r):new t(this)}},{key:"maxabs",value:function(e){var r=w(e);return this.cmpabs(r)<0?new t(r):new t(this)}},{key:"minabs",value:function(e){var r=w(e);return this.cmpabs(r)>0?new t(r):new t(this)}},{key:"clamp",value:function(e,r){return this.max(e).min(r)}},{key:"clampMin",value:function(e){return this.max(e)}},{key:"clampMax",value:function(e){return this.min(e)}},{key:"cmp_tolerance",value:function(e,r){var a=w(e);return this.eq_tolerance(a,r)?0:this.cmp(a)}},{key:"compare_tolerance",value:function(e,r){return this.cmp_tolerance(e,r)}},{key:"eq_tolerance",value:function(e,r){var a=w(e);if(r==null&&(r=1e-7),this.sign!==a.sign||Math.abs(this.layer-a.layer)>1)return!1;var s=this.mag,i=a.mag;return this.layer>a.layer&&(i=On(i)),this.layer<a.layer&&(s=On(s)),Math.abs(s-i)<=r*Math.max(Math.abs(s),Math.abs(i))}},{key:"equals_tolerance",value:function(e,r){return this.eq_tolerance(e,r)}},{key:"neq_tolerance",value:function(e,r){return!this.eq_tolerance(e,r)}},{key:"notEquals_tolerance",value:function(e,r){return this.neq_tolerance(e,r)}},{key:"lt_tolerance",value:function(e,r){var a=w(e);return!this.eq_tolerance(a,r)&&this.lt(a)}},{key:"lte_tolerance",value:function(e,r){var a=w(e);return this.eq_tolerance(a,r)||this.lt(a)}},{key:"gt_tolerance",value:function(e,r){var a=w(e);return!this.eq_tolerance(a,r)&&this.gt(a)}},{key:"gte_tolerance",value:function(e,r){var a=w(e);return this.eq_tolerance(a,r)||this.gt(a)}},{key:"pLog10",value:function(){return this.lt(t.dZero)?z(0,0,0):this.log10()}},{key:"absLog10",value:function(){return this.sign===0?new t(t.dNaN):this.layer>0?H(Math.sign(this.mag),this.layer-1,Math.abs(this.mag)):H(1,0,Math.log10(this.mag))}},{key:"log10",value:function(){return this.sign<=0?new t(t.dNaN):this.layer>0?H(Math.sign(this.mag),this.layer-1,Math.abs(this.mag)):H(this.sign,0,Math.log10(this.mag))}},{key:"log",value:function(e){return e=w(e),this.sign<=0?new t(t.dNaN):e.sign<=0?new t(t.dNaN):e.sign===1&&e.layer===0&&e.mag===1?new t(t.dNaN):this.layer===0&&e.layer===0?H(this.sign,0,Math.log(this.mag)/Math.log(e.mag)):t.div(this.log10(),e.log10())}},{key:"log2",value:function(){return this.sign<=0?new t(t.dNaN):this.layer===0?H(this.sign,0,Math.log2(this.mag)):this.layer===1?H(Math.sign(this.mag),0,Math.abs(this.mag)*3.321928094887362):this.layer===2?H(Math.sign(this.mag),1,Math.abs(this.mag)+.5213902276543247):H(Math.sign(this.mag),this.layer-1,Math.abs(this.mag))}},{key:"ln",value:function(){return this.sign<=0?new t(t.dNaN):this.layer===0?H(this.sign,0,Math.log(this.mag)):this.layer===1?H(Math.sign(this.mag),0,Math.abs(this.mag)*2.302585092994046):this.layer===2?H(Math.sign(this.mag),1,Math.abs(this.mag)+.36221568869946325):H(Math.sign(this.mag),this.layer-1,Math.abs(this.mag))}},{key:"logarithm",value:function(e){return this.log(e)}},{key:"pow",value:function(e){var r=w(e),a=new t(this),s=new t(r);if(a.sign===0)return s.eq(0)?z(1,0,1):a;if(a.sign===1&&a.layer===0&&a.mag===1)return a;if(s.sign===0)return z(1,0,1);if(s.sign===1&&s.layer===0&&s.mag===1)return a;var i=a.absLog10().mul(s).pow10();return this.sign===-1?Math.abs(s.toNumber()%2)%2===1?i.neg():Math.abs(s.toNumber()%2)%2===0?i:new t(t.dNaN):i}},{key:"pow10",value:function(){if(this.eq(t.dInf))return new t(t.dInf);if(this.eq(t.dNegInf))return z(0,0,0);if(!Number.isFinite(this.layer)||!Number.isFinite(this.mag))return new t(t.dNaN);var e=new t(this);if(e.layer===0){var r=Math.pow(10,e.sign*e.mag);if(Number.isFinite(r)&&Math.abs(r)>=.1)return H(1,0,r);if(e.sign===0)return z(1,0,1);e=z(e.sign,e.layer+1,Math.log10(e.mag))}return e.sign>0&&e.mag>=0?H(e.sign,e.layer+1,e.mag):e.sign<0&&e.mag>=0?H(-e.sign,e.layer+1,-e.mag):z(1,0,1)}},{key:"pow_base",value:function(e){return w(e).pow(this)}},{key:"root",value:function(e){var r=w(e);return this.lt(0)&&r.mod(2,!0).eq(1)?this.neg().root(r).neg():this.pow(r.recip())}},{key:"factorial",value:function(){return this.mag<0?this.add(1).gamma():this.layer===0?this.add(1).gamma():this.layer===1?t.exp(t.mul(this,t.ln(this).sub(1))):t.exp(this)}},{key:"gamma",value:function(){if(this.mag<0)return this.recip();if(this.layer===0){if(this.lt(z(1,0,24)))return t.fromNumber(_i(this.sign*this.mag));var e=this.mag-1,r=.9189385332046727;r=r+(e+.5)*Math.log(e),r=r-e;var a=e*e,s=e,i=12*s,o=1/i,c=r+o;if(c===r||(r=c,s=s*a,i=360*s,o=1/i,c=r-o,c===r))return t.exp(r);r=c,s=s*a,i=1260*s;var l=1/i;return r=r+l,s=s*a,i=1680*s,l=1/i,r=r-l,t.exp(r)}else return this.layer===1?t.exp(t.mul(this,t.ln(this).sub(1))):t.exp(this)}},{key:"lngamma",value:function(){return this.gamma().ln()}},{key:"exp",value:function(){return this.mag<0?z(1,0,1):this.layer===0&&this.mag<=709.7?t.fromNumber(Math.exp(this.sign*this.mag)):this.layer===0?H(1,1,this.sign*Math.log10(Math.E)*this.mag):this.layer===1?H(1,2,this.sign*(Math.log10(.4342944819032518)+this.mag)):H(1,this.layer+1,this.sign*this.mag)}},{key:"sqr",value:function(){return this.pow(2)}},{key:"sqrt",value:function(){if(this.layer===0)return t.fromNumber(Math.sqrt(this.sign*this.mag));if(this.layer===1)return H(1,2,Math.log10(this.mag)-.3010299956639812);var e=t.div(z(this.sign,this.layer-1,this.mag),z(1,0,2));return e.layer+=1,e.normalize(),e}},{key:"cube",value:function(){return this.pow(3)}},{key:"cbrt",value:function(){return this.lt(0)?this.neg().pow(1/3).neg():this.pow(1/3)}},{key:"tetrate",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:z(1,0,1),a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(e===1)return t.pow(this,r);if(e===0)return new t(r);if(this.eq(t.dOne))return z(1,0,1);if(this.eq(-1))return t.pow(this,r);if(e===Number.POSITIVE_INFINITY){var s=this.toNumber();if(s<=1.444667861009766&&s>=.06598803584531254){var i=t.ln(this).neg(),o=i.lambertw().div(i);if(s<1)return o;var c=i.lambertw(!1).div(i);return s>1.444667861009099&&(o=c=t.fromNumber(Math.E)),r=w(r),r.eq(c)?c:r.lt(c)?o:new t(t.dInf)}else return s>1.444667861009766?new t(t.dInf):new t(t.dNaN)}if(this.eq(t.dZero)){var l=Math.abs((e+1)%2);return l>1&&(l=2-l),t.fromNumber(l)}if(e<0)return t.iteratedlog(r,this,-e,a);r=new t(r);var m=e;e=Math.trunc(e);var u=m-e;if(this.gt(t.dZero)&&(this.lt(1)||this.lte(1.444667861009766)&&r.lte(t.ln(this).neg().lambertw(!1).div(t.ln(this).neg())))&&(m>1e4||!a)){var f=Math.min(1e4,e);r.eq(t.dOne)?r=this.pow(u):this.lt(1)?r=r.pow(1-u).mul(this.pow(r).pow(u)):r=r.layeradd(u,this);for(var b=0;b<f;++b){var x=r;if(r=this.pow(r),x.eq(r))return r}return m>1e4&&Math.ceil(m)%2==1?this.pow(r):r}u!==0&&(r.eq(t.dOne)?this.gt(10)||a?r=this.pow(u):(r=t.fromNumber(t.tetrate_critical(this.toNumber(),u)),this.lt(2)&&(r=r.sub(1).mul(this.minus(1)).plus(1))):this.eq(10)?r=r.layeradd10(u,a):this.lt(1)?r=r.pow(1-u).mul(this.pow(r).pow(u)):r=r.layeradd(u,this,a));for(var p=0;p<e;++p){if(r=this.pow(r),!isFinite(r.layer)||!isFinite(r.mag))return r.normalize();if(r.layer-this.layer>3)return z(r.sign,r.layer+(e-p-1),r.mag);if(p>1e4)return r}return r}},{key:"iteratedexp",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:z(1,0,1),a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return this.tetrate(e,r,a)}},{key:"iteratedlog",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(r<0)return t.tetrate(e,-r,this,a);e=w(e);var s=t.fromDecimal(this),i=r;r=Math.trunc(r);var o=i-r;if(s.layer-e.layer>3){var c=Math.min(r,s.layer-e.layer-3);r-=c,s.layer-=c}for(var l=0;l<r;++l){if(s=s.log(e),!isFinite(s.layer)||!isFinite(s.mag))return s.normalize();if(l>1e4)return s}return o>0&&o<1&&(e.eq(10)?s=s.layeradd10(-o,a):s=s.layeradd(-o,e,a)),s}},{key:"slog",value:function(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s=.001,i=!1,o=!1,c=this.slog_internal(e,a).toNumber(),l=1;l<r;++l){var m=new t(e).tetrate(c,t.dOne,a),u=m.gt(this);if(l>1&&o!=u&&(i=!0),o=u,i?s/=2:s*=2,s=Math.abs(s)*(u?-1:1),c+=s,s===0)break}return t.fromNumber(c)}},{key:"slog_internal",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(e=w(e),e.lte(t.dZero))return new t(t.dNaN);if(e.eq(t.dOne))return new t(t.dNaN);if(e.lt(t.dOne))return this.eq(t.dOne)?z(0,0,0):this.eq(t.dZero)?z(-1,0,1):new t(t.dNaN);if(this.mag<0||this.eq(t.dZero))return z(-1,0,1);if(e.lt(1.444667861009766)){var a=t.ln(e).neg(),s=a.lambertw().div(a);if(this.eq(s))return new t(t.dInf);if(this.gt(s))return new t(t.dNaN)}var i=0,o=t.fromDecimal(this);if(o.layer-e.layer>3){var c=o.layer-e.layer-3;i+=c,o.layer-=c}for(var l=0;l<100;++l)if(o.lt(t.dZero))o=t.pow(e,o),i-=1;else{if(o.lte(t.dOne))return r?t.fromNumber(i+o.toNumber()-1):t.fromNumber(i+t.slog_critical(e.toNumber(),o.toNumber()));i+=1,o=t.log(o,e)}return t.fromNumber(i)}},{key:"layeradd10",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e=t.fromValue_noAlloc(e).toNumber();var a=t.fromDecimal(this);if(e>=1){a.mag<0&&a.layer>0?(a.sign=0,a.mag=0,a.layer=0):a.sign===-1&&a.layer==0&&(a.sign=1,a.mag=-a.mag);var s=Math.trunc(e);e-=s,a.layer+=s}if(e<=-1){var i=Math.trunc(e);if(e-=i,a.layer+=i,a.layer<0)for(var o=0;o<100;++o){if(a.layer++,a.mag=Math.log10(a.mag),!isFinite(a.mag))return a.sign===0&&(a.sign=1),a.layer<0&&(a.layer=0),a.normalize();if(a.layer>=0)break}}for(;a.layer<0;)a.layer++,a.mag=Math.log10(a.mag);return a.sign===0&&(a.sign=1,a.mag===0&&a.layer>=1&&(a.layer-=1,a.mag=1)),a.normalize(),e!==0?a.layeradd(e,10,r):a}},{key:"layeradd",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s=w(r);if(s.gt(1)&&s.lte(1.444667861009766)){var i=t.excess_slog(this,r,a),o=i[0].toNumber(),c=i[1],l=o+e,m=t.ln(r).neg(),u=m.lambertw().div(m),f=m.lambertw(!1).div(m),b=t.dOne;c==1?b=u.mul(f).sqrt():c==2&&(b=f.mul(2));var x=s.pow(b),p=Math.floor(l),g=l-p,h=b.pow(1-g).mul(x.pow(g));return t.tetrate(s,p,h,a)}var v=this.slog(r,100,a).toNumber(),y=v+e;return y>=0?t.tetrate(r,y,t.dOne,a):Number.isFinite(y)?y>=-1?t.log(t.tetrate(r,y+1,t.dOne,a),r):t.log(t.log(t.tetrate(r,y+2,t.dOne,a),r),r):new t(t.dNaN)}},{key:"lambertw",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this.lt(-.3678794411710499)?new t(t.dNaN):e?this.abs().lt("1e-300")?new t(this):this.mag<0?t.fromNumber(Bn(this.toNumber())):this.layer===0?t.fromNumber(Bn(this.sign*this.mag)):this.lt("eee15")?Ta(this):this.ln():this.sign===1?new t(t.dNaN):this.layer===0?t.fromNumber(Bn(this.sign*this.mag,1e-10,!1)):this.layer==1?Ta(this,1e-10,!1):this.neg().recip().lambertw().neg()}},{key:"ssqrt",value:function(){return this.linear_sroot(2)}},{key:"linear_sroot",value:function(e){if(e==1)return this;if(this.eq(t.dInf))return new t(t.dInf);if(!this.isFinite())return new t(t.dNaN);if(e>0&&e<1)return this.root(e);if(e>-2&&e<-1)return t.fromNumber(e).add(2).pow(this.recip());if(e<=0)return new t(t.dNaN);if(e==Number.POSITIVE_INFINITY){var r=this.toNumber();return r<Math.E&&r>Li?this.pow(this.recip()):new t(t.dNaN)}if(this.eq(1))return z(1,0,1);if(this.lt(0))return new t(t.dNaN);if(this.lte("1ee-16"))return e%2==1?new t(this):new t(t.dNaN);if(this.gt(1)){var a=t.dTen;this.gte(t.tetrate(10,e,1,!0))&&(a=this.iteratedlog(10,e-1,!0)),e<=1&&(a=this.root(e));for(var s=t.dZero,i=a.layer,o=a.iteratedlog(10,i,!0),c=o,l=o.div(2),m=!0;m;)l=s.add(o).div(2),t.iteratedexp(10,i,l,!0).tetrate(e,1,!0).gt(this)?o=l:s=l,l.eq(c)?m=!1:c=l;return t.iteratedexp(10,i,l,!0)}else{for(var u=1,f=H(1,10,1),b=H(1,10,1),x=H(1,10,1),p=H(1,1,-16),g=t.dZero,h=H(1,10,1),v=p.pow10().recip(),y=t.dZero,T=v,M=v,E=Math.ceil(e)%2==0,I=0,R=H(1,10,1),_=!1,V=t.dZero,B=!1;u<4;){if(u==2){if(E)break;x=H(1,10,1),p=f,u=3,h=H(1,10,1),R=H(1,10,1)}for(_=!1;p.neq(x);){if(V=p,p.pow10().recip().tetrate(e,1,!0).eq(1)&&p.pow10().recip().lt(.4))v=p.pow10().recip(),T=p.pow10().recip(),M=p.pow10().recip(),y=t.dZero,I=-1,u==3&&(R=p);else if(p.pow10().recip().tetrate(e,1,!0).eq(p.pow10().recip())&&!E&&p.pow10().recip().lt(.4))v=p.pow10().recip(),T=p.pow10().recip(),M=p.pow10().recip(),y=t.dZero,I=0;else if(p.pow10().recip().tetrate(e,1,!0).eq(p.pow10().recip().mul(2).tetrate(e,1,!0)))v=p.pow10().recip(),T=t.dZero,M=v.mul(2),y=v,E?I=-1:I=0;else{for(g=p.mul(12e-17),v=p.pow10().recip(),T=p.add(g).pow10().recip(),y=v.sub(T),M=v.add(y);T.tetrate(e,1,!0).eq(v.tetrate(e,1,!0))||M.tetrate(e,1,!0).eq(v.tetrate(e,1,!0))||T.gte(v)||M.lte(v);)g=g.mul(2),T=p.add(g).pow10().recip(),y=v.sub(T),M=v.add(y);if((u==1&&M.tetrate(e,1,!0).gt(v.tetrate(e,1,!0))&&T.tetrate(e,1,!0).gt(v.tetrate(e,1,!0))||u==3&&M.tetrate(e,1,!0).lt(v.tetrate(e,1,!0))&&T.tetrate(e,1,!0).lt(v.tetrate(e,1,!0)))&&(R=p),M.tetrate(e,1,!0).lt(v.tetrate(e,1,!0)))I=-1;else if(E)I=1;else if(u==3&&p.gt_tolerance(f,1e-8))I=0;else{for(;T.tetrate(e,1,!0).eq_tolerance(v.tetrate(e,1,!0),1e-8)||M.tetrate(e,1,!0).eq_tolerance(v.tetrate(e,1,!0),1e-8)||T.gte(v)||M.lte(v);)g=g.mul(2),T=p.add(g).pow10().recip(),y=v.sub(T),M=v.add(y);M.tetrate(e,1,!0).sub(v.tetrate(e,1,!0)).lt(v.tetrate(e,1,!0).sub(T.tetrate(e,1,!0)))?I=0:I=1}}if(I==-1&&(B=!0),u==1&&I==1||u==3&&I!=0)if(x.eq(H(1,10,1)))p=p.mul(2);else{var $=!1;if(_&&(I==1&&u==1||I==-1&&u==3)&&($=!0),p=p.add(x).div(2),$)break}else if(x.eq(H(1,10,1)))x=p,p=p.div(2);else{var C=!1;if(_&&(I==1&&u==1||I==-1&&u==3)&&(C=!0),x=x.sub(h),p=p.sub(h),C)break}if(x.sub(p).div(2).abs().gt(h.mul(1.5))&&(_=!0),h=x.sub(p).div(2).abs(),p.gt("1e18")||p.eq(V))break}if(p.gt("1e18")||!B||R==H(1,10,1))break;u==1?f=R:u==3&&(b=R),u++}x=f,p=H(1,1,-18);for(var Y=p,F=t.dZero,q=!0;q;)if(x.eq(H(1,10,1))?F=p.mul(2):F=x.add(p).div(2),t.pow(10,F).recip().tetrate(e,1,!0).gt(this)?p=F:x=F,F.eq(Y)?q=!1:Y=F,p.gt("1e18"))return new t(t.dNaN);if(F.eq_tolerance(f,1e-15)){if(b.eq(H(1,10,1)))return new t(t.dNaN);for(x=H(1,10,1),p=b,Y=p,F=t.dZero,q=!0;q;)if(x.eq(H(1,10,1))?F=p.mul(2):F=x.add(p).div(2),t.pow(10,F).recip().tetrate(e,1,!0).gt(this)?p=F:x=F,F.eq(Y)?q=!1:Y=F,p.gt("1e18"))return new t(t.dNaN);return F.pow10().recip()}else return F.pow10().recip()}}},{key:"pentate",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:z(1,0,1),a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;r=new t(r);var s=e;e=Math.floor(e);var i=s-e,o=t.dZero,c=t.dZero;if(i!==0)if(r.eq(t.dOne))++e,r=t.fromNumber(i);else return this.pentate(r.penta_log(this,void 0,a).plus(s).toNumber(),1,a);if(e>0)for(var l=0;l<e;){if(c=o,o=r,r=this.tetrate(r.toNumber(),t.dOne,a),++l,this.gt(0)&&this.lte(1)&&r.gt(0)&&r.lte(1))return this.tetrate(e-l,r,a);if(r.eq(o)||r.eq(c)&&l%2==e%2||!isFinite(r.layer)||!isFinite(r.mag))return r.normalize();if(l>1e4)return r}else for(var m=0;m<-e;++m){if(o=r,r=r.slog(this,void 0,a),r.eq(o)||!isFinite(r.layer)||!isFinite(r.mag))return r.normalize();if(m>100)return r}return r}},{key:"penta_log",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(e=new t(e),e.lte(1))return new t(t.dNaN);if(this.eq(1))return z(0,0,0);if(this.eq(t.dInf))return new t(t.dInf);var s=new t(1),i=0,o=1;if(this.lt(-1)){if(this.lte(-2))return new t(t.dNaN);var c=e.tetrate(this.toNumber(),1,a);if(this.eq(c))return new t(t.dNegInf);if(this.gt(c))return new t(t.dNaN)}if(this.gt(1)){for(;s.lt(this);)if(i++,s=t.tetrate(e,s.toNumber(),1,a),i>1e3)return new t(t.dNaN)}else for(;s.gt(this);)if(i--,s=t.slog(s,e,a),i>100)return new t(t.dNaN);for(var l=1;l<r;++l){var m=e.pentate(i,t.dOne,a);if(m.eq(this))break;var u=m.gt(this);if(o=Math.abs(o)*(u?-1:1),i+=o,o/=2,o===0)break}return t.fromNumber(i)}},{key:"linear_penta_root",value:function(e){return e==1?this:e<0?new t(t.dNaN):this.eq(t.dInf)?new t(t.dInf):this.isFinite()?e>0&&e<1?this.root(e):this.eq(1)?z(1,0,1):this.lt(0)?new t(t.dNaN):this.lt(1)?this.linear_sroot(e):t.increasingInverse(function(r){return t.pentate(r,e,1,!0)})(this):new t(t.dNaN)}},{key:"sin",value:function(){return this.mag<0?new t(this):this.layer===0?t.fromNumber(Math.sin(this.sign*this.mag)):z(0,0,0)}},{key:"cos",value:function(){return this.mag<0?z(1,0,1):this.layer===0?t.fromNumber(Math.cos(this.sign*this.mag)):z(0,0,0)}},{key:"tan",value:function(){return this.mag<0?new t(this):this.layer===0?t.fromNumber(Math.tan(this.sign*this.mag)):z(0,0,0)}},{key:"asin",value:function(){return this.mag<0?new t(this):this.layer===0?t.fromNumber(Math.asin(this.sign*this.mag)):new t(t.dNaN)}},{key:"acos",value:function(){return this.mag<0?t.fromNumber(Math.acos(this.toNumber())):this.layer===0?t.fromNumber(Math.acos(this.sign*this.mag)):new t(t.dNaN)}},{key:"atan",value:function(){return this.mag<0?new t(this):this.layer===0?t.fromNumber(Math.atan(this.sign*this.mag)):t.fromNumber(Math.atan(this.sign*(1/0)))}},{key:"sinh",value:function(){return this.exp().sub(this.negate().exp()).div(2)}},{key:"cosh",value:function(){return this.exp().add(this.negate().exp()).div(2)}},{key:"tanh",value:function(){return this.sinh().div(this.cosh())}},{key:"asinh",value:function(){return t.ln(this.add(this.sqr().add(1).sqrt()))}},{key:"acosh",value:function(){return t.ln(this.add(this.sqr().sub(1).sqrt()))}},{key:"atanh",value:function(){return this.abs().gte(1)?new t(t.dNaN):t.ln(this.add(1).div(t.fromNumber(1).sub(this))).div(2)}},{key:"ascensionPenalty",value:function(e){return e===0?new t(this):this.root(t.pow(10,e))}},{key:"egg",value:function(){return this.add(9)}},{key:"lessThanOrEqualTo",value:function(e){return this.cmp(e)<1}},{key:"lessThan",value:function(e){return this.cmp(e)<0}},{key:"greaterThanOrEqualTo",value:function(e){return this.cmp(e)>-1}},{key:"greaterThan",value:function(e){return this.cmp(e)>0}}],[{key:"fromComponents",value:function(e,r,a){return new t().fromComponents(e,r,a)}},{key:"fromComponents_noNormalize",value:function(e,r,a){return new t().fromComponents_noNormalize(e,r,a)}},{key:"fromMantissaExponent",value:function(e,r){return new t().fromMantissaExponent(e,r)}},{key:"fromMantissaExponent_noNormalize",value:function(e,r){return new t().fromMantissaExponent_noNormalize(e,r)}},{key:"fromDecimal",value:function(e){return new t().fromDecimal(e)}},{key:"fromNumber",value:function(e){return new t().fromNumber(e)}},{key:"fromString",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return new t().fromString(e,r)}},{key:"fromValue",value:function(e){return new t().fromValue(e)}},{key:"fromValue_noAlloc",value:function(e){if(e instanceof t)return e;if(typeof e=="string"){var r=t.fromStringCache.get(e);return r!==void 0?r:t.fromString(e)}else return typeof e=="number"?t.fromNumber(e):z(0,0,0)}},{key:"abs",value:function(e){return w(e).abs()}},{key:"neg",value:function(e){return w(e).neg()}},{key:"negate",value:function(e){return w(e).neg()}},{key:"negated",value:function(e){return w(e).neg()}},{key:"sign",value:function(e){return w(e).sign}},{key:"sgn",value:function(e){return w(e).sign}},{key:"round",value:function(e){return w(e).round()}},{key:"floor",value:function(e){return w(e).floor()}},{key:"ceil",value:function(e){return w(e).ceil()}},{key:"trunc",value:function(e){return w(e).trunc()}},{key:"add",value:function(e,r){return w(e).add(r)}},{key:"plus",value:function(e,r){return w(e).add(r)}},{key:"sub",value:function(e,r){return w(e).sub(r)}},{key:"subtract",value:function(e,r){return w(e).sub(r)}},{key:"minus",value:function(e,r){return w(e).sub(r)}},{key:"mul",value:function(e,r){return w(e).mul(r)}},{key:"multiply",value:function(e,r){return w(e).mul(r)}},{key:"times",value:function(e,r){return w(e).mul(r)}},{key:"div",value:function(e,r){return w(e).div(r)}},{key:"divide",value:function(e,r){return w(e).div(r)}},{key:"recip",value:function(e){return w(e).recip()}},{key:"reciprocal",value:function(e){return w(e).recip()}},{key:"reciprocate",value:function(e){return w(e).reciprocate()}},{key:"mod",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return w(e).mod(r,a)}},{key:"modulo",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return w(e).modulo(r,a)}},{key:"modular",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return w(e).modular(r,a)}},{key:"cmp",value:function(e,r){return w(e).cmp(r)}},{key:"cmpabs",value:function(e,r){return w(e).cmpabs(r)}},{key:"compare",value:function(e,r){return w(e).cmp(r)}},{key:"isNaN",value:(function(n){function e(r){return n.apply(this,arguments)}return e.toString=function(){return n.toString()},e})(function(n){return n=w(n),isNaN(n.sign)||isNaN(n.layer)||isNaN(n.mag)})},{key:"isFinite",value:(function(n){function e(r){return n.apply(this,arguments)}return e.toString=function(){return n.toString()},e})(function(n){return n=w(n),isFinite(n.sign)&&isFinite(n.layer)&&isFinite(n.mag)})},{key:"eq",value:function(e,r){return w(e).eq(r)}},{key:"equals",value:function(e,r){return w(e).eq(r)}},{key:"neq",value:function(e,r){return w(e).neq(r)}},{key:"notEquals",value:function(e,r){return w(e).notEquals(r)}},{key:"lt",value:function(e,r){return w(e).lt(r)}},{key:"lte",value:function(e,r){return w(e).lte(r)}},{key:"gt",value:function(e,r){return w(e).gt(r)}},{key:"gte",value:function(e,r){return w(e).gte(r)}},{key:"max",value:function(e,r){return w(e).max(r)}},{key:"min",value:function(e,r){return w(e).min(r)}},{key:"minabs",value:function(e,r){return w(e).minabs(r)}},{key:"maxabs",value:function(e,r){return w(e).maxabs(r)}},{key:"clamp",value:function(e,r,a){return w(e).clamp(r,a)}},{key:"clampMin",value:function(e,r){return w(e).clampMin(r)}},{key:"clampMax",value:function(e,r){return w(e).clampMax(r)}},{key:"cmp_tolerance",value:function(e,r,a){return w(e).cmp_tolerance(r,a)}},{key:"compare_tolerance",value:function(e,r,a){return w(e).cmp_tolerance(r,a)}},{key:"eq_tolerance",value:function(e,r,a){return w(e).eq_tolerance(r,a)}},{key:"equals_tolerance",value:function(e,r,a){return w(e).eq_tolerance(r,a)}},{key:"neq_tolerance",value:function(e,r,a){return w(e).neq_tolerance(r,a)}},{key:"notEquals_tolerance",value:function(e,r,a){return w(e).notEquals_tolerance(r,a)}},{key:"lt_tolerance",value:function(e,r,a){return w(e).lt_tolerance(r,a)}},{key:"lte_tolerance",value:function(e,r,a){return w(e).lte_tolerance(r,a)}},{key:"gt_tolerance",value:function(e,r,a){return w(e).gt_tolerance(r,a)}},{key:"gte_tolerance",value:function(e,r,a){return w(e).gte_tolerance(r,a)}},{key:"pLog10",value:function(e){return w(e).pLog10()}},{key:"absLog10",value:function(e){return w(e).absLog10()}},{key:"log10",value:function(e){return w(e).log10()}},{key:"log",value:function(e,r){return w(e).log(r)}},{key:"log2",value:function(e){return w(e).log2()}},{key:"ln",value:function(e){return w(e).ln()}},{key:"logarithm",value:function(e,r){return w(e).logarithm(r)}},{key:"pow",value:function(e,r){return w(e).pow(r)}},{key:"pow10",value:function(e){return w(e).pow10()}},{key:"root",value:function(e,r){return w(e).root(r)}},{key:"factorial",value:function(e,r){return w(e).factorial()}},{key:"gamma",value:function(e,r){return w(e).gamma()}},{key:"lngamma",value:function(e,r){return w(e).lngamma()}},{key:"exp",value:function(e){return w(e).exp()}},{key:"sqr",value:function(e){return w(e).sqr()}},{key:"sqrt",value:function(e){return w(e).sqrt()}},{key:"cube",value:function(e){return w(e).cube()}},{key:"cbrt",value:function(e){return w(e).cbrt()}},{key:"tetrate",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:z(1,0,1),s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return w(e).tetrate(r,a,s)}},{key:"iteratedexp",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:z(1,0,1),s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return w(e).iteratedexp(r,a,s)}},{key:"iteratedlog",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return w(e).iteratedlog(r,a,s)}},{key:"layeradd10",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return w(e).layeradd10(r,a)}},{key:"layeradd",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:10,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return w(e).layeradd(r,a,s)}},{key:"slog",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return w(e).slog(r,100,a)}},{key:"lambertw",value:function(e,r){return w(e).lambertw(r)}},{key:"ssqrt",value:function(e){return w(e).ssqrt()}},{key:"linear_sroot",value:function(e,r){return w(e).linear_sroot(r)}},{key:"pentate",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:z(1,0,1),s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return w(e).pentate(r,a,s)}},{key:"penta_log",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return w(e).penta_log(r,100,a)}},{key:"linear_penta_root",value:function(e,r){return w(e).linear_penta_root(r)}},{key:"sin",value:function(e){return w(e).sin()}},{key:"cos",value:function(e){return w(e).cos()}},{key:"tan",value:function(e){return w(e).tan()}},{key:"asin",value:function(e){return w(e).asin()}},{key:"acos",value:function(e){return w(e).acos()}},{key:"atan",value:function(e){return w(e).atan()}},{key:"sinh",value:function(e){return w(e).sinh()}},{key:"cosh",value:function(e){return w(e).cosh()}},{key:"tanh",value:function(e){return w(e).tanh()}},{key:"asinh",value:function(e){return w(e).asinh()}},{key:"acosh",value:function(e){return w(e).acosh()}},{key:"atanh",value:function(e){return w(e).atanh()}},{key:"affordGeometricSeries",value:function(e,r,a,s){return this.affordGeometricSeries_core(w(e),w(r),w(a),s)}},{key:"sumGeometricSeries",value:function(e,r,a,s){return this.sumGeometricSeries_core(e,w(r),w(a),s)}},{key:"affordArithmeticSeries",value:function(e,r,a,s){return this.affordArithmeticSeries_core(w(e),w(r),w(a),w(s))}},{key:"sumArithmeticSeries",value:function(e,r,a,s){return this.sumArithmeticSeries_core(w(e),w(r),w(a),w(s))}},{key:"efficiencyOfPurchase",value:function(e,r,a){return this.efficiencyOfPurchase_core(w(e),w(r),w(a))}},{key:"randomDecimalForTesting",value:function(e){if(Math.random()*20<1)return z(0,0,0);var r=Math.random()>.5?1:-1;if(Math.random()*20<1)return z(r,0,1);var a=Math.floor(Math.random()*(e+1)),s=a===0?Math.random()*616-308:Math.random()*16;Math.random()>.9&&(s=Math.trunc(s));var i=Math.pow(10,s);return Math.random()>.9&&(i=Math.trunc(i)),H(r,a,i)}},{key:"affordGeometricSeries_core",value:function(e,r,a,s){var i=r.mul(a.pow(s));return t.floor(e.div(i).mul(a.sub(1)).add(1).log10().div(a.log10()))}},{key:"sumGeometricSeries_core",value:function(e,r,a,s){return r.mul(a.pow(s)).mul(t.sub(1,a.pow(e))).div(t.sub(1,a))}},{key:"affordArithmeticSeries_core",value:function(e,r,a,s){var i=r.add(s.mul(a)),o=i.sub(a.div(2)),c=o.pow(2);return o.neg().add(c.add(a.mul(e).mul(2)).sqrt()).div(a).floor()}},{key:"sumArithmeticSeries_core",value:function(e,r,a,s){var i=r.add(s.mul(a));return e.div(2).mul(i.mul(2).plus(e.sub(1).mul(a)))}},{key:"efficiencyOfPurchase_core",value:function(e,r,a){return e.div(r).add(e.div(a))}},{key:"slog_critical",value:function(e,r){return e>10?r-1:t.critical_section(e,r,qi)}},{key:"tetrate_critical",value:function(e,r){return t.critical_section(e,r,Ai)}},{key:"critical_section",value:function(e,r,a){r*=10,r<0&&(r=0),r>10&&(r=10),e<2&&(e=2),e>10&&(e=10);for(var s=0,i=0,o=0;o<Qt.length;++o)if(Qt[o]==e){s=a[o][Math.floor(r)],i=a[o][Math.ceil(r)];break}else if(Qt[o]<e&&Qt[o+1]>e){var c=(e-Qt[o])/(Qt[o+1]-Qt[o]);s=a[o][Math.floor(r)]*(1-c)+a[o+1][Math.floor(r)]*c,i=a[o][Math.ceil(r)]*(1-c)+a[o+1][Math.ceil(r)]*c;break}var l=r-Math.floor(r);return s<=0||i<=0?s*(1-l)+i*l:Math.pow(e,Math.log(s)/Math.log(e)*(1-l)+Math.log(i)/Math.log(e)*l)}},{key:"excess_slog",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;e=w(e),r=w(r);var s=r;if(r=r.toNumber(),r==1||r<=0)return[new t(t.dNaN),0];if(r>1.444667861009766)return[e.slog(r,100,a),0];var i=t.ln(r).neg(),o=i.lambertw().div(i),c=t.dInf;if(r>1&&(c=i.lambertw(!1).div(i)),r>1.444667861009099&&(o=c=t.fromNumber(Math.E)),e.lt(o))return[e.slog(r,100,a),0];if(e.eq(o))return[new t(t.dInf),0];if(e.eq(c))return[new t(t.dNegInf),2];if(e.gt(c)){var l=c.mul(2),m=s.pow(l),u=0;if(e.gte(l)&&e.lt(m))u=0;else if(e.gte(m)){var f=m;for(u=1;f.lt(e);)if(f=s.pow(f),u=u+1,f.layer>3){var b=Math.floor(e.layer-f.layer+1);f=s.iteratedexp(b,f,a),u=u+b}f.gt(e)&&(f=f.log(r),u=u-1)}else if(e.lt(l)){var x=l;for(u=0;x.gt(e);)x=x.log(r),u=u-1}for(var p=0,g=0,h=.5,v=l,y=t.dZero;h>1e-16;){if(g=p+h,v=l.pow(1-g).mul(m.pow(g)),y=t.iteratedexp(r,u,v),y.eq(e))return[new t(u+g),2];y.lt(e)&&(p+=h),h/=2}return y.neq_tolerance(e,1e-7)?[new t(t.dNaN),0]:[new t(u+p),2]}if(e.lt(c)&&e.gt(o)){var T=o.mul(c).sqrt(),M=s.pow(T),E=0;if(e.lte(T)&&e.gt(M))E=0;else if(e.lte(M)){var I=M;for(E=1;I.gt(e);)I=s.pow(I),E=E+1;I.lt(e)&&(I=I.log(r),E=E-1)}else if(e.gt(T)){var R=T;for(E=0;R.lt(e);)R=R.log(r),E=E-1}for(var _=0,V=0,B=.5,$=T,C=t.dZero;B>1e-16;){if(V=_+B,$=T.pow(1-V).mul(M.pow(V)),C=t.iteratedexp(r,E,$),C.eq(e))return[new t(E+V),1];C.gt(e)&&(_+=B),B/=2}return C.neq_tolerance(e,1e-7)?[new t(t.dNaN),0]:[new t(E+_),1]}throw new Error("Unhandled behavior in excess_slog")}},{key:"increasingInverse",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:120,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:t.dLayerMax.neg(),i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:t.dLayerMax,o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:t.dLayerMax.neg(),c=arguments.length>6&&arguments[6]!==void 0?arguments[6]:t.dLayerMax;return function(l){if(l=new t(l),s=new t(s),i=new t(i),o=new t(o),c=new t(c),l.isNan()||i.lt(s)||l.lt(o)||l.gt(c))return new t(t.dNaN);var m=function(Q){return new t(Q)},u=!0;if(i.lt(0))u=!1;else if(s.gt(0))u=!0;else{var f=e(t.dZero);if(f.eq(l))return z(0,0,0);u=l.gt(f),r&&(u=!u)}var b=u,x;if(u){if(i.lt(Xt))u=!0;else if(s.gt(Xt))u=!1;else{var p=e(new t(Xt));u=l.lt(p),r&&(u=!u)}if(u){x=!0;var g=t.pow(10,wt).recip();if(i.lt(g))u=!1;else if(s.gt(g))u=!0;else{var h=e(new t(g));u=l.gt(h),r&&(u=!u)}if(u)m=function(Q){return t.pow(10,Q).recip()};else{var v=t.tetrate(10,wt);if(i.lt(v))u=!1;else if(s.gt(v))u=!0;else{var y=e(new t(v));u=l.gt(y),r&&(u=!u)}u?m=function(Q){return t.tetrate(10,new t(Q).toNumber()).recip()}:m=function(Q){return new t(Q).gt(Math.log10(Number.MAX_VALUE))?t.dZero:t.tetrate(10,t.pow(10,Q).toNumber()).recip()}}}else{if(x=!1,i.lt(wt))u=!0;else if(s.gt(wt))u=!1;else{var T=e(new t(wt));u=l.lt(T),r&&(u=!u)}if(u)m=function(Q){return new t(Q)};else{var M=t.pow(10,wt);if(i.lt(M))u=!0;else if(s.gt(M))u=!1;else{var E=e(new t(M));u=l.lt(E),r&&(u=!u)}if(u)m=function(Q){return t.pow(10,Q)};else{var I=t.tetrate(10,wt);if(i.lt(I))u=!0;else if(s.gt(I))u=!1;else{var R=e(new t(I));u=l.lt(R),r&&(u=!u)}u?m=function(Q){return t.tetrate(10,new t(Q).toNumber())}:m=function(Q){return new t(Q).gt(Math.log10(Number.MAX_VALUE))?t.dInf:t.tetrate(10,t.pow(10,Q).toNumber())}}}}}else{if(x=!0,i.lt(-Xt))u=!1;else if(s.gt(-Xt))u=!0;else{var _=e(new t(-Xt));u=l.gt(_),r&&(u=!u)}if(u){var V=t.pow(10,wt).recip().neg();if(i.lt(V))u=!0;else if(s.gt(V))u=!1;else{var B=e(new t(V));u=l.lt(B),r&&(u=!u)}if(u)m=function(Q){return t.pow(10,Q).recip().neg()};else{var $=t.tetrate(10,wt).neg();if(i.lt($))u=!0;else if(s.gt($))u=!1;else{var C=e(new t($));u=l.lt(C),r&&(u=!u)}u?m=function(Q){return t.tetrate(10,new t(Q).toNumber()).recip().neg()}:m=function(Q){return new t(Q).gt(Math.log10(Number.MAX_VALUE))?t.dZero:t.tetrate(10,t.pow(10,Q).toNumber()).recip().neg()}}}else{if(x=!1,i.lt(-wt))u=!1;else if(s.gt(-wt))u=!0;else{var Y=e(new t(-wt));u=l.gt(Y),r&&(u=!u)}if(u)m=function(Q){return t.neg(Q)};else{var F=t.pow(10,wt).neg();if(i.lt(F))u=!1;else if(s.gt(F))u=!0;else{var q=e(new t(F));u=l.gt(q),r&&(u=!u)}if(u)m=function(Q){return t.pow(10,Q).neg()};else{var tt=t.tetrate(10,wt).neg();if(i.lt(tt))u=!1;else if(s.gt(tt))u=!0;else{var j=e(new t(tt));u=l.gt(j),r&&(u=!u)}u?m=function(Q){return t.tetrate(10,new t(Q).toNumber()).neg()}:m=function(Q){return new t(Q).gt(Math.log10(Number.MAX_VALUE))?t.dNegInf:t.tetrate(10,t.pow(10,Q).toNumber()).neg()}}}}}for(var ot=b!=x!=r,U=ot?function(rt,Q){return t.gt(rt,Q)}:function(rt,Q){return t.lt(rt,Q)},k=.001,W=!1,P=!1,D=1,X=t.dOne,N=0,A=!1,O=1;O<a;++O){A=!1,N=D,X=m(D),X.gt(i)&&(X=i,A=!0),X.lt(s)&&(X=s,A=!0);var J=e(X);if(J.eq(l)&&!A)break;var lt=U(J,l);if(O>1&&P!=lt&&(W=!0),P=lt,W?k/=2:k*=2,lt!=ot&&X.eq(i)||lt==ot&&X.eq(s))return new t(t.dNaN);if(k=Math.abs(k)*(lt?-1:1),D+=k,k===0||N==D)break}return m(D)}}}]),t})();d.dZero=z(0,0,0);d.dOne=z(1,0,1);d.dNegOne=z(-1,0,1);d.dTwo=z(1,0,2);d.dTen=z(1,0,10);d.dNaN=z(Number.NaN,Number.NaN,Number.NaN);d.dInf=z(1,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);d.dNegInf=z(-1,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);d.dNumberMax=H(1,0,Number.MAX_VALUE);d.dNumberMin=H(1,0,Number.MIN_VALUE);d.dLayerSafeMax=H(1,Number.MAX_SAFE_INTEGER,wt-1);d.dLayerSafeMin=H(1,Number.MAX_SAFE_INTEGER,-8999999999999999);d.dLayerMax=H(1,Number.MAX_VALUE,wt-1);d.dLayerMin=H(1,Number.MAX_VALUE,-8999999999999999);d.fromStringCache=new Mi(Ei);w=d.fromValue_noAlloc;H=d.fromComponents;z=d.fromComponents_noNormalize;d.fromMantissaExponent;d.fromMantissaExponent_noNormalize;const L=t=>`${t.replace(/^\//,"./")}`,vt={1:{tier:1,name:"T1 Mana Gem",icon:L("icons/t1 gem.png"),effect:{type:"flat",value:new d(.1)},recipe:[{type:"mana",amount:new d(0)}],craftTime:1,visibleByDefault:!0},2:{tier:2,name:"T2 Mana Gem",icon:L("icons/t2 gem.png"),effect:{type:"multiplier",value:new d(2)},recipe:[{type:"gem",tier:1,amount:new d(10)}],craftTime:2,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:1,amount:100}},3:{tier:3,name:"T3 Mana Gem",icon:L("icons/t3 gem.png"),effect:{type:"multiplier",value:new d(2)},recipe:[{type:"gem",tier:2,amount:new d(50)}],craftTime:4,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:2,amount:500}},4:{tier:4,name:"T4 Mana Gem",icon:L("icons/t4 gem.png"),effect:{type:"multiplier",value:new d(3)},recipe:[{type:"gem",tier:3,amount:new d(200)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:3,amount:2e3}},5:{tier:5,name:"T5 Mana Gem",icon:L("icons/t5 gem.png"),effect:{type:"multiplier",value:new d(4)},recipe:[{type:"gem",tier:4,amount:new d(500)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:4,amount:5e3}},6:{tier:6,name:"T6 Mana Gem",icon:L("icons/t6 gem.png"),effect:{type:"multiplier",value:new d(5)},recipe:[{type:"gem",tier:5,amount:new d(1e3)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:5,amount:1e4}},7:{tier:7,name:"T7 Mana Gem",icon:L("icons/t7 gem.png"),effect:{type:"multiplier",value:new d(10)},recipe:[{type:"gem",tier:6,amount:new d(2500)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:6,amount:25e3}},8:{tier:8,name:"T8 Mana Gem",icon:L("icons/t8 gem.png"),effect:{type:"multiplier",value:new d(20)},recipe:[{type:"gem",tier:7,amount:new d(1e4)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:7,amount:1e5}}},Mt=[1,2,3,4,5,6,7,8],xe={1:{tier:1,name:"T1 Flask",icon:L("icons/t1 flask.png"),recipe:[{type:"gem",tier:1,amount:new d(10)}],craftTime:5},2:{tier:2,name:"T2 Flask",icon:L("icons/t2 flask.png"),recipe:[{type:"gem",tier:2,amount:new d(20)}],craftTime:10},3:{tier:3,name:"T3 Flask",icon:L("icons/t3 flask.png"),recipe:[{type:"gem",tier:3,amount:new d(30)}],craftTime:15},4:{tier:4,name:"T4 Flask",icon:L("icons/t4 flask.png"),recipe:[{type:"gem",tier:4,amount:new d(40)}],craftTime:20},5:{tier:5,name:"T5 Flask",icon:L("icons/t5 flask.png"),recipe:[{type:"gem",tier:5,amount:new d(50)}],craftTime:25},6:{tier:6,name:"T6 Flask",icon:L("icons/t6 flask.png"),recipe:[{type:"gem",tier:6,amount:new d(60)}],craftTime:30},7:{tier:7,name:"T7 Flask",icon:L("icons/t7 flask.png"),recipe:[{type:"gem",tier:7,amount:new d(70)}],craftTime:35},8:{tier:8,name:"T8 Flask",icon:L("icons/t8 flask.png"),recipe:[{type:"gem",tier:8,amount:new d(80)}],craftTime:40}},Nt=[1,2,3,4,5,6,7,8],Fi={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:2e4,sacrificeBatchSize:1,calculateSacrificeBonus:t=>{if(t<=0)return new d(1);const n=Math.min(t,2e4);return new d(1+Math.pow(n,.4)*.1)}},Ui={t1_knight:{id:"t1_knight",name:"T1 Knight",icon:L("icons/t1 knight.png"),recipe:[{type:"gem",tier:1,amount:new d(100)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:1,strengthExponent:.8},t4_knight:{id:"t4_knight",name:"T4 Knight",icon:L("icons/t4 knight.png"),recipe:[{type:"gem",tier:4,amount:new d(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:4,amount:1e5},unitRole:"strength",strengthMultiplier:20,strengthExponent:.8},t7_knight:{id:"t7_knight",name:"T7 Knight",icon:L("icons/t7 knight.png"),recipe:[{type:"gem",tier:7,amount:new d(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:7,amount:1e6},unitRole:"strength",strengthMultiplier:400,strengthExponent:.8},t2_boat:{id:"t2_boat",name:"T2 Boat",icon:L("icons/t2 boat.png"),recipe:[{type:"gem",tier:2,amount:new d(500)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:2,amount:5e4},unitRole:"speed",strengthMultiplier:1,strengthExponent:.6},t5_boat:{id:"t5_boat",name:"T5 Boat",icon:L("icons/t5 boat.png"),recipe:[{type:"gem",tier:5,amount:new d(5e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:5,amount:5e5},unitRole:"speed",strengthMultiplier:5,strengthExponent:.6},t3_beacon:{id:"t3_beacon",name:"T3 Beacon",icon:L("icons/t3 beacon.png"),recipe:[{type:"gem",tier:3,amount:new d(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e5},unitRole:"taunt",strengthMultiplier:1,strengthExponent:.8},t6_beacon:{id:"t6_beacon",name:"T6 Beacon",icon:L("icons/t6 beacon.png"),recipe:[{type:"gem",tier:6,amount:new d(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:6,amount:1e6},unitRole:"taunt",strengthMultiplier:10,strengthExponent:.8}},Pi=["t1_knight","t2_boat","t3_beacon","t4_knight","t5_boat","t6_beacon","t7_knight"],un=1,us=.1,Oi=5,Bi=(t,n)=>1,Di=[{id:"expedition_1",name:"Forest Patrol",difficulty:5,duration:60,rewards:{artifactShards:1},icon:L("icons/forest patrol.png"),group:"Shards"},{id:"expedition_2",name:"Mountain Pass",difficulty:1e3,duration:3600,rewards:{artifactShards:150},icon:L("icons/mountain pass.png"),group:"Shards"},{id:"expedition_3",name:"Ancient Ruins",difficulty:5e4,duration:10800,rewards:{nullstone:1},icon:L("icons/ancient ruins.png"),group:"Nullstones",unlockRequirement:"expedition_2"},{id:"expedition_4",name:"Wraith Stronghold",difficulty:5e5,duration:21600,rewards:{artifactShards:1e5},icon:L("icons/wraith stronghold.png"),group:"Shards",unlockRequirement:"expedition_2"},{id:"heroic_shard_affinity",name:"Shard Affinity",duration:1800,rewards:{},icon:L("icons/artifact shard.png"),group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"shard_drops",rewardScaling:1.1}},{id:"heroic_prime_mastery",name:"Prime Realm Mastery",duration:1800,rewards:{},icon:L("icons/r0.png"),group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm1_output",rewardScaling:1.1}},{id:"heroic_war_mastery",name:"Realm of War Mastery",duration:1800,rewards:{},icon:L("icons/portal.png"),group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm2_output",rewardScaling:1.1}}],Ut=["t1_ring","t2_ring","t3_ring","t4_ring","t5_ring","t6_ring","t7_ring","t8_ring","combat_artifact","crafting_speed"],ht={t1_ring:{id:"t1_ring",type:"ring",tier:1,name:"T1 Ring",icon:L("icons/t1 ring.png"),description:"Amplifies T1 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(10),gems:new d(0)}},t2_ring:{id:"t2_ring",type:"ring",tier:2,name:"T2 Ring",icon:L("icons/t2 ring.png"),description:"Amplifies T2 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(50),gems:new d(0)}},t3_ring:{id:"t3_ring",type:"ring",tier:3,name:"T3 Ring",icon:L("icons/t3 ring.png"),description:"Amplifies T3 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(500),gems:new d(0)}},t4_ring:{id:"t4_ring",type:"ring",tier:4,name:"T4 Ring",icon:L("icons/t4 ring.png"),description:"Amplifies T4 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(1e4),gems:new d(0)}},t5_ring:{id:"t5_ring",type:"ring",tier:5,name:"T5 Ring",icon:L("icons/t5 ring.png"),description:"Amplifies T5 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(1e5),gems:new d(0)}},t6_ring:{id:"t6_ring",type:"ring",tier:6,name:"T6 Ring",icon:L("icons/t6 ring.png"),description:"Amplifies T6 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(1e6),gems:new d(0)}},t7_ring:{id:"t7_ring",type:"ring",tier:7,name:"T7 Ring",icon:L("icons/t7 ring.png"),description:"Amplifies T7 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(1e7),gems:new d(0)}},t8_ring:{id:"t8_ring",type:"ring",tier:8,name:"T8 Ring",icon:L("icons/t8 ring.png"),description:"Amplifies T8 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:1/0,cost:{artifactShards:new d(1e8),gems:new d(0)}},combat_artifact:{id:"combat_artifact",type:"combat",tier:0,name:"Combat Artifact",icon:L("icons/combat artifact.png"),description:"Increases combat strength (x1.1 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.1,costScaling:3,maxLevel:100,cost:{artifactShards:new d(50),gems:new d(0)}},crafting_speed:{id:"crafting_speed",type:"crafting_speed",tier:0,name:"Crafting Speed",icon:L("icons/crafting speed.png"),description:"Increases crafting speed (+5% per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.05,costScaling:2.5,maxLevel:40,cost:{artifactShards:new d(200),gems:new d(0)}}};new d(1e15),new d(1e30),new d(1e60),new d(1e120),new d(1e240),new d("1e480"),new d("1e1000"),new d("1e2000");const Hi=Object.freeze(Object.defineProperty({__proto__:null,ALL_ARTIFACT_IDS:Ut,ALL_MILITARY_UNIT_IDS:Pi,ARTIFACTS:ht,COMPLETIONS_TO_UNLOCK:Oi,EXPEDITIONS:Di,MAX_SUCCESS_RATE:un,MILITARY_UNITS:Ui,MIN_SUCCESS_RATE:us,MODIFIERS:Fi,calculateQuestBonus:Bi},Symbol.toStringTag,{value:"Module"})),Gi={manaModifier:t=>t.sqrt(),craftTimeMultiplier:4,flaskRecipeMultiplier:4,sacrificeCap:2e5,sacrificeBatchSize:10,calculateSacrificeBonus:t=>{if(t<=0)return new d(1);const n=Math.min(t,2e5);return new d(1+Math.pow(n,.5)*.02)}},Vi={t1_sword:{id:"t1_sword",name:"T1 Sword",icon:L("icons/t1 sword.png"),recipe:[{type:"gem",tier:1,amount:new d(1e3)}],craftTime:10,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:10,strengthExponent:.8},t2_sword:{id:"t2_sword",name:"T2 Sword",icon:L("icons/t2 sword.png"),recipe:[{type:"gem",tier:2,amount:new d(1e4)}],craftTime:15,unlockRequirement:{type:"lifetime_gems",tier:2,amount:1e5},unitRole:"strength",strengthMultiplier:100,strengthExponent:.8},t3_sword:{id:"t3_sword",name:"T3 Sword",icon:L("icons/t3 sword.png"),recipe:[{type:"gem",tier:3,amount:new d(1e5)}],craftTime:20,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e6},unitRole:"strength",strengthMultiplier:1e3,strengthExponent:.8},t4_sword:{id:"t4_sword",name:"T4 Sword",icon:L("icons/t4 sword.png"),recipe:[{type:"gem",tier:4,amount:new d(4e5)}],craftTime:30,unlockRequirement:{type:"lifetime_gems",tier:4,amount:4e6},unitRole:"strength",strengthMultiplier:1e4,strengthExponent:.8},t5_sword:{id:"t5_sword",name:"T5 Sword",icon:L("icons/t5 sword.png"),recipe:[{type:"gem",tier:5,amount:new d(16e5)}],craftTime:45,unlockRequirement:{type:"lifetime_gems",tier:5,amount:16e6},unitRole:"strength",strengthMultiplier:1e5,strengthExponent:.8},t6_sword:{id:"t6_sword",name:"T6 Sword",icon:L("icons/t6 sword.png"),recipe:[{type:"gem",tier:6,amount:new d(64e5)}],craftTime:60,unlockRequirement:{type:"lifetime_gems",tier:6,amount:64e6},unitRole:"strength",strengthMultiplier:1e6,strengthExponent:.8}},ji=["t1_sword","t2_sword","t3_sword","t4_sword","t5_sword","t6_sword"],Yi=1,Wi=.1,Ki=15,ds=[{id:"t1_quest",name:"T1 Quest",difficulty:50,duration:60,rewards:{questBonusTiers:[1]},icon:L("icons/t1 gem.png"),group:"Output Bonuses"},{id:"t2_quest",name:"T2 Quest",difficulty:500,duration:60,rewards:{questBonusTiers:[1,2]},icon:L("icons/t2 gem.png"),group:"Output Bonuses"},{id:"t3_quest",name:"T3 Quest",difficulty:5e3,duration:60,rewards:{questBonusTiers:[1,2,3]},icon:L("icons/t3 gem.png"),group:"Output Bonuses"},{id:"t4_quest",name:"T4 Quest",difficulty:5e4,duration:60,rewards:{questBonusTiers:[1,2,3,4]},icon:L("icons/t4 gem.png"),group:"Output Bonuses"},{id:"t5_quest",name:"T5-T6 Quest",difficulty:2e6,duration:60,rewards:{questBonusTiers:[5,6]},icon:L("icons/t5 gem.png"),group:"Output Bonuses"}],zi=(t,n)=>{let e=1;for(const r of ds){const a=r.rewards.questBonusTiers;if(a&&a.includes(t)){const s=n[r.id]||0;s>0&&(e+=Math.sqrt(s*.1))}}return e},Zi=Object.freeze(Object.defineProperty({__proto__:null,ALL_MILITARY_UNIT_IDS:ji,COMPLETIONS_TO_UNLOCK:Ki,EXPEDITIONS:ds,MAX_SUCCESS_RATE:Yi,MILITARY_UNITS:Vi,MIN_SUCCESS_RATE:Wi,MODIFIERS:Gi,calculateQuestBonus:zi},Symbol.toStringTag,{value:"Module"})),It=["realm1","realm2"],Xi={realm1:"Prime Realm",realm2:"Realm of War"},gt=t=>t==="realm1"?Hi:Zi,Rt={};function fs(t,n,e){return t==="mana"?{type:"mana",amount:e}:{type:"recipe",recipeId:`gem_${n}`,amount:e}}for(const t of Mt){const n=vt[t],e=`gem_${t}`;Rt[e]={id:e,category:"gem",name:n.name,icon:n.icon,tier:t,recipe:n.recipe.map(r=>fs(r.type,r.tier,r.amount)),craftTime:n.craftTime,visibleByDefault:n.visibleByDefault,unlockCondition:n.unlockRequirement?{recipeId:`gem_${n.unlockRequirement.tier}`,threshold:n.unlockRequirement.amount}:void 0,manaEffect:n.effect}}for(const t of Nt){const n=xe[t],e=`flask_${t}`;Rt[e]={id:e,category:"flask",name:n.name,icon:n.icon,tier:t,recipe:n.recipe.map(r=>({type:"recipe",recipeId:`gem_${r.tier}`,amount:r.amount})),craftTime:n.craftTime,unlockCondition:{recipeId:`gem_${t}`,threshold:500}}}for(const t of It){const n=gt(t),e=n.MILITARY_UNITS;for(const r of n.ALL_MILITARY_UNIT_IDS){const a=e[r];Rt[r]||(Rt[r]={id:r,category:"military",name:a.name,icon:a.icon,recipe:a.recipe.map(s=>fs(s.type,s.tier,s.amount)),craftTime:a.craftTime,unlockCondition:{recipeId:`gem_${a.unlockRequirement.tier}`,threshold:a.unlockRequirement.amount},unitRole:a.unitRole,strengthMultiplier:a.strengthMultiplier,strengthExponent:a.strengthExponent,realmId:t,...t==="realm2"&&a.unlockRequirement.tier>=4?{crossRealmPooling:{minGlobalTier:2}}:{}})}}Rt.artifact_shard={id:"artifact_shard",category:"expedition_reward",name:"Artifact Shard",icon:L("icons/artifact shard.png"),recipe:[],craftTime:0};Rt.nullstone={id:"nullstone",category:"expedition_reward",name:"Nullstone",icon:L("icons/nullstone.png"),recipe:[],craftTime:0};const Ke=Rt,oe=Object.keys(Rt),yt=t=>{const n=Rt[t];if(!n)throw new Error(`Unknown recipe: ${t}`);return n},Pe=t=>oe.filter(n=>{const e=Rt[n];return e.category==="expedition_reward"?!1:e.category!=="military"?!0:e.realmId===t});Mt.map(t=>`gem_${t}`);Nt.map(t=>`flask_${t}`);const Qi=t=>oe.filter(n=>Rt[n].category==="military"&&Rt[n].realmId===t);oe.filter(t=>Rt[t].category==="military");const lr=["artifact_shard","nullstone"],Ma=t=>`gem_${t}`,Ji=t=>`flask_${t}`,Er=()=>{const t={};for(const n of oe)t[n]=new d(0);return t},et=(t,n)=>t[n]??new d(0),be=(t,n,e)=>{t[n]=et(t,n).add(e)},kt=(t,n,e)=>{t[n]=d.max(et(t,n).sub(e),0)},to=(t,n,e)=>et(t,n).gte(e),eo=t=>{const n={};for(const e of Object.keys(t)){const r=t[e];r&&!r.eq(0)&&(n[e]=r.toString())}return n},no=t=>{const n=Er();for(const[e,r]of Object.entries(t))r&&e in n&&(n[e]=new d(r));return n},Nr=()=>{const t={};for(const n of oe)t[n]={assignment:0,progress:0,lifetimeProduced:0};return t},ro=t=>{const n={};for(const[e,r]of Object.entries(t))(r.assignment!==0||r.progress!==0||r.lifetimeProduced!==0)&&(n[e]={a:r.assignment,p:r.progress,l:r.lifetimeProduced});return n},ao=t=>{const n=Nr();for(const[e,r]of Object.entries(t))e in n&&(n[e]={assignment:r.a??0,progress:r.p??0,lifetimeProduced:r.l??0});return n},Lt=(t,n)=>{var s;const e=yt(t);if(e.visibleByDefault||!e.unlockCondition)return!0;const{recipeId:r,threshold:a}=e.unlockCondition;return(((s=n[r])==null?void 0:s.lifetimeProduced)??0)>=a},de=(t,n)=>{for(const e of t)if(!Lt(e,n))return e;return null},Dn=(t,n)=>{var s;const e=yt(t);if(!e.unlockCondition)return null;const{recipeId:r,threshold:a}=e.unlockCondition;return{current:((s=n[r])==null?void 0:s.lifetimeProduced)??0,required:a}},so=t=>{var e;let n=0;for(const r of oe)n+=((e=t[r])==null?void 0:e.assignment)??0;return n},ms=(t,n)=>t-so(n),Kt=t=>{const n={};for(const e of Mt)n[e]=et(t,`gem_${e}`);return n},Te=t=>{const n={};for(const e of Nt)n[e]=et(t,`flask_${e}`);return n},Yt=t=>{const n={};for(const e of oe)yt(e).category==="military"&&(n[e]=et(t,e));return n},Ar=(t,n)=>{const e={},r={},a={};for(const s of n){const i=t[s];e[s]=(i==null?void 0:i.assignment)??0,r[s]=(i==null?void 0:i.progress)??0,a[s]=(i==null?void 0:i.lifetimeProduced)??0}return{crafterAssignments:e,craftProgress:r,lifetimeCrafted:a}},Wt={crafters:{id:"crafters",name:"Crafter",description:"Unlock a crafter for gem production",baseCost:new d(1),costExponent:10,maxLevel:300}},ps=Object.keys(Wt),io=[[{tier:1,amount:new d(50)}],[{tier:1,amount:new d(200)},{tier:2,amount:new d(100)}],[{tier:2,amount:new d(300)},{tier:3,amount:new d(200)}],[{tier:3,amount:new d(400)},{tier:4,amount:new d(300)}],[{tier:4,amount:new d(500)},{tier:5,amount:new d(400)}],[{tier:5,amount:new d(600)},{tier:6,amount:new d(500)}],[{tier:6,amount:new d(700)},{tier:7,amount:new d(600)}],[{tier:7,amount:new d(800)},{tier:8,amount:new d(700)}]],oo=Array.from({length:16},(t,n)=>{const e=Math.floor(n/2)+1,r=n%2===0?10:50;return[{tier:e,amount:new d(r)}]}),Hn=(t,n=5e4)=>Array.from({length:10},(e,r)=>[{tier:t,amount:new d(n).mul(d.pow(4,r))}]),Gn=t=>Array.from({length:8},(n,e)=>[{tier:t,amount:new d(1e4).mul(d.pow(1.4,e))},{tier:t,amount:new d(1e3).mul(d.pow(1.4,e)),recipeId:`t${t}_sword`}]),lo=[[{tier:1,amount:new d(10)}],[{tier:1,amount:new d(25)}],[{tier:1,amount:new d(50)}],[{tier:2,amount:new d(10)}],[{tier:2,amount:new d(25)}],[{tier:2,amount:new d(50)}],[{tier:3,amount:new d(10)}],[{tier:3,amount:new d(25)}],[{tier:3,amount:new d(50)}],[{tier:4,amount:new d(100)}]],co=[[{tier:1,amount:new d(100)},{tier:2,amount:new d(100)}],[{tier:1,amount:new d(500)},{tier:2,amount:new d(500)}],[{tier:2,amount:new d(100)},{tier:3,amount:new d(100)}],[{tier:2,amount:new d(500)},{tier:3,amount:new d(500)}],[{tier:3,amount:new d(100)},{tier:4,amount:new d(100)}],[{tier:3,amount:new d(500)},{tier:4,amount:new d(500)}],[{tier:4,amount:new d(100)},{tier:5,amount:new d(100)}],[{tier:4,amount:new d(500)},{tier:5,amount:new d(500)}],[{tier:5,amount:new d(100)},{tier:6,amount:new d(100)}],[{tier:5,amount:new d(500)},{tier:6,amount:new d(500)}]],uo=[[{tier:1,amount:new d(50)}],[{tier:1,amount:new d(100)}],[{tier:1,amount:new d(250)}],[{tier:2,amount:new d(50)}],[{tier:2,amount:new d(100)}],[{tier:2,amount:new d(250)}],[{tier:3,amount:new d(50)}],[{tier:3,amount:new d(100)}],[{tier:3,amount:new d(250)}],[{tier:4,amount:new d(1e3)}]],gs={craftersGuild:{id:"craftersGuild",name:"Crafter's Guild",description:"The first 30 crafters boost all crafters' output",tooltip:`Each of the first 30 crafters multiplies ALL crafting output (does not increase consumption).
Lv1: x1.03 per crafter, +0.005 per additional level.
Total multiplier = (1 + bonus) ^ min(total crafters, 30).
Applies to gems, flasks, and military.`,costs:io},gemManufacturing:{id:"gemManufacturing",name:"Gem Manufacturing",description:"Increases all gem output",tooltip:`Multiplies ALL gem crafting output by x1.2 per level.
Does not affect flask or military output.
Does not increase consumption.`,costs:oo},t1KnightStrength:{id:"t1KnightStrength",name:"T1 Knight Strength",description:"Increases T1 Knight combat strength",tooltip:`Multiplies T1 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:Hn(1,1e3)},t4KnightStrength:{id:"t4KnightStrength",name:"T4 Knight Strength",description:"Increases T4 Knight combat strength",tooltip:`Multiplies T4 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:Hn(4)},t7KnightStrength:{id:"t7KnightStrength",name:"T7 Knight Strength",description:"Increases T7 Knight combat strength",tooltip:`Multiplies T7 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:Hn(7)},cheaperGems:{id:"cheaperGems",name:"Cheaper Gems",description:"Reduces gem input requirements",tooltip:`Reduces gem crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, gems cost 50% less to craft.`,costs:lo},cheaperFlasks:{id:"cheaperFlasks",name:"Cheaper Flasks",description:"Reduces flask input requirements",tooltip:`Reduces flask crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, flasks cost 50% less to craft.`,costs:uo},cheaperMilitary:{id:"cheaperMilitary",name:"Cheaper Expedition Units",description:"Reduces military input requirements",tooltip:`Reduces military crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, expedition units cost 50% less to craft.`,costs:co},t4SwordEfficiency:{id:"t4SwordEfficiency",name:"T4 Sword Efficiency",description:"Reduces T4 Sword input requirements",tooltip:`Reduces T4 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T4 Swords cost 96% less to craft.`,costs:Gn(4)},t5SwordEfficiency:{id:"t5SwordEfficiency",name:"T5 Sword Efficiency",description:"Reduces T5 Sword input requirements",tooltip:`Reduces T5 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T5 Swords cost 96% less to craft.`,costs:Gn(5)},t6SwordEfficiency:{id:"t6SwordEfficiency",name:"T6 Sword Efficiency",description:"Reduces T6 Sword input requirements",tooltip:`Reduces T6 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T6 Swords cost 96% less to craft.`,costs:Gn(6)}},hs=Object.keys(gs),Mn=[...ps,...hs],Bt={...gs},vs=(t,n,e)=>t[n].gte(e),qr=(t,n,e,r)=>{const a=e==="realm1"?t:n,s=e==="realm1"?n:t,i={...a};for(const o of Object.keys(s)){const c=Ke[o];c!=null&&c.crossRealmPooling&&r>=c.crossRealmPooling.minGlobalTier&&(i[o]=(i[o]||new d(0)).add(s[o]||new d(0)))}return i},fo=(t,n,e,r,a)=>{const s=qr(t,n,r,a);for(const i of Object.keys(e)){const o=e[i];if(o>0&&(s[i]||new d(0)).lt(o))return!1}return!0},mo=(t,n,e,r,a)=>{let s={...t},i={...n};for(const o of Object.keys(e)){let c=e[o];if(c<=0)continue;const l=Ke[o];if((l==null?void 0:l.crossRealmPooling)&&a>=l.crossRealmPooling.minGlobalTier){const u=r==="realm1"?s:i,f=r==="realm1"?i:s,b=(u[o]||new d(0)).toNumber(),x=Math.min(c,b);x>0&&(u[o]=(u[o]||new d(0)).sub(x),c-=x),c>0&&(f[o]=(f[o]||new d(0)).sub(c)),r==="realm1"?(s=u,i=f):(i=u,s=f)}else{const u=r==="realm1"?s:i;u[o]=(u[o]||new d(0)).sub(c)}}return{realm1:s,realm2:i}},_r=()=>{const t={};for(const n of Mn)t[n]=0;return t},po=t=>{const n={};for(const e of Mn)t[e]!==0&&(n[e]=t[e]);return n},go=t=>{const n=_r();for(const e of Mn)t[e]!==void 0&&(n[e]=t[e]);return n},Ot=(t,n,e=0)=>{if(n in Wt){const r=Wt[n];return t[n]>=r.maxLevel}if(n in Bt){const r=Bt[n];return t[n]>=r.costs.length}return!0},ho=(t,n=0)=>t in Wt?Wt[t].maxLevel:t in Bt?Bt[t].costs.length:0,vo=(t,n)=>{const e=Wt[t];return n>=e.maxLevel?null:e.baseCost.mul(d.pow(e.costExponent,n))},ze=(t,n)=>{const e=Bt[t];return!e||n>=e.costs.length?null:e.costs[n]},Lr=(t,n,e=0)=>{if(n in Wt){const r=vo(n,t[n]);return r?{type:"mana",amount:r}:null}if(n in Bt){const r=ze(n,t[n]);return!r||r.length===0?null:{type:"flask",tier:r[0].tier,amount:r[0].amount}}return null},Ze=(t,n,e,r,a,s=0,i)=>{if(n in Wt){const o=Lr(t,n);return o?e.gte(o.amount):!1}if(n in Bt){const o=ze(n,t[n]);return o?o.every(c=>c.recipeId&&i?et(i,c.recipeId).gte(c.amount):vs(a,c.tier,c.amount)):!1}return!1},dn=t=>1+(t.crafters??0),bo=.03,yo=.005,xo=30,Fr=t=>{const n=t.craftersGuild??0;if(n<=0)return new d(1);const e=Math.min(dn(t),xo),r=bo+yo*(n-1);return new d(1+r).pow(e)},wo=1.2,Ur=t=>{const n=t.gemManufacturing??0;return n<=0?new d(1):new d(wo).pow(n)},Pr=.05,Or=t=>{const n=t.cheaperGems??0;return n<=0?new d(1):new d(1-Pr*n)},Br=t=>{const n=t.cheaperFlasks??0;return n<=0?new d(1):new d(1-Pr*n)},Dr=t=>{const n=t.cheaperMilitary??0;return n<=0?new d(1):new d(1-Pr*n)},So=.12,ko={t4_sword:"t4SwordEfficiency",t5_sword:"t5SwordEfficiency",t6_sword:"t6SwordEfficiency"},Ne=["t4SwordEfficiency","t5SwordEfficiency","t6SwordEfficiency"],Hr=(t,n)=>{const e=ko[n];if(!e)return new d(1);const r=t[e]??0;return r<=0?new d(1):new d(1-So*r)},Ia=(t,n)=>new d(1),Oe=(t,n)=>new d(1),cr=(t,n)=>new d(1),Ra=t=>new d(1),$a=t=>new d(1),In=t=>1,To=t=>1,bs=(t,n)=>0,Mo=1.3,Io={t1_knight:"t1KnightStrength",t4_knight:"t4KnightStrength",t7_knight:"t7KnightStrength"},Ae=["t1KnightStrength","t4KnightStrength","t7KnightStrength"],ys=(t,n)=>{const e=Io[n];if(!e)return 1;const r=t[e]??0;return r<=0?1:Math.pow(Mo,r)},Xe=t=>gt(t).MILITARY_UNITS,Ct=t=>gt(t).ALL_MILITARY_UNIT_IDS,Ro=(t,n)=>{const e=[];for(const r of It)if(r!==t)for(const a of gt(r).ALL_MILITARY_UNIT_IDS){const s=Ke[a];s!=null&&s.crossRealmPooling&&n>=s.crossRealmPooling.minGlobalTier&&e.push(a)}return e},Gt=(t,n)=>{const e=gt(t).ALL_MILITARY_UNIT_IDS,r=Ro(t,n);return r.length>0?[...e,...r]:[...e]},Me=(t,n)=>{const e={};Object.assign(e,gt(t).MILITARY_UNITS);for(const r of It){if(r===t)continue;const a=gt(r).MILITARY_UNITS;for(const s of Object.keys(a)){const i=Ke[s];i!=null&&i.crossRealmPooling&&n>=i.crossRealmPooling.minGlobalTier&&(e[s]=a[s])}}return e},$o=t=>{for(const n of It)for(const e of gt(n).ALL_MILITARY_UNIT_IDS){const r=Ke[e];if(r!=null&&r.crossRealmPooling&&t>=r.crossRealmPooling.minGlobalTier)return!0}return!1},Co=()=>{const t={};for(const n of It){const e=gt(n).MILITARY_UNITS;Object.assign(t,e)}return t},Vt=t=>gt(t).EXPEDITIONS,Gr=t=>gt(t).COMPLETIONS_TO_UNLOCK,Rn=t=>gt(t).calculateQuestBonus,xs=10,ws=40,Ss=20,fn=(t,n)=>{if(n){const e=ht[n];if(e)return e.maxLevel}return 1/0},Vr=(t,n,e=1/0)=>{if(n>=e)return{artifactShards:new d(1/0),gems:new d(1/0)};const r=d.pow(t.costScaling,n);return{artifactShards:t.cost.artifactShards.mul(r),gems:new d(0)}},Eo=(t,n)=>{const e=ht[t];return d.pow(1+e.upgradeBonus,n)},ks=(t,n,e)=>{if(!e)return{inputMultiplier:new d(1),outputMultiplier:new d(1)};const r=ht[t],a=Eo(t,n),s=r.baseOutputMultiplier.mul(a);return{inputMultiplier:new d(1),outputMultiplier:s}},jr=()=>{const t={},n={};for(const e of Ut)t[e]=!1,n[e]=0;return{owned:t,upgradeLevels:n,slotted:[],slotCount:0}},No=t=>({owned:t.owned,upgradeLevels:t.upgradeLevels,slotted:t.slotted,slotCount:t.slotCount}),Ao=t=>{const n=jr(),e=t==null?void 0:t.owned,r=t==null?void 0:t.upgradeLevels;if(e&&typeof e=="object"&&Object.keys(e).some(c=>c.startsWith("artifact_t")))return n;const a={},s={};for(const i of Ut)a[i]=(e==null?void 0:e[i])??!1,s[i]=(r==null?void 0:r[i])??0;return{owned:a,upgradeLevels:s,slotted:Array.isArray(t==null?void 0:t.slotted)?t.slotted.filter(i=>Ut.includes(i)):[],slotCount:(t==null?void 0:t.slotCount)??0}},Et=(t,n)=>t.owned[n]===!0,Ts=(t,n)=>{const e=ht[t];return e?n>=e.cost.artifactShards.toNumber():!1},Ms=(t,n,e,r=1/0)=>{if(n>=r)return!1;const a=ht[t];if(!a)return!1;const s=Vr(a,n,r);return e>=s.artifactShards.toNumber()},Is=(t,n)=>{let e=new d(1);for(const r of Ut){if(ht[r].tier!==n)continue;const{inputMultiplier:s}=ks(r,t.upgradeLevels[r]??0,t.owned[r]??!1);e=e.mul(s)}return e},Yr=(t,n)=>{let e=new d(1);for(const r of Ut){if(ht[r].tier!==n)continue;const{outputMultiplier:s}=ks(r,t.upgradeLevels[r]??0,t.owned[r]??!1);e=e.mul(s)}return e},Rs=t=>{const n="combat_artifact";if(!t.owned[n])return 1;const e=t.upgradeLevels[n]??0;return e<=0?1:Math.pow(1+ht[n].upgradeBonus,e)},$s=t=>{const n="crafting_speed";if(!t.owned[n])return 1;const e=t.upgradeLevels[n]??0;return e<=0?1:1+ht[n].upgradeBonus*e},qo=(t,n)=>{const e=ht[t];return[{type:"shards",icon:L("icons/artifact shard.png"),amount:e.cost.artifactShards,have:new d(n),canAfford:n>=e.cost.artifactShards.toNumber()}]},_o=(t,n,e,r)=>{const a=ht[t],s=Vr(a,n,e);return[{type:"shards",icon:L("icons/artifact shard.png"),amount:s.artifactShards,have:new d(r),canAfford:r>=s.artifactShards.toNumber()}]},Lo=1e3,Fo=100,Uo=.2,Po=.01,Cs=()=>({prestigeCounts:{},autoPrestige:{}}),Oo=t=>({prestigeCounts:t.prestigeCounts,autoPrestige:t.autoPrestige}),Bo=t=>{const n=t.prestigeCounts||{},e=t.autoPrestige||{};return{prestigeCounts:n,autoPrestige:e}},$n=t=>new d(Lo).mul(new d(Fo).pow(t)),Cn=(t,n,e)=>{const r=$n(e);return n.gte(r)},Es=(t,n)=>{const e=t[n]||0;return new d(1+e*Uo)},Ns=t=>{let n=0;for(const e of Object.values(t))n+=e;return new d(1+n*Po)},Dt=(t,n)=>Es(t,n).mul(Ns(t)),Do=()=>{const t={};for(const n of Mt)t[`gem_${n}`]=0;for(const n of Nt)t[`flask_${n}`]=0;for(const n of It)for(const e of Ct(n))t[`military_${e}`]=0;return t.artifact_shard=0,t.nullstone=0,t},Wr=()=>({tier:0,sacrificeCounts:Do(),activeSacrifice:null,sacrificeProgress:0}),ur=t=>t>=1,As=(t,n,e)=>{const r=t[`gem_${n}`]||0;return e(r)},qs=(t,n,e)=>{const r=t[`flask_${n}`]||0;return e(r)},Kr=(t,n)=>{const e=t.artifact_shard||0;return n(e)},zr=(t,n)=>{const e=t.nullstone||0;return n(e)},_s=(t,n,e)=>{const r=t[`military_${n}`]||0;return e(r)},Ho=t=>{const n={};for(const[e,r]of Object.entries(t.sacrificeCounts))r>0&&(n[e]=r);return{tier:t.tier,sacrificeCounts:n,activeSacrifice:t.activeSacrifice,sacrificeProgress:t.sacrificeProgress}},Go=t=>{const e={...Wr().sacrificeCounts};if(t.sacrificeCounts)for(const[r,a]of Object.entries(t.sacrificeCounts))r in e&&typeof a=="number"&&(e[r]=a);return{tier:t.tier??0,sacrificeCounts:e,activeSacrifice:t.activeSacrifice??null,sacrificeProgress:t.sacrificeProgress??0}},Ls=()=>({activeExpeditions:{},completionsPerExpedition:{},expeditionSetups:{},expeditionLog:[],pendingRepeats:{},portalBuilt:!1,heroicVictories:{}}),Vo=t=>({activeExpeditions:t.activeExpeditions,completionsPerExpedition:t.completionsPerExpedition,expeditionSetups:t.expeditionSetups,expeditionLog:t.expeditionLog,pendingRepeats:t.pendingRepeats,portalBuilt:t.portalBuilt,heroicVictories:t.heroicVictories}),Ca={expedition_3:"expedition_2",expedition_4:"expedition_3",expedition_5:"expedition_4"},jo=t=>t==="expedition_2"&&!Ca.expedition_2?null:Ca[t]||t,Yo=t=>{const n=[t.expeditionSetups,t.activeExpeditions,t.completionsPerExpedition,t.pendingRepeats];for(const e of n)if(e&&"expedition_5"in e)return!0;return!1},Wo=t=>{const n=Yo(t),e=u=>n?jo(u):u,r={};if(t.expeditionSetups)for(const[u,f]of Object.entries(t.expeditionSetups)){const b=e(u);if(!b)continue;const x={},p=f.assignedUnits;if(p)for(const g of Object.keys(p))x[g]=p[g];r[b]={assignedUnits:x,repeatIfUnitsAvailable:f.repeatIfUnitsAvailable||!1}}const a={};if(t.activeExpeditions)for(const[u,f]of Object.entries(t.activeExpeditions)){const b=e(u);b&&(a[b]=f.map(x=>{const p={},g=x.assignedUnits;if(g)for(const h of Object.keys(g))p[h]=g[h];return{...x,expeditionId:b,assignedUnits:p}}))}const s=t.completionsPerExpedition||{},i={};for(const[u,f]of Object.entries(s)){const b=e(u);b&&(i[b]=(i[b]||0)+f)}const o=t.pendingRepeats||{},c={};for(const[u,f]of Object.entries(o)){const b=e(u);b&&(c[b]=f)}const l=t.expeditionLog||[],m=[];for(const u of l){const f=e(u.expeditionId);f&&m.push({...u,expeditionId:f})}return{activeExpeditions:a,completionsPerExpedition:i,expeditionSetups:r,expeditionLog:m,pendingRepeats:c,portalBuilt:t.portalBuilt||!1,heroicVictories:t.heroicVictories||{}}},En=(t,n="realm1")=>Xe(n)[t]||Co()[t]||null,Zr=(t,n,e="realm1",r=0)=>{if(n<=0)return 0;const a=En(t,e);return a?Math.pow(n,a.strengthExponent)*(a.strengthMultiplier+r):0},Ko=(t,n,e="realm1",r=0)=>{const a=En(t,e);return!a||a.unitRole!=="strength"?0:Zr(t,n,e,r)},qt=(t,n="realm1",e,r,a=0)=>{let s=0;const i=Gt(n,a);for(const c of i){const l=e?bs():0;let m=Ko(c,t[c]||0,n,l);if(e){const u=ys(e,c);u>1&&(m*=u)}s+=m}const o=r?Rs(r):1;return s*o},mn=(t,n="realm1",e=0)=>{let r=0;const a=Gt(n,e);for(const s of a){const i=En(s,n);!i||i.unitRole!=="speed"||(r+=Zr(s,t[s]||0,n))}return r},At=(t,n="realm1",e=0)=>{let r=0;const a=Gt(n,e);for(const s of a){const i=En(s,n);!i||i.unitRole!=="taunt"||(r+=Zr(s,t[s]||0,n))}return r},Ht=t=>1+t/ws,pn=t=>1+t/Ss,zo=t=>1+t/xs,we=(t,n,e="realm1",r=0)=>{const a=Vt(e),s=Gr(e),i=a.findIndex(m=>m.id===t);if(i===0)return!0;const o=a[i];if(!o)return!1;if(o.heroic)return Qo(r);let c;return o.unlockRequirement?c=a.find(m=>m.id===o.unlockRequirement):c=a[i-1],c?(n[c.id]||0)>=s:!1},Zo=(t,n,e,r="realm1")=>{const a=n[t]||[],s=Tt(t,r);return s!=null&&s.heroic?a.length===0:!(a.length>=e)},Xo=(t="realm1")=>{const n={},e=Ct(t);for(const r of e)n[r]=0;return n},Xr=()=>({assignedUnits:Xo(),repeatIfUnitsAvailable:!0}),Tt=(t,n="realm1")=>Vt(n).find(r=>r.id===t),dr=t=>t*us/un,Be=(t,n)=>{const e=t/n*un;return Math.min(e,un)},Se=(t,n="realm1",e=0)=>{const r=Tt(t,n),a=r?r.duration*1e3:6e4;return Math.round(a/zo(e))},zt=(t,n)=>{if(!t.heroic)return t.difficulty??0;const e=n[t.id]||0;return Math.round(t.heroic.baseDifficulty*Math.pow(t.heroic.difficultyScaling,e))},le=(t,n="realm1")=>{var a;const e=Vt(n);let r=1;for(const s of e)if(((a=s.heroic)==null?void 0:a.rewardType)==="shard_drops"){const i=t[s.id]||0;i>0&&(r*=Math.pow(s.heroic.rewardScaling,i))}return r},Qr=(t,n,e="realm1")=>{var i;const r=Vt(e),a=n==="realm1"?"realm1_output":"realm2_output";let s=1;for(const o of r)if(((i=o.heroic)==null?void 0:i.rewardType)===a){const c=t[o.id]||0;c>0&&(s*=Math.pow(o.heroic.rewardScaling,c))}return s},Qo=t=>t>=2,Jr=(t,n,e,r,a,s)=>{const i=le(e,s),o=Dt(r.prestigeCounts,"artifact_shard").toNumber(),c=Dt(r.prestigeCounts,"nullstone").toNumber(),l=gt(s).MODIFIERS.calculateSacrificeBonus,m=Kr(a,l).toNumber(),u=zr(a,l).toNumber(),f={};return t.artifactShards&&(f.artifactShards=Math.round(t.artifactShards*n*i*o*m)),t.nullstone&&(f.nullstone=Math.round(t.nullstone*n*c*u)),t.questBonusTiers&&(f.questBonusTiers=t.questBonusTiers),f},gn=(t="realm1")=>({mana:new d(0),recipeInventory:Er(),recipeCrafting:Nr(),upgrades:_r(),autoBuyUpgrades:{},combat:Ls(),artifacts:jr(),altar:Wr(),prestige:Cs()}),ta=()=>({realms:{realm1:gn("realm1"),realm2:gn("realm2")},activeRealm:"realm1",realm2Unlocked:!1,globalTier:0,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0,paused:!1,backgroundImageOff:!1,tabHighlightingOff:!1,uiScale:1,totalPlaytime:0,skippedTime:0,timeWarpCharges:0,collapsedSections:[],dismissedTips:[]}),ea=(t,n)=>{let e=t[1].mul(vt[1].effect.value);for(const r of Mt.slice(1)){const a=t[r];if(a.gt(0)){const s=vt[r],i=new d(1).add(a.mul(s.effect.value.sub(1)));e=e.mul(i)}}return n&&(e=n(e)),e},Ea=(t,n,e,r)=>{const a=ea(n,r);return t.add(a.mul(e))},na=(t,n)=>t==="crafting"?`gem_${n}`:t==="flaskCrafting"?`flask_${n}`:String(n),ra=(t,n)=>{const e=t.activeRealm,r=t.realms[e],a={...r,...n(r)};return{realms:{...t.realms,[e]:a}}},Fs=t=>{const n=dn(t.upgrades);return ms(n,t.recipeCrafting)},Vn=(t,n,e)=>(r,a)=>{const s=n(),i=K(s),o=na(t,r),c=i.recipeCrafting[o],l=Fs(i),m=(c==null?void 0:c.assignment)??0;let u=m+a;u=Math.max(0,u),u=Math.min(m+l,u),u!==m&&e(ra(s,f=>({recipeCrafting:{...f.recipeCrafting,[o]:{...f.recipeCrafting[o],assignment:u}}})))},jn=(t,n,e)=>r=>{const a=n(),s=K(a),i=na(t,r),o=s.recipeCrafting[i],c=Fs(s),m=((o==null?void 0:o.assignment)??0)+c;e(ra(a,u=>({recipeCrafting:{...u.recipeCrafting,[i]:{...u.recipeCrafting[i],assignment:m}}})))},Yn=(t,n,e)=>r=>{const a=n(),s=na(t,r);e(ra(a,i=>({recipeCrafting:{...i.recipeCrafting,[s]:{...i.recipeCrafting[s],assignment:0,progress:0}}})))},Us=(t,n)=>{const e=t.activeRealm,r=t.realms[e],a={...r,...n(r)};return{realms:{...t.realms,[e]:a}}},Jo=(t,n)=>e=>{const r=t();if(r.activeRealm==="realm2"&&Ae.includes(e)||r.activeRealm==="realm1"&&Ne.includes(e))return!1;const a=K(r),s=r.globalTier,i=Kt(a.recipeInventory),o=Te(a.recipeInventory);if(Ot(a.upgrades,e,s)||!Ze(a.upgrades,e,a.mana,i,o,s,a.recipeInventory))return!1;let c=a.mana;const l={...a.recipeInventory};if(e in Bt){const m=ze(e,a.upgrades[e]);if(!m)return!1;for(const u of m)if(u.recipeId)kt(l,u.recipeId,u.amount);else{const f=Ji(u.tier);kt(l,f,u.amount)}}else{const m=Lr(a.upgrades,e,s);if(!m)return!1;m.type==="mana"&&(c=c.sub(m.amount))}return n(Us(r,()=>({mana:c,recipeInventory:l,upgrades:{...a.upgrades,[e]:a.upgrades[e]+1}}))),!0},tl=(t,n)=>e=>{const r=t(),a=K(r),s=a.autoBuyUpgrades[e]??!1;n(Us(r,()=>({autoBuyUpgrades:{...a.autoBuyUpgrades,[e]:!s}})))},aa=(t,n)=>{const e=t.activeRealm,r=t.realms[e],a={...r,...n(r)};return{realms:{...t.realms,[e]:a}}},el=(t,n)=>(e,r)=>{const a=t(),s=K(a),i={...s.combat.pendingRepeats};r.repeatIfUnitsAvailable||delete i[e],n(aa(a,()=>({combat:{...s.combat,expeditionSetups:{...s.combat.expeditionSetups,[e]:r},pendingRepeats:i}})))},nl=(t,n)=>(e,r,a=!1)=>{const s=t(),i=K(s),o=Gt(s.activeRealm,s.globalTier),c=Tt(e,s.activeRealm);if(!c||!we(e,i.combat.completionsPerExpedition,s.activeRealm,s.globalTier))return!1;const l=In(i.upgrades);if(!Zo(e,i.combat.activeExpeditions,l,s.activeRealm))return!1;c.heroic&&(a=!1);const m={};for(const F of o)m[F]=r[F]||0;const u=mn(m,s.activeRealm,s.globalTier),f=At(m,s.activeRealm,s.globalTier),b=Ht(f),x=pn(f),g=(c.heroic?zt(c,i.combat.heroicVictories):c.difficulty??0)*b,h=qt(m,s.activeRealm,i.upgrades,i.artifacts,s.globalTier),v=dr(g);if(h<v)return!1;const y=Yt(s.realms.realm1.recipeInventory),T=Yt(s.realms.realm2.recipeInventory);let M=null,E=null,I={...i.recipeInventory};if(!fo(y,T,m,s.activeRealm,s.globalTier))return!1;const R=mo(y,T,m,s.activeRealm,s.globalTier),_=s.activeRealm==="realm1"?"realm2":"realm1",V=_==="realm1"?y:T,B=_==="realm1"?R.realm1:R.realm2;let $=!1;for(const F of o){const q=V[F]??new d(0),tt=B[F]??new d(0);if(!q.eq(tt)){$=!0;break}}if($){M={...s.realms.realm1.recipeInventory},E={...s.realms.realm2.recipeInventory};for(const F of o)if((m[F]||0)>0){const tt=y[F]??new d(0),j=R.realm1[F]??new d(0),ot=tt.sub(j);ot.gt(0)&&kt(M,F,ot);const U=T[F]??new d(0),k=R.realm2[F]??new d(0),W=U.sub(k);W.gt(0)&&kt(E,F,W)}}else for(const F of o){const q=m[F]||0;q>0&&kt(I,F,new d(q))}const C={expeditionId:e,assignedUnits:m,strength:h,successRate:Be(h,g),startTime:Date.now(),duration:Se(e,s.activeRealm,u),repeatIfUnitsAvailable:a,speed:u,tauntMultiplier:x},Y=i.combat.activeExpeditions[e]||[];return n($&&M&&E?{realms:{...s.realms,realm1:{...s.realms.realm1,recipeInventory:M},realm2:{...s.realms.realm2,recipeInventory:E},[s.activeRealm]:{...s.realms[s.activeRealm],recipeInventory:s.activeRealm==="realm1"?M:E,combat:{...i.combat,activeExpeditions:{...i.combat.activeExpeditions,[e]:[...Y,C]}}}}}:aa(s,()=>({recipeInventory:I,combat:{...i.combat,activeExpeditions:{...i.combat.activeExpeditions,[e]:[...Y,C]}}}))),!0},rl=(t,n)=>e=>{const r=t(),a=K(r),s=Gt(r.activeRealm,r.globalTier),i=a.combat.activeExpeditions[e]||[],o={...a.recipeInventory};for(const u of i)for(const f of s){const b=u.assignedUnits[f]||0;b>0&&be(o,f,new d(b))}const c={...a.combat.activeExpeditions};delete c[e];const l={...a.combat.expeditionSetups};delete l[e];const m={...a.combat.pendingRepeats};delete m[e],n(aa(r,()=>({recipeInventory:o,combat:{...a.combat,activeExpeditions:c,expeditionSetups:l,pendingRepeats:m}})))},De=1e3,Ps=(t,n)=>{const e=t.activeRealm,r=t.realms[e],a={...r,...n(r)};return{realms:{...t.realms,[e]:a}}},al=(t,n)=>e=>{const r=t(),a=K(r),s=ht[e];if(!s||Et(a.artifacts,e))return!1;const i=et(a.recipeInventory,"artifact_shard").toNumber();if(!Ts(e,i))return!1;const o={...a.recipeInventory};return kt(o,"artifact_shard",s.cost.artifactShards),n(Ps(r,()=>({recipeInventory:o,artifacts:{...a.artifacts,owned:{...a.artifacts.owned,[e]:!0},upgradeLevels:{...a.artifacts.upgradeLevels,[e]:1}}}))),!0},sl=(t,n)=>e=>{const r=t(),a=K(r),s=ht[e];if(!s||!Et(a.artifacts,e))return!1;const i=a.artifacts.upgradeLevels[e]??0,o=fn(a.altar.tier,e);if(i>=o)return!1;const c=et(a.recipeInventory,"artifact_shard").toNumber();if(!Ms(e,i,c,o))return!1;const l=Vr(s,i,o),m={...a.recipeInventory};return kt(m,"artifact_shard",l.artifactShards),n(Ps(r,()=>({recipeInventory:m,artifacts:{...a.artifacts,upgradeLevels:{...a.artifacts.upgradeLevels,[e]:i+1}}}))),!0},il=(t,n)=>e=>{const r=t(),a=r.realms.realm1,s=r.realms.realm2;if(!Et(a.artifacts,e)||et(a.recipeInventory,"nullstone").toNumber()<De)return!1;const o=a.artifacts.upgradeLevels[e]??0,c=Et(s.artifacts,e),l=s.artifacts.upgradeLevels[e]??0;if(c&&o<=l)return!1;const m={...a.recipeInventory};kt(m,"nullstone",new d(De));const u={...a.artifacts,owned:{...a.artifacts.owned,[e]:!1},upgradeLevels:{...a.artifacts.upgradeLevels,[e]:0}},f={...s.artifacts,owned:{...s.artifacts.owned,[e]:!0},upgradeLevels:{...s.artifacts.upgradeLevels,[e]:o}};return n({realms:{...r.realms,realm1:{...a,recipeInventory:m,artifacts:u},realm2:{...s,artifacts:f}}}),!0},Os=5,Bs=Mt.map(t=>({id:`gem_${t}`,type:"gem",tier:t,name:`T${t} Mana Gem`})),Ds=Nt.map(t=>({id:`flask_${t}`,type:"flask",tier:t,name:`T${t} Flask`})),fr=[{id:"artifact_shard",type:"expedition_reward",name:"Artifact Shard"},{id:"nullstone",type:"expedition_reward",name:"Nullstone"}],Hs=t=>{const n=Ct(t),e=Xe(t);return[...Bs,...Ds,...n.map(r=>({id:`military_${r}`,type:"military",militaryId:r,name:e[r].name})),...t==="realm1"?fr:[]]},Qe=t=>{if(t.startsWith("gem_")){const n=parseInt(t.slice(4));return Bs.find(e=>e.tier===n)}if(t.startsWith("flask_")){const n=parseInt(t.slice(6));return Ds.find(e=>e.tier===n)}if(t.startsWith("military_")){const n=t.slice(9);return{id:t,type:"military",militaryId:n,name:n}}if(t==="artifact_shard")return fr[0];if(t==="nullstone")return fr[1]},ke={1:{manaRequirement:new d(1e20),crafterSpeedMultiplier:1.2,artifactUpgradeCap:10},2:{manaRequirement:new d(1e20),crafterSpeedMultiplier:7/6,artifactUpgradeCap:100}},mr=2,Gs=!0,hn=(t,n,e)=>{const r=n+1;if(r>mr)return!1;const a=ke[r];if(!a)return!1;if(e!==void 0){if(r===2&&Gs){if(e!=="realm2")return!1}else if(e!=="realm1")return!1}return t.gte(a.manaRequirement)},qe=t=>t===2&&Gs?"realm2":"realm1",ol=t=>{let n=1;for(let e=1;e<=t;e++)ke[e]&&(n*=ke[e].crafterSpeedMultiplier);return n},Vs=(t,n)=>{const e=t.activeRealm,r=t.realms[e],a={...r,...n(r)};return{realms:{...t.realms,[e]:a}}},Na=(t,n,e,r="realm1")=>{const a=gn(r),s={...t.altar,tier:n,activeSacrifice:null,sacrificeProgress:0},i={...a,altar:s,prestige:t.prestige,combat:{...a.combat,portalBuilt:t.combat.portalBuilt,heroicVictories:t.combat.heroicVictories,completionsPerExpedition:t.combat.completionsPerExpedition},...e&&{artifacts:t.artifacts}};if(e){const o=t.recipeCrafting.artifact_shard;o&&i.recipeCrafting.artifact_shard&&(i.recipeCrafting.artifact_shard.lifetimeProduced=o.lifetimeProduced);const c=t.recipeCrafting.nullstone;c&&i.recipeCrafting.nullstone&&(i.recipeCrafting.nullstone.lifetimeProduced=c.lifetimeProduced)}return i},ll=(t,n)=>()=>{const e=t(),r=K(e),a=e.globalTier+1,s=qe(a);if(e.activeRealm!==s||!hn(r.mana,e.globalTier,e.activeRealm))return!1;const i=a>=2;if(a===2){const o={};for(const c of It){const l=e.realms[c];o[c]=Na(l,a,i,c)}n({realms:o,globalTier:a,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}else{const o=Na(r,a,i,e.activeRealm);n({realms:{...e.realms,[e.activeRealm]:o},globalTier:a,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}return!0},cl=(t,n)=>e=>{const r=t(),a=K(r);if(r.globalTier<1)return!1;const s=Qe(e);if(!s)return!1;const i=gt(r.activeRealm);if((a.altar.sacrificeCounts[e]||0)>=i.MODIFIERS.sacrificeCap)return!1;let c=null;return s.type==="gem"&&s.tier!==void 0?c=`gem_${s.tier}`:s.type==="flask"&&s.tier!==void 0?c=`flask_${s.tier}`:s.type==="military"&&s.militaryId!==void 0?c=s.militaryId:s.type==="expedition_reward"&&(c=e),(c?et(a.recipeInventory,c).gte(1):!1)?(n(Vs(r,()=>({altar:{...a.altar,activeSacrifice:e,sacrificeProgress:0}}))),!0):!1},ul=(t,n)=>()=>{const e=t(),r=K(e);n(Vs(e,()=>({altar:{...r.altar,activeSacrifice:null,sacrificeProgress:0}})))},dl=(t,n)=>e=>{const r=t(),a=r.activeRealm,s=K(r),i=et(s.recipeInventory,e),o=s.prestige.prestigeCounts[e]||0;if(!Cn(e,i,o))return!1;const c=$n(o),l={...s.recipeInventory};l[e]=i.sub(c);const m={...s.prestige.prestigeCounts};return m[e]=o+1,n(u=>({realms:{...u.realms,[a]:{...u.realms[a],recipeInventory:l,prestige:{...u.realms[a].prestige,prestigeCounts:m}}}})),!0},fl=(t,n)=>e=>{const r=t(),a=r.activeRealm,i=K(r).prestige.autoPrestige[e]??!1;n(o=>({realms:{...o.realms,[a]:{...o.realms[a],prestige:{...o.realms[a].prestige,autoPrestige:{...o.realms[a].prestige.autoPrestige,[e]:!i}}}}}))},sa="0.69",Aa=t=>({mana:t.mana.toString(),recipeInventory:eo(t.recipeInventory),recipeCrafting:ro(t.recipeCrafting),upgrades:po(t.upgrades),autoBuyUpgrades:t.autoBuyUpgrades,combat:Vo(t.combat),artifacts:No(t.artifacts),altar:Ho(t.altar),prestige:Oo(t.prestige)}),qa=(t,n="realm1")=>{var o,c;if(!t)return gn(n);const e=t.artifacts?Ao(t.artifacts):jr(),r=t.combat?Wo(t.combat):Ls(),a=t.recipeInventory?no(t.recipeInventory):Er(),s=t.recipeCrafting?ao(t.recipeCrafting):Nr();let i=t.upgrades?go(t.upgrades):_r();if((o=t.upgrades)!=null&&o.r1MilitaryStrength&&!((c=t.upgrades)!=null&&c.t1KnightStrength)){const l=t.upgrades.r1MilitaryStrength;i={...i,t1KnightStrength:l,t4KnightStrength:l,t7KnightStrength:l}}return{mana:new d(t.mana||0),recipeInventory:a,recipeCrafting:s,upgrades:i,autoBuyUpgrades:t.autoBuyUpgrades||{},combat:r,artifacts:e,altar:t.altar?Go(t.altar):Wr(),prestige:t.prestige?Bo(t.prestige):Cs()}},js=t=>JSON.stringify({version:sa,realms:{realm1:Aa(t.realms.realm1),realm2:Aa(t.realms.realm2)},activeRealm:t.activeRealm,realm2Unlocked:t.realm2Unlocked,globalTier:t.globalTier,backgroundImageOff:t.backgroundImageOff,uiScale:t.uiScale,lastFrameTimestamp:t.lastFrameTimestamp,totalPlaytime:t.totalPlaytime,skippedTime:t.skippedTime,timeWarpCharges:t.timeWarpCharges,collapsedSections:t.collapsedSections,dismissedTips:t.dismissedTips,paused:t.paused}),Ys=t=>{var n;try{const e=JSON.parse(t),r=e.version||null;if(!r)return{state:null,incompatible:!0,savedVersion:r};if(parseFloat(r)<.4)return{state:null,incompatible:!0,savedVersion:r};if(!e.realms||!((n=e.realms.realm1)!=null&&n.recipeInventory))return{state:null,incompatible:!0,savedVersion:r};const a=It.includes(e.activeRealm)?e.activeRealm:"realm1",s=qa(e.realms.realm1,"realm1"),i=qa(e.realms.realm2,"realm2"),o=e.globalTier??s.altar.tier;return{state:{realms:{realm1:s,realm2:i},activeRealm:a,realm2Unlocked:e.realm2Unlocked??!1,globalTier:o,backgroundImageOff:e.backgroundImageOff??!1,uiScale:e.uiScale??1,lastFrameTimestamp:e.lastFrameTimestamp||Date.now(),totalPlaytime:e.totalPlaytime??0,skippedTime:e.skippedTime??0,timeWarpCharges:e.timeWarpCharges??0,collapsedSections:Array.isArray(e.collapsedSections)?e.collapsedSections:[],dismissedTips:Array.isArray(e.dismissedTips)?e.dismissedTips:[],paused:e.paused??!1},incompatible:!1,savedVersion:r}}catch{return{state:null,incompatible:!1,savedVersion:null}}},He="evercraft-save",Ge="evercraft-last-frame",Ve="evercraft-last-save",ml=5e3;let ia=!1,oa=0;const pl=()=>ia,gl=()=>oa,_a=()=>{ia=!1,oa=0},pr=()=>sa,hl=t=>()=>{localStorage.removeItem(He),localStorage.removeItem(Ge),localStorage.removeItem(Ve),t(ta())},vl=t=>()=>{const n=t();return btoa(js(n))},bl=(t,n,e)=>r=>{try{const a=atob(r),s=Ys(a);if(s.incompatible){let i=0;try{i=JSON.parse(a).globalTier??0}catch{}const o=ta();return n(o),localStorage.removeItem(He),localStorage.removeItem(Ge),localStorage.removeItem(Ve),e(!0),{success:!1,incompatible:!0,oldTier:i}}return s.state?(n({...s.state}),e(!0),{success:!0,incompatible:!1}):{success:!1,incompatible:!1}}catch{return{success:!1,incompatible:!1}}},yl=(t,n)=>(e=!1)=>{const r=t(),a=Date.now();!e&&a-r.lastSaveTimestamp<ml||(localStorage.setItem(He,js(r)),localStorage.setItem(Ge,r.lastFrameTimestamp.toString()),localStorage.setItem(Ve,a.toString()),n({lastSaveTimestamp:a}))},xl=t=>()=>{const n=localStorage.getItem(He),e=localStorage.getItem(Ge),r=localStorage.getItem(Ve);if(n){const a=Ys(n);if(a.incompatible){try{oa=JSON.parse(n).globalTier??0}catch{}ia=!0,localStorage.removeItem(He),localStorage.removeItem(Ge),localStorage.removeItem(Ve);return}a.state&&t({...a.state,lastFrameTimestamp:e?parseInt(e,10):Date.now(),lastSaveTimestamp:r?parseInt(r,10):0})}},La=(t,n,e)=>{const r=Oe(),a=e?Is(e,n):new d(1);return r.mul(a)},Ws=(t,n,e,r,a,s,i,o)=>{const c=yt(t),l=c.tier,m=c.category,u=Fr(n);let f=new d(i).mul(u);return m==="gem"&&l?f=f.mul(Oe()).mul(cr()).mul(Ia()).mul(Yr(e,l)).mul(l<=4?Ra():1).mul(l>=5&&l<=6?$a():1).mul(As(r.sacrificeCounts,l,a)).mul(s).mul(Ur(n)):m==="flask"&&l?f=f.mul(Oe()).mul(cr()).mul(Ia()).mul(l<=4?Ra():1).mul(l>=5&&l<=6?$a():1).mul(qs(r.sacrificeCounts,l,a)).mul(s):m==="military"&&(f=f.mul(_s(r.sacrificeCounts,t,a))),o&&(f=f.mul(Dt(o.prestigeCounts,t))),f},Wn=(t,n,e,r,a,s,i,o)=>{const c=yt(t),l=c.tier,m=c.category,u=[];(m==="gem"||m==="flask")&&l?(u.push({label:"Production mult",value:Oe()}),u.push({label:"Yield mult",value:cr()}),m==="gem"?(u.push({label:"Artifact output",value:Yr(e,l)}),u.push({label:"Sacrifice bonus",value:As(r.sacrificeCounts,l,a)}),u.push({label:"Gem Manufacturing",value:Ur(n)})):u.push({label:"Sacrifice bonus",value:qs(r.sacrificeCounts,l,a)}),u.push({label:"Quest bonus",value:new d(s)})):m==="military"&&u.push({label:"Sacrifice bonus",value:_s(r.sacrificeCounts,t,a)}),u.push({label:"Heroic mastery",value:new d(i)}),u.push({label:"Crafter's Guild",value:Fr(n)}),u.push({label:"Prestige",value:o?Dt(o.prestigeCounts,t):new d(1)});const f=u.reduce((b,x)=>b.mul(x.value),new d(1));return{multipliers:u,total:f}},Kn=(t,n,e,r)=>{const a=yt(t),s=a.tier,i=a.category,o=[];if((i==="gem"||i==="flask")&&s&&(o.push({label:"Production mult",value:Oe()}),o.push({label:"Artifact input",value:Is(e,s)})),i==="gem"&&o.push({label:"Cheaper Gems",value:Or(n)}),i==="flask"&&(o.push({label:"Flask recipe mult",value:new d(r)}),o.push({label:"Cheaper Flasks",value:Br(n)})),i==="military"){o.push({label:"Cheaper Expedition Units",value:Dr(n)});const l=Hr(n,t);l.eq(1)||o.push({label:"Sword Efficiency",value:l})}const c=o.reduce((l,m)=>l.mul(m.value),new d(1));return{multipliers:o,total:c}},_e=(t,n,e,r)=>{const a=yt(t),s=a.tier,i=a.category;return a.recipe.map(o=>{let c=o.amount;if(i==="gem"&&s){if(!(s===1&&o.type==="mana")){const m=La(n,s,e);c=c.mul(m)}c=c.mul(Or(n))}else if(i==="flask"&&s){const l=La(n,s,e);c=c.mul(l).mul(r),c=c.mul(Br(n))}else i==="military"&&(c=c.mul(Dr(n)),c=c.mul(Hr(n,t)));return{type:o.type,recipeId:o.recipeId,amount:c}})},la=(t,n,e,r,a)=>{const s=yt(t);let o=ol(r)/a;return s.category==="military"&&(o*=To()),o*=$s(e),o},wl=(t,n,e,r,a,s,i,o,c,l,m,u,f)=>{const b=Rn(c),x=l.completionsPerExpedition??{};let p=new d(0);const g={},h=Pe(c);for(const v of h){g[v]=new d(0);const y=t[v];if(!y||y.assignment<=0)continue;const T=yt(v),M=T.tier??0,E=b?b(M,x):1,R=la(v,n,e,a,s)/T.craftTime,_=Ws(v,n,e,r,i,E,u,f);g[v]=g[v].add(new d(y.assignment).mul(R).mul(_));const V=_e(v,n,e,m);for(const B of V){const $=B.amount.mul(y.assignment).mul(R);B.type==="mana"?p=p.sub($):B.recipeId&&(g[B.recipeId]||(g[B.recipeId]=new d(0)),g[B.recipeId]=g[B.recipeId].sub($))}}if(r.activeSacrifice&&o){const v=r.activeSacrifice;let y=null;v.startsWith("military_")?y=v.replace("military_",""):y=v,y&&g[y]!==void 0?g[y]=g[y].sub(new d(o)):y&&(g[y]=new d(-o))}return{mana:p,recipes:g}},Sl=10080*60*1e3,Fa=(t,n,e,r)=>{for(const a of t){const s=a.amount.mul(n);if(a.type==="mana"){if(e.lt(s))return!1}else if(a.recipeId&&!to(r,a.recipeId,s))return!1}return!0},kl=(t,n,e,r)=>{let a=e;for(const s of t){const i=s.amount.mul(n);s.type==="mana"?a=a.sub(i):s.recipeId&&kt(r,s.recipeId,i)}return a},Tl=(t,n,e,r,a,s={})=>{const i=gt(t),o=i.MODIFIERS.craftTimeMultiplier,c=i.MODIFIERS.flaskRecipeMultiplier,l=i.MODIFIERS.manaModifier,m=i.MODIFIERS.calculateSacrificeBonus,u=i.MODIFIERS.sacrificeCap,f=i.MODIFIERS.sacrificeBatchSize,b=Rn(t),x=Qr(s,t);let p=n.mana;const g={};for(const[U,k]of Object.entries(n.recipeInventory))g[U]=k;const h={};for(const[U,k]of Object.entries(n.recipeCrafting))h[U]={...k};const v=Pe(t),y={},T={},M={};for(const U of v){const W=yt(U).tier??0,P=b?b(W,n.combat.completionsPerExpedition):1;y[U]=_e(U,n.upgrades,n.artifacts,c),T[U]=Ws(U,n.upgrades,n.artifacts,n.altar,m,P,x,n.prestige),M[U]=la(U,n.upgrades,n.artifacts,a,o)}const E=U=>{const k=h[U];if(!k||k.assignment<=0)return!1;const W=y[U];if(!Fa(W,k.assignment,p,g))return!1;p=kl(W,k.assignment,p,g);const P=T[U].mul(k.assignment);return be(g,U,P),k.lifetimeProduced+=P.toNumber(),k.progress=0,!0},I=()=>{for(const U of v){const k=h[U];k&&k.progress>=1&&E(U)}},R=()=>Kt(g);let _=e/1e3;if(_>600){const k={};for(const P of v){const D=h[P];if(!D||D.assignment<=0||!Lt(P,h))continue;const X=yt(P),N=M[P],O=60/(X.craftTime/N)*D.assignment;k[P]={costs:y[P].map(J=>({...J,amount:J.amount.mul(O)})),output:T[P].mul(O)}}let W=0;for(;_>0;){if(W++,W>10100){console.error(`[processRealm ${t}] crafting loop exceeded 10100 iterations, breaking!`);break}const P=Math.min(60,_),D=P/60;p=Ea(p,R(),new d(P),l);const X=[];for(const N in k){const A=k[N];if(Fa(A.costs.map(O=>({...O,amount:O.amount.mul(D)})),1,p,g)){for(const O of A.costs){const J=O.amount.mul(D);O.type==="mana"?p=p.sub(J):O.recipeId&&kt(g,O.recipeId,J)}X.push(N)}}for(const N of X){const A=k[N].output.mul(D);be(g,N,A);const O=h[N];O&&(O.lifetimeProduced+=A.toNumber())}_-=P}for(const P of v){const D=h[P];D&&(D.progress=0)}}else{let U=0;for(;_>0;){if(U++,U>1e4){console.error(`[processRealm ${t}] crafting loop exceeded 10000 iterations, breaking!`);break}I();let k=_,W=null;for(const P of v){const D=h[P];if(!D||D.assignment<=0||!Lt(P,h)||D.progress>=1)continue;const X=yt(P),N=M[P]/X.craftTime,A=(1-D.progress)/N;A<=k&&(k=A,W=P)}p=Ea(p,R(),new d(k),l);for(const P of v){const D=h[P];if(!D||D.assignment<=0||!Lt(P,h)||D.progress>=1)continue;const X=yt(P),N=M[P]/X.craftTime;D.progress+=k*N}if(_-=k,W===null)break;E(W)||(h[W].progress=1)}for(const k of v){const W=h[k];W&&(W.progress=Math.min(1,W.progress))}}const $=Ct(t);let C={...n.combat},Y=0;const F=[],q=In(n.upgrades);let tt=0;for(;;){if(tt++,tt>1e4){console.error(`[processRealm ${t}] expedition loop exceeded 10000 iterations, breaking!`);break}let U=r+1,k=null,W=-1;for(const[st,it]of Object.entries(C.activeExpeditions))for(let nt=0;nt<it.length;nt++){const ut=it[nt],xt=ut.startTime+ut.duration;xt<=r&&xt<U&&(U=xt,k=st,W=nt)}if(k===null)break;const P=C.activeExpeditions[k],D=P[W],N=Math.random()<D.successRate,A=Tt(k,t);let O,J=0;if(N&&A){O=A.rewards;const st=D.tauntMultiplier??1,it=le(C.heroicVictories,t),nt=Dt(n.prestige.prestigeCounts,"artifact_shard").toNumber(),ut=Dt(n.prestige.prestigeCounts,"nullstone").toNumber(),xt=Kr(n.altar.sacrificeCounts,m).toNumber(),Zt=zr(n.altar.sacrificeCounts,m).toNumber();J=Math.round((O.artifactShards||0)*st*it*nt*xt);const Fn=Math.round((O.nullstone||0)*st*ut*Zt);J>0&&(be(g,"artifact_shard",new d(J)),h.artifact_shard&&(h.artifact_shard.lifetimeProduced+=J)),Y+=Fn,C={...C,completionsPerExpedition:{...C.completionsPerExpedition,[k]:(C.completionsPerExpedition[k]||0)+1}},A.heroic&&(C={...C,heroicVictories:{...C.heroicVictories,[k]:(C.heroicVictories[k]||0)+1}})}const lt=D.tauntMultiplier??1,rt=O&&{...O,...O.artifactShards?{artifactShards:J}:{},...O.nullstone?{nullstone:Math.round(O.nullstone*lt)}:{}};F.push({expeditionId:k,success:N,successRate:D.successRate,timestamp:U,rewards:rt});const Q=[...P];if(Q.splice(W,1),Q.length>0)C={...C,activeExpeditions:{...C.activeExpeditions,[k]:Q}};else{const{[k]:st,...it}=C.activeExpeditions;if(C={...C,activeExpeditions:it},A!=null&&A.heroic&&C.expeditionSetups[k]){const{[k]:nt,...ut}=C.expeditionSetups;C={...C,expeditionSetups:ut}}}if(D.repeatIfUnitsAvailable){const st=C.expeditionSetups[k];if(st&&st.repeatIfUnitsAvailable&&A){let it=!0;for(const ue of $){const Re=st.assignedUnits[ue]||0;if(Re>0&&et(g,ue).lt(Re)){it=!1;break}}const nt=C.activeExpeditions[k]||[],ut=nt.length<q,xt=mn(st.assignedUnits,t,a),Zt=At(st.assignedUnits,t,a),Fn=Ht(Zt),wi=pn(Zt),ya=(A.heroic?Math.round(A.heroic.baseDifficulty*Math.pow(A.heroic.difficultyScaling,C.heroicVictories[k]||0)):A.difficulty??0)*Fn,Un=qt(st.assignedUnits,t,n.upgrades,n.artifacts,a),Si=dr(ya),xa=Un>=Si;if(it&&ut&&xa){for(const Re of $){const wa=st.assignedUnits[Re]||0;wa>0&&kt(g,Re,new d(wa))}const ue={expeditionId:k,assignedUnits:{...st.assignedUnits},strength:Un,successRate:Be(Un,ya),startTime:U,duration:Se(k,t,xt),repeatIfUnitsAvailable:!0,speed:xt,tauntMultiplier:wi};C={...C,activeExpeditions:{...C.activeExpeditions,[k]:[...nt,ue]}}}else if(!it&&ut&&xa){const ue=C.pendingRepeats[k]||0;C={...C,pendingRepeats:{...C.pendingRepeats,[k]:ue+1}}}}}}if(F.length>0){const U=[...C.expeditionLog,...F],k={};for(const P of U)k[P.expeditionId]||(k[P.expeditionId]=[]),k[P.expeditionId].push(P);const W=[];for(const P of Object.values(k))W.push(...P.slice(-20));W.sort((P,D)=>P.timestamp-D.timestamp),C={...C,expeditionLog:W}}for(const[U,k]of Object.entries(C.pendingRepeats)){if(k<=0)continue;const W=C.expeditionSetups[U],P=Tt(U,t);if(!W||!P)continue;const D=C.activeExpeditions[U]||[];if(D.length>=q)continue;const X=mn(W.assignedUnits,t,a),N=At(W.assignedUnits,t,a),A=Ht(N),O=pn(N),lt=(P.heroic?Math.round(P.heroic.baseDifficulty*Math.pow(P.heroic.difficultyScaling,C.heroicVictories[U]||0)):P.difficulty??0)*A,rt=qt(W.assignedUnits,t,n.upgrades,n.artifacts,a),Q=dr(lt);if(rt<Q)continue;let st=!0;for(const it of $){const nt=W.assignedUnits[it]||0;if(nt>0&&et(g,it).lt(nt)){st=!1;break}}if(st){for(const nt of $){const ut=W.assignedUnits[nt]||0;ut>0&&kt(g,nt,new d(ut))}const it={expeditionId:U,assignedUnits:{...W.assignedUnits},strength:rt,successRate:Be(rt,lt),startTime:r,duration:Se(U,t,X),repeatIfUnitsAvailable:!0,speed:X,tauntMultiplier:O};C={...C,activeExpeditions:{...C.activeExpeditions,[U]:[...D,it]},pendingRepeats:{...C.pendingRepeats,[U]:k-1}}}}let j={...n.altar};if(j.activeSacrifice&&a>=1){const U=Qe(j.activeSacrifice);if(U)if((j.sacrificeCounts[j.activeSacrifice]||0)>=u)j={...j,activeSacrifice:null,sacrificeProgress:0};else{const W=e/1e3;let P=j.sacrificeProgress+W,D={...j.sacrificeCounts};for(;P>=1;){let X=null;U.type==="military"&&U.militaryId?X=U.militaryId:U.type==="expedition_reward"?X=U.id:U.tier!==void 0&&(X=`${U.type}_${U.tier}`);let N=!1;if(X&&(U.type==="gem"&&U.tier===1?N=et(g,X).gt(Os+f-1):N=et(g,X).gte(f)),!N){j={...j,sacrificeProgress:1,sacrificeCounts:D};break}const A=D[j.activeSacrifice]||0;if(A>=u){j={...j,activeSacrifice:null,sacrificeProgress:0,sacrificeCounts:D};break}const O=Math.min(f,u-A);X&&kt(g,X,new d(O)),D[j.activeSacrifice]=A+O,P-=1}j.activeSacrifice&&(j={...j,sacrificeProgress:P,sacrificeCounts:D})}}return{updatedRealmState:{mana:p,recipeInventory:g,recipeCrafting:h,upgrades:n.upgrades,autoBuyUpgrades:n.autoBuyUpgrades,combat:C,artifacts:n.artifacts,altar:j,prestige:n.prestige},nullstoneEarned:Y}},Ml=()=>{const t=S.getState(),n=Date.now();if(t.paused){S.setState({lastFrameTimestamp:n}),t.saveToStorage();return}let e=n-t.lastFrameTimestamp;if(e=Math.min(e,Sl),e<=0){S.setState({lastFrameTimestamp:n}),t.saveToStorage();return}const r={};let a=0;const s=t.realms.realm1.combat.heroicVictories;for(const i of It){const o=t.realms[i],c=Tl(i,o,e,n,t.globalTier,s);r[i]=c.updatedRealmState,a+=c.nullstoneEarned}if(a>0){const i=r.realm1.recipeInventory,o=r.realm1.recipeCrafting;be(i,"nullstone",new d(a)),o.nullstone&&(o.nullstone.lifetimeProduced+=a)}if(S.setState({realms:r,lastFrameTimestamp:n,totalPlaytime:t.totalPlaytime+e}),t.globalTier>=1){const i=S.getState(),o=K(i),c=i.globalTier;for(const l of Mn)i.activeRealm==="realm2"&&Ae.includes(l)||i.activeRealm==="realm1"&&Ne.includes(l)||o.autoBuyUpgrades[l]&&(Ot(o.upgrades,l,c)||Ze(o.upgrades,l,o.mana,Kt(o.recipeInventory),Te(o.recipeInventory),c,o.recipeInventory)&&S.getState().purchaseUpgrade(l))}if(t.globalTier>=2)for(const i of It){const c=S.getState().realms[i],{autoPrestige:l,prestigeCounts:m}=c.prestige;for(const u of Object.keys(l)){if(!l[u])continue;const f=et(c.recipeInventory,u),b=m[u]||0;if(Cn(u,f,b)){const x=$n(b),p={...c.recipeInventory};p[u]=f.sub(x);const g={...m};g[u]=b+1,S.setState(h=>({realms:{...h.realms,[i]:{...h.realms[i],recipeInventory:p,prestige:{...h.realms[i].prestige,prestigeCounts:g}}}}))}}}t.saveToStorage()},$e=(t,n)=>{const e=t.activeRealm,r=t.realms[e],a={...r,...n(r)};return{realms:{...t.realms,[e]:a}}},S=Ti()((t,n)=>{const e=yl(n,t);return{...ta(),setMana:r=>{t(a=>$e(a,()=>({mana:r})))},addMana:r=>{t(a=>$e(a,s=>({mana:s.mana.add(r)})))},spendMana:r=>{const a=n();return K(a).mana.gte(r)?(t(i=>$e(i,o=>({mana:o.mana.sub(r)}))),!0):!1},addGem:(r,a)=>{t(s=>$e(s,i=>{const o=Ma(r),c={...i.recipeInventory};return be(c,o,a),{recipeInventory:c}}))},removeGem:(r,a)=>{t(s=>$e(s,i=>{const o=Ma(r),c={...i.recipeInventory};return kt(c,o,a),{recipeInventory:c}}))},getManaPerSecond:()=>{const r=K(n());return ea(Kt(r.recipeInventory))},assignCrafter:Vn("crafting",n,t),assignAllCrafters:jn("crafting",n,t),unassignAllCrafters:Yn("crafting",n,t),assignFlaskCrafter:Vn("flaskCrafting",n,t),assignAllFlaskCrafters:jn("flaskCrafting",n,t),unassignAllFlaskCrafters:Yn("flaskCrafting",n,t),assignMilitaryCrafter:Vn("militaryCrafting",n,t),assignAllMilitaryCrafters:jn("militaryCrafting",n,t),unassignAllMilitaryCrafters:Yn("militaryCrafting",n,t),getTotalCrafters:()=>{const r=K(n());return dn(r.upgrades)},getAvailableCrafters:()=>{const r=K(n());return ms(dn(r.upgrades),r.recipeCrafting)},purchaseUpgrade:Jo(n,t),toggleAutoBuy:tl(n,t),startExpedition:nl(n,t),saveExpeditionSetup:el(n,t),clearExpedition:rl(n,t),craftArtifact:al(n,t),upgradeArtifact:sl(n,t),shipArtifact:il(n,t),prestigeRecipe:dl(n,t),toggleAutoPrestige:fl(n,t),togglePause:()=>{t(r=>({paused:!r.paused}))},toggleBackgroundImage:()=>{t(r=>({backgroundImageOff:!r.backgroundImageOff}))},toggleTabHighlighting:()=>{t(r=>({tabHighlightingOff:!r.tabHighlightingOff}))},setUiScale:r=>{t({uiScale:Math.max(.8,Math.min(1.3,r))})},tierReset:ll(n,t),startSacrifice:cl(n,t),stopSacrifice:ul(n,t),setActiveRealm:r=>{const a=n();r==="realm2"&&!a.realm2Unlocked||t({activeRealm:r})},unlockRealm2:()=>{t({realm2Unlocked:!0})},hardReset:hl(t),exportSave:vl(n),importSave:bl(n,t,e),saveToStorage:e,loadFromStorage:xl(t)}}),vn=(t,n)=>(t instanceof d?t:new d(t)).toExponential(n).replace("e+","e"),G=t=>{const n=t instanceof d?t.toNumber():t;if(!Number.isFinite(n))return t instanceof d?vn(t,1):n.toString();const e=Math.abs(n),r=n<0?"-":"";if(e<10)return r+e.toFixed(2);if(e<100)return r+e.toFixed(1);if(e<1e3)return r+e.toFixed(0);if(e<1e6){const a=e/1e3;return a<10?r+a.toFixed(2)+"k":a<100?r+a.toFixed(1)+"k":r+a.toFixed(0)+"k"}if(e<1e9){const a=e/1e6;return a<10?r+a.toFixed(2)+"m":a<100?r+a.toFixed(1)+"m":r+a.toFixed(0)+"m"}if(e<1e12){const a=e/1e9;return a<10?r+a.toFixed(2)+"b":a<100?r+a.toFixed(1)+"b":r+a.toFixed(0)+"b"}if(e<1e15){const a=e/1e12;return a<10?r+a.toFixed(2)+"t":a<100?r+a.toFixed(1)+"t":r+a.toFixed(0)+"t"}return r+vn(e,1)},at=t=>{const n=t instanceof d?t.toNumber():t;if(!Number.isFinite(n))return t instanceof d?vn(t,0):n.toString();const e=Math.abs(n),r=n<0?"-":"";if(e<1e3)return r+Math.floor(e).toString();if(e<1e6){const a=e/1e3;return r+a.toFixed(a<10?1:0)+"k"}if(e<1e9){const a=e/1e6;return r+a.toFixed(a<10?1:0)+"m"}if(e<1e12){const a=e/1e9;return r+a.toFixed(a<10?1:0)+"b"}return r+vn(e,0)},Ua=t=>{const n=t.trim().toLowerCase();if(n==="")return NaN;const e={k:1e3,m:1e6,b:1e9,t:1e12},r=n[n.length-1];if(e[r]){const s=parseFloat(n.slice(0,-1));return isNaN(s)?NaN:Math.floor(s*e[r])}const a=parseFloat(n);return isNaN(a)?NaN:Math.floor(a)},bn=t=>{const n=t instanceof d?t.toNumber():t;return n===0?"":`(${n>0?"+":""}${G(n)}/s)`},yn=(t,n,e="arcane")=>t?"border-muted--30 text-muted--50 line-through cursor-not-allowed":n?`border-${e} text-${e} hover-bg-${e}--20 cursor-pointer`:"border-muted--30 text-muted--50 cursor-not-allowed",Pa=(t,n,e="arcane")=>t||!n?"border-muted--30 cursor-not-allowed":`border-${e} hover-bg-${e}--20 cursor-pointer`,Il=()=>{let t="";return n=>n===t?!1:(t=n,!0)},sn=(t,n,e=!1)=>{t&&(t.style.width=`${n*100}%`,t.className=`h-full craft-progress-fill${e?" blocked":""}`)},Ks=t=>`absolute inset-0 ${t>=1?"bg-steel--40":"bg-steel--30"}`,Je=(t,n)=>`<div ${n} class="${Ks(t)}" style="width: ${t*100}%"></div>`,tn=(t,n,e=!1)=>{t&&(e?t.style.display="none":(t.style.display="",t.style.width=`${n*100}%`,t.className=Ks(n)))},Rl=t=>t===0?"":`<span class="text-xs font-mono ${t>0?"text-positive":"text-red"}">${bn(t)}</span>`,Ce=(t,n)=>{t&&(t.innerHTML=Rl(n))},ca=(t,n,e,r="")=>t.map((a,s)=>`
    <span class="flex items-center gap-1">
      ${s>0?'<span class="text-text mx-1">+</span>':""}
      <img src="${a.icon}" alt="${a.alt}" style="width: 40px; height: 40px;" class="object-contain">
      <span class="text-text text-sm" data-${n}recipe-amount="${e}-${s}">${a.amount.eq(0)?"free":G(a.amount)}${r}</span>
    </span>
  `).join(""),zs=(t,n,e)=>{let r="";n&&(r+=`<div class="tooltip-title">${n}</div>`,r+='<div class="tooltip-divider"></div>');for(const s of t)r+='<div class="tooltip-row">',r+=`<span class="tooltip-label">${s.label}</span>`,s.value!==void 0&&(r+=`<span class="tooltip-value ${s.valueClass??""}">${s.value}</span>`),r+="</div>";return`<span class="hover-tooltip-wrapper">${e??'<span class="text-muted cursor-help">?</span>'}<div class="hover-tooltip">${r}</div></span>`},dt={Inventory:1,Crafting:2,Upgrades:4,Combat:8,Artifacts:16,Altar:32,Tier:64,Realm:128,Prestige:512,TabBar:1024},$l=Object.values(dt).reduce((t,n)=>t|n,0);let te=0,gr=dt.Crafting;const Cl=t=>{te|=t},Zs=()=>{te=$l},El=t=>{gr=t,Cl(t)},Le=new Map,je=(t,n)=>{Le.set(t,n)},Xs=t=>{Le.delete(t)},Nl=()=>{var t,n,e;te!==0&&(te&dt.Inventory&&((t=Le.get(dt.Inventory))==null||t()),te&dt.TabBar&&((n=Le.get(dt.TabBar))==null||n()),te&gr&&((e=Le.get(gr))==null||e()),te=0)},Al=(t,n,e)=>{const r=t[1],a=r.mul(vt[1].effect.value),s=[];let i=a;for(const l of Mt.slice(1)){const m=t[l];if(m.gt(0)){const u=vt[l],f=new d(1).add(m.mul(u.effect.value.sub(1)));s.push({tier:l,count:m,individualMultiplier:u.effect.value,tierMultiplier:f}),i=i.mul(f)}}const o=e!==void 0,c=e?e(i):i;return{baseGeneration:a,t1Count:r,multipliers:s,preModifierTotal:i,hasModifier:o,totalGeneration:c,craftingRate:n.toNumber(),netRate:c.add(n).toNumber()}},Oa=t=>{const n={};for(const e of Object.values(t.activeExpeditions))for(const r of e){if(!r.repeatIfUnitsAvailable)continue;const a=r.duration/1e3;if(!(a<=0))for(const[s,i]of Object.entries(r.assignedUnits))i<=0||(n[s]=(n[s]||0)+i/a)}return n},ql=(t,n,e,r)=>{let a=0,s=0;const i=le(t.heroicVictories,n),o=Dt(e.prestigeCounts,"artifact_shard").toNumber(),c=Dt(e.prestigeCounts,"nullstone").toNumber(),l=gt(n).MODIFIERS.calculateSacrificeBonus,m=Kr(r,l).toNumber(),u=zr(r,l).toNumber();for(const[f,b]of Object.entries(t.activeExpeditions))for(const x of b){if(!x.repeatIfUnitsAvailable)continue;const p=Tt(f,n);if(!p)continue;const g=x.tauntMultiplier??1,h=p.rewards.artifactShards||0,v=p.rewards.nullstone||0,y=Math.round(h*g*i*o*m),T=Math.round(v*g*c*u),M=x.duration/1e3;M>0&&(a+=y*x.successRate/M,s+=T*x.successRate/M)}return{shardsPerSecond:a,nullstonePerSecond:s}},$t={gems:!1,flasks:!1,military:!1,expeditions:!1};let mt=null,xn=!1,on=null;const _l=t=>{const n=on;if(!n)return;const e=n.querySelector("[data-tooltip-t1]");if(e){const c=e.querySelector(".tooltip-label"),l=e.querySelector(".tooltip-value");c&&(c.innerHTML=`<img src="${vt[1].icon}" class="tooltip-icon"> ${G(t.t1Count)} T1 gems  ${G(vt[1].effect.value)}/s`),l&&(l.textContent=`+${G(t.baseGeneration)}/s`)}const r=n.querySelector("[data-tooltip-multipliers]");if(r)if(t.multipliers.length>0){r.classList.remove("hidden");let c='<div class="tooltip-section">Multipliers</div>';for(const l of t.multipliers)c+='<div class="tooltip-row">',c+='<span class="tooltip-label">',c+=`<img src="${vt[l.tier].icon}" class="tooltip-icon"> `,c+=`${G(l.count)} T${l.tier} gems`,c+="</span>",c+=`<span class="tooltip-value text-gold"> x${G(l.tierMultiplier)} multiplier</span>`,c+="</div>";r.innerHTML=c}else r.classList.add("hidden");const a=n.querySelector("[data-tooltip-mana-globe]");a&&a.classList.add("hidden");const s=n.querySelector("[data-tooltip-modifier]");if(s)if(t.hasModifier){s.classList.remove("hidden");const c=s.querySelector(".tooltip-label"),l=s.querySelector(".tooltip-value");c&&(c.textContent=`${G(t.preModifierTotal)} (R2 effect)`),l&&(l.textContent=`=${G(t.totalGeneration)}/s`)}else s.classList.add("hidden");const i=n.querySelector("[data-tooltip-crafting]");if(i)if(t.craftingRate!==0){i.classList.remove("hidden");const c=i.querySelector(".tooltip-label"),l=i.querySelector(".tooltip-value");c&&(c.textContent=`Crafting ${t.craftingRate>0?"production":"consumption"}`),l&&(l.textContent=bn(t.craftingRate),l.className=`tooltip-value ${t.craftingRate>0?"text-positive":"text-red"}`)}else i.classList.add("hidden");const o=n.querySelector("[data-tooltip-total]");if(o){const c=o.querySelector(".tooltip-value");c&&(c.textContent=bn(t.netRate),c.className=`tooltip-value ${t.netRate>=0?"text-positive":"text-red"}`)}},Ll=()=>{let t='<div class="mana-tooltip">';return t+='<div class="tooltip-title">Mana Generation Breakdown</div>',t+='<div class="tooltip-divider"></div>',t+='<div class="tooltip-row" data-tooltip-t1>',t+='<span class="tooltip-label"></span>',t+='<span class="tooltip-value text-positive"></span>',t+="</div>",t+='<div class="tooltip-divider"></div>',t+="<div data-tooltip-multipliers></div>",t+='<div class="tooltip-row hidden" data-tooltip-mana-globe>',t+='<span class="tooltip-label"></span>',t+='<span class="tooltip-value text-gold"></span>',t+="</div>",t+='<div class="tooltip-row hidden" data-tooltip-modifier>',t+='<span class="tooltip-label text-red"></span>',t+='<span class="tooltip-value text-red"></span>',t+="</div>",t+='<div class="tooltip-divider"></div>',t+='<div class="tooltip-row hidden" data-tooltip-crafting>',t+='<span class="tooltip-label"></span>',t+='<span class="tooltip-value"></span>',t+="</div>",t+='<div class="tooltip-divider"></div>',t+='<div class="tooltip-row tooltip-total" data-tooltip-total>',t+='<span class="tooltip-label">Net mana rate</span>',t+='<span class="tooltip-value"></span>',t+="</div>",t+="</div>",t},nn=(t,n)=>{const e=$t[t];return`
    <div class="flex items-center gap-2 py-1 px-1 border-b border-muted--30 cursor-pointer hover-bg-panel--50" data-collapse-toggle="${t}">
      <span class="text-steel text-xs w-4">${e?"+":""}</span>
      <span class="text-gold text-sm font-mono">${n}</span>
    </div>
  `},hr=()=>{var D,X;if(!mt)return;const t=S.getState(),n=K(t),{mana:e,recipeInventory:r,recipeCrafting:a,upgrades:s,artifacts:i,altar:o}=n,c=Kt(r),l=Te(r),m=Yt(r),u=$o(t.globalTier),f=Me(t.activeRealm,t.globalTier),b=Gt(t.activeRealm,t.globalTier),x=Ar(a,b),p=gt(t.activeRealm),g=p.MODIFIERS.manaModifier,h=ea(c,g),v=Qr(t.realms.realm1.combat.heroicVictories,t.activeRealm),y=wl(a,s,i,o,t.globalTier,p.MODIFIERS.craftTimeMultiplier,p.MODIFIERS.calculateSacrificeBonus,p.MODIFIERS.sacrificeBatchSize,t.activeRealm,n.combat,p.MODIFIERS.flaskRecipeMultiplier,v,n.prestige),T=h.add(y.mana).toNumber(),M=Al(c,y.mana,g),E=Mt.filter(N=>{var J;if((((J=a[`gem_${N}`])==null?void 0:J.lifetimeProduced)??0)===0)return!1;const A=c[N].toNumber(),O=(y.recipes[`gem_${N}`]??new d(0)).toNumber();return A!==0||O!==0}),I=Nt.filter(N=>{var A;return(((A=a[`flask_${N}`])==null?void 0:A.lifetimeProduced)??0)>0}),R=u?qr(Yt(t.realms.realm1.recipeInventory),Yt(t.realms.realm2.recipeInventory),t.activeRealm,t.globalTier):m,_=b.filter(N=>{var J;if((((J=a[N])==null?void 0:J.lifetimeProduced)??0)===0)return!1;const A=(R[N]||new d(0)).toNumber(),O=(y.recipes[N]||new d(0)).toNumber();return A!==0||O!==0}),V=Nt.some(N=>Lt(`flask_${N}`,a)),B=b.some(N=>(x.lifetimeCrafted[N]??0)>0),$=(((D=a.artifact_shard)==null?void 0:D.lifetimeProduced)??0)>0,C=t.activeRealm==="realm1"&&(((X=t.realms.realm1.recipeCrafting.nullstone)==null?void 0:X.lifetimeProduced)??0)>0,Y=$||C,F=E.join(","),q=I.join(","),tt=_.join(","),j=`${$t.gems}|${$t.flasks}|${$t.military}|${$t.expeditions}`,ot=`${V}|${B}|${$}|${C}`,U=`${j}|${ot}|${F}|${q}|${tt}|${t.activeRealm}`;if(!xn||mt.dataset.structureKey!==U){let N=`
      <div class="inventory-sections overflow-y-auto pr-2" style="flex: 1; min-height: 0;">
      <div class="mana-row-wrapper">
        <table style="table-layout: fixed; width: 100%;">
          <colgroup>
            <col style="width: 50px;">
            <col style="width: 36px;">
            <col style="width: 70px;">
            <col>
          </colgroup>
          <tbody>
            <tr class="mana-row">
              <td class="text-text text-sm pr-2">Mana</td>
              <td>
                <img src="${L("icons/mana.png")}" alt="Mana" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-mana-value></td>
              <td class="text-right" data-mana-rate></td>
            </tr>
          </tbody>
        </table>
        ${Ll()}
      </div>
    `;if(N+=nn("gems","Gems"),!$t.gems){if(N+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,E.length===0)N+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No gems yet</td></tr>';else for(const A of E)N+=`
            <tr data-gem-row="${A}">
              <td class="text-text text-sm">T${A}</td>
              <td>
                <img src="${vt[A].icon}" alt="${vt[A].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-gem-count="${A}"></td>
              <td class="text-right" data-gem-rate="${A}"></td>
            </tr>
          `;N+="</tbody></table>"}if(V&&(N+=nn("flasks","Flasks"),!$t.flasks)){if(N+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,I.length===0)N+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No flasks yet</td></tr>';else for(const A of I)N+=`
            <tr data-flask-row="${A}">
              <td class="text-text text-sm">T${A}</td>
              <td>
                <img src="${xe[A].icon}" alt="${xe[A].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-flask-count="${A}"></td>
              <td class="text-right" data-flask-rate="${A}"></td>
            </tr>
          `;N+="</tbody></table>"}if(B&&(N+=nn("military","Expedition Units"),!$t.military)){if(N+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,_.length===0)N+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No units yet</td></tr>';else for(const A of _)N+=`
            <tr data-military-row="${A}">
              <td class="text-text text-sm">${f[A].name.slice(0,2)}</td>
              <td>
                <img src="${f[A].icon}" alt="${f[A].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-military-count="${A}"></td>
              <td class="text-right" data-military-rate="${A}"></td>
            </tr>
          `;N+="</tbody></table>"}Y&&(N+=nn("expeditions","Expeditions Loot"),$t.expeditions||(N+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,$&&(N+=`
          <tr>
            <td class="text-text text-sm">SHRD</td>
            <td>
              <img src="${L("icons/artifact shard.png")}" alt="Artifact Shards" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-shards></td>
            <td class="text-right" data-combat-shards-rate></td>
          </tr>
        `),C&&(N+=`
          <tr>
            <td class="text-text text-sm">NULS</td>
            <td>
              <img src="${L("icons/nullstone.png")}" alt="Nullstone" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-nullstone></td>
            <td class="text-right" data-combat-nullstone-rate></td>
          </tr>
        `),N+="</tbody></table>")),N+="</div>",mt.innerHTML=N,mt.dataset.structureKey=U,xn=!0,Ul()}const k=mt.querySelector("[data-mana-value]");k&&(k.textContent=G(e));const W=mt.querySelector("[data-mana-rate]");W&&(T!==0?W.innerHTML=`<span class="text-xs font-mono ${T>0?"text-positive":"text-red"}">${bn(T)}</span>`:W.innerHTML=""),_l(M);for(const N of E){const A=c[N].toNumber(),O=(y.recipes[`gem_${N}`]??new d(0)).toNumber(),J=mt.querySelector(`[data-gem-count="${N}"]`);J&&(J.textContent=G(A)),Ce(mt.querySelector(`[data-gem-rate="${N}"]`),O)}for(const N of I){const A=l[N].toNumber(),O=(y.recipes[`flask_${N}`]??new d(0)).toNumber(),J=mt.querySelector(`[data-flask-count="${N}"]`);J&&(J.textContent=G(A)),Ce(mt.querySelector(`[data-flask-rate="${N}"]`),O)}const P=Oa(n.combat);if(u){const N=t.activeRealm==="realm1"?"realm2":"realm1",A=Oa(t.realms[N].combat);for(const[O,J]of Object.entries(A))P[O]=(P[O]||0)+J}for(const N of _){const A=(R[N]||new d(0)).toNumber(),O=(y.recipes[N]||new d(0)).toNumber()-(P[N]||0),J=mt.querySelector(`[data-military-count="${N}"]`);J&&(J.textContent=G(A)),Ce(mt.querySelector(`[data-military-rate="${N}"]`),O)}if(!$t.expeditions){const N=mt.querySelector("[data-combat-shards]");N&&(N.textContent=at(et(r,"artifact_shard").toNumber()));const A=mt.querySelector("[data-combat-nullstone]");A&&(A.textContent=at(et(t.realms.realm1.recipeInventory,"nullstone").toNumber()));const O=ql(n.combat,t.activeRealm,n.prestige,n.altar.sacrificeCounts),J=(y.recipes.artifact_shard??new d(0)).toNumber(),lt=(y.recipes.nullstone??new d(0)).toNumber();Ce(mt.querySelector("[data-combat-shards-rate]"),O.shardsPerSecond+J),Ce(mt.querySelector("[data-combat-nullstone-rate]"),O.nullstonePerSecond+lt)}};let Ba=!1;const Fl=t=>{const e=t.target.closest("[data-collapse-toggle]");if(e){const r=e.getAttribute("data-collapse-toggle");$t[r]=!$t[r],xn=!1,hr()}};let fe=!1,zn=null;const Ul=()=>{const t=mt==null?void 0:mt.querySelector(".mana-row-wrapper"),n=mt==null?void 0:mt.querySelector(".mana-tooltip");if(!t||!n)return;on&&on.remove(),document.body.appendChild(n),on=n,zn&&zn();const e=a=>{const s=t.contains(a.target);if(s&&!fe){const i=t.getBoundingClientRect();n.style.top=`${i.bottom+4}px`,n.style.left=`${i.left}px`,n.classList.add("visible"),fe=!0}else!s&&fe&&(n.classList.remove("visible"),fe=!1)},r=()=>{fe&&(n.classList.remove("visible"),fe=!1)};document.addEventListener("mousemove",e),document.addEventListener("mouseleave",r),zn=()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseleave",r)}},Da=()=>{mt=document.getElementById("inventory"),mt&&(xn=!1,Ba||(mt.addEventListener("click",Fl),Ba=!0),hr(),je(dt.Inventory,hr))},Ft={},Pl=()=>{const{collapsedSections:t}=S.getState();for(const n of t)Ft[n]=!1};let vr=!1;const Ol=()=>{vr||(vr=!0,Pl())},Bl=()=>{const t=Object.entries(Ft).filter(([,n])=>!n).map(([n])=>n);S.setState({collapsedSections:t})},se=(t,n,e,r=!0,a="")=>{Ol(),Ft[t]===void 0&&(Ft[t]=r);const s=Ft[t];return`
    <div>
      <div class="w-full flex items-center" style="padding: 8px 12px; gap: 10px;">
        <button
          data-action="toggle-collapsible"
          data-id="${t}"
          class="hover-opacity-100"
          style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; opacity: 0.6; cursor: pointer; color: var(--color-steel); font-size: 16px;"
        >
          ${s?"":"+"}
        </button>
        <span style="color: var(--color-steel);">${n}</span>
        ${a?`<div class="ml-auto">${a}</div>`:""}
      </div>
      <div data-collapsible-content="${t}" class="p-3 pt-0" style="${s?"":"display: none;"}">${e}</div>
    </div>
  `},Dl=t=>{Ft[t]=!Ft[t],Bl()},ua=()=>{for(const t of Object.keys(Ft))delete Ft[t];vr=!1};document.addEventListener("click",t=>{const e=t.target.closest('[data-action="toggle-collapsible"]');if(e){const r=e.getAttribute("data-id");Dl(r);const a=Ft[r];e.textContent=a?"":"+";const s=document.querySelector(`[data-collapsible-content="${r}"]`);s&&(s.style.display=a?"":"none")}});const ce=(t,n,e)=>{let r=null;const a=()=>{var i;(i=e==null?void 0:e.onCleanup)==null||i.call(e),Xs(t),r=null};return{cleanup:a,render:i=>{a(),r=i;const o=n(r);je(t,()=>{r&&o()}),o()},getContainer:()=>r}},Zn=t=>{const n=S.getState(),e=K(n),r=gt(n.activeRealm),a=yt(t),s=la(t,e.upgrades,e.artifacts,n.globalTier,r.MODIFIERS.craftTimeMultiplier);return a.craftTime/s},me=(t,n,e)=>`<span class="text-text" style="display: inline-block; width: 68px">${t}</span><span class="${e}">(${n}/s)</span>`,Hl="grid-template-columns: 120px 210px 20px 225px 90px 110px 55px 70px; gap: 16px; padding-left: 12px;",da=(t,n)=>{const e=n%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",r=t.type==="gem"?"assign-crafter":t.type==="flask"?"assign-flask-crafter":"assign-military-crafter",a=t.type==="military"?`data-id="${t.id}"`:`data-tier="${t.id}"`,s=t.type==="gem"?"":t.type==="flask"?"flask-":"military-";return`
    <div class="grid items-center py-1" style="${Hl} background-color: ${e}">
      <div class="text-gold text-sm whitespace-nowrap">${t.name}</div>
      <div class="flex items-center"><span class="hover-tooltip-wrapper">${t.ingredients}<div class="hover-tooltip" data-${s}input-tooltip="${t.id}">${t.inputTooltipHtml??""}</div></span></div>
      <div class="text-text text-center"></div>
      <div class="flex items-center gap-1 mr-2.5">
        <span class="hover-tooltip-wrapper"><span class="flex items-center gap-1"><img src="${t.icon}" alt="${t.name}" style="width: 40px; height: 40px;" class="object-contain"><span class="text-text text-sm" data-${s}recipe-output="${t.id}">${t.outputAmount}</span></span><div class="hover-tooltip" data-${s}output-tooltip="${t.id}">${t.outputTooltipHtml??""}</div></span>
      </div>
      <div class="flex items-center gap-1">
        <button data-action="${r}" ${a} data-delta="-1" class="text-red hover-text-white hover-bg-red--20 font-mono text-xl font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
        <span data-${s}crafter-count="${t.id}" class="text-positive text-center font-mono text-sm w-6">${at(t.assigned)}</span>
        <button data-action="${r}" ${a} data-delta="1" class="text-positive hover-text-white hover-bg-positive--20 font-mono text-xl font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
      </div>
      <div class="w-24 h-4 overflow-hidden craft-progress-bg">
        <div data-${s}progress-bar="${t.id}" class="h-full craft-progress-fill${t.blocked?" blocked":""}" style="width: ${t.progress*100}%"></div>
      </div>
      <div class="text-sm text-text" data-${s}craft-time="${t.id}">${G(t.craftTime)}s</div>
      <div class="text-sm text-positive">${t.effectText||""}</div>
    </div>
  `},pe=(t,n,e,r,a,s,i)=>{const o=[];o.push({label:n,value:G(e)});for(const l of r){const m=l.value instanceof d?l.value:new d(l.value);m.eq(1)||o.push({label:l.label,value:`x${G(m)}`,valueClass:"text-steel"})}a>1&&o.push({label:"Crafters",value:`x${a}`,valueClass:"text-positive"}),a>0?(o.push({label:"Craft speed",value:`${G(s)}/s`,valueClass:"text-steel"}),o.push({label:"Total",value:`${G(i)}/s`,valueClass:"text-gold"})):o.push({label:"Total",value:G(i),valueClass:"text-gold"});let c=`<div class="tooltip-title">${t}</div><div class="tooltip-divider"></div>`;for(const l of o)c+=`<div class="tooltip-row"><span class="tooltip-label">${l.label}</span>`,l.value!==void 0&&(c+=`<span class="tooltip-value ${l.valueClass??""}">${l.value}</span>`),c+="</div>";return c},Gl=(t,n)=>{const e=vt[t],r=e.effect.type==="flat"?`+${G(e.effect.value)}/s`:`x${G(e.effect.value)}`,a=e.recipe.map(s=>({icon:s.type==="mana"?L("icons/mana.png"):vt[s.tier].icon,alt:s.type==="mana"?"Mana":`T${s.tier}`,amount:new d(0)}));return da({type:"gem",id:String(t),name:e.name,icon:e.icon,ingredients:ca(a,"",t,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0,effectText:r},n)},Vl=(t,n)=>{const e=xe[t],r=e.recipe.map(a=>({icon:vt[a.tier].icon,alt:`T${a.tier}`,amount:new d(0)}));return da({type:"flask",id:String(t),name:e.name,icon:e.icon,ingredients:ca(r,"flask-",t,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0},n)},jl=(t,n)=>{const e=S.getState(),a=Xe(e.activeRealm)[t],s=a.recipe.map(i=>({icon:i.type==="mana"?L("icons/mana.png"):vt[i.tier].icon,alt:i.type==="mana"?"Mana":`T${i.tier}`,amount:new d(0)}));return da({type:"military",id:t,name:a.name,icon:a.icon,ingredients:ca(s,"military-",t,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0},n)};let Ha=null,rn=null,Xn=null;const Yl=t=>{const n=()=>{var R,_,V,B;const e=S.getState(),r=K(e),{recipeCrafting:a}=r,s=Mt.map($=>`gem_${$}`),i=Nt.map($=>`flask_${$}`),o=Ct(e.activeRealm),c=Mt.filter($=>Lt(`gem_${$}`,a)),l=Nt.filter($=>Lt(`flask_${$}`,a)),m=de(s,a),u=m?parseInt(m.replace("gem_","")):null;Ha=m,rn=de(i,a),Xn=de(o,a);let f=c.map(($,C)=>Gl($,C)).join("");if(u){const $=c.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";f+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${$}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${vt[u-1].icon}" alt="T${u-1}" style="width: 40px; height: 40px;" class="object-contain">
          <span data-unlock-progress>to unlock</span>
        </div>
      </div>
    `}const b=`<div class="mobile-scroll-x">${f}</div>`;let x=`
    <div class="mb-4 flex items-center gap-2 text-sm font-mono">
      <span class="text-steel">Crafters:</span>
      <span class="text-gold" data-crafters-available></span>
      <span class="text-muted">/</span>
      <span class="text-text" data-crafters-total></span>
      <span class="text-muted ml-2">|</span>
      <span class="text-steel ml-2">Buy crafter</span>
      <button
        data-action="purchase-crafter"
        disabled
        class="relative px-2 py-1 text-sm font-mono border overflow-hidden ${Pa(!1,!1)}"
      >
        ${Je(0,"data-crafter-progress")}
        <span class="relative z-10 flex items-center gap-1">
          <img src="${L("icons/mana.png")}" alt="Mana" class="w-5 h-5 object-contain">
          <span data-crafter-cost class="text-text"></span>
        </span>
      </button>
    </div>
  `;e.dismissedTips.includes("crafter-rightclick")||(x+=`
      <div data-tip="crafter-rightclick" class="mb-4 flex items-center gap-2 text-sm">
        <button data-action="dismiss-tip" data-tip-id="crafter-rightclick" class="text-muted hover-text-positive cursor-pointer border-none bg-transparent" title="Dismiss tip">&#x2714;</button>
        <span class="text-muted">Tip: right-click crafter buttons to assign/unassign all crafters</span>
      </div>
    `),x+=se("mana-gems","Mana gems",b);const g=((R=a.gem_1)==null?void 0:R.lifetimeProduced)??0,h=g>=100,v=rn?parseInt(rn.replace("flask_","")):null;let y=l.map(($,C)=>Vl($,C)).join("");if(v){const $=l.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";y+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-flask-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${$}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${vt[v].icon}" alt="T${v}" style="width: 40px; height: 40px;" class="object-contain">
          <span data-flask-unlock-progress>to unlock</span>
        </div>
      </div>
    `}if(h){const $=`<div class="mobile-scroll-x">${y}</div>`;x+=`<div class="mt-4">${se("research-flasks","Research flasks",$)}</div>`}const M=Ct(e.activeRealm).filter($=>Lt($,a)),E=Xn;if(g>=500){let $=M.map((Y,F)=>jl(Y,F)).join("");if(E){const Y=M.length%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",F=yt(E),q=F.unlockCondition?((_=vt[parseInt(F.unlockCondition.recipeId.replace("gem_",""))])==null?void 0:_.icon)??"":"";$+=`
        <div class="unlock-progress-bg text-steel text-sm py-1">
          <div data-military-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${Y}"></div>
          <div class="unlock-progress-label">
            <span>Craft</span>
            <img src="${q}" alt="" style="width: 40px; height: 40px;" class="object-contain">
            <span data-military-unlock-progress>to unlock</span>
          </div>
        </div>
      `}const C=`<div class="mobile-scroll-x">${$}</div>`;x+=`<div class="mt-4">${se("military","Expedition Units",C)}</div>`}t.innerHTML=x,t.querySelectorAll('[data-action="assign-crafter"]').forEach($=>{$.addEventListener("click",()=>{const C=parseInt($.getAttribute("data-tier")),Y=parseInt($.getAttribute("data-delta"));S.getState().assignCrafter(C,Y)}),$.addEventListener("contextmenu",C=>{C.preventDefault();const Y=parseInt($.getAttribute("data-tier"));parseInt($.getAttribute("data-delta"))>0?S.getState().assignAllCrafters(Y):S.getState().unassignAllCrafters(Y)})}),t.querySelectorAll('[data-action="assign-flask-crafter"]').forEach($=>{$.addEventListener("click",()=>{const C=parseInt($.getAttribute("data-tier")),Y=parseInt($.getAttribute("data-delta"));S.getState().assignFlaskCrafter(C,Y)}),$.addEventListener("contextmenu",C=>{C.preventDefault();const Y=parseInt($.getAttribute("data-tier"));parseInt($.getAttribute("data-delta"))>0?S.getState().assignAllFlaskCrafters(Y):S.getState().unassignAllFlaskCrafters(Y)})}),t.querySelectorAll('[data-action="assign-military-crafter"]').forEach($=>{$.addEventListener("click",()=>{const C=$.getAttribute("data-id"),Y=parseInt($.getAttribute("data-delta"));S.getState().assignMilitaryCrafter(C,Y)}),$.addEventListener("contextmenu",C=>{C.preventDefault();const Y=$.getAttribute("data-id");parseInt($.getAttribute("data-delta"))>0?S.getState().assignAllMilitaryCrafters(Y):S.getState().unassignAllMilitaryCrafters(Y)})}),(V=t.querySelector('[data-action="purchase-crafter"]'))==null||V.addEventListener("click",()=>{S.getState().purchaseUpgrade("crafters")}),(B=t.querySelector('[data-action="dismiss-tip"]'))==null||B.addEventListener("click",$=>{var F;const C=$.currentTarget.getAttribute("data-tip-id"),Y=S.getState();S.setState({dismissedTips:[...Y.dismissedTips,C]}),(F=t.querySelector(`[data-tip="${C}"]`))==null||F.remove()})};return n(),()=>{const e=S.getState(),r=K(e),{recipeCrafting:a}=r,s=Mt.map(q=>`gem_${q}`),i=Nt.map(q=>`flask_${q}`),o=Ct(e.activeRealm),c=de(s,a),l=de(i,a),m=de(o,a);if(c!==Ha||l!==rn||m!==Xn){n();return}const u=e.getAvailableCrafters(),f=e.getTotalCrafters(),b=t.querySelector("[data-crafters-available]");b&&(b.textContent=at(u));const x=t.querySelector("[data-crafters-total]");x&&(x.textContent=at(f));const p=Lr(r.upgrades,"crafters"),g=Ze(r.upgrades,"crafters",r.mana,Kt(r.recipeInventory),Te(r.recipeInventory)),h=Ot(r.upgrades,"crafters"),v=h||!p?1:Math.min(1,r.mana.div(p.amount).toNumber()),y=t.querySelector("[data-crafter-cost]");y&&p&&(y.textContent=G(p.amount));const T=t.querySelector('[data-action="purchase-crafter"]');if(T){const q=Pa(h,g);T.className=`relative px-2 py-1 text-sm font-mono border overflow-hidden ${q}`,h||!g?T.setAttribute("disabled",""):T.removeAttribute("disabled")}tn(t.querySelector("[data-crafter-progress]"),v,h);const M=gt(e.activeRealm),E=Rn(e.activeRealm),I=Qr(e.realms.realm1.combat.heroicVictories,e.activeRealm);for(const q of Mt){const tt=`gem_${q}`,j=a[tt],ot=(j==null?void 0:j.progress)??0,U=ot>=1,k=(j==null?void 0:j.assignment)??0,W=vt[q],P=E(q,r.combat.completionsPerExpedition),D=Zn(tt),X=1/D;sn(t.querySelector(`[data-progress-bar="${q}"]`),ot,U);const N=t.querySelector(`[data-crafter-count="${q}"]`);N&&(N.textContent=at(k));const A=_e(tt,r.upgrades,r.artifacts,1);A.forEach((it,nt)=>{const ut=t.querySelector(`[data-recipe-amount="${q}-${nt}"]`);if(ut)if(it.amount.eq(0))ut.innerHTML="free";else{const xt=G(it.amount);ut.innerHTML=k>0?`${me(xt,G(it.amount.mul(k).mul(X)),"text-text")}`:xt}});const O=Wn(tt,r.upgrades,r.artifacts,r.altar,M.MODIFIERS.calculateSacrificeBonus,P,I,r.prestige),J=O.total,lt=t.querySelector(`[data-recipe-output="${q}"]`);if(lt){const it=G(J);lt.innerHTML=k>0?`${me(it,G(J.mul(k).mul(X)),"text-positive")}`:it,lt.classList.toggle("text-positive",k>0),lt.classList.toggle("text-text",k<=0)}const rt=t.querySelector(`[data-input-tooltip="${q}"]`);if(rt){const it=Kn(tt,r.upgrades,r.artifacts,1),nt=W.recipe.length>0?W.recipe[0].amount:new d(0),ut=A.length>0?k>0?A[0].amount.mul(k).mul(X):it.total.mul(nt):new d(0);rt.innerHTML=pe(k>0?"Input per second":"Input per craft","Base cost/craft",nt,it.multipliers,k,X,ut)}const Q=t.querySelector(`[data-output-tooltip="${q}"]`);Q&&(Q.innerHTML=pe(k>0?"Output per second":"Output per craft","Base output/craft",new d(1),O.multipliers,k,X,k>0?J.mul(k).mul(X):J));const st=t.querySelector(`[data-craft-time="${q}"]`);st&&(st.textContent=`${G(D)}s`)}for(const q of Nt){const tt=`flask_${q}`,j=a[tt],ot=(j==null?void 0:j.progress)??0,U=ot>=1,k=(j==null?void 0:j.assignment)??0,W=xe[q],P=E(q,r.combat.completionsPerExpedition),D=Zn(tt),X=1/D;sn(t.querySelector(`[data-flask-progress-bar="${q}"]`),ot,U);const N=t.querySelector(`[data-flask-crafter-count="${q}"]`);N&&(N.textContent=at(k));const A=M.MODIFIERS.flaskRecipeMultiplier,O=_e(tt,r.upgrades,r.artifacts,A);O.forEach((nt,ut)=>{const xt=t.querySelector(`[data-flask-recipe-amount="${q}-${ut}"]`);if(xt)if(nt.amount.eq(0))xt.innerHTML="free";else{const Zt=G(nt.amount);xt.innerHTML=k>0?`${me(Zt,G(nt.amount.mul(k).mul(X)),"text-text")}`:Zt}});const J=Wn(tt,r.upgrades,r.artifacts,r.altar,M.MODIFIERS.calculateSacrificeBonus,P,I,r.prestige),lt=J.total,rt=t.querySelector(`[data-flask-recipe-output="${q}"]`);if(rt){const nt=G(lt);rt.innerHTML=k>0?`${me(nt,G(lt.mul(k).mul(X)),"text-positive")}`:nt,rt.classList.toggle("text-positive",k>0),rt.classList.toggle("text-text",k<=0)}const Q=t.querySelector(`[data-flask-input-tooltip="${q}"]`);if(Q){const nt=Kn(tt,r.upgrades,r.artifacts,A),ut=W.recipe.length>0?W.recipe[0].amount:new d(0),xt=O.length>0?k>0?O[0].amount.mul(k).mul(X):nt.total.mul(ut):new d(0);Q.innerHTML=pe(k>0?"Input per second":"Input per craft","Base cost/craft",ut,nt.multipliers,k,X,xt)}const st=t.querySelector(`[data-flask-output-tooltip="${q}"]`);st&&(st.innerHTML=pe(k>0?"Output per second":"Output per craft","Base output/craft",new d(1),J.multipliers,k,X,k>0?lt.mul(k).mul(X):lt));const it=t.querySelector(`[data-flask-craft-time="${q}"]`);it&&(it.textContent=`${G(D)}s`)}const R=c?Dn(c,a):null,_=t.querySelector("[data-unlock-progress]");if(_&&R){_.textContent=`to unlock (${G(R.required-R.current)} more)`;const q=t.querySelector("[data-unlock-bar]");q&&(q.style.width=`${Math.min(100,R.current/R.required*100)}%`)}const V=l?Dn(l,a):null,B=t.querySelector("[data-flask-unlock-progress]");if(B&&V){B.textContent=`to unlock (${G(V.required-V.current)} more)`;const q=t.querySelector("[data-flask-unlock-bar]");q&&(q.style.width=`${Math.min(100,V.current/V.required*100)}%`)}const $=Ct(e.activeRealm),C=Xe(e.activeRealm);for(const q of $){const tt=q,j=a[tt],ot=(j==null?void 0:j.progress)??0,U=ot>=1,k=(j==null?void 0:j.assignment)??0,W=C[q];if(!W)continue;const P=Zn(tt),D=1/P;sn(t.querySelector(`[data-military-progress-bar="${q}"]`),ot,U);const X=t.querySelector(`[data-military-crafter-count="${q}"]`);X&&(X.textContent=at(k));const N=_e(tt,r.upgrades,r.artifacts,1);N.forEach((st,it)=>{const nt=t.querySelector(`[data-military-recipe-amount="${q}-${it}"]`);if(nt)if(st.amount.eq(0))nt.innerHTML="free";else{const ut=G(st.amount);nt.innerHTML=k>0?`${me(ut,G(st.amount.mul(k).mul(D)),"text-text")}`:ut}});const A=Wn(tt,r.upgrades,r.artifacts,r.altar,M.MODIFIERS.calculateSacrificeBonus,1,I,r.prestige),O=A.total,J=t.querySelector(`[data-military-recipe-output="${q}"]`);if(J){const st=G(O);J.innerHTML=k>0?`${me(st,G(O.mul(k).mul(D)),"text-positive")}`:st,J.classList.toggle("text-positive",k>0),J.classList.toggle("text-text",k<=0)}const lt=t.querySelector(`[data-military-input-tooltip="${q}"]`);if(lt){const st=Kn(tt,r.upgrades,r.artifacts,1),it=W.recipe.length>0?W.recipe[0].amount:new d(0),nt=N.length>0?k>0?N[0].amount.mul(k).mul(D):st.total.mul(it):new d(0);lt.innerHTML=pe(k>0?"Input per second":"Input per craft","Base cost/craft",it,st.multipliers,k,D,nt)}const rt=t.querySelector(`[data-military-output-tooltip="${q}"]`);rt&&(rt.innerHTML=pe(k>0?"Output per second":"Output per craft","Base output/craft",new d(1),A.multipliers,k,D,k>0?O.mul(k).mul(D):O));const Q=t.querySelector(`[data-military-craft-time="${q}"]`);Q&&(Q.textContent=`${G(P)}s`)}const Y=m?Dn(m,a):null,F=t.querySelector("[data-military-unlock-progress]");if(F&&Y){F.textContent=`to unlock (${G(Y.required-Y.current)} more)`;const q=t.querySelector("[data-military-unlock-bar]");q&&(q.style.width=`${Math.min(100,Y.current/Y.required*100)}%`)}}},Qs=ce(dt.Crafting,Yl),Wl=Qs.cleanup,Kl=Qs.render,br={t1KnightStrength:"t1_knight",t4KnightStrength:"t4_knight",t7KnightStrength:"t7_knight"},yr={t4SwordEfficiency:"t4_sword",t5SwordEfficiency:"t5_sword",t6SwordEfficiency:"t6_sword"},Ga=(t,n)=>{if(t==="craftersGuild")return Fr(n);if(t==="gemManufacturing")return Ur(n);if(t==="cheaperGems")return Or(n);if(t==="cheaperFlasks")return Br(n);if(t==="cheaperMilitary")return Dr(n);const e=br[t];if(e)return new d(ys(n,e));const r=yr[t];return r?Hr(n,r):new d(1)},zl=(t,n,e,r)=>{const a=ze(t,n);if(!a)return 1;let s=1;for(const i of a){let o;i.recipeId&&r?o=et(r,i.recipeId):o=e[i.tier];const c=i.amount.gt(0)?Math.min(1,o.div(i.amount).toNumber()):1;s=Math.min(s,c)}return s},Zl=(t,n,e)=>{let r="";const a=e>=1;for(const s of t){const i=Bt[s],o=Ot(n,s,e),c=yn(o,!1);r+=`
      <tr data-upgrade-row="${s}" class="${o?"text-muted--50":""}">
        <td data-upgrade-name="${s}" class="w-76 ${o?"line-through":"text-gold"}">
          <span class="inline-flex items-center gap-1.5">
            ${zs(i.tooltip.split(`
`).map(l=>({label:l})))}
            ${i.name}
          </span>
        </td>
        <td data-upgrade-level="${s}" class="w-24 text-steel"></td>
        <td data-upgrade-cost="${s}" class="w-50"></td>
        <td data-upgrade-effect="${s}" class="w-48"></td>
        <td class="w-28">
          <button
            data-action="purchase-upgrade"
            data-id="${s}"
            disabled
            class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${c}"
          >
            ${o?"":Je(0,`data-upgrade-progress="${s}"`)}
            <span data-upgrade-btn-text="${s}" class="relative z-10">${o?"MAX":"Buy"}</span>
          </button>
        </td>
        ${a?`<td class="w-16 text-center">
          ${o?"":`<input type="checkbox" data-action="toggle-autobuy" data-id="${s}" class="cursor-pointer accent-gold">`}
        </td>`:""}
      </tr>`}return r},Xl=(t,n,e,r)=>{if(t.length===0)return"";const a=t.every(i=>Ot(n,i,e));let s="";return a&&(s+='<div class="text-muted text-sm mb-4">All research upgrades maxed.</div>'),s+=`<div class="mobile-scroll-x"><table class="text-sm font-mono mb-6" data-upgrade-table="${r}">
    <thead>
      <tr class="text-steel border-b border-muted--30">
        <th class="w-76 text-left">Upgrade</th>
        <th class="w-24 text-left">Level</th>
        <th class="w-50 text-left">Cost</th>
        <th class="w-48 text-left">Effect</th>
        <th class="w-28"></th>
        ${e>=1?'<th class="w-16 text-center">Auto</th>':""}
      </tr>
    </thead>
    <tbody>${Zl(t,n,e)}</tbody>
  </table></div>`,s},Ql=t=>{let n=S.getState().activeRealm,e=S.getState().globalTier,r=0,a=!0;const s=()=>{t.querySelectorAll("[data-upgrade-row]").forEach(o=>{const c=o;a&&c.classList.contains("text-muted--50")?c.style.display="none":c.style.display=""})},i=()=>{const o=S.getState(),c=K(o),{upgrades:l}=c,m=o.globalTier;n=o.activeRealm,e=m;const u=hs.filter(g=>{var h,v;if(Ae.includes(g)){if(o.activeRealm!=="realm1")return!1;const y=br[g];if(y&&(((h=c.recipeCrafting[y])==null?void 0:h.lifetimeProduced)??0)===0)return!1}if(Ne.includes(g)){if(o.activeRealm!=="realm2")return!1;const y=yr[g];if(y&&(((v=c.recipeCrafting[y])==null?void 0:v.lifetimeProduced)??0)===0)return!1}return!0});r=u.filter(g=>Ae.includes(g)||Ne.includes(g)).length;const f=u.some(g=>Ot(l,g,m));let b='<div class="p-4 font-mono">';f&&(b+=`<label class="inline-flex items-center gap-2 text-sm text-steel cursor-pointer mb-4">
        <input type="checkbox" data-action="toggle-hide-maxed" ${a?"checked":""} class="cursor-pointer accent-gold">
        Hide maxed upgrades
      </label>`),b+=Xl(u,l,m,"research"),b+="</div>",t.innerHTML=b;const x=t.querySelector('[data-action="toggle-hide-maxed"]');x&&x.addEventListener("change",()=>{a=x.checked,s()}),s(),t.querySelectorAll('[data-action="purchase-upgrade"]').forEach(g=>{g.addEventListener("click",()=>{const h=g.getAttribute("data-id");S.getState().purchaseUpgrade(h)})});const p=K(S.getState());t.querySelectorAll('[data-action="toggle-autobuy"]').forEach(g=>{const h=g.getAttribute("data-id");g.checked=p.autoBuyUpgrades[h]??!1,g.addEventListener("change",()=>{S.getState().toggleAutoBuy(h)})})};return i(),()=>{const o=S.getState(),c=K(o),{upgrades:l}=c,m=Te(c.recipeInventory),u=Kt(c.recipeInventory),f=o.globalTier,b=Ae.filter(p=>{var h;const g=br[p];return g&&(((h=c.recipeCrafting[g])==null?void 0:h.lifetimeProduced)??0)>0}).length+Ne.filter(p=>{var h;const g=yr[p];return g&&(((h=c.recipeCrafting[g])==null?void 0:h.lifetimeProduced)??0)>0}).length;if(o.activeRealm!==n||o.globalTier!==e||b!==r){i();return}const x=t.querySelectorAll("[data-upgrade-row]");for(const p of x){const g=p.getAttribute("data-upgrade-row");if(Ot(l,g,f)&&!p.classList.contains("text-muted--50")){i();return}}t.querySelectorAll("[data-upgrade-row]").forEach(p=>{const g=p.getAttribute("data-upgrade-row"),h=l[g],v=ho(g,f),y=Ot(l,g,f),T=ze(g,h),M=Ze(l,g,c.mana,u,m,f,c.recipeInventory),E=y?1:zl(g,h,m,c.recipeInventory),I=t.querySelector(`[data-upgrade-level="${g}"]`);I&&(I.textContent=`${at(h)}/${at(v)}`);const R=t.querySelector(`[data-upgrade-cost="${g}"]`);R&&(y||!T?R.innerHTML="-":R.innerHTML=`<div class="flex items-center gap-2 flex-nowrap">${T.map($=>{const C=$.recipeId?$.recipeId.replace("_"," "):`t${$.tier} flask`;let Y;return $.recipeId?Y=et(c.recipeInventory,$.recipeId).gte($.amount):Y=vs(m,$.tier,$.amount),`<div class="flex items-center gap-0.5">
              <img src="${L(`icons/${C}.png`)}" alt="" class="w-8 h-8 object-contain">
              <span class="${Y?"text-text":"text-muted--50"}">${G($.amount)}</span>
            </div>`}).join("")}</div>`);const _=t.querySelector(`[data-upgrade-effect="${g}"]`);if(_){const $=Ga(g,l);if(y)_.innerHTML=`<span class="text-steel">x${G($)}</span>`;else{const C={...l,[g]:h+1},Y=Ga(g,C);_.innerHTML=`<span class="text-steel">x${G($)}</span><span class="text-muted">  </span><span class="text-positive">x${G(Y)}</span>`}}const V=t.querySelector(`[data-action="purchase-upgrade"][data-id="${g}"]`);if(V){const $=yn(y,M);V.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${$}`,y||!M?V.setAttribute("disabled",""):V.removeAttribute("disabled");const C=t.querySelector(`[data-upgrade-btn-text="${g}"]`);C&&(C.textContent=y?"MAX":"Buy"),tn(t.querySelector(`[data-upgrade-progress="${g}"]`),E,y)}const B=t.querySelector(`[data-action="toggle-autobuy"][data-id="${g}"]`);B&&(B.checked=c.autoBuyUpgrades[g]??!1)}),s()}},Js=ce(dt.Upgrades,Ql),Jl=Js.cleanup,tc=Js.render,Va=(t,n="w-10 h-10")=>t.map(e=>`
    <span class="inline-flex items-center gap-0.5">
      <img src="${e.icon}" alt="" class="${n} object-contain">
      <span class="${e.canAfford?"text-text":"text-red"}">${G(e.amount)}</span>
    </span>
  `).join(""),ja=()=>{const t=S.getState(),n=K(t),{artifacts:e}=n;if(!Ut.some(c=>e.owned[c]))return"";const a=[],s=c=>`<img src="${c}" alt="" style="width:40px;height:40px" class="object-contain">`;for(let c=1;c<=8;c++){const l=Yr(e,c);l.eq(1)||a.push(`<tr><td class="pr-2">${s(L(`icons/t${c} gem.png`))}</td><td class="text-positive">x${G(l)}</td><td class="pl-1 text-muted">gem output</td></tr>`)}const i=Rs(e);i>1&&a.push(`<tr><td class="pr-2">${s(L("icons/combat artifact.png"))}</td><td class="text-positive">x${G(i)}</td><td class="pl-1 text-muted">combat strength</td></tr>`);const o=$s(e);return o>1&&a.push(`<tr><td class="pr-2">${s(L("icons/crafting speed.png"))}</td><td class="text-positive">x${G(o)}</td><td class="pl-1 text-muted">craft speed</td></tr>`),a.length===0?"":`
    <div class="p-2 border border-muted--20" style="width:fit-content">
      <div class="text-xs text-muted mb-1">Active Bonuses</div>
      <table class="text-sm font-mono">
        ${a.join("")}
      </table>
    </div>
  `},_t=(t,n)=>{const e=ht[t];if(e.type==="crafting_speed"){const a=1+e.upgradeBonus*n;return a===1?"x1":`x${G(a)}`}const r=Math.pow(1+e.upgradeBonus,n);return r===1?"x1":`x${G(r)}`},ge=t=>{const n=ht[t];return n.type==="combat"?"combat strength":n.type==="crafting_speed"?"craft speed":"gem output"},Ya=t=>{if(t.length===0)return 0;let n=1;for(const e of t)if(e.amount.gt(0)){const r=Math.min(1,e.have.div(e.amount).toNumber());r<n&&(n=r)}return n},wn=t=>{const n=S.getState(),e=K(n),r=Et(e.artifacts,t),a=e.artifacts.upgradeLevels[t]??0,s=fn(n.globalTier,t);if(n.activeRealm==="realm2")return{costHtml:"",canAct:!1,action:"none",progress:0};const o=et(e.recipeInventory,"artifact_shard").toNumber();if(!r){const m=qo(t,o),u=Ts(t,o);return{costHtml:Va(m),canAct:u,action:"buy",progress:Ya(m)}}if(a>=s)return{costHtml:"",canAct:!1,action:"maxed",progress:0};const c=_o(t,a,s,o),l=Ms(t,a,o,s);return{costHtml:Va(c),canAct:l,action:"upgrade",progress:Ya(c)}},ec=["ring","general"],nc={ring:"Rings",general:"General"},rc=t=>{const n=ht[t];return n.type==="combat"||n.type==="crafting_speed"?"general":"ring"},Wa=()=>{const t=S.getState(),n=K(t);return t.activeRealm==="realm2"?Ut.filter(r=>n.artifacts.owned[r]):Ut.filter(r=>{var s,i;const a=ht[r];return n.artifacts.owned[r]||t.realms.realm2.artifacts.owned[r]?!0:a.tier===1?(((s=n.recipeCrafting.artifact_shard)==null?void 0:s.lifetimeProduced)??0)>0:(((i=n.recipeCrafting.artifact_shard)==null?void 0:i.lifetimeProduced)??0)>0})},Ka=t=>{const{costHtml:n,action:e}=wn(t);return e==="none"||e==="maxed"?"":`<span class="inline-flex items-center gap-1 text-xs">${n}</span>`},za=t=>{const{canAct:n,action:e,progress:r}=wn(t);return e==="none"?"":e==="maxed"?'<span class="text-gold text-xs">MAX</span>':`
      <button
        data-action="${e}-artifact"
        data-id="${t}"
        ${n?"":"disabled"}
        class="relative px-2 py-0.5 text-xs font-mono border overflow-hidden ${n?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"} whitespace-nowrap"
      >${Je(r,`data-forge-progress="${t}"`)}<span class="relative z-10">Forge</span></button>
  `},ac=t=>{const n=()=>{var c;const e=S.getState(),r=K(e),a=e.activeRealm==="realm2";if(!a&&(((c=r.recipeCrafting.artifact_shard)==null?void 0:c.lifetimeProduced)??0)===0){t.innerHTML=`
        <div class="flex items-center justify-center h-64">
          <div class="text-center text-muted">
            <div class="text-lg mb-2">You must get artifact shards from expeditions before you can craft artifacts</div>
          </div>
        </div>
      `;return}const s=Wa();if(s.length===0&&a){t.innerHTML=`
        <div class="p-4 font-mono">
          <h2 class="text-lg text-gold mb-2">Artifacts</h2>
          <div class="text-muted text-center py-8">
            No artifacts shipped yet. Use the Realm tab to ship artifacts from the Prime Realm.
          </div>
        </div>
      `;return}let i='<div class="p-4 font-mono">';i+='<div class="flex items-start gap-4">',i+='<div class="flex-1 min-w-0">',i+='<h2 class="text-lg text-gold mb-2">Artifacts</h2>',i+=`<div class="text-sm text-steel mb-4">${a?"Artifacts shipped from the Prime Realm.":"Craft and upgrade artifacts with artifact shards from expeditions."}</div>`,a||(i+=`
        <div class="text-sm mb-4">
          <span class="text-muted">Artifact Shards:</span>
          <span class="text-text" data-artifact-shards>${at(et(r.recipeInventory,"artifact_shard").toNumber())}</span>
        </div>
      `);const o={ring:[],general:[]};for(const l of s)o[rc(l)].push(l);for(const l of ec){const m=o[l];if(m.length===0)continue;let u=`<div class="mobile-scroll-x"><table class="text-sm font-mono" style="table-layout:fixed" data-artifacts-table="${l}">
        <colgroup>
          <col style="width:200px">
          <col style="width:70px">
          <col style="width:320px">
          <col style="width:80px">
          <col style="width:80px">
        </colgroup>
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="text-left">Artifact</th>
            <th class="text-left">Level</th>
            <th class="text-left">Effect</th>
            <th class="text-left">Cost</th>
            <th class="text-right">Forge</th>
          </tr>
        </thead>
        <tbody>`;for(const f of m){const b=ht[f],x=Et(r.artifacts,f),p=r.artifacts.upgradeLevels[f]??0,g=fn(e.globalTier,f),h=p>=g;let v="";if(x)if(h)v=`<span class="text-text">${_t(f,p)}</span> <span class="text-muted">${ge(f)}</span>`;else{const y=_t(f,p),T=_t(f,p+1),M=ge(f);v=`<span class="text-text">${y}</span> <span class="text-steel"></span> <span class="text-positive">${T}</span> <span class="text-muted">${M}</span>`}else{const y=_t(f,1),T=ge(f);v=`<span class="text-text">${_t(f,0)}</span> <span class="text-steel"></span> <span class="text-positive">${y}</span> <span class="text-muted">${T}</span>`}u+=`
          <tr data-artifact-row="${f}">
            <td class="py-1">
              <span class="inline-flex items-center gap-1.5">
                <img src="${b.icon}" alt="${b.name}" style="width: 48px; height: 48px;" class="object-contain">
                <span class="text-gold">${b.name}</span>
              </span>
            </td>
            <td class="text-steel" data-artifact-level="${f}">${x?p:"-"}</td>
            <td data-artifact-effect-cell="${f}">${v}</td>
            <td data-artifact-cost="${f}">${Ka(f)}</td>
            <td class="text-right" data-artifact-action="${f}">${za(f)}</td>
          </tr>`}u+="</tbody></table></div>",i+=`<div class="mb-4">${se(`artifacts-${l}`,nc[l],u)}</div>`}i+="</div>",i+=`<div data-artifacts-bonuses class="flex-shrink-0">${ja()}</div>`,i+="</div>",i+="</div>",t.innerHTML=i,sc(t),t.querySelectorAll("[data-artifact-action]").forEach(l=>{const m=l.getAttribute("data-artifact-action"),{action:u}=wn(m);l.setAttribute("data-prev-action",u)})};return n(),()=>{var m;const e=S.getState(),r=K(e),a=e.activeRealm==="realm2",s=t.querySelectorAll("[data-artifact-row]");let i=!1;const o=Wa();for(const u of o)if(!t.querySelector(`[data-artifact-row="${u}"]`)){i=!0;break}if(!i)for(const u of s){const f=u.getAttribute("data-artifact-row"),b=Et(r.artifacts,f),x=t.querySelector(`[data-artifact-level="${f}"]`);if(x&&x.textContent!=="-"!==b){i=!0;break}}if(!a&&(((m=r.recipeCrafting.artifact_shard)==null?void 0:m.lifetimeProduced)??0)>0&&!t.querySelector("[data-artifacts-bonuses]")&&(i=!0),i){n();return}const c=t.querySelector("[data-artifacts-bonuses]");c&&(c.innerHTML=ja());const l=t.querySelector("[data-artifact-shards]");l&&(l.textContent=at(et(r.recipeInventory,"artifact_shard").toNumber()));for(const u of s){const f=u.getAttribute("data-artifact-row"),b=Et(r.artifacts,f),x=r.artifacts.upgradeLevels[f]??0,p=fn(e.globalTier,f),g=x>=p,h=t.querySelector(`[data-artifact-level="${f}"]`);h&&(h.textContent=b?String(x):"-");const v=t.querySelector(`[data-artifact-effect-cell="${f}"]`);if(v){let M="";if(b)if(g)M=`<span class="text-text">${_t(f,x)}</span> <span class="text-muted">${ge(f)}</span>`;else{const E=_t(f,x),I=_t(f,x+1),R=ge(f);M=`<span class="text-text">${E}</span> <span class="text-steel"></span> <span class="text-positive">${I}</span> <span class="text-muted">${R}</span>`}else{const E=_t(f,1),I=ge(f);M=`<span class="text-text">${_t(f,0)}</span> <span class="text-steel"></span> <span class="text-positive">${E}</span> <span class="text-muted">${I}</span>`}v.innerHTML=M}const y=t.querySelector(`[data-artifact-cost="${f}"]`);y&&(y.innerHTML=Ka(f));const T=t.querySelector(`[data-artifact-action="${f}"]`);if(T){const{canAct:M,action:E,progress:I}=wn(f),R=t.querySelector(`[data-forge-progress="${f}"]`);tn(R,I);const _=T.querySelector("button");if(_){const $=M?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed";_.className=`relative px-2 py-0.5 text-xs font-mono border overflow-hidden ${$} whitespace-nowrap`,_.disabled=!M}const V=T.getAttribute("data-prev-action")??"",B=E;if(V!==B){T.setAttribute("data-prev-action",B),T.innerHTML=za(f);const $=T.querySelector("button");$&&$.addEventListener("click",C=>{C.stopPropagation(),ti(f)})}}}}},ti=t=>{const n=S.getState(),e=K(n);Et(e.artifacts,t)?S.getState().upgradeArtifact(t):S.getState().craftArtifact(t)},sc=t=>{t.querySelectorAll('[data-action="buy-artifact"], [data-action="upgrade-artifact"]').forEach(n=>{n.addEventListener("click",e=>{e.stopPropagation();const r=n.getAttribute("data-id");ti(r)})})},ei=ce(dt.Artifacts,ac),ic=ei.render,oc=ei.cleanup,Nn=t=>{const n=Math.ceil(t/1e3),e=Math.floor(n/60),r=n%60;if(e===0)return`${r}s`;if(e>=60){const a=Math.floor(e/60),s=e%60;return`${a}h ${s}m`}return`${e}m ${r}s`},lc=t=>{const e=Date.now()-t,r=Math.floor(e/1e3),a=Math.floor(r/60),s=Math.floor(a/60);return s>0?`${s}h ago`:a>0?`${a}m ago`:`${r}s ago`},An=(t,n="normal")=>{const e=[],r=n==="small"?28:32,a=`width: ${r}px; height: ${r}px;`,s=n==="small"?"text-muted":"text-xs text-muted",i=n==="small"?"font-size: 14px;":"";if(t.artifactShards&&e.push(`<span class="inline-flex items-center gap-1"><img src="${L("icons/artifact shard.png")}" style="${a}"><span class="${s}" style="${i}">${at(t.artifactShards)}</span></span>`),t.nullstone&&e.push(`<span class="inline-flex items-center gap-1"><img src="${L("icons/nullstone.png")}" style="${a}"><span class="${s}" style="${i}">${at(t.nullstone)}</span></span>`),t.questBonusTiers&&t.questBonusTiers.length>0){const o=t.questBonusTiers.length===1?`T${t.questBonusTiers[0]}`:`T${Math.min(...t.questBonusTiers)}-T${Math.max(...t.questBonusTiers)}`;e.push(`<span class="text-xs text-yellow">${o} Output Bonus</span>`)}return e.join(" ")},ni=(t,n)=>{const e={};return t.artifactShards&&(e.artifactShards=t.artifactShards*n),t.nullstone&&(e.nullstone=t.nullstone*n),t.questBonusTiers&&(e.questBonusTiers=t.questBonusTiers),e},qn=(t,n,e=1)=>{if(n<=0)return"";const r=n/1e3,a=[];if(t.artifactShards){const s=t.artifactShards/r*e;a.push(`${G(s)}/s`)}if(t.nullstone){const s=t.nullstone/r*e;a.push(`${G(s)}/s`)}return a.length===0?"":`(${a.join(", ")})`},fa=(t,n,e)=>t.unlockRequirement?n.find(r=>r.id===t.unlockRequirement):e>0?n[e-1]:void 0,Sn=(t,n,e,r,a=0)=>{if(we(t,e,r,a))return!(t==="heroic_war_mastery"&&!S.getState().realms.realm1.combat.portalBuilt);const s=n.find(c=>c.id===t);if(s!=null&&s.heroic)return!1;const i=n.findIndex(c=>c.id===t);if(!s)return!1;const o=fa(s,n,i);return o?we(o.id,e,r,a):i===0},Ie=()=>{const t=S.getState();return qr(Yt(t.realms.realm1.recipeInventory),Yt(t.realms.realm2.recipeInventory),t.activeRealm,t.globalTier)},ri=(t,n)=>{const e=Rn(t);let r=!1;for(let s=1;s<=6;s++)if(e(s,n)>1){r=!0;break}if(!r)return"";let a='<div class="mb-4 p-3 border border-yellow--30 bg-yellow--5">';a+='<div class="text-sm font-bold text-yellow mb-2">Quest Output Bonuses</div>',a+='<div class="flex gap-4 text-xs">';for(let s=1;s<=6;s++){const i=e(s,n),o=i>1?`x${i.toFixed(2)}`:"",c=i>1?"text-yellow":"text-muted";a+=`<div class="flex flex-col items-center"><span class="text-muted">T${s}</span><span class="${c} font-mono">${o}</span></div>`}return a+="</div></div>",a};let pt=null,Z=Xr();const cc=()=>pt,uc=()=>{pt=null,Z=Xr()},dc=(t,n)=>{var i;const e=S.getState(),r=K(e);if(!we(t,r.combat.completionsPerExpedition,e.activeRealm,e.globalTier))return;pt=t;const a=Tt(t,e.activeRealm),s=r.combat.expeditionSetups[t];if(s){let o={...s.assignedUnits};if(a!=null&&a.heroic){const c=Me(e.activeRealm,e.globalTier);for(const l of Object.keys(o))((i=c[l])==null?void 0:i.unitRole)==="taunt"&&delete o[l]}Z={assignedUnits:o,repeatIfUnitsAvailable:a!=null&&a.heroic?!1:s.repeatIfUnitsAvailable}}else Z=Xr();Mc(n),Pt(n)},xr=t=>{pt=null;const n=t.querySelector("[data-setup-modal]");n&&n.classList.add("hidden")},fc=(t,n)=>{if(!pt)return;const e=pt;S.getState().saveExpeditionSetup(e,Z),xr(t),mc(e),n()},mc=t=>{const n=S.getState(),r=K(n).combat.expeditionSetups[t];r&&n.startExpedition(t,r.assignedUnits,r.repeatIfUnitsAvailable)},_n=t=>{var r;const n=S.getState();return((r=Me(n.activeRealm,n.globalTier)[t])==null?void 0:r.unitRole)??"strength"},ma=t=>{if(!pt)return;const n=S.getState(),e=K(n),r=Tt(pt,n.activeRealm);if(!r)return;const a=!!r.heroic,s=At(Z.assignedUnits,n.activeRealm,n.globalTier),i=Ht(s),c=(a?zt(r,e.combat.heroicVictories):r.difficulty??0)*i;if(qt(Z.assignedUnits,n.activeRealm,e.upgrades,e.artifacts,n.globalTier)<=c)return;const m=Gt(n.activeRealm,n.globalTier),u=Me(n.activeRealm,n.globalTier),f=m.filter(h=>{const v=u[h];return(v==null?void 0:v.unitRole)==="strength"&&(Z.assignedUnits[h]||0)>0});if(f.length===0)return;let b=0,x=1,p=0;for(let h=0;h<50;h++){const v=(b+x)/2,y={...Z.assignedUnits};for(const M of f)y[M]=Math.max(0,Math.floor((Z.assignedUnits[M]||0)*v));qt(y,n.activeRealm,e.upgrades,e.artifacts,n.globalTier)>=c?(p=v,x=v):b=v}const g={...Z.assignedUnits};for(const h of f)g[h]=Math.max(0,Math.floor((Z.assignedUnits[h]||0)*p));Z={...Z,assignedUnits:g},Pt(t)},Pt=t=>{if(!pt)return;const n=S.getState(),e=K(n),{upgrades:r}=e,a=Ie(),s=Tt(pt,n.activeRealm);if(!s)return;const i=mn(Z.assignedUnits,n.activeRealm,n.globalTier),o=At(Z.assignedUnits,n.activeRealm,n.globalTier),c=Ht(o),l=pn(o),u=(s.heroic?zt(s,e.combat.heroicVictories):s.difficulty??0)*c,f=qt(Z.assignedUnits,n.activeRealm,r,e.artifacts,n.globalTier),b=Be(f,u),x=b>0,p=Gt(n.activeRealm,n.globalTier);for(const _ of p){const V=(a[_]||{toNumber:()=>0}).toNumber(),B=t.querySelector(`[data-modal-available-${_}]`);B&&(B.textContent=at(V));const $=t.querySelector(`[data-modal-input-${_}]`);$&&document.activeElement!==$&&($.value=at(Z.assignedUnits[_]||0))}const g=t.querySelector("[data-modal-strength]");g&&(g.textContent=G(f),g.className=`font-mono ${x?"text-positive":"text-red"}`);const h=t.querySelector("[data-modal-success-rate]");h&&(h.textContent=`${(b*100).toFixed(1)}%`,h.className=`font-mono ${b>0?"text-positive":"text-red"}`);const v=t.querySelector("[data-modal-speed]");if(v){const _=Se(pt,n.activeRealm,i);v.textContent=i>0?`${Nn(_)}`:"",v.className=`font-mono ${i>0?"text-cyan":"text-muted"}`}const y=t.querySelector("[data-modal-taunt-diff]");y&&(y.textContent=o>0?`x${c.toFixed(2)}`:"",y.className=`font-mono ${o>0?"text-magenta":"text-muted"}`);const T=t.querySelector("[data-modal-taunt-reward]");T&&(T.textContent=o>0?`x${l.toFixed(2)}`:"",T.className=`font-mono ${o>0?"text-magenta":"text-muted"}`);const M=t.querySelector("[data-modal-effective-difficulty]");M&&(M.textContent=at(Math.round(u)),M.className=c>1?"text-magenta font-mono":"font-mono");const E=t.querySelector("[data-modal-effective-rewards]");if(E&&!!!s.heroic){const V=le(e.combat.heroicVictories,n.activeRealm);let B=s.rewards;V!==1&&s.rewards.artifactShards&&(B={...B,artifactShards:Math.round(s.rewards.artifactShards*V)});const $={...B,artifactShards:B.artifactShards?Math.round(B.artifactShards*l):void 0,nullstone:B.nullstone?Math.round(B.nullstone*l):void 0};E.innerHTML=An($,"small"),l>1?E.classList.add("text-magenta"):E.classList.remove("text-magenta");const C=t.querySelector("[data-modal-rewards-rate]");if(C){const Y=Se(pt,n.activeRealm,i),F=Jr(s.rewards,l,e.combat.heroicVictories,e.prestige,e.altar.sacrificeCounts,n.activeRealm);C.textContent=qn(F,Y,b)}}const I=t.querySelector("[data-repeat-checkbox]");I&&(I.checked=Z.repeatIfUnitsAvailable);const R=t.querySelector("[data-save-setup]");R&&(x?(R.disabled=!1,R.classList.remove("line-through","text-muted"),R.classList.add("text-steel","cursor-pointer")):(R.disabled=!0,R.classList.add("line-through","text-muted"),R.classList.remove("text-steel","cursor-pointer")))},wr=(t,n,e)=>{if(!pt)return;const r=S.getState(),a=Tt(pt,r.activeRealm);if(!a)return;const s=Ie(),i=Math.floor((s[t]||{toNumber:()=>0}).toNumber());let c=(Z.assignedUnits[t]||0)+n;c=Math.max(0,c),c=Math.min(i,c);const l=!!a.heroic,m=_n(t);if(n>0&&m==="strength"){const f=At(Z.assignedUnits,r.activeRealm,r.globalTier),b=Ht(f),p=(l?zt(a,K(S.getState()).combat.heroicVictories):a.difficulty??0)*b,g=K(S.getState()),{upgrades:h}=g,v=i;let y=v;const T=K(S.getState()).artifacts;for(let M=0;M<=v;M++){const E={...Z.assignedUnits,[t]:M};if(qt(E,r.activeRealm,h,T,r.globalTier)>=p){y=M;break}}c=Math.min(c,y)}const u=m==="taunt"?At(Z.assignedUnits,r.activeRealm,r.globalTier):0;if(Z={...Z,assignedUnits:{...Z.assignedUnits,[t]:c}},m==="taunt"&&n<0&&At(Z.assignedUnits,r.activeRealm,r.globalTier)<u){ma(e);return}Pt(e)},pc=(t,n)=>{if(!pt)return;const e=_n(t);if(Z={...Z,assignedUnits:{...Z.assignedUnits,[t]:0}},e==="taunt"){ma(n);return}Pt(n)},Za=(t,n,e)=>{if(!pt)return;const r=S.getState(),a=K(r),s=Tt(pt,r.activeRealm);if(!s)return;const i=Ie(),o=Math.floor((i[t]||{toNumber:()=>0}).toNumber());let c=Math.max(0,Math.floor(n));c=Math.min(o,c);const l=!!s.heroic,m=_n(t);if(m==="strength"){const f=At(Z.assignedUnits,r.activeRealm,r.globalTier),b=Ht(f),p=(l?zt(s,a.combat.heroicVictories):s.difficulty??0)*b,g={...Z.assignedUnits,[t]:0},h=qt(g,r.activeRealm,a.upgrades,a.artifacts,r.globalTier),v=p-h;let y;if(v<=0)y=0;else{const M=Me(r.activeRealm,r.globalTier)[t],E=bs(a.upgrades),I=((M==null?void 0:M.strengthMultiplier)??1)+E,R=(M==null?void 0:M.strengthExponent)??1;y=Math.ceil(Math.pow(v/I,1/R))}c=Math.min(c,y)}const u=Z.assignedUnits[t]||0;if(Z={...Z,assignedUnits:{...Z.assignedUnits,[t]:c}},m==="taunt"&&c<u){ma(e);return}Pt(e)},gc=(t,n)=>{if(!pt)return;const e=S.getState(),r=K(e),a=Tt(pt,e.activeRealm);if(!a)return;const s=Ie(),i=Math.floor((s[t]||{toNumber:()=>0}).toNumber()),o=!!a.heroic,c=i;if(_n(t)!=="strength"){Z={...Z,assignedUnits:{...Z.assignedUnits,[t]:c}},Pt(n);return}const m=At(Z.assignedUnits,e.activeRealm,e.globalTier),u=Ht(m),b=(o?zt(a,r.combat.heroicVictories):a.difficulty??0)*u;let x=0,p=c,g=c;for(;x<=p;){const h=Math.floor((x+p)/2),v={...Z.assignedUnits,[t]:h};qt(v,e.activeRealm,r.upgrades,r.artifacts,e.globalTier)>=b?(g=h,p=h-1):x=h+1}Z={...Z,assignedUnits:{...Z.assignedUnits,[t]:g}},Pt(n)},hc=(t,n)=>{if(!pt)return;const e=S.getState(),r=K(e),a=Tt(pt,e.activeRealm);if(!a)return;const s=Ie(),i=Math.floor((s[t]||{toNumber:()=>0}).toNumber()),o=!!a.heroic,c=At(Z.assignedUnits,e.activeRealm,e.globalTier),l=Ht(c),u=(o?zt(a,r.combat.heroicVictories):a.difficulty??0)*l,f=qt(Z.assignedUnits,e.activeRealm,r.upgrades,r.artifacts,e.globalTier),b=Be(f,u),x=Math.min(b+.1,1),p=u*x;let g=Z.assignedUnits[t]||0,h=i,v=h;for(;g<=h;){const y=Math.floor((g+h)/2),T={...Z.assignedUnits,[t]:y};qt(T,e.activeRealm,r.upgrades,r.artifacts,e.globalTier)>=p?(v=y,h=y-1):g=y+1}Z={...Z,assignedUnits:{...Z.assignedUnits,[t]:v}},Pt(n)},vc=t=>{var o;const n=S.getState(),r=((o=K(n).recipeCrafting[t])==null?void 0:o.lifetimeProduced)??0;if(r<=0)return[1,10,100];const a=r*.01,s=Math.floor(Math.log10(Math.max(1,a))),i=Math.max(1,Math.pow(10,s));return[i/100,i/10,i]},bc=(t,n,e)=>{wr(t,n,e)},yc=t=>{Z={...Z,repeatIfUnitsAvailable:!Z.repeatIfUnitsAvailable},Pt(t)},xc=(t,n)=>{const e={strength:[],speed:[],taunt:[]};for(const r of t){const a=n[r];a&&e[a.unitRole].push(r)}return e},wc={strength:"Army",speed:"Fleet",taunt:"Beacons"},Sc={strength:"Increases combat strength, improving success rate",speed:"Reduces expedition duration",taunt:"Increases rewards (2x) and difficulty (1x)"},kc={strength:[{label:"Success rate",value:"strength / difficulty"},{label:"Capped at 100%"},{label:"On success",value:"all units lost, rewards granted"},{label:"On failure",value:"all units lost, no rewards"}],speed:[{label:"Duration",value:"base / (1 + speed / "+xs+")"},{label:"Higher fleet value = faster expeditions"}],taunt:[{label:"Reward mult",value:"1 + taunt / "+Ss},{label:"Difficulty mult",value:"1 + taunt / "+ws},{label:"Reward bonus is 2x the difficulty bonus"}]},Tc=(t,n)=>{const e=[{label:Sc[t.unitRole]},{label:"Formula",value:`n^${t.strengthExponent}  ${G(t.strengthMultiplier)}`},...kc[t.unitRole]],r=`${n}<span class="text-muted cursor-help">?</span>`;return zs(e,t.name,r)},Qn=(t,n,e,r)=>{if(n.length===0)return"";let a="";const s="h-6 text-xs border border-muted text-muted hover-border-steel hover-text-steel cursor-pointer";for(const o of n){const c=e[o],l=(r[o]||{toNumber:()=>0}).toNumber(),m=Z.assignedUnits[o]||0,u=`<img src="${c.icon}" alt="${c.name}" style="width: 32px; height: 32px;">`;let f;if(t==="strength")f=`
          <button data-modal-assign="clear" data-unit="${o}" class="${s}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all assigned units">--</button>
          <input type="text" data-modal-input-${o} data-unit="${o}" value="${at(m)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
          <button data-modal-assign="plus10" data-unit="${o}" class="${s}" style="min-width: 40px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add units to increase success rate by 10%">+10%</button>
          <button data-modal-assign="max" data-unit="${o}" class="${s}" style="min-width: 40px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add minimum units for 100% success rate">100%</button>
      `;else{const[b,x,p]=vc(o);f=`
          <button data-modal-assign="clear" data-unit="${o}" class="${s}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all assigned units">--</button>
          <input type="text" data-modal-input-${o} data-unit="${o}" value="${at(m)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
          <span class="text-muted text-xs" style="line-height: 1;">+</span>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button data-modal-assign="static" data-unit="${o}" data-amount="${p}" class="${s}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${at(p)} units">${at(p)}</button>
            <button data-modal-assign="static" data-unit="${o}" data-amount="${x}" class="${s}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${at(x)} units">${at(x)}</button>
            <button data-modal-assign="static" data-unit="${o}" data-amount="${b}" class="${s}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${at(b)} units">${at(b)}</button>
          </div>
      `}a+=`
      <div class="flex items-center mb-1" style="gap: 20px;">
        <span class="flex items-center gap-1">
          ${Tc(c,u)}
        </span>
        <span class="text-muted text-xs font-mono" style="width: 48px;" data-modal-available-${o}>${at(l)}</span>
        <div class="flex items-center gap-1">
          ${f}
        </div>
      </div>
    `}return`
    <div class="min-w-0" style="flex: 1;">
      <div class="mb-2 pb-1 border-b border-muted--30">
        <span class="text-xs ${t==="strength"?"text-red":t==="speed"?"text-cyan":"text-magenta"} font-bold">${wc[t]}</span>
      </div>
      ${a}
    </div>
  `},Mc=t=>{if(!pt)return;const n=S.getState(),e=Tt(pt,n.activeRealm);if(!e)return;const r=K(n),a=Ie(),s=Se(e.id,n.activeRealm),i=e.heroic?zt(e,r.combat.heroicVictories):e.difficulty??0,o=!!e.heroic,c=le(r.combat.heroicVictories,n.activeRealm);let l=e.rewards;c!==1&&e.rewards.artifactShards&&(l={...l,artifactShards:Math.round(e.rewards.artifactShards*c)});const m=Gt(n.activeRealm,n.globalTier),u=Me(n.activeRealm,n.globalTier),f=xc(m,u),b=f.speed.length>0,x=!o&&f.taunt.length>0,p=1+(b?1:0)+(x?1:0),g=Qn("strength",f.strength,u,a),h=b?Qn("speed",f.speed,u,a):"",v=x?Qn("taunt",f.taunt,u,a):"",y=t.querySelector("[data-setup-modal]");if(y){const T=p>=3?"max-w-5xl":p>=2?"max-w-4xl":"max-w-2xl";y.innerHTML=`
      <div data-modal-backdrop class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
        <div class="bg-black border border-muted--50 p-6 ${T} w-full mx-4">
          <div class="flex items-center gap-3 mb-4">
            <div>
              <h3 class="text-gold font-bold">${e.name}</h3>
              <div class="text-xs text-muted">
                Difficulty: <span data-modal-effective-difficulty class="font-mono">${at(i)}</span>
                | Duration: ${Nn(s)}
                | Done: ${o?r.combat.heroicVictories[e.id]||0:r.combat.completionsPerExpedition[e.id]||0}
              </div>
            </div>
            <button data-close-modal class="ml-auto text-muted hover-text-text text-2xl cursor-pointer">&times;</button>
          </div>

          <div class="mb-2">
            ${o?`<div class="text-xs text-muted">&#8226; ${e.heroic.rewardType==="shard_drops"?"Artifact shard drops":e.heroic.rewardType==="realm1_output"?"R1 output":"R2 output"} x${e.heroic.rewardScaling} per victory (compounding)</div><div class="text-xs text-muted">&#8226; Difficulty scales x${e.heroic.difficultyScaling} per victory</div>`:`<div class="flex items-center gap-2"><span class="text-xs text-muted">Rewards:</span> <span data-modal-effective-rewards>${An(l,"small")}</span> <span data-modal-rewards-rate class="text-xs text-cyan font-mono">${qn(l,s)}</span></div>`}
          </div>

          <div class="mb-4">
            <div class="flex gap-4">
              ${g}
              ${h}
              ${v}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Strength:</span>
              <span data-modal-strength class="font-mono text-text">0</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Success:</span>
              <span data-modal-success-rate class="font-mono text-red">0%</span>
            </div>
            ${b?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Duration:</span>
              <span data-modal-speed class="font-mono text-muted"></span>
            </div>`:""}
            ${x?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Beacon Diff:</span>
              <span data-modal-taunt-diff class="font-mono text-muted"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Beacon Reward:</span>
              <span data-modal-taunt-reward class="font-mono text-muted"></span>
            </div>`:""}
          </div>

          ${o?"":`<div class="mb-4">
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" data-repeat-checkbox ${Z.repeatIfUnitsAvailable?"checked":""} class="w-4 h-4 accent-cyan">
              <span class="text-sm text-text">Repeat if units available</span>
            </label>
          </div>`}

          <div class="flex gap-2">
            <button data-close-modal class="flex-1 px-4 py-2 border border-muted text-muted hover-border-text hover-text-text cursor-pointer">Cancel</button>
            <button data-save-setup class="flex-1 px-4 py-2 border border-steel text-steel cursor-pointer">Save and Start</button>
          </div>
        </div>
      </div>
    `,y.classList.remove("hidden");const M=y.querySelector("[data-repeat-checkbox]");M&&M.addEventListener("change",()=>{yc(t)});for(const E of m){const I=y.querySelector(`[data-modal-input-${E}]`);I&&(I.addEventListener("change",()=>{const R=Ua(I.value);isNaN(R)||Za(E,R,t)}),I.addEventListener("keydown",R=>{if(R.key==="Enter"){const _=Ua(I.value);isNaN(_)||Za(E,_,t),I.blur()}}))}}},Sr=(t,n,e)=>{const r=Vt(n);let a=`
    <select data-log-filter class="bg-black text-text border border-muted--30 text-xs px-2 py-1 rounded">
      <option value="all"${e==="all"?" selected":""}>All Expeditions</option>
  `;for(const l of r)a+=`<option value="${l.id}"${e===l.id?" selected":""}>${l.name}</option>`;a+="</select>";const i=(e==="all"?t:t.filter(l=>l.expeditionId===e)).slice(-20);if(i.length===0)return`
      <div class="flex items-center gap-3 mb-2">${a}</div>
      <div class="text-muted text-sm">No expeditions completed yet.</div>
    `;const o=[...i].reverse();let c=`
    <div class="flex items-center gap-3 mb-2">${a}</div>
    <table class="w-full border-collapse text-xs">
      <thead>
        <tr class="border-b border-muted--30 text-muted">
          <th class="py-1 px-2 text-left w-6"></th>
          <th class="py-1 px-2 text-left">Expedition</th>
          <th class="py-1 px-2 text-right">Chance</th>
          <th class="py-1 px-2 text-right">Rewards</th>
          <th class="py-1 px-2 text-right">Time</th>
        </tr>
      </thead>
      <tbody>
  `;for(const l of o){const m=Tt(l.expeditionId,n),u=(m==null?void 0:m.name)||l.expeditionId,f=l.success?"text-positive":"text-red",b=l.success?"":"",x=`${(l.successRate*100).toFixed(0)}%`;let p="";if(l.success&&l.rewards){const g=[];l.rewards.artifactShards&&g.push(`<span class="inline-flex items-center gap-1"><img src="${L("icons/artifact shard.png")}" style="width: 32px; height: 32px;">+${at(l.rewards.artifactShards)}</span>`),l.rewards.nullstone&&g.push(`<span class="inline-flex items-center gap-1"><img src="${L("icons/nullstone.png")}" style="width: 32px; height: 32px;">+${at(l.rewards.nullstone)}</span>`),p=g.join(" ")}c+=`
      <tr class="border-b border-muted--20" data-log-entry="${l.timestamp}">
        <td class="py-1 px-2 ${f}">${b}</td>
        <td class="py-1 px-2 text-text">${u}</td>
        <td class="py-1 px-2 text-muted text-right">${x}</td>
        <td class="py-1 px-2 text-muted text-right">${p}</td>
        <td class="py-1 px-2 text-muted text-right" data-log-time="${l.timestamp}">${lc(l.timestamp)}</td>
      </tr>
    `}return c+="</tbody></table>",c};let ct=null,ye=null,Fe=null,ee="all",Ye="",kr="",Tr="";const Ic=()=>{Xs(dt.Combat),ye&&(clearInterval(ye),ye=null),Fe&&ct&&(ct.removeEventListener("click",Fe),Fe=null),ct=null,uc(),ee="all",Ye="",kr="",Tr=""},ai=(t,n)=>{if(t.length===0)return"";let e="";for(let r=0;r<t.length;r++){const a=t[r],i=Date.now()-a.startTime,o=Math.max(0,a.duration-i),c=Math.min(i/a.duration,1),l=Math.round(c*100);e+=`
      <div data-progress-slot="${r}" class="flex items-center gap-2">
        <div class="w-16 h-2 bg-muted--30 overflow-hidden">
          <div data-progress-bar="${r}" class="h-full transition-none" style="width: ${l}%; min-width: ${l>0?"2px":"0"}; background-color: var(--color-cyan);"></div>
        </div>
        <span data-remaining-time="${r}" class="text-xs text-muted font-mono w-16 text-left">${Nn(o)}</span>
      </div>
    `}return e},Rc=()=>{if(!ct)return;const t=S.getState(),n=K(t),{combat:e}=n,r=Vt(t.activeRealm);for(const a of r){const s=e.activeExpeditions[a.id]||[],i=ct.querySelector(`[data-expedition-row="${a.id}"]`);if(!i)continue;const o=i.querySelector("[data-progress-bars]");if(!o||o.querySelectorAll("[data-progress-slot]").length!==s.length)continue;const l=Date.now();for(let m=0;m<s.length;m++){const u=s[m],f=l-u.startTime,b=Math.max(0,u.duration-f),x=Math.round(Math.min(f/u.duration,1)*100),p=o.querySelector(`[data-progress-bar="${m}"]`);p&&(p.style.width=`${x}%`,p.style.minWidth=x>0?"2px":"0");const g=o.querySelector(`[data-remaining-time="${m}"]`);g&&(g.textContent=Nn(b))}}},$c=(t,n,e,r,a,s,i)=>{var m,u;const o=[r,String(a),s,i],c=Vt(r);for(const f of c){const b=t.activeExpeditions[f.id]||[];o.push(`${f.id}:${t.completionsPerExpedition[f.id]||0}:${b.length}:${t.heroicVictories[f.id]||0}:${t.pendingRepeats[f.id]||0}:${JSON.stringify(((m=t.expeditionSetups[f.id])==null?void 0:m.assignedUnits)||{})}:${((u=t.expeditionSetups[f.id])==null?void 0:u.repeatIfUnitsAvailable)||!1}`)}const l=Ct(r);for(const f of l){const b=(n[f]||{toNumber:()=>0}).toNumber();o.push(`${f}:${Math.floor(b)}`)}for(const f of l)o.push(`lc${f}:${e.lifetimeCrafted[f]??0}`);return o.join("|")},an=()=>{var g,h;if(!ct)return;const t=S.getState(),n=K(t),{combat:e}=n,r=Yt(n.recipeInventory),a=Ar(n.recipeCrafting,Ct(t.activeRealm)),s=JSON.stringify(n.prestige.prestigeCounts),i=JSON.stringify(n.altar.sacrificeCounts),o=$c(e,r,a,t.activeRealm,t.globalTier,s,i);if(o===kr)return;kr=o;const c=Vt(t.activeRealm),l=Gr(t.activeRealm);if(Ct(t.activeRealm).some(v=>(a.lifetimeCrafted[v]??0)>0)&&!ct.querySelector("[data-expedition-row]")){ln(ct);return}In(n.upgrades);for(let v=0;v<c.length;v++){const y=c[v],T=ct.querySelector(`[data-expedition-row="${y.id}"]`);if(!T){if(Sn(y.id,c,e.completionsPerExpedition,t.activeRealm,t.globalTier)){ln(ct);return}continue}const M=we(y.id,e.completionsPerExpedition,t.activeRealm,t.globalTier),E=Sn(y.id,c,e.completionsPerExpedition,t.activeRealm,t.globalTier),I=e.activeExpeditions[y.id]||[],R=e.completionsPerExpedition[y.id]||0;if(E)T.classList.remove("hidden");else{T.classList.add("hidden");continue}const _=T.querySelector("[data-setup-btn]");if(M&&!_){ln(ct);return}const V=T.querySelector("[data-locked-info]");if(V)if(M)V.classList.add("hidden");else{V.classList.remove("hidden");const q=fa(y,c,v);if(q){const tt=e.completionsPerExpedition[q.id]||0,j=l-tt;V.innerHTML=`<span class="text-red">&#128274;</span> ${j} more`}}const B=T.querySelector("[data-completions]");if(B&&(y.heroic?B.textContent=`${e.heroicVictories[y.id]||0}`:B.textContent=`${R}`),y.heroic){const q=T.querySelector(`[data-heroic-stats="${y.id}"]`);if(q){const j=e.heroicVictories[y.id]||0,ot=y.heroic.rewardType==="shard_drops"?"Shards":y.heroic.rewardType==="realm1_output"?"R1 out":"R2 out";q.textContent=`${ot} x${(y.heroic.rewardScaling**j).toFixed(2)}`}const tt=T.querySelector(`[data-heroic-victory-count="${y.id}"]`);tt&&(tt.textContent=`W: ${e.heroicVictories[y.id]||0}`)}const $=T.querySelector(`[data-quest-bonus="${y.id}"]`);if($&&y.rewards.questBonusTiers&&y.rewards.questBonusTiers.length>0){const q=y.rewards.questBonusTiers.length===1?`T${y.rewards.questBonusTiers[0]}`:`T${Math.min(...y.rewards.questBonusTiers)}-T${Math.max(...y.rewards.questBonusTiers)}`;let tt="";R>0&&(tt=` (+${Math.sqrt(R*.1).toFixed(2)})`),$.textContent=`${q} Output${tt}`}const C=T.querySelector(`[data-reward-icons="${y.id}"]`);if(C){const q=le(e.heroicVictories,t.activeRealm);let tt=y.rewards;q!==1&&y.rewards.artifactShards&&(tt={...tt,artifactShards:Math.round(y.rewards.artifactShards*q)}),C.innerHTML=An(tt,"small");const j=T.querySelector(`[data-reward-rate="${y.id}"]`);if(j)if(I.length>0){const ot=I[0].tauntMultiplier??1,U=Jr(y.rewards,ot,e.heroicVictories,n.prestige,n.altar.sacrificeCounts,t.activeRealm);j.textContent=qn(ni(U,I.length),I[0].duration,I[0].successRate)}else j.textContent=""}const Y=T.querySelector("[data-progress-bars]");Y&&Y.querySelectorAll("[data-progress-slot]").length!==I.length&&(I.length>0?Y.innerHTML=ai(I):Y.innerHTML="");const F=T.querySelector(`[data-clear-expedition="${y.id}"]`);F&&(I.length>0||!!e.expeditionSetups[y.id]?F.classList.remove("hidden"):F.classList.add("hidden"))}cc()&&Pt(ct);const f=((g=e.expeditionLog[0])==null?void 0:g.timestamp)??0,b=((h=e.expeditionLog[e.expeditionLog.length-1])==null?void 0:h.timestamp)??0,x=`${ee}-${e.expeditionLog.length}-${f}-${b}`;if(x!==Ye){Ye=x;const v=ct.querySelector("[data-expedition-log]");v&&(v.innerHTML=Sr(e.expeditionLog,t.activeRealm,ee))}const p=JSON.stringify(e.completionsPerExpedition);if(p!==Tr){Tr=p;const v=ct.querySelector("[data-quest-bonuses]");v&&(v.innerHTML=ri(t.activeRealm,e.completionsPerExpedition))}},ln=t=>{ct=t;const n=S.getState(),e=K(n),{combat:r}=e,a=Ct(n.activeRealm),s=Ar(e.recipeCrafting,a);if(!a.some(h=>(s.lifetimeCrafted[h]??0)>0)){t.innerHTML=`
      <div class="flex items-center justify-center h-64">
        <div class="text-center text-muted">
          <div class="text-lg mb-2">You must craft expedition units before you can start an expedition</div>
        </div>
      </div>
    `,je(dt.Combat,an);return}In(e.upgrades);const o=Vt(n.activeRealm),c=Gr(n.activeRealm),l=[],m=new Map;for(const h of o){const v=h.group||"Expeditions";if(!m.has(v)){const y=[];m.set(v,y),l.push({name:v,expeditions:y})}m.get(v).push(h)}const u=(h,v)=>{const y=we(h.id,r.completionsPerExpedition,n.activeRealm,n.globalTier),T=r.activeExpeditions[h.id]||[],M=r.completionsPerExpedition[h.id]||0,E=v.indexOf(h);if(!Sn(h.id,v,r.completionsPerExpedition,n.activeRealm,n.globalTier))return"";if(y){const I=!!h.heroic,R=I&&r.heroicVictories[h.id]||0;let _="";if(I){const B=h.heroic.rewardType==="shard_drops"?"Shards":h.heroic.rewardType==="realm1_output"?"R1 out":"R2 out";_=`<div class="text-xs text-yellow font-mono" data-heroic-stats="${h.id}">${B} x${(h.heroic.rewardScaling**R).toFixed(2)}</div><div class="text-xs text-muted" data-heroic-victory-count="${h.id}">W: ${R}</div>`}else if(h.rewards.questBonusTiers&&h.rewards.questBonusTiers.length>0){const B=h.rewards.questBonusTiers.length===1?`T${h.rewards.questBonusTiers[0]}`:`T${Math.min(...h.rewards.questBonusTiers)}-T${Math.max(...h.rewards.questBonusTiers)}`;_=`<div class="text-xs text-yellow" data-quest-bonus="${h.id}">${B} Output${M>0?` (+${Math.sqrt(M*.1).toFixed(2)})`:""}</div>`}else{const B=le(r.heroicVictories,n.activeRealm);let $=h.rewards;B!==1&&h.rewards.artifactShards&&($={...$,artifactShards:Math.round(h.rewards.artifactShards*B)});let C="";if(T.length>0){const Y=T[0].tauntMultiplier??1,F=Jr(h.rewards,Y,r.heroicVictories,e.prestige,e.altar.sacrificeCounts,n.activeRealm);C=qn(ni(F,T.length),T[0].duration,T[0].successRate)}_=`<span data-reward-icons="${h.id}">${An($,"small")}</span><div class="text-xs text-cyan font-mono" data-reward-rate="${h.id}">${C}</div>`}const V=T.length>0||!!r.expeditionSetups[h.id];return`
        <div data-expedition-row="${h.id}" data-expedition-click="${h.id}" class="border border-muted--30 p-2 cursor-pointer hover-border-steel hover-bg-row-odd-bright relative flex flex-col" style="width: 160px; height: 160px; background: var(--color-row-odd); overflow: hidden;">
          <div class="flex flex-col items-center gap-1">
            ${_}
          </div>
          <div data-progress-bars class="flex flex-col gap-1 mt-1 w-full">
            ${ai(T)}
          </div>
          <span data-completions class="hidden">${I?R:M}</span>
          <span data-difficulty="${h.id}" class="hidden"></span>
          <span data-heroic-reward="${h.id}" class="hidden"></span>
          <div data-locked-info class="hidden"></div>
          <button data-setup-btn="${h.id}" class="hidden"></button>
          <button data-clear-expedition="${h.id}" class="mt-auto w-full text-xs border border-muted--30 text-muted hover-border-red hover-text-red cursor-pointer py-1 ${V?"":"hidden"}">Clear</button>
        </div>
      `}else{let I="";const R=fa(h,v,E);if(R){const _=r.completionsPerExpedition[R.id]||0;I=`<span class="text-red">&#128274;</span> ${c-_} more`}return`
        <div data-expedition-row="${h.id}" class="border border-muted--20 p-2 flex items-center justify-center" style="width: 160px; height: 160px; opacity: 0.5; background: var(--color-row-odd);">
          <div data-locked-info class="text-xs text-muted text-center">${I}</div>
        </div>
      `}},f={"Shards & CP":"+Shards<br>+Combat Points",Nullstones:"+Nullstones","Heroic Expeditions":"Heroic","Output Bonuses":"Output Bonuses"};let b="";for(const h of l){let v="";for(const T of h.expeditions)v+=u(T,o);if(!v)continue;const y=f[h.name]||h.name;b+=`
      <div class="flex items-center gap-4 mb-4">
        <div class="text-xs text-muted font-bold font-mono" style="width: 130px; flex-shrink: 0;">${y}</div>
        <div class="flex flex-wrap gap-2 items-center">
          ${v}
        </div>
      </div>
    `}const p=l.some(h=>h.name==="Heroic Expeditions"&&h.expeditions.some(v=>Sn(v.id,o,r.completionsPerExpedition,n.activeRealm,n.globalTier)))?'<div class="text-xs text-muted mb-4" style="margin-left: 146px;">Heroic expeditions never reset.</div>':"",g=ri(n.activeRealm,r.completionsPerExpedition);t.innerHTML=`
    <div>
      <div data-quest-bonuses>${g}</div>
      ${b}
      ${p}
      <div class="mt-6">
        ${se("expedition-log","Expedition Log",`<div data-expedition-log class="max-w-2xl">
            ${Sr(r.expeditionLog,n.activeRealm,ee)}
          </div>`,!0)}
      </div>
      <div data-setup-modal class="hidden"></div>
    </div>
  `,Fe=h=>{const v=h.target,y=v.closest("[data-clear-expedition]");if(y){const I=y.getAttribute("data-clear-expedition");I&&S.getState().clearExpedition(I);return}const T=v.closest("[data-expedition-click]");if(T){const I=T.getAttribute("data-expedition-click");if(I){dc(I,ct);return}}if(v.hasAttribute("data-close-modal")){xr(ct);return}if(v.hasAttribute("data-modal-backdrop")){xr(ct);return}if(v.hasAttribute("data-save-setup")&&!v.disabled){fc(ct,an);return}const M=v.getAttribute("data-modal-assign"),E=v.getAttribute("data-unit");if(M&&E){switch(M){case"clear":pc(E,ct);break;case"sub1":wr(E,-1,ct);break;case"add1":wr(E,1,ct);break;case"max":gc(E,ct);break;case"plus10":hc(E,ct);break;case"static":{const I=Number(v.getAttribute("data-amount")||"0");I>0&&bc(E,I,ct);break}}return}},t.addEventListener("click",Fe),t.addEventListener("change",h=>{var y,T;const v=h.target;if(v.matches("[data-log-filter]")){ee=v.value,Ye="";const M=ct==null?void 0:ct.querySelector("[data-expedition-log]");if(M){const E=S.getState(),I=K(E).combat;M.innerHTML=Sr(I.expeditionLog,E.activeRealm,ee);const R=((y=I.expeditionLog[0])==null?void 0:y.timestamp)??0,_=((T=I.expeditionLog[I.expeditionLog.length-1])==null?void 0:T.timestamp)??0;Ye=`${ee}-${I.expeditionLog.length}-${R}-${_}`}}}),je(dt.Combat,an),ye&&clearInterval(ye),ye=setInterval(Rc,100),an()},Xa=(t,n)=>{if(t.lte(0))return 0;if(t.gte(n))return 1;const e=t.log10().toNumber(),r=n.log10().toNumber(),a=0;return e<=a?0:Math.min(1,Math.max(0,(e-a)/(r-a)))};let ne=null;const Cc=t=>{const n=ke[t];if(!n)return"";const r=qe(t)==="realm2"?"in R2":"";return`${G(n.manaRequirement)} mana${r?` ${r}`:""}`},Qa=[{tier:1,bonuses:["x1.2 Crafter Speed"],unlocks:["Altar of Sacrifice","Upgrade Auto-Buy"]},{tier:2,bonuses:["x1.4 Crafter Speed (total)","Artifacts persist on reset"],unlocks:["Heroic Expeditions","R2 T4+ Swords usable in any realm","Auto-Prestige"],requiredRealm:"realm2",notes:"Resets BOTH realms"}],Ec=(t,n,e,r,a)=>{const s=n>=t.tier,i=n===t.tier-1,o=s?"border-positive bg-positive--20":"bg-panel border-muted--30",c=s?"text-positive":"text-gold",l=s?"text-positive":"text-text",m=t.bonuses.map(g=>`<div class="text-sm ${l}"> ${g}</div>`).join(""),u=t.unlocks.map(g=>`<div class="text-sm ${l}"> ${g}</div>`).join("");let f="";s?f='<span class="text-positive font-mono text-sm"> Complete</span>':i&&(f=`
      <button
        data-action="tier-reset"
        ${r?"":"disabled"}
        class="px-4 py-2 font-mono border ${r?"border-gold text-gold hover-bg-gold--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"}"
      >Reset</button>
    `);const b=Cc(t.tier),x=i?`
    <div class="mt-3 h-2 bg-muted--20 border border-muted--30 overflow-hidden">
      <div data-tier-progress="${t.tier}" class="h-full ${r?"bg-positive":"bg-arcane"}" style="width: ${a*100}%"></div>
    </div>
  `:"",p=t.notes&&!s?`
    <div class="text-xs text-yellow mt-2">${t.notes}</div>
  `:"";return`
    <div data-milestone="${t.tier}" class="border ${o} p-4">
      <div class="flex items-start gap-4">
        <div class="text-2xl font-mono ${c} w-12 flex-shrink-0">T${t.tier}</div>
        <div class="flex-1 min-w-0">
          <div class="text-sm ${l} mb-2">
            <span class="text-steel">Req:</span> ${b}
            ${i?`<span class="text-muted ml-2">(Current: <span data-current-mana class="${r?"text-positive":"text-text"}">${e}</span>)</span>`:""}
          </div>
          <div class="flex gap-4 flex-wrap">
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Bonuses</div>
              ${m}
            </div>
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Unlocks</div>
              ${u||'<div class="text-sm text-muted"></div>'}
            </div>
          </div>
          ${p}
          ${x}
          ${f?`<div class="mt-3">${f}</div>`:""}
        </div>
      </div>
    </div>
  `},Nc=t=>{const n=()=>{const e=S.getState(),r=e.globalTier,s=Qa.filter(m=>m.tier<=r+1).slice().reverse().map(m=>{var v;const u=qe(m.tier),f=e.realms[u].mana,x=e.activeRealm===u&&hn(f,r,u)&&r===m.tier-1,p=((v=ke[m.tier])==null?void 0:v.manaRequirement)??new d(1),g=Xa(f,p),h=G(f);return Ec(m,r,h,x,g)}).join(""),i=r+1,o=i<=mr?qe(i):null,l=!(o===e.activeRealm)&&o?`
      <div class="mb-4 p-3 border border-yellow text-yellow text-sm">
        T${i} reset requires ${Xi[o]}. ${e.realm2Unlocked?"Switch realms to perform the reset.":"Advance through expeditions to unlock the Realm tab and open a portal to the Realm of War."}
      </div>
    `:"";t.innerHTML=`
      <div class="max-w-5xl">
        <div class="mb-6">
          <h2 class="text-xl font-mono text-gold mb-2">Tier Milestones</h2>
          <p class="text-sm text-steel">Reset your progress to unlock permanent bonuses. Bonuses persist through future resets.</p>
        </div>
        ${l}
        <div class="flex flex-col gap-2">
          ${s}
        </div>
      </div>
    `,ne&&t.removeEventListener("click",ne),ne=m=>{m.target.getAttribute("data-action")==="tier-reset"&&S.getState().tierReset()},t.addEventListener("click",ne)};return n(),()=>{var f;const e=S.getState(),r=e.globalTier,a=Qa.filter(b=>b.tier<=r+1),s=t.querySelectorAll("[data-milestone]").length;if(a.length!==s){n();return}const i=r+1,o=qe(i),c=e.realms[o].mana,m=e.activeRealm===o&&hn(c,r,e.activeRealm),u=t.querySelector("[data-current-mana]");if(u&&(u.textContent=G(c),u.className=m?"text-positive":"text-text"),i<=mr){const b=((f=ke[i])==null?void 0:f.manaRequirement)??new d(1),x=Xa(c,b),p=t.querySelector(`[data-tier-progress="${i}"]`);p&&(p.style.width=`${x*100}%`,p.className=`h-full ${m?"bg-positive":"bg-arcane"}`);const g=t.querySelector('[data-action="tier-reset"]');g&&(g.disabled=!m,g.className=`px-4 py-2 font-mono border ${m?"border-gold text-gold hover-bg-gold--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"}`)}}},pa=ce(dt.Tier,Nc,{onCleanup:()=>{var t;ne&&((t=pa.getContainer())==null||t.removeEventListener("click",ne),ne=null)}}),Ac=pa.cleanup,qc=pa.render,_c=t=>{const n=Math.abs(t),e=t<0?"-":"";return n<1e3?e+n.toFixed(0):n<1e6?e+(n/1e3).toFixed(2)+"k":n<1e9?e+(n/1e6).toFixed(2)+"m":n<1e12?e+(n/1e9).toFixed(2)+"b":n<1e15?e+(n/1e12).toFixed(2)+"t":t.toExponential(2)},Lc=(t,n)=>`
    <div class="h-2 border border-muted--30 overflow-hidden">
      <div data-progress-bar class="h-full ${n?"bg-red":"bg-positive"}" style="width: ${t*100}%"></div>
    </div>
  `;let re=null;const Fc=t=>{var e,r;const n=Qe(t);if(!n)return"";if(n.type==="gem"&&n.tier!==void 0)return vt[n.tier].icon;if(n.type==="flask"&&n.tier!==void 0)return xe[n.tier].icon;if(n.type==="military"&&n.militaryId!==void 0){const a=S.getState();return((e=Xe(a.activeRealm)[n.militaryId])==null?void 0:e.icon)??""}else if(n.type==="expedition_reward")return((r=yt(n.id))==null?void 0:r.icon)??"";return""},si=t=>{var s;const n=S.getState(),e=K(n),r=Qe(t);if(!r)return 0;const a=r.type==="military"&&r.militaryId?r.militaryId:t;return((s=e.recipeInventory[a])==null?void 0:s.toNumber())??0},ii=t=>t==="gem_1"?Os:1,Uc=t=>{const n=S.getState(),e=K(n);if(e.altar.activeSacrifice!==t||e.altar.sacrificeProgress<1)return!1;const r=si(t),a=ii(t);return r<=a},Pc=()=>{const t=S.getState(),n=gt(t.activeRealm),e=n.MODIFIERS.sacrificeCap,r=n.MODIFIERS.sacrificeBatchSize,a=n.MODIFIERS.calculateSacrificeBonus,s=a(e),i=Hs(t.activeRealm),o=i.filter(p=>p.type==="gem"),c=i.filter(p=>p.type==="flask"),l=i.filter(p=>p.type==="military"),m=i.filter(p=>p.type==="expedition_reward"),u=(p,g)=>{if(!Qe(p))return"";const v=`
      <button
        data-action="start-sacrifice"
        data-item="${p}"
        disabled
        class="px-2 py-1 text-xs font-mono border border-muted--30 text-muted--50 cursor-not-allowed"
      >Sacrifice</button>
    `;return`
      <tr data-sacrifice-row="${p}">
        <td class="py-2 pr-4" style="width: 200px;">
          <div class="flex items-center gap-3">
            <img src="${Fc(p)}" alt="${g}" class="w-8 h-8 object-contain">
            <span class="text-text text-sm whitespace-nowrap">${g}</span>
          </div>
        </td>
        <td class="text-text font-mono text-sm text-left pl-2" style="width: 110px;" data-item-count="${p}"></td>
        <td class="text-steel font-mono text-sm text-left pl-2" style="width: 110px;" data-sacrifice-count="${p}"></td>
        <td class="text-positive font-mono text-sm text-left pl-2" style="width: 100px;" data-sacrifice-bonus="${p}"></td>
        <td style="width: 200px;" data-sacrifice-action="${p}">${v}</td>
      </tr>
    `},f=(p,g)=>g.length===0?"":`
      <div class="mb-6 mobile-scroll-x">
        <table style="width: 720px; table-layout: fixed;">
          <thead>
            <tr class="text-xs text-steel">
              <th class="text-left pb-2 text-orange" style="width: 200px;">${p}</th>
              <th class="text-left pb-2 pl-2" style="width: 110px;">Owned</th>
              <th class="text-left pb-2 pl-2" style="width: 110px;">Sacrificed</th>
              <th class="text-left pb-2 pl-2" style="width: 100px;">Bonus</th>
              <th style="width: 200px;"></th>
            </tr>
          </thead>
          <tbody>
            ${g.map(h=>u(h.id,h.name)).join("")}
          </tbody>
        </table>
      </div>
    `,b=r>1?` Sacrifices ${r} items at a time.`:"";return`
    <div class="text-lg font-mono text-gold mb-3">Altar of Sacrifice</div>
    <div class="text-sm text-steel mb-4">
      ${`Sacrifice items to permanently increase their output bonus.<br>
        Altar bonuses do not reset on tier up. Cap: ${at(e)} sacrificed (x${G(s)} max).${b}`}
    </div>
    <hr class="border-muted--30 mb-6">
    ${f("Gem",o)}
    ${f("Flask",c)}
    ${f("Unit",l)}
    ${f("Reward",m)}
  `},Oc=t=>{const n=()=>{const e=S.getState();if(!ur(e.globalTier)){t.innerHTML=`
        <div class="flex items-center justify-center h-64">
          <div class="text-center text-muted">
            <div class="text-lg mb-2">The Altar is locked</div>
            <div class="text-sm">Perform a Tier 1 reset to unlock the Altar.</div>
          </div>
        </div>
      `;return}t.innerHTML=`
      <div class="max-w-4xl">
        ${Pc()}
      </div>
    `,re&&t.removeEventListener("click",re),re=r=>{const a=r.target,s=a.getAttribute("data-action");if(s==="start-sacrifice"){const i=a.getAttribute("data-item");i&&S.getState().startSacrifice(i)}else s==="stop-sacrifice"&&S.getState().stopSacrifice()},t.addEventListener("click",re)};return n(),()=>{const e=S.getState(),r=K(e),a=gt(e.activeRealm),{altar:s}=r,i=a.MODIFIERS.sacrificeCap,o=a.MODIFIERS.calculateSacrificeBonus;if(!t.querySelector("[data-sacrifice-row]")&&ur(e.globalTier)){n();return}const c=Hs(e.activeRealm);for(const l of c){const m=t.querySelector(`[data-sacrifice-row="${l.id}"]`);if(!m)continue;const u=s.sacrificeCounts[l.id]||0,f=o(u),b=u>=i,x=s.activeSacrifice===l.id,p=si(l.id),g=ii(l.id),h=p>g&&!b,v=m.querySelector(`[data-item-count="${l.id}"]`);v&&(v.textContent=at(p));const y=m.querySelector(`[data-sacrifice-count="${l.id}"]`);y&&(y.textContent=_c(u));const T=m.querySelector(`[data-sacrifice-bonus="${l.id}"]`);T&&(T.textContent=`x${G(f)}`);const M=m.querySelector(`[data-sacrifice-action="${l.id}"]`);if(M)if(x){const E=Uc(l.id);let I=M.querySelector("[data-progress-bar]");I?sn(I,s.sacrificeProgress,E):M.innerHTML=`
              <div class="flex items-center gap-2">
                <div class="w-24">${Lc(s.sacrificeProgress,E)}</div>
                <button
                  data-action="stop-sacrifice"
                  class="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red--20 cursor-pointer"
                >Stop</button>
              </div>
            `}else if(b)M.innerHTML='<span class="text-gold text-xs">MAX</span>';else{const E=h?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed",I=M.querySelector('[data-action="start-sacrifice"]');if(!I)M.innerHTML=`
              <button
                data-action="start-sacrifice"
                data-item="${l.id}"
                ${h?"":"disabled"}
                class="px-2 py-1 text-xs font-mono border ${E}"
              >Sacrifice</button>
            `;else{const R=I;R.className=`px-2 py-1 text-xs font-mono border ${E}`,R.disabled=!h}}}}},ga=ce(dt.Altar,Oc,{onCleanup:()=>{var t;re&&((t=ga.getContainer())==null||t.removeEventListener("click",re),re=null)}}),Bc=ga.cleanup,Dc=ga.render,Jt=10;let ae=null;const Hc=t=>{const n=S.getState(),e=n.realms.realm1,r=n.realms.realm2,a=ht[t],s=Et(e.artifacts,t),i=e.artifacts.upgradeLevels[t]??0,o=Et(r.artifacts,t),c=r.artifacts.upgradeLevels[t]??0;if(!s)return"";const l=et(n.realms.realm1.recipeInventory,"nullstone").toNumber(),m=l>=De&&(!o||i>c),u=o;let f,b,x=!1;m?u?(f="border-gold text-gold hover-bg-gold--20 cursor-pointer",b=`Overwrite (+${i-c})`):(f="border-lime text-lime hover-bg-lime--20 cursor-pointer",b="Ship"):l<De?(f="border-muted--30 text-muted--50 cursor-not-allowed",b="Ship",x=!0):(f="border-muted--30 text-muted--50 cursor-not-allowed line-through",b="Already in R2",x=!0);const p=i>0?`<span class="text-cyan">+${i}</span>`:"";let g="";return o&&(g=`<div class="text-xs text-steel">In R2: +${c}</div>`),`
    <div class="flex items-center gap-3 p-2 border border-muted--30 bg-black--30" data-ship-card="${t}">
      <img src="${a.icon}" alt="${a.name}" class="w-12 h-12 object-contain">
      <div class="flex-1 min-w-0">
        <div class="text-sm font-mono text-text">${a.name} ${p}</div>
        <div class="text-xs text-steel">T${a.tier} ${a.type}</div>
        ${g}
      </div>
      <button
        data-action="ship-artifact"
        data-artifact-id="${t}"
        ${x?"disabled":""}
        class="px-3 py-1 text-xs font-mono border ${f}"
      >${b}</button>
    </div>
  `},Ja=()=>{const t=S.getState(),n=et(t.realms.realm1.recipeInventory,"nullstone").toNumber(),e=t.realms.realm1,r=Ut.filter(s=>Et(e.artifacts,s));if(r.length===0)return`
      <div data-shipping-section class="mt-8 p-4 border border-muted--30">
        <h3 class="text-lg font-mono text-gold mb-2">Ship Artifacts to Realm of War</h3>
        <p class="text-sm text-steel">
          You don't have any artifacts in the Prime Realm to ship.
          Craft artifacts in the Artifacts tab first.
        </p>
      </div>
    `;const a=r.map(s=>Hc(s)).join("");return`
    <div data-shipping-section class="mt-8 p-4 border border-muted--30">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-mono text-gold">Ship Artifacts to Realm of War</h3>
          <p class="text-xs text-steel">
            In the Realm of War, you cannot craft artifacts - only receive shipments from the Prime Realm.
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-text">
            <span data-ship-nullstone-count>${at(n)}</span>
            <img src="${L("icons/nullstone.png")}" alt="Nullstone" class="w-4 h-4 inline ml-1">
          </div>
          <div class="text-xs text-steel">Cost: ${De} per artifact</div>
        </div>
      </div>
      <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
        ${a}
      </div>
      <div class="mt-3 text-xs text-steel">
        Shipped artifacts are removed from the Prime Realm and must be re-crafted.
        You can overwrite a Realm of War artifact only if the Prime Realm version has a higher upgrade level.
      </div>
    </div>
  `},ts=()=>{const t=S.getState(),n=t.realms.realm1.artifacts,e=t.realms.realm2.artifacts;return JSON.stringify({nullstone:et(t.realms.realm1.recipeInventory,"nullstone").toNumber(),r1Owned:n.owned,r1Levels:n.upgradeLevels,r2Owned:e.owned,r2Levels:e.upgradeLevels})},Gc={realm1:{icon:"icons/r0.png",name:"Prime Realm",color:"cyan"},realm2:{icon:"icons/portal.png",name:"Realm of War",color:"arcane"}},Vc=()=>`
  <div class="tooltip-title" style="color: var(--color-cyan);">Prime Realm</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">The standard realm with normal mechanics.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Mana generation</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Normal</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Craft speed</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Normal</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Artifacts</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Craftable</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Heroic expeditions</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Available</span>
  </div>
`,es=(t,n)=>{const e=Gc[t],r=t==="realm1"?Vc():hi(),a=n?"1":"0.4",s=n?`<span class="text-${e.color} text-xs font-mono">Current realm</span>`:'<span class="text-steel text-xs font-mono">Click to enter</span>';return`
    <div class="flex flex-col items-center gap-2 portal-card" data-portal-card="${t}" data-portal-active="${n}">
      <div class="realm-tooltip-wrapper" style="display: inline-block;">
        <div
          ${n?"":'data-action="switch-realm"'}
          data-realm-target="${t}"
          style="cursor: ${n?"default":"pointer"}; opacity: ${a};"
          class="portal-card-img"
        >
          <img
            src="${L(e.icon)}"
            alt="${e.name}"
            style="width: 160px; height: 160px;"
            class="object-contain"
          >
        </div>
        <div class="realm-tooltip" style="left: 50%; transform: translateX(-50%);">
          ${r}
        </div>
      </div>
      <div class="text-${e.color} font-mono" style="opacity: ${a};">${e.name}</div>
      <div style="opacity: ${a};">${s}</div>
    </div>
  `},jc=t=>{const n=Il();let e=null;const r=()=>{const a=S.getState(),s=et(a.realms.realm1.recipeInventory,"nullstone").toNumber(),{portalBuilt:i}=a.realms.realm1.combat,o=Math.min(1,s/Jt),c=s>=Jt;let l,m="";if(i){const u=a.activeRealm==="realm1";e=a.activeRealm,l=`
        <div class="flex items-start justify-center gap-12">
          ${es("realm1",u)}
          ${es("realm2",!u)}
        </div>
      `,u||(m=Ja(),n(ts()))}else l=`
        <div class="flex flex-col items-center gap-4">
          <button
            data-action="build-portal"
            ${c?"":"disabled"}
            class="relative px-6 py-3 font-mono text-lg border ${c?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"} overflow-hidden"
            style="min-width: 300px;"
          >
            ${Je(o,"data-portal-progress")}
            <span class="relative flex items-center justify-center gap-2">
              Build a portal to another realm -
              <span class="inline-flex items-center gap-1 bg-black--50 px-2 py-0.5 rounded">
                ${Jt}
                <img src="${L("icons/nullstone.png")}" alt="Nullstone" style="width: 18px; height: 18px;" class="object-contain">
              </span>
            </span>
          </button>
          <div class="text-sm text-steel">
            You have <span data-nullstone-count class="text-text font-mono">${s}</span> nullstone
          </div>
        </div>
      `;t.innerHTML=`
      <div class="max-w-3xl mx-auto">
        <div class="mb-8 text-center">
          <h2 class="text-xl font-mono text-arcane mb-2">Realm Portal</h2>
          <p class="text-sm text-steel">Harness the power of nullstone to open a gateway to another realm.</p>
        </div>
        ${l}
        ${m}
      </div>
    `,ae&&t.removeEventListener("click",ae),ae=u=>{const b=u.target.closest("[data-action]");if(!b)return;const x=b.getAttribute("data-action");if(x==="build-portal"){const p=S.getState();if(et(p.realms.realm1.recipeInventory,"nullstone").toNumber()>=Jt){const h=p.realms.realm1,v={...h.recipeInventory};kt(v,"nullstone",new d(Jt)),S.setState({realms:{...p.realms,realm1:{...h,recipeInventory:v,combat:{...h.combat,portalBuilt:!0}}}})}}else if(x==="switch-realm"){const p=S.getState(),g=b.getAttribute("data-realm-target");if(!g||g===p.activeRealm)return;p.realm2Unlocked||p.unlockRealm2(),p.setActiveRealm(g)}else if(x==="ship-artifact"){const p=b.getAttribute("data-artifact-id");p&&S.getState().shipArtifact(p)}},t.addEventListener("click",ae)};return r(),()=>{const a=S.getState(),s=et(a.realms.realm1.recipeInventory,"nullstone").toNumber(),{portalBuilt:i}=a.realms.realm1.combat,o=t.querySelector("[data-portal-card]"),c=t.querySelector('[data-action="build-portal"]');if(i&&!o){r();return}if(i&&o&&a.activeRealm!==e){r();return}if(!i&&c){const l=Math.min(1,s/Jt),m=s>=Jt;tn(t.querySelector("[data-portal-progress]"),l);const u=t.querySelector("[data-nullstone-count]");u&&(u.textContent=String(s));const f=c;f.disabled=!m,f.className=`relative px-6 py-3 font-mono text-lg border overflow-hidden ${m?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}`}if(i&&a.activeRealm==="realm2")if(n(ts())){const l=t.querySelector("[data-shipping-section]");l&&(l.outerHTML=Ja())}else{const l=t.querySelector("[data-ship-nullstone-count]");l&&(l.textContent=at(s))}}},ha=ce(dt.Realm,jc,{onCleanup:()=>{var t;ae&&((t=ha.getContainer())==null||t.removeEventListener("click",ae),ae=null)}}),Yc=ha.cleanup,Wc=ha.render,Kc=["gem","flask","military","expedition_reward"],zc={gem:"Mana Gems",flask:"Research Flasks",military:"Expedition Units",expedition_reward:"Expedition Rewards"},Zc=t=>{const n=()=>{const e=S.getState(),r=K(e),{prestige:a}=r,s=[...Pe(e.activeRealm),...lr];let i='<div class="p-4 font-mono">';i+='<h2 class="text-lg text-gold mb-2">Prestige</h2>',i+=`<div class="text-sm text-steel mb-4">Spend items from a recipe's inventory for permanent output multipliers. Prestige is not reset on tier.</div>`,i+=`<div class="mb-4">${se("prestige-explanation","How prestige works",`
      <div class="text-sm border border-muted--30 bg-panel p-3">
        <div class="text-muted mb-1"> Each prestige subtracts the requirement from inventory</div>
        <div class="text-muted mb-1"> <span class="text-positive">Recipe bonus:</span> +x0.2 output multiplier for that recipe per prestige</div>
        <div class="text-muted mb-1"> <span class="text-cyan">Global bonus:</span> +x0.01 output multiplier for <span class="text-text">all</span> recipes per prestige (any recipe)</div>
        <div class="text-muted"> Cost scales x100 per prestige (1.00k  100k  10.0m  ...)</div>
      </div>`)}</div>`,i+='<div class="text-sm mb-4">',i+='<span class="text-muted">Global prestige bonus:</span> ',i+='<span class="text-positive" data-prestige-global-mult></span>',i+='<span class="text-muted"> (all recipes)</span>',i+="</div>";const c={gem:[],flask:[],military:[],expedition_reward:[]};for(const l of s){const m=yt(l);c[m.category].push(l)}for(const l of Kc){const m=c[l];if(m.length===0)continue;const u=m.filter(b=>{const x=et(r.recipeInventory,b),p=a.prestigeCounts[b]||0;return x.gt(0)||p>0});if(u.length===0)continue;let f=`<table class="text-sm font-mono w-full" data-prestige-table="${l}">
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="w-40 text-left">Recipe</th>
            <th class="w-24 text-center">Count</th>
            <th class="w-28 text-center">Inventory</th>
            <th class="w-28 text-center">Cost</th>
            <th class="w-28 text-center text-positive">Recipe</th>
            <th class="w-28 text-center text-cyan">Total</th>
            <th class="w-28"></th>
            <th class="w-10 text-center" data-auto-prestige-header style="display: none">
              <span data-action="toggle-all-auto-prestige" data-category="${l}" class="cursor-pointer text-steel hover-text-text" title="Toggle all auto-prestige">Auto</span>
            </th>
          </tr>
        </thead>
        <tbody>`;for(const b of u){const x=yt(b),p=yn(!1,!1);f+=`
          <tr data-prestige-row="${b}">
            <td class="w-40 py-1">
              <span class="inline-flex items-center gap-1.5">
                <img src="${x.icon}" alt="${x.name}" style="width: 28px; height: 28px;" class="object-contain">
                <span class="text-gold">${x.name}</span>
              </span>
            </td>
            <td class="w-24 text-center text-steel" data-prestige-count="${b}"></td>
            <td class="w-28 text-center text-muted--50" data-prestige-inventory="${b}"></td>
            <td class="w-28 text-center text-text" data-prestige-cost="${b}"></td>
            <td class="w-28 text-center text-positive" data-prestige-recipe-mult="${b}"></td>
            <td class="w-28 text-center text-cyan" data-prestige-total-mult="${b}"></td>
            <td class="w-28">
              <button
                data-action="prestige-recipe"
                data-id="${b}"
                disabled
                class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${p}"
              >
                ${Je(0,`data-prestige-progress="${b}"`)}
                <span class="relative z-10">Prestige</span>
              </button>
            </td>
            <td class="w-10 text-center" data-auto-prestige-cell="${b}" style="display: none">
              <input type="checkbox" data-action="toggle-auto-prestige" data-id="${b}" title="Auto-prestige" class="cursor-pointer" />
            </td>
          </tr>`}f+="</tbody></table>",i+=`<div class="mb-4">${se(`prestige-${l}`,zc[l],f)}</div>`}if(i+="</div>",t.innerHTML=i,t.querySelectorAll('[data-action="prestige-recipe"]').forEach(l=>{l.addEventListener("click",()=>{const m=l.getAttribute("data-id");S.getState().prestigeRecipe(m)})}),t.querySelectorAll('[data-action="toggle-auto-prestige"]').forEach(l=>{l.addEventListener("change",()=>{const m=l.getAttribute("data-id");S.getState().toggleAutoPrestige(m)})}),t.querySelectorAll('[data-action="toggle-all-auto-prestige"]').forEach(l=>{l.addEventListener("click",()=>{const m=l.getAttribute("data-category"),u=S.getState(),f=K(u),b=t.querySelector(`[data-prestige-table="${m}"]`);if(!b)return;const x=[];b.querySelectorAll("[data-prestige-row]").forEach(g=>{x.push(g.getAttribute("data-prestige-row"))});const p=x.every(g=>f.prestige.autoPrestige[g]);for(const g of x){const h=f.prestige.autoPrestige[g]??!1;(p?h:!h)&&S.getState().toggleAutoPrestige(g)}})}),e.globalTier>=2){t.querySelectorAll("[data-auto-prestige-header]").forEach(l=>l.style.display=""),t.querySelectorAll("[data-auto-prestige-cell]").forEach(l=>l.style.display="");for(const l of s){const m=t.querySelector(`[data-action="toggle-auto-prestige"][data-id="${l}"]`);m&&(m.checked=r.prestige.autoPrestige[l]??!1)}}};return n(),()=>{const e=S.getState(),r=K(e),{prestige:a}=r,s=Ns(a.prestigeCounts),i=t.querySelectorAll("[data-prestige-row]");let o=!1;for(const u of i){const f=u.getAttribute("data-prestige-row"),b=et(r.recipeInventory,f),x=a.prestigeCounts[f]||0;if(b.eq(0)&&x>0){const p=t.querySelector(`[data-prestige-count="${f}"]`);if(p&&p.textContent!==at(x)){o=!0;break}}}const c=[...Pe(e.activeRealm),...lr];for(const u of c){const f=et(r.recipeInventory,u),b=a.prestigeCounts[u]||0;if((f.gt(0)||b>0)&&!t.querySelector(`[data-prestige-row="${u}"]`)){o=!0;break}}o&&n();const l=t.querySelector("[data-prestige-global-mult]");l&&(l.textContent=`x${G(s)}`);const m=o?t.querySelectorAll("[data-prestige-row]"):i;for(const u of m){const f=u.getAttribute("data-prestige-row"),b=a.prestigeCounts[f]||0,x=et(r.recipeInventory,f),p=$n(b),g=Cn(f,x,b),h=x.gt(0)?Math.min(1,x.div(p).toNumber()):0,v=Es(a.prestigeCounts,f),y=Dt(a.prestigeCounts,f),T=t.querySelector(`[data-prestige-count="${f}"]`);T&&(T.textContent=at(b));const M=t.querySelector(`[data-prestige-inventory="${f}"]`);M&&(M.textContent=G(x),M.className=`w-28 text-center ${x.gte(p)?"text-text":"text-muted--50"}`);const E=t.querySelector(`[data-prestige-cost="${f}"]`);E&&(E.textContent=G(p));const I=t.querySelector(`[data-prestige-recipe-mult="${f}"]`);I&&(I.textContent=`x${G(v)}`);const R=t.querySelector(`[data-prestige-total-mult="${f}"]`);R&&(R.textContent=`x${G(y)}`);const _=t.querySelector(`[data-action="prestige-recipe"][data-id="${f}"]`);if(_){const B=yn(!1,g);_.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${B}`,g?_.removeAttribute("disabled"):_.setAttribute("disabled",""),tn(t.querySelector(`[data-prestige-progress="${f}"]`),h,!1)}const V=t.querySelector(`[data-action="toggle-auto-prestige"][data-id="${f}"]`);V&&V.checked!==(a.autoPrestige[f]??!1)&&(V.checked=a.autoPrestige[f]??!1)}}},oi=ce(dt.Prestige,Zc),Xc=oi.cleanup,Qc=oi.render,Jc={0:0,1:100,2:200,3:300},tu=t=>Jc[Math.min(t,3)]??0,Ln=t=>{var s,i;const n=tu(t),e=document.createElement("div");e.className="fixed inset-0 bg-black--90 flex items-center justify-center z-50";const r=n>0?`
      <p class="text-text mb-2">
        Based on your previous progress (Tier ${t}), you are eligible for
        <span class="text-yellow font-bold">${n} Time Warp charges</span>.
      </p>
      <p class="text-steel mb-4" style="font-size: 13px;">
        Each charge skips 5 minutes of game time, helping you get back to where you were faster.
        You can use them from the tab bar at any time.
      </p>
      <div class="flex gap-4 justify-center">
        <button data-action="accept" class="px-6 py-2 border-2 border-yellow text-yellow hover-bg-yellow hover-text-black font-mono cursor-pointer">
          Accept ${n} Charges
        </button>
        <button data-action="decline" class="px-6 py-2 border-2 border-steel text-steel hover-bg-steel hover-text-black font-mono cursor-pointer">
          No Thanks
        </button>
      </div>
    `:`
      <button data-action="decline" class="px-6 py-2 border-2 border-steel text-steel hover-bg-steel hover-text-black font-mono cursor-pointer">
        OK
      </button>
    `,a=n>0?`<p class="text-text mb-4">
        To help you get back to where you were, a <span class="text-yellow font-bold">Time Warp</span> feature is available.
        Time Warp charges let you fast-forward through the early game.
      </p>`:"";e.innerHTML=`
    <div class="bg-black border-2 border-red p-6 max-w-lg text-center">
      <h2 class="text-xl text-red font-bold mb-4">v${pr()}  Incompatible Save</h2>
      <p class="text-text mb-4">
        Version ${pr()} is incompatible with previous versions and your progress has been reset. Sorry about that!
      </p>
      ${a}
      ${r}
    </div>
  `,document.body.appendChild(e),(s=e.querySelector('[data-action="accept"]'))==null||s.addEventListener("click",()=>{S.setState({timeWarpCharges:n}),e.remove(),_a()}),(i=e.querySelector('[data-action="decline"]'))==null||i.addEventListener("click",()=>{e.remove(),_a()})},li="evercraft-hotkeys",ns={tabLeft:{label:"Cycle Tab Left",key:"a"},tabRight:{label:"Cycle Tab Right",key:"d"},swapRealm:{label:"Swap Realm",key:"q"}};let We=eu();function eu(){var t;try{const n=localStorage.getItem(li);if(n){const e=JSON.parse(n),r={...ns};for(const a of Object.keys(r))(t=e[a])!=null&&t.key&&(r[a]={...r[a],key:e[a].key});return r}}catch{}return{...ns}}function nu(){const t={};for(const[n,e]of Object.entries(We))t[n]={key:e.key};localStorage.setItem(li,JSON.stringify(t))}const ru=()=>We,au=(t,n)=>{We[t]={...We[t],key:n},nu()},su=t=>{const n=t.toLowerCase();for(const[e,r]of Object.entries(We))if(r.key.toLowerCase()===n)return e;return null},iu=["tabLeft","tabRight","swapRealm"],ou=t=>t===" "?"Space":t.length===1?t.toUpperCase():t,lu=[{version:"0.69",changes:["Boats (speed units) can now be used in heroic expeditions to reduce duration","Fixed expedition card income rate not being formatted for large numbers"]},{version:"0.68",changes:["Tweaked inventory panel alignment"]},{version:"0.67",changes:['Fixed combat tab message to say "expedition units" instead of "military unit"',"Altar tab hidden until first tier reset; Artifacts tab hidden until an expedition unit has been crafted","Added dismissable tip under crafters about right-click to assign/unassign all"]},{version:"0.66",changes:["Mobile browser support: responsive layout, collapsible inventory sidebar, horizontally scrollable tables and crafting grids, smaller fonts and spacing on small screens"]},{version:"0.65",changes:["Expedition dialog: replaced unit assignment buttons with role-specific controls  Army gets +10% and 100% success rate buttons, Fleet/Beacons get three scaled static-amount buttons"]},{version:"0.64",changes:["Added favicon (T1 gem icon)","Altar of Sacrifice: removed extra border wrapper, moved section labels into table headers"]},{version:"0.63",changes:["Prepared realm tab to support R3","Fixed realm portal button shrinking on narrow browsers","Removed title header from nav bar to give tabs more space","New display setting: Tab Highlighting toggle  disables glow and count indicators on tabs"]},{version:"0.62",changes:["Reduced R2 sword gem cost scaling from x10 to x4 per tier for T4+ (T1-T3 unchanged)","New R2 research upgrades: T4/T5/T6 Sword Efficiency  reduces sword input costs by 12% per level (max 8 levels, costs flasks + swords)"]},{version:"0.61",changes:['Auto-Prestige unlocked at T2: checkbox next to each prestige button to automatically prestige when affordable. Click "Auto" column header to toggle all in a category.',"Heroic expedition setup is now automatically cleared when the expedition finishes","New Realm 2 expedition: T5-T6 Quest (difficulty 2M)  grants scaling output bonus to T5 and T6 recipes"]},{version:"0.60",changes:["Reduced T1 Knight Strength research base cost from 50k to 1k flasks","Expedition unit tooltips now show on icon hover and explain how stats affect success rate, duration, and rewards","Expeditions now consume all assigned units on success (previously half were returned)"]},{version:"0.59",changes:["Prestige now subtracts the requirement cost instead of resetting the recipe to 0","Pause state now persists across refresh  no offline time is processed for a paused game","Expedition modal: unit icons now have hover tooltips showing role description and strength formula"]},{version:"0.58",changes:["New artifact: Combat Artifact (x1.1 combat strength per level, max 100, 50 shard base cost)","New artifact: Crafting Speed (+5% crafting speed per level, max 40, 200 shard base cost)","Fix: Expeditions 3 and 4 no longer reset to locked on page refresh"]},{version:"0.57",changes:["Removed Cave Exploration expedition; remaining expeditions renumbered","Expedition unlock requirement reduced from 20 to 5 completions","Expedition difficulty reduced: Mountain Pass, Ancient Ruins, Wraith Stronghold","Beacons now increase rewards by twice as much as difficulty (was equal), and beacon effect strengthened 5x","Knight strength exponent increased from 0.7 to 0.8","Prestige tab: explanation section is now collapsible, collapse state persists across saves"]},{version:"0.56",changes:["Prestige tab: added mechanics explanation, split bonus column into separate Recipe and Total columns"]},{version:"0.55",changes:["Reduced base cost of knight strength research from 1M to 50K flasks","Fixed inventory panel scrollbar not flush with right border"]},{version:"0.54",changes:["Crafter's Guild bonus now caps at 30 crafters (the 31st+ crafter no longer increases the bonus)"]},{version:"0.53",changes:["Crafting tab now always shows per-craft amounts, with per-second rate in parentheses when crafters are assigned","Fixed Altar tab in Realm of War showing Nullstone and Artifact Shard sacrifice options (these are only earnable in Realm 1)"]},{version:"0.52",changes:["Fixed tooltips getting clipped when near the bottom of the screen"]},{version:"0.51",changes:["Fixed collapsible sections breaking the page when collapsed"]},{version:"0.50",changes:["Mountain Pass expedition rebalanced: difficulty 50k10k, duration 3h1h, shards 400150"]},{version:"0.49",changes:["Tier tab warning now guides players to advance through expeditions when Realm of War is not yet unlocked","Recipe output rate now displays in green when crafters are actively producing","Renamed Upgrades tab to Research","Fixed research upgrades table showing blank Level, Cost, and Effect columns",'Added "Hide maxed upgrades" checkbox to Research tab (on by default)']},{version:"0.48",changes:["R1 military unlock thresholds now scale per unit (x100 craft cost) instead of flat 100k","Buffed all ring artifact upgrade bonuses from x1.3 to x1.35 per level","Reduced T2 ring shard cost from 100 to 50 and T3 ring shard cost from 1000 to 500","Forest Patrol expedition difficulty reduced from 10 to 5 and duration from 2m to 1m"]},{version:"0.47",changes:["Reduced T1 tier reset mana requirement from 1e21 to 1e20"]},{version:"0.46",changes:["New research upgrade: Cheaper Gems  reduces gem input costs by 5% per level (10 levels)","New research upgrade: Cheaper Expedition Units  reduces military input costs by 5% per level (10 levels)","New research upgrade: Cheaper Flasks  reduces flask input costs by 5% per level (10 levels)","Buffed T4T8 gem mana multipliers (T4: x1.6x3, T5: x2x4, T6: x2.4x5, T7: x3x10, T8: x5x20)"]},{version:"0.45",changes:['Mana tooltip now shows cleaner format: "605 T2 gems  x605 multiplier"',"R1 military unlock thresholds increased to 100k lifetime gems","R1 boat and beacon gem crafting costs increased"]},{version:"0.44",changes:["Knight strength upgrades are now hidden until the corresponding knight has been produced","Expedition unit unlock conditions increased (more lifetime gems required)"]},{version:"0.43",changes:["T2 global military changed: only Realm of War T4+ Swords are usable cross-realm (previously all units were global)","Gem Manufacturing research upgrade rebalanced: 16 levels with alternating 10/50 flask costs climbing through tiers"]},{version:"0.42",changes:["Fix: Inventory panel nullstone/shard rates now include prestige and sacrifice bonus multipliers","Fix: Expedition rewards/s now factors in success rate instead of assuming 100%","New military unit: T7 Knight (Realm 1)","Auto-buy checkboxes on upgrades tab are now hidden before Tier 1","R1 Military Strength upgrade split into 3 per-knight upgrades (T1/T4/T7). Existing levels migrate to all three."]},{version:"0.41",changes:["Playtime clock now visible for all players","Fix: Time Warp button now appears immediately after migration grants charges"]},{version:"0.40",changes:["Major rework, too many changes to list","V0.39 incompatible. Receive time warps as compensation based on tier reached."]},{version:"0.39",changes:["T1 Mana Gems are now free to craft (no mana cost)","Starting mana is now 0","Fix: crafting progress bars now animate correctly"]},{version:"0.38",changes:["Fix: offline time calculation no longer undercounts production"]},{version:"0.37",changes:["Internal: centralized UI update system with dirty flags for better performance","Internal: split large combat and artifact UI modules into smaller files","Internal: removed code duplication with tab manager factory and fingerprint utility","Fix: mana regeneration tooltip no longer cut off by inventory panel"]},{version:"0.36",changes:["Ring artifacts now only increase output (no longer increase input costs)","Tier milestones now display in chronological order"]},{version:"0.35",changes:["New artifact: Mana Globe (x10 mana generation, x10 per upgrade level)","New artifact: Crafting Speed (+30% crafting speed, +2% per upgrade level)","New expedition: Abyssal Rift (artifact shards + combat points)","New expedition: Void Sanctum (nullstone)","New heroic expedition: Combat Mastery (scales combat point drops)","Added 3 more artifact slots (6-8)","Expedition reward icons now reflect heroic multipliers","Added T5 Sword and T6 Sword military units in Realm of War","Molds now always give 100% of their effect (no longer need to be slotted)"]},{version:"0.34",changes:["Fixed tier reset corrupting Realm of War military crafters (NaN bug)","Expedition UI simplified: compact reward squares replace icon cards","Click any expedition square to open the setup dialog","Category labels shown to the left of each expedition group"]},{version:"0.33",changes:["Heroic expeditions no longer have a 9,999 unit cap","Expedition unlocks now persist across tier resets"]},{version:"0.32",changes:["Expedition UI redesigned: side-by-side icon cards replace table rows","Custom expedition icons for R1 (Forest Patrol, Cave, Mountain, Ruins, Wraith)","R2 quest icons now use gem icons instead of enemy icons","Heroic expedition cards show victories and bonus multiplier","R2 quest cards show completions and output bonus","Setup dialog: unit controls use table layout for proper alignment","Setup dialog: expedition icon enlarged to 96x96","Performance: separated lightweight progress bar updates from full state updates"]},{version:"0.31",changes:["Added automatic update notification when a new version is available"]},{version:"0.30",changes:["Upgrades and Tier tabs glow when an action is available","Expedition setup now saves and starts in one click","Expedition log is now collapsible","Early game pacing tweaked to be faster"]},{version:"0.29",changes:["Removed mold artifacts from the game","Artifact shards spent on molds (purchase + upgrades) are refunded automatically"]},{version:"0.28",changes:["Added Heroic Expeditions"]},{version:"0.27",changes:["Fixed inventory sections not collapsible in R2","Removed spinner arrows from expedition unit assignment input","Fixed +/- buttons not working on expedition assignment until ++ was used first","Fixed expedition log not updating when switching realms while on Expeditions tab",'Removed misleading "T3 reset only here" from Realm of War tooltip (T3 resets both realms)',"R2 expedition dialog now shows the bonus formula per completion"]},{version:"0.26",changes:["Added UI Scale slider in Settings under new Display section (0.8x to 1.3x)","Moved Background Image toggle from Game to Display section"]},{version:"0.25",changes:["Added realm background images (blended with 70% black overlay)",'Added "Background Image" toggle in Settings under Game',"Crafting row backgrounds now semi-transparent to show background image"]},{version:"0.24",changes:["Expedition log now shows last 20 entries per expedition type","Added filter dropdown to expedition log to view specific expedition types","Tab content now scrolls independently instead of the whole page"]},{version:"0.23",changes:["Added Combat Artifact: costs 100k Artifact Shards, 100k Ghost Knights, and 100k Wisps","Combat Artifact grants +30% military strength (+3% per upgrade level)","Expeditions can now reach 100% success rate (was capped at 80%)"]},{version:"0.22",changes:["Added Realm of War tooltip on realm switch button and portal gate","Added Q hotkey to swap realms","Added rebindable hotkeys dialog in Settings"]},{version:"0.21",changes:["Increased max units per expedition from 5,000 to 9,999","Lowered military research upgrade costs","Increased T6 gem multiplier from x2.0 to x2.4"]},{version:"0.2",changes:["Added Realm of War"]},{version:"0.17",changes:["T2 reset now grants x1.4 total crafter speed and unlocks Military Research","Added Military Research upgrades: Knight Strength and Wisp Strength","Improved Tier milestone UI with two-column layout"]},{version:"0.16",changes:["T4-T6 ring and mold artifacts","Added T5-T6 Output combat upgrade","Added T5-T6 Output mana upgrades","Rebalanced artifact slot and artifact costs","Fixed expedition unit assignment buttons firing multiple times when switching tabs","Fixed military strength formula to apply exponent to count before multiplier"]},{version:"0.15",changes:["Added Tier system - prestige mechanic with permanent bonuses","Added Altar of Sacrifice - sacrifice items for permanent output bonuses","T1 reset requires 1e21 mana, grants x1.2 crafter speed and unlocks Altar","T2 reset requires 1e40 mana, grants x1.4 total crafter speed and unlocks Military Research","T1 gems require minimum 5 to prevent softlock when sacrificing","Craft time display now reflects tier speed bonuses"]},{version:"0.14",changes:["Removed Village system (did not playtest well)"]},{version:"0.13",changes:["Added military crafting speed combat upgrade","Fixed crafting input display to include artifact bonuses"]},{version:"0.12",changes:["Added keyboard hotkeys: A/D to cycle main tabs, [/] to cycle inventory tabs"]},{version:"0.11",changes:["Renamed Combat tab to Expeditions","Artifacts tab now shows a message when you have no lifetime artifact shards","Expeditions tab now shows a message when you have no lifetime ghost knights","Added lifetime artifact shards tracking","Added changelog to settings"]},{version:"0.1",changes:["Initial release"]}];let Jn=!1,va=!1,cn=!1,ie=null,he="",kn="",tr=null;const en=t=>{kn=t,tr&&clearTimeout(tr),tr=window.setTimeout(()=>{kn="",bt()},3e3),bt()},cu=async()=>{const t=S.getState().exportSave();await navigator.clipboard.writeText(t),en("Copied to clipboard!")},uu=()=>{const t=S.getState().exportSave(),n=new Blob([t],{type:"text/plain"}),e=URL.createObjectURL(n),r=document.createElement("a");r.href=e,r.download=`evercraft-save-${Date.now()}.txt`,r.click(),URL.revokeObjectURL(e),en("File downloaded!")},du=async()=>{const t=await navigator.clipboard.readText(),n=S.getState().importSave(t);n.success?ua():n.incompatible?Ln(n.oldTier??0):en("Invalid save data!")},fu=()=>{const t=S.getState().importSave(he);t.success?(he="",ua()):t.incompatible?Ln(t.oldTier??0):en("Invalid save data!")},mu=t=>{const n=new FileReader;n.onload=e=>{var s;const r=(s=e.target)==null?void 0:s.result,a=S.getState().importSave(r);a.success?ua():a.incompatible?Ln(a.oldTier??0):en("Invalid save data!")},n.readAsText(t)},pu=()=>{S.getState().hardReset(),window.location.reload()},gu=()=>{S.getState().togglePause(),bt()},hu=()=>{S.getState().toggleBackgroundImage(),yi(S.getState().activeRealm),bt()},vu=()=>{S.getState().toggleTabHighlighting(),bt()},er=t=>{const n=S.getState().uiScale,e=Math.round((n+t)*100)/100;S.getState().setUiScale(e),ba(e),bt()},ba=t=>{const n=document.getElementById("root");n&&(n.style.zoom=`${t}`,n.style.height=`${100/t}vh`,n.style.width=`${100/t}vw`)},bu=()=>{va=!0,bt()},rs=()=>{va=!1,bt()},yu=()=>va?`
    <div data-changelog-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-2xl w-full mx-4 max-h-80vh flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Changelog</h2>
          <button data-action="close-changelog" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div class="overflow-y-auto flex-1 pr-2">
          ${lu.map(n=>`
    <div class="mb-6">
      <h3 class="text-lg text-gold font-mono mb-2">v${n.version}</h3>
      <ul class="list-disc list-inside text-text">
        ${n.changes.map(e=>`<li class="mb-1">${e}</li>`).join("")}
      </ul>
    </div>
  `).join("")}
        </div>
      </div>
    </div>
  `:"",xu=()=>{if(!cn)return"";const t=ru();return`
    <div data-hotkey-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Hotkeys</h2>
          <button data-action="close-hotkeys" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div>
          ${iu.map(e=>{const r=t[e],a=ie===e,s=a?'<span class="text-gold animate-pulse">Press a key...</span>':`<span class="text-cyan font-mono">${ou(r.key)}</span>`;return`
      <div class="flex items-center justify-between py-2 border-b border-muted--20">
        <span class="text-text">${r.label}</span>
        <div class="flex items-center gap-3">
          ${s}
          <button
            data-action="rebind-hotkey"
            data-hotkey-action="${e}"
            class="px-3 py-1 text-xs font-mono border ${a?"border-gold text-gold":"border-steel text-steel hover-bg-steel hover-text-black"}"
          >${a?"Cancel":"Rebind"}</button>
        </div>
      </div>
    `}).join("")}
        </div>
        <div class="mt-4 text-xs text-steel">Click Rebind, then press any key to assign it.</div>
      </div>
    </div>
  `};let Ue=null;const wu=t=>{ie=t,bt(),Ue=n=>{if(n.preventDefault(),n.stopPropagation(),n.key==="Escape"){ci();return}au(t,n.key),ie=null,Tn(),bt()},document.addEventListener("keydown",Ue,!0)},ci=()=>{ie=null,Tn(),bt()},Tn=()=>{Ue&&(document.removeEventListener("keydown",Ue,!0),Ue=null)};let ft=null;const bt=()=>{var c,l,m,u,f,b,x,p,g,h,v,y,T,M,E,I,R;if(!ft)return;const t=S.getState().paused,n=S.getState().backgroundImageOff,e=S.getState().tabHighlightingOff,r=S.getState().uiScale;ft.innerHTML=`
    ${kn?`<div class="mb-4 p-2 border-2 border-arcane text-arcane">${kn}</div>`:""}

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Game</h2>
      <div class="flex items-center gap-4">
        <button data-action="toggle-pause" class="px-4 py-2 border-2 ${t?"border-positive text-positive hover-bg-positive hover-text-black":"border-gold text-gold hover-bg-gold hover-text-black"} bg-black font-mono transition-colors">
          ${t?"Resume Game":"Pause Game"}
        </button>
        <button data-action="show-hotkeys" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Hotkeys
        </button>
        <a href="https://discord.gg/fCp7jCDqgg" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-discord text-discord bg-black font-mono hover-bg-discord hover-text-white transition-colors">
          <svg width="20" height="20" viewBox="0 -28.5 256 256" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid">
            <path d="M216.856 16.597A208.502 208.502 0 0 0 164.042 0c-2.275 4.113-4.933 9.645-6.766 14.046-19.692-2.961-39.203-2.961-58.533 0-1.832-4.4-4.55-9.933-6.846-14.046a207.809 207.809 0 0 0-52.855 16.638C5.618 67.147-3.443 116.4 1.087 164.956c22.169 16.555 43.653 26.612 64.775 33.193A161.094 161.094 0 0 0 79.735 175.3a136.413 136.413 0 0 1-21.846-10.632 108.636 108.636 0 0 0 5.356-4.237c42.122 19.702 87.89 19.702 129.51 0a131.66 131.66 0 0 0 5.355 4.237 136.07 136.07 0 0 1-21.886 10.653c4.006 8.02 8.638 15.67 13.873 22.848 21.142-6.58 42.646-16.637 64.815-33.213 5.316-56.288-9.08-105.09-38.056-148.36ZM85.474 135.095c-12.645 0-23.015-11.805-23.015-26.18s10.149-26.2 23.015-26.2c12.867 0 23.236 11.804 23.015 26.2.02 14.375-10.148 26.18-23.015 26.18Zm85.051 0c-12.645 0-23.014-11.805-23.014-26.18s10.148-26.2 23.014-26.2c12.867 0 23.236 11.804 23.015 26.2 0 14.375-10.148 26.18-23.015 26.18Z" fill="currentColor"/>
          </svg>
          Join Discord
        </a>
        ${t?'<span class="text-red">Game is paused - time is not accumulating</span>':""}
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Display</h2>
      <div class="flex items-center gap-4 mb-4">
        <button data-action="toggle-bg-image" class="px-4 py-2 border-2 ${n?"border-steel text-steel hover-bg-steel hover-text-black":"border-positive text-positive hover-bg-positive hover-text-black"} bg-black font-mono transition-colors">
          Background Image ${n?"Off":"On"}
        </button>
        <button data-action="toggle-tab-highlighting" class="px-4 py-2 border-2 ${e?"border-steel text-steel hover-bg-steel hover-text-black":"border-positive text-positive hover-bg-positive hover-text-black"} bg-black font-mono transition-colors">
          Tab Highlighting ${e?"Off":"On"}
        </button>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-steel font-mono">UI Scale</span>
        <button data-action="ui-scale-down" ${r<=.8?"disabled":""} class="px-3 py-1 font-mono border-2 ${r<=.8?"border-muted--30 text-muted--30 cursor-not-allowed":"border-steel text-steel hover-bg-steel hover-text-black"} bg-black transition-colors">&minus;</button>
        <span class="text-text font-mono" data-ui-scale-value style="min-width: 3.5em; text-align: center;">${Math.round(r*100)}%</span>
        <button data-action="ui-scale-up" ${r>=1.3?"disabled":""} class="px-3 py-1 font-mono border-2 ${r>=1.3?"border-muted--30 text-muted--30 cursor-not-allowed":"border-steel text-steel hover-bg-steel hover-text-black"} bg-black transition-colors">+</button>
        <button data-action="reset-ui-scale" class="px-2 py-1 text-xs font-mono border border-steel text-steel hover-bg-steel hover-text-black transition-colors">Reset</button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Export</h2>
      <div class="flex gap-4">
        <button data-action="export-clipboard" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Copy to Clipboard
        </button>
        <button data-action="export-file" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Download File
        </button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Import</h2>
      <div class="flex gap-4 mb-4">
        <button data-action="import-clipboard" class="px-4 py-2 border-2 border-arcane text-arcane bg-black font-mono hover-bg-arcane hover-text-black transition-colors">
          Paste from Clipboard
        </button>
        <label class="px-4 py-2 border-2 border-arcane text-arcane bg-black font-mono cursor-pointer hover-bg-arcane hover-text-black transition-colors">
          Load File
          <input type="file" accept=".txt" data-action="import-file" class="hidden">
        </label>
      </div>
      <div class="flex gap-4">
        <input
          type="text"
          data-input="import-text"
          value="${he}"
          placeholder="Paste save data here..."
          class="flex-1 px-4 py-2 bg-panel border-2 border-text text-text font-mono placeholder-text-muted"
        >
        <button
          data-action="import-text"
          ${he?"":"disabled"}
          class="px-4 py-2 border-2 font-mono ${he?"border-arcane text-arcane bg-black hover-bg-arcane hover-text-black transition-colors":"border-muted--30 text-muted--30 cursor-not-allowed line-through"}"
        >
          Import
        </button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Danger Zone</h2>
      ${Jn?`
        <div class="flex gap-4 items-center">
          <span class="text-red">Are you sure?</span>
          <button data-action="hard-reset" class="px-4 py-2 border-2 border-red text-red bg-black font-mono hover-bg-red hover-text-black transition-colors">
            Yes, Reset Everything
          </button>
          <button data-action="cancel-reset" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
            Cancel
          </button>
        </div>
      `:`
        <button data-action="show-reset-confirm" class="px-4 py-2 border-2 border-red text-red bg-black font-mono hover-bg-red hover-text-black transition-colors">
          Hard Reset
        </button>
      `}
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">About</h2>
      <div class="flex items-center gap-4">
        <span class="text-muted">Version ${pr()}</span>
        <button data-action="show-changelog" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          View Changelog
        </button>
      </div>
    </div>

    ${yu()}
    ${xu()}
  `,(c=ft.querySelector('[data-action="toggle-pause"]'))==null||c.addEventListener("click",gu),(l=ft.querySelector('[data-action="toggle-bg-image"]'))==null||l.addEventListener("click",hu),(m=ft.querySelector('[data-action="toggle-tab-highlighting"]'))==null||m.addEventListener("click",vu),(u=ft.querySelector('[data-action="ui-scale-down"]'))==null||u.addEventListener("click",()=>er(-.05)),(f=ft.querySelector('[data-action="ui-scale-up"]'))==null||f.addEventListener("click",()=>er(.05)),(b=ft.querySelector('[data-action="reset-ui-scale"]'))==null||b.addEventListener("click",()=>er(1-S.getState().uiScale)),(x=ft.querySelector('[data-action="export-clipboard"]'))==null||x.addEventListener("click",cu),(p=ft.querySelector('[data-action="export-file"]'))==null||p.addEventListener("click",uu),(g=ft.querySelector('[data-action="import-clipboard"]'))==null||g.addEventListener("click",du),(h=ft.querySelector('[data-action="import-text"]'))==null||h.addEventListener("click",fu),(v=ft.querySelector('[data-action="show-reset-confirm"]'))==null||v.addEventListener("click",()=>{Jn=!0,bt()}),(y=ft.querySelector('[data-action="hard-reset"]'))==null||y.addEventListener("click",pu),(T=ft.querySelector('[data-action="cancel-reset"]'))==null||T.addEventListener("click",()=>{Jn=!1,bt()}),(M=ft.querySelector('[data-action="show-changelog"]'))==null||M.addEventListener("click",bu),(E=ft.querySelector('[data-action="close-changelog"]'))==null||E.addEventListener("click",rs);const a=ft.querySelector("[data-changelog-dialog]");a==null||a.addEventListener("click",_=>{_.target===a&&rs()}),(I=ft.querySelector('[data-action="show-hotkeys"]'))==null||I.addEventListener("click",()=>{cn=!0,bt()}),(R=ft.querySelector('[data-action="close-hotkeys"]'))==null||R.addEventListener("click",()=>{cn=!1,ie=null,Tn(),bt()});const s=ft.querySelector("[data-hotkey-dialog]");s==null||s.addEventListener("click",_=>{_.target===s&&(cn=!1,ie=null,Tn(),bt())}),ft.querySelectorAll('[data-action="rebind-hotkey"]').forEach(_=>{_.addEventListener("click",()=>{const V=_.getAttribute("data-hotkey-action");ie===V?ci():wu(V)})});const i=ft.querySelector('[data-action="import-file"]');i==null||i.addEventListener("change",_=>{var B;const V=(B=_.target.files)==null?void 0:B[0];V&&(mu(V),i.value="")});const o=ft.querySelector('[data-input="import-text"]');o==null||o.addEventListener("input",_=>{he=_.target.value,bt()})},Su=t=>{ft=t,bt()};let St="crafting";const ku={crafting:dt.Crafting,upgrades:dt.Upgrades,prestige:dt.Prestige,combat:dt.Combat,artifacts:dt.Artifacts,tier:dt.Tier,altar:dt.Altar,realm:dt.Realm,settings:0},ui=t=>{St=t,El(ku[t]),Ee(),Ir()},Tu=["crafting","upgrades","prestige","combat","artifacts","tier","altar","realm","settings"],di=()=>{const t=S.getState(),n=et(t.realms.realm1.recipeInventory,"nullstone").gte(1)||t.realms.realm1.combat.portalBuilt,e=ur(t.globalTier),r=It.some(a=>{const s=t.realms[a].recipeCrafting;return Qi(a).some(i=>{var o;return(((o=s[i])==null?void 0:o.lifetimeProduced)??0)>0})});return Tu.filter(a=>a==="realm"?n:a==="altar"?e:a==="artifacts"?r:!0)},as=t=>{const n=di(),r=(n.indexOf(St)+t+n.length)%n.length;ui(n[r])},ve={crafting:"Crafting",upgrades:"Research",prestige:"Prestige",artifacts:"Artifacts",combat:"Expeditions",tier:"Tier",altar:"Altar",realm:"Realm",settings:"Settings"},Mu=()=>{var a;const t=S.getState(),n=K(t),{recipeCrafting:e}=n,r=[];for(const s of ps){if(s==="crafters")continue;const o=s.match(/manaT(\d)Output/);if(o){const c=parseInt(o[1]);if((((a=e[`gem_${c}`])==null?void 0:a.lifetimeProduced)??0)<=0)continue}r.push(s)}for(const s of Mt)Lt(`flask_${s}`,e)&&r.push(`researchT${s}Production`);return r},fi=()=>{const t=S.getState(),n=K(t),{mana:e,upgrades:r}=n,a=Kt(n.recipeInventory),s=Te(n.recipeInventory),i=t.globalTier;return Mu().filter(o=>!Ot(r,o,i)&&Ze(r,o,e,a,s,i,n.recipeInventory)).length},mi=()=>{const t=S.getState(),n=K(t);return hn(n.mana,t.globalTier,t.activeRealm)},pi=()=>{const t=S.getState(),n=K(t),{prestige:e}=n,r=[...Pe(t.activeRealm),...lr];let a=0;for(const s of r){const i=et(n.recipeInventory,s),o=e.prestigeCounts[s]||0;Cn(s,i,o)&&a++}return a},gi=()=>window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",ss=t=>{const n=Math.floor(t/6e4),e=Math.floor(n/60),r=Math.floor(e/24);if(r>=1){const s=e%24;return`${r}d ${s}h`}const a=n%60;return`${e}h ${String(a).padStart(2,"0")}m`},hi=()=>`
    <div class="tooltip-title" style="color: var(--color-row-special);">Realm of War</div>
    <div class="tooltip-section" style="margin-bottom: 4px;">A harsher realm with unique mechanics:</div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-penalty); margin-bottom: 2px; font-weight: bold;">Penalties</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Mana generation</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">Square rooted</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Craft speed</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">x4 slower</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Flask gem costs</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">x4 higher</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Artifacts</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">Cannot craft</span>
    </div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-bonus); margin-bottom: 2px; font-weight: bold;">Bonuses</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice cap</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">200k (vs 20k)</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice batch</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">10 at once</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice scaling</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">Up to x9.94</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Quest bonuses</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">Tier output multipliers</span>
    </div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-special); margin-bottom: 2px; font-weight: bold;">Unique</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Military</span>
      <span class="tooltip-value" style="color: var(--color-text);">T1-T4 Swords</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Quest unlock</span>
      <span class="tooltip-value" style="color: var(--color-text);">15 completions</span>
    </div>
    <div style="font-size: 11px; color: var(--color-muted); margin-top: 8px;">Click to switch to Prime Realm.</div>
  `,Mr=t=>{const n=S.getState(),e={...n.realms};for(const r of It){const a=n.realms[r],s={};for(const[i,o]of Object.entries(a.combat.activeExpeditions))s[i]=o.map(c=>({...c,startTime:c.startTime-t}));e[r]={...a,combat:{...a.combat,activeExpeditions:s}}}S.setState({lastFrameTimestamp:n.lastFrameTimestamp-t,realms:e,skippedTime:n.skippedTime+t})},Ee=()=>{const t=document.getElementById("tab-buttons");t.innerHTML="";const n=S.getState();if(n.realm2Unlocked){const u=n.activeRealm==="realm2",f=L(u?"icons/portal.png":"icons/r0.png"),b="border-white",x=document.createElement("div");x.className="realm-tooltip-wrapper mr-2 flex-shrink-0";const p=document.createElement("button");p.className=`px-2 py-1 border ${b} hover-bg-panel--50 cursor-pointer flex items-center`,p.innerHTML=`<img src="${f}" alt="Realm" style="width: 24px; height: 24px;" class="object-contain">`,p.onclick=()=>{const h=n.activeRealm==="realm1"?"realm2":"realm1";S.getState().setActiveRealm(h)},x.appendChild(p);const g=document.createElement("div");g.className="realm-tooltip",u?g.innerHTML=hi():g.innerHTML=`<div class="tooltip-title text-cyan">Prime Realm</div>
        <div class="tooltip-section">Click to switch to the Realm of War.</div>`,x.appendChild(g),t.appendChild(x)}const e=di(),r=n.tabHighlightingOff,a=r?0:fi(),s=r?0:pi(),i=r?!1:mi(),o={upgrades:a>0,prestige:s>0,tier:i},c={upgrades:a,prestige:s};for(const u of e){const f=document.createElement("button"),b=St===u,x=!b&&(o[u]??!1);f.className=`px-4 py-2 font-mono transition-colors ${b?"tab-active":"tab-inactive"}${x?" tab-glow":""}`;const p=c[u]??0,g=p>0&&!b?`${ve[u]} (${p})`:ve[u];if(f.textContent=g,(u==="upgrades"||u==="prestige"||u==="tier")&&(f.setAttribute("data-tab",u),x)){const h=document.createElement("div");h.className="tab-glow-bg",f.prepend(h)}f.onclick=()=>ui(u),t.appendChild(f)}const l=document.createElement("div");l.className="flex items-center gap-4 ml-auto",l.setAttribute("data-right-container","");const m=document.createElement("span");if(m.className="font-mono text-steel text-sm",m.setAttribute("data-playtime-clock",""),l.appendChild(m),n.timeWarpCharges>0){const u=document.createElement("button");u.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black cursor-pointer",u.setAttribute("data-time-warp-btn",""),u.textContent=`Time Warp (${n.timeWarpCharges})`,u.onclick=()=>{const f=S.getState();f.timeWarpCharges<=0||(Mr(300*1e3),S.setState({timeWarpCharges:f.timeWarpCharges-1}))},l.appendChild(u)}if(gi()){const u=document.createElement("button");u.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black",u.textContent="+5min",u.onclick=()=>Mr(300*1e3),l.appendChild(u)}l.childNodes.length>0&&t.appendChild(l)},Ir=()=>{const t=document.getElementById("main-content");Wl(),Jl(),Xc(),oc(),Ic(),Ac(),Bc(),Yc(),t.innerHTML="",St==="crafting"?Kl(t):St==="upgrades"?tc(t):St==="prestige"?Qc(t):St==="artifacts"?ic(t):St==="combat"?ln(t):St==="tier"?qc(t):St==="altar"?Dc(t):St==="realm"?Wc(t):St==="settings"&&Su(t)};let nr=!1,rr=!1,ar="realm1",sr=0,ir=0,is=!1,or=0;const vi={realm1:{color:"var(--color-background)",image:'url("icons/r1%20bg.png")'},realm2:{color:"var(--color-realm2-bg)",image:'url("icons/r2%20bg.png")'}},bi=(t,n)=>{t.style.backgroundColor=n.color,n.image?(t.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), ${n.image}`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.style.backgroundRepeat="no-repeat"):t.style.backgroundImage="none"},yi=t=>{const n=vi[t],e=S.getState().backgroundImageOff;bi(document.body,e?{color:n.color}:n);const r=document.querySelector("#root > div");r&&(r.style.backgroundColor="transparent",r.style.backgroundImage="none")},Iu=()=>{const t=S.getState(),n=vi[t.activeRealm];bi(document.body,t.backgroundImageOff?{color:n.color}:n);const e=document.getElementById("root");e.innerHTML=`
    <div class="h-full flex flex-col p-2 gap-2 overflow-hidden">
      <nav>
        <div id="tab-buttons" class="flex items-center px-4" style="border: 1px solid var(--color-brown);"></div>
      </nav>
      <div id="update-banner" class="update-banner hidden"></div>
      <div class="flex flex-1 overflow-hidden gap-2 mobile-layout">
        <div id="inventory" class="pt-2 pb-2 pl-2 flex-shrink-0 flex flex-col overflow-hidden" style="border: 1px solid var(--color-brown); width: 280px;"></div>
        <main id="main-content" class="flex-1 p-6 overflow-auto" style="border: 1px solid var(--color-brown);"></main>
      </div>
    </div>
  `;const r=document.getElementById("inventory"),a=e.querySelector("nav"),s=document.createElement("button");s.className="mobile-inventory-toggle",s.textContent="Inventory",s.setAttribute("data-mobile-inv-toggle",""),s.onclick=()=>{r.classList.toggle("mobile-open"),s.textContent=r.classList.contains("mobile-open")?"Hide Inventory":"Inventory"},a.appendChild(s),t.uiScale!==1&&ba(t.uiScale),nr=et(t.realms.realm1.recipeInventory,"nullstone").gte(1)||t.realms.realm1.combat.portalBuilt,rr=t.realm2Unlocked,ar=t.activeRealm,or=t.timeWarpCharges,Ee(),Da(),Ir();const i=()=>{const o=S.getState(),c=et(o.realms.realm1.recipeInventory,"nullstone").gte(1)||o.realms.realm1.combat.portalBuilt;c!==nr&&(nr=c,Ee()),o.realm2Unlocked!==rr&&(rr=o.realm2Unlocked,Ee()),o.activeRealm!==ar&&(ar=o.activeRealm,yi(o.activeRealm),Ee(),Ir(),Da(),Zs());const l=o.tabHighlightingOff,m=(p,g,h)=>{if(g===h)return h;const v=document.querySelector(`[data-tab="${p}"]`);if(v&&St!==p){const y=v.querySelector(".tab-glow-bg");if(g&&!y){v.classList.add("tab-glow");const T=document.createElement("div");T.className="tab-glow-bg",v.prepend(T)}else!g&&y&&(v.classList.remove("tab-glow"),y.remove())}return g},u=l?0:fi();if(u!==sr){const p=sr>0,g=u>0;sr=u;const h=document.querySelector('[data-tab="upgrades"]');if(h&&St!=="upgrades"){if(g!==p){const v=h.querySelector(".tab-glow-bg");if(g&&!v){h.classList.add("tab-glow");const y=document.createElement("div");y.className="tab-glow-bg",h.prepend(y)}else!g&&v&&(h.classList.remove("tab-glow"),v.remove())}if(h.textContent=g?`${ve.upgrades} (${u})`:ve.upgrades,g&&!h.querySelector(".tab-glow-bg")){const v=document.createElement("div");v.className="tab-glow-bg",h.prepend(v)}}}const f=l?0:pi();if(f!==ir){const p=ir>0,g=f>0;ir=f;const h=document.querySelector('[data-tab="prestige"]');if(h&&St!=="prestige"){if(g!==p){const v=h.querySelector(".tab-glow-bg");if(g&&!v){h.classList.add("tab-glow");const y=document.createElement("div");y.className="tab-glow-bg",h.prepend(y)}else!g&&v&&(h.classList.remove("tab-glow"),v.remove())}if(h.textContent=g?`${ve.prestige} (${f})`:ve.prestige,g&&!h.querySelector(".tab-glow-bg")){const v=document.createElement("div");v.className="tab-glow-bg",h.prepend(v)}}}is=m("tier",l?!1:mi(),is);const b=o.timeWarpCharges;if(b!==or)if(or=b,b<=0){const p=document.querySelector("[data-time-warp-btn]");p&&p.remove()}else{let p=document.querySelector("[data-time-warp-btn]");if(p)p.textContent=`Time Warp (${b})`;else{const g=document.querySelector("[data-right-container]");g&&(p=document.createElement("button"),p.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black cursor-pointer",p.setAttribute("data-time-warp-btn",""),p.textContent=`Time Warp (${b})`,p.onclick=()=>{const h=S.getState();h.timeWarpCharges<=0||(Mr(300*1e3),S.setState({timeWarpCharges:h.timeWarpCharges-1}))},g.prepend(p))}}const x=document.querySelector("[data-playtime-clock]");if(x){const p=o.totalPlaytime;let g=ss(p);gi()&&o.skippedTime>0&&(g+=` (${ss(o.skippedTime)} skipped)`),x.textContent=g}};je(dt.TabBar,i),document.addEventListener("keydown",o=>{const c=o.target;if(c.tagName==="INPUT"||c.tagName==="TEXTAREA")return;const l=su(o.key);if(l)switch(l){case"tabLeft":as(-1);break;case"tabRight":as(1);break;case"swapRealm":{const m=S.getState();if(m.realm2Unlocked){const u=m.activeRealm==="realm1"?"realm2":"realm1";m.setActiveRealm(u)}break}}}),document.addEventListener("mouseover",o=>{var m,u;const c=(u=(m=o.target).closest)==null?void 0:u.call(m,".hover-tooltip-wrapper");if(!c)return;const l=c.getBoundingClientRect();c.classList.toggle("tooltip-above",l.top>window.innerHeight/2)})},xi="evercraft_analytics_tiers",Ru=()=>{try{const t=localStorage.getItem(xi);return t?new Set(JSON.parse(t)):new Set}catch{return new Set}},$u=t=>{localStorage.setItem(xi,JSON.stringify([...t]))},Cu=t=>{const n=window.gtag;typeof n=="function"&&n("event","tier_reached",{tier:t})},Rr=()=>{const t=S.getState();let n=0;for(const e of It){const r=t.realms[e];if(r)for(const a of Mt)Lt(`gem_${a}`,r.recipeCrafting)&&a>n&&(n=a)}return n},os=()=>{const t=Rr(),n=Ru();let e=!1;for(let r=0;r<=t;r++)n.has(r)||(Cu(r),n.add(r),e=!0);e&&$u(n)},Eu=()=>{os();let t=Rr();S.subscribe(()=>{const n=Rr();n!==t&&(t=n,os())})},Nu=()=>{const t=S.getState().uiScale;t!==1&&ba(t),pl()&&Ln(gl()),Eu();const n=()=>{Ml(),Zs(),Nl(),requestAnimationFrame(n)};requestAnimationFrame(n)},Au=6e4;let qu=null,ls=null;const _u=()=>{if(ls!==null)return;const t=async()=>{try{const n=await fetch(L("version.json")+"?t="+Date.now());if(!n.ok)return;const e=await n.json();e.version&&parseFloat(e.version)>parseFloat(sa)&&(qu=e.version,Lu(e.version))}catch{}};t(),ls=window.setInterval(t,Au)},Lu=t=>{const n=document.getElementById("update-banner");if(!n)return;const e=L("changelog.txt");n.innerHTML=`V${t} is out, refresh to update (<a href="${e}" target="_blank" class="text-cyan" style="text-decoration: underline;">changelog</a>)`,n.classList.remove("hidden")};S.getState().loadFromStorage();Iu();Nu();_u();
